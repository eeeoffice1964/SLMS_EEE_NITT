<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Leave Management System - Firebase</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Add jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #17a2b8;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --admin-color: #8e44ad;
      --student-color: #16a085;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 2.2rem;
    }

    .role-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
    }

    .role-btn {
      padding: 18px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .role-btn i {
      font-size: 1.3rem;
    }

    .admin-btn {
      background: var(--admin-color);
      color: white;
    }

    .admin-btn:hover {
      background: #7d3c98;
      transform: translateY(-2px);
    }

    .student-btn {
      background: var(--student-color);
      color: white;
    }

    .student-btn:hover {
      background: #138a72;
      transform: translateY(-2px);
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #27ae60;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #e74c3c;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #f39c12;
    }

    .close-btn {
      margin-left: auto;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .dashboard-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      min-height: 90vh;
      display: none;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-right button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right button:hover {
      background: rgba(255,255,255,0.3);
    }

    .dashboard-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 0;
      min-height: calc(90vh - 100px);
    }

    .sidebar {
      background: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #e9ecef;
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .menu-btn {
      width: 100%;
      text-align: left;
      padding: 12px 15px;
      border: none;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--dark);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid transparent;
    }

    .menu-btn.active {
      background: var(--secondary);
      color: white;
      border-left-color: var(--primary);
    }

    .menu-btn:hover:not(.active) {
      background: #e9ecef;
      border-left-color: #adb5bd;
    }

    .main-content {
      padding: 25px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
      transition: opacity 0.3s ease;
    }

    .main-content.hidden {
      opacity: 0;
    }

    .main-content.visible {
      opacity: 1;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .card-header h2 {
      color: var(--primary);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #d6eaf8; color: #1a5276; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .offline-notice {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #f39c12;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 5px solid var(--secondary);
    }

    .stat-card h3 {
      color: var(--secondary);
      font-size: 2rem;
      margin: 5px 0;
    }

    .leave-balance-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .leave-balance-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border-top: 5px solid #3498db;
    }

    .leave-count {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .leave-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .refresh-btn {
      background: var(--info);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #138496;
      transform: rotate(180deg);
    }

    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .student-info-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--secondary);
    }

    .student-info-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ced4da;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 5px;
    }

    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s ease;
    }

    .search-result-item:hover {
      background: #f8f9fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-id {
      font-weight: 600;
      color: var(--primary);
    }

    .search-result-name {
      color: #666;
      font-size: 0.9rem;
    }

    .btn-pdf {
      background: #e74c3c;
      color: white;
    }

    .btn-pdf:hover {
      background: #c0392b;
    }

    .filters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .search-box {
      position: relative;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-box input {
      padding-left: 35px;
    }

    .backup-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .backup-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .backup-stat {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .backup-stat h3 {
      font-size: 2rem;
      margin: 10px 0;
    }

    .confirmation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .confirmation-dialog {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 400px;
      width: 90%;
    }

    .confirmation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .backup-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .backup-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backup-info h4 {
      margin-bottom: 5px;
    }

    .backup-meta {
      font-size: 0.85rem;
      color: #666;
    }

    .year-credit-actions {
      display: flex;
      gap: 5px;
    }

    .bulk-select-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .bulk-select-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .bulk-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    .file-upload-area {
      border: 2px dashed #3498db;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-area:hover {
      background: #e9ecef;
      border-color: #2980b9;
    }

    .file-upload-area.dragover {
      background: #d1ecf1;
      border-color: #17a2b8;
    }

    .file-preview {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 15px;
      padding: 10px;
      background: white;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      border-radius: 12px;
      color: white;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      border: 3px solid white;
    }

    .profile-info h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .profile-info p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .profile-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .profile-field {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .profile-field label {
      display: block;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .profile-field .value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
    }

    .edit-profile-btn {
      margin-top: 20px;
      padding: 15px 30px;
    }

    .security-rule-card {
      background: #f8f9fa;
      border-left: 4px solid var(--success);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .security-rule-card.warning {
      border-left-color: var(--warning);
    }

    .security-rule-card.danger {
      border-left-color: var(--danger);
    }

    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .rule-code {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.success {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }

    .status-indicator.error {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    .status-indicator.warning {
      background: var(--warning);
      box-shadow: 0 0 10px var(--warning);
    }

    .email-config-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .email-template-preview {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background: #f8f9fa;
      max-height: 300px;
      overflow-y: auto;
    }

    .template-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
    }

    .template-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .template-tab.active {
      color: var(--secondary);
      border-bottom: 3px solid var(--secondary);
      background: #e8f4fd;
    }

    .template-tab:hover:not(.active) {
      background: #f8f9fa;
      color: var(--dark);
    }

    @media (max-width: 768px) {
      .dashboard-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .login-card {
        padding: 25px;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .header-right {
        flex-direction: column;
        align-items: flex-end;
      }
      
      .filters-container {
        grid-template-columns: 1fr;
      }
      
      .confirmation-dialog {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <div class="login-card">
      <h1><i class="fas fa-graduation-cap"></i> Leave Management System</h1>
      <p style="color: #666; margin-bottom: 20px;">Version 5.0 | Enhanced Email Notifications</p>
      
      <div class="role-selector">
        <button onclick="showAdminLoginForm()" class="role-btn admin-btn">
          <i class="fas fa-user-shield"></i> Admin Login
        </button>
        <button onclick="showStudentLoginForm()" class="role-btn student-btn">
          <i class="fas fa-user-graduate"></i> Student Login
        </button>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: #666; font-size: 0.9rem;">
          <i class="fas fa-shield-alt"></i> Secure Authentication System
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        <p>Welcome, <span id="adminName">Administrator</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="firebaseStatusBadge">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshAdminData()" title="Refresh Data" id="adminRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showAdminProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="showEmailConfig()">
          <i class="fas fa-envelope"></i> Email Config
        </button>
        <button onclick="logout('admin')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showAdminSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('students')">
            <i class="fas fa-user-graduate"></i> Students
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveTypes')">
            <i class="fas fa-list-alt"></i> Leave Types
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('categories')">
            <i class="fas fa-users-cog"></i> Categories
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('yearCredits')">
            <i class="fas fa-calendar-alt"></i> Year Credits
          </button></li>
          <li><button class="menu-btn" onclick="showLeaveEntryForm()">
            <i class="fas fa-file-signature"></i> Enter Leave Request
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveApprovals')">
            <i class="fas fa-check-circle"></i> Leave Approvals
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveHistory')">
            <i class="fas fa-history"></i> Leave History
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('bulkUpload')">
            <i class="fas fa-file-upload"></i> Bulk Upload
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('reports')">
            <i class="fas fa-chart-bar"></i> Reports
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('backup')">
            <i class="fas fa-database"></i> Backup & Restore
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('firebaseConfig')">
            <i class="fas fa-fire"></i> Firebase Config
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('systemSettings')">
            <i class="fas fa-cogs"></i> System Settings
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="adminMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Student Dashboard (No Profile Section) -->
  <div id="studentDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-graduate"></i> Student Dashboard</h1>
        <p>Welcome, <span id="studentName">Student</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="studentFirebaseStatus">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshStudentData()" title="Refresh Data" id="studentRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <!-- Profile button removed as requested - student dashboard has no profile section -->
        <button onclick="logout('student')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showStudentSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveBalance')">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveHistory')">
            <i class="fas fa-history"></i> My Leave History
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="studentMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal for Operations -->
  <div id="operationModal" class="modal"></div>

  <script>
    // ==================== GLOBAL VARIABLES ====================
    let firebaseInitialized = false;
    let currentUser = null;
    let currentRole = null;
    let currentStudent = null;
    let refreshInterval = null;
    let selectedStudentInfo = null;
    
    let currentReportData = null;
    let currentReportType = null;
    let currentFromDate = null;
    let currentToDate = null;
    let allStudents = [];
    let selectedStudents = new Set();
    let currentFilters = {
      search: '',
      category: '',
      year: '',
      semester: '',
      specialization: ''
    };

    let filterStates = {
      students: {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      },
      leaveHistory: {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      },
      leaveApprovals: {
        search: '',
        studentId: '',
        leaveType: ''
      },
      reports: {
        fromDate: '',
        toDate: '',
        reportType: 'all'
      }
    };

    const DEFAULT_ADMIN_EMAIL = 'admin@leavemanagement.com';
    const DEFAULT_ADMIN_PASSWORD = 'Admin@123';

    const SETTINGS_COLLECTION = 'systemSettings';
    const FILTERS_COLLECTION = 'userFilters';
    const BACKUP_COLLECTION = 'systemBackups';

    // ==================== FIREBASE STORAGE UTILITIES ====================
    
    async function saveSetting(key, value, userId = 'system') {
      try {
        if (firebase.apps.length === 0) return false;
        
        const db = firebase.firestore();
        const settingRef = db.collection(SETTINGS_COLLECTION).doc(key);
        
        await settingRef.set({
          key: key,
          value: value,
          updatedAt: new Date().toISOString(),
          updatedBy: userId
        }, { merge: true });
        
        return true;
      } catch (error) {
        console.error('Error saving setting:', error);
        return false;
      }
    }

    async function getSetting(key, defaultValue = null) {
      try {
        if (firebase.apps.length === 0) return defaultValue;
        
        const db = firebase.firestore();
        const settingDoc = await db.collection(SETTINGS_COLLECTION).doc(key).get();
        
        if (settingDoc.exists) {
          return settingDoc.data().value;
        }
        return defaultValue;
      } catch (error) {
        console.error('Error getting setting:', error);
        return defaultValue;
      }
    }

    async function saveUserFilter(userId, section, filters) {
      try {
        if (firebase.apps.length === 0 || !userId) return false;
        
        const db = firebase.firestore();
        const filterRef = db.collection(FILTERS_COLLECTION).doc(`${userId}_${section}`);
        
        await filterRef.set({
          userId: userId,
          section: section,
          filters: filters,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        return true;
      } catch (error) {
        console.error('Error saving filter:', error);
        return false;
      }
    }

    async function loadUserFilter(userId, section, defaultFilters) {
      try {
        if (firebase.apps.length === 0 || !userId) return defaultFilters;
        
        const db = firebase.firestore();
        const filterDoc = await db.collection(FILTERS_COLLECTION).doc(`${userId}_${section}`).get();
        
        if (filterDoc.exists) {
          return filterDoc.data().filters || defaultFilters;
        }
        return defaultFilters;
      } catch (error) {
        console.error('Error loading filter:', error);
        return defaultFilters;
      }
    }

    async function saveGoogleAppsScriptUrl(url) {
      return await saveSetting('googleAppsScriptUrl', url, currentUser?.uid || 'system');
    }

    async function loadGoogleAppsScriptUrl() {
      return await getSetting('googleAppsScriptUrl', '');
    }

    async function saveFirebaseConfigToFirestore(config) {
      return await saveSetting('firebaseConfig', config, currentUser?.uid || 'system');
    }

    async function loadFirebaseConfigFromFirestore() {
      return await getSetting('firebaseConfig', null);
    }

    async function saveBackupTimestamp(timestamp) {
      return await saveSetting('lastBackupTimestamp', timestamp, currentUser?.uid || 'system');
    }

    async function loadBackupTimestamp() {
      return await getSetting('lastBackupTimestamp', null);
    }

    async function saveFilterState(section, filters) {
      filterStates[section] = { ...filters };
      
      if (currentUser?.uid) {
        await saveUserFilter(currentUser.uid, section, filters);
      }
    }

    async function loadFilterState(section) {
      if (currentUser?.uid) {
        const saved = await loadUserFilter(currentUser.uid, section, filterStates[section]);
        filterStates[section] = saved;
      }
      return filterStates[section];
    }

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase(config) {
      try {
        if (firebase.apps.length > 0) {
          return { success: true, message: 'Firebase already initialized' };
        }
        
        firebase.initializeApp(config);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        firebase.firestore().enablePersistence()
          .catch((err) => {
            console.warn('Firebase persistence error:', err);
          });
        
        firebaseInitialized = true;
        updateFirebaseStatusBadges(true);
        
        return { success: true };
      } catch (error) {
        console.error('Firebase initialization error:', error);
        updateFirebaseStatusBadges(false);
        return { success: false, error: error.message };
      }
    }

    function updateFirebaseStatusBadges(isConnected) {
      const adminBadge = document.getElementById('firebaseStatusBadge');
      const studentBadge = document.getElementById('studentFirebaseStatus');
      
      if (adminBadge) {
        adminBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        adminBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
      
      if (studentBadge) {
        studentBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        studentBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
    }

    async function loadFirebaseConfig() {
      const firestoreConfig = await loadFirebaseConfigFromFirestore();
      
      if (firestoreConfig) {
        try {
          const result = initializeFirebase(firestoreConfig);
          if (result.success) {
            console.log('Firebase initialized from Firestore config');
            await loadGoogleAppsScriptUrlFromFirestore();
            return;
          }
        } catch (error) {
          console.error('Failed to load Firebase config from Firestore:', error);
        }
      }
      
      const savedConfig = localStorage.getItem('firebaseConfig');
      if (savedConfig) {
        try {
          const config = JSON.parse(savedConfig);
          const result = initializeFirebase(config);
          if (result.success) {
            console.log('Firebase initialized from localStorage config');
          }
        } catch (error) {
          console.error('Failed to load saved Firebase config:', error);
        }
      }
    }

    async function loadGoogleAppsScriptUrlFromFirestore() {
      const url = await loadGoogleAppsScriptUrl();
      if (url) {
        window.GOOGLE_APPS_SCRIPT_URL = url;
      }
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    function showAdminLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
          <form onsubmit="adminLogin(event)">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="adminEmail" required 
                     placeholder="Enter your registered email">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" class="form-control" id="adminPassword" required 
                     placeholder="Enter your password">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
              <button type="button" class="btn btn-link" onclick="showForgotPasswordModal()" 
                      style="color: var(--secondary); padding: 0; background: none; border: none; cursor: pointer;">
                <i class="fas fa-key"></i> Forgot Password?
              </button>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;" id="adminLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function adminLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      
      const loginBtn = document.getElementById('adminLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Verifying...';
      loginBtn.disabled = true;
      
      try {
        const firestoreConfig = await loadFirebaseConfigFromFirestore();
        const localStorageConfig = localStorage.getItem('firebaseConfig');
        const isFirebaseConfigured = firestoreConfig !== null || localStorageConfig !== null;
        
        if (!isFirebaseConfigured) {
          if (email === DEFAULT_ADMIN_EMAIL && password === DEFAULT_ADMIN_PASSWORD) {
            currentUser = {
              uid: 'default-admin',
              email: DEFAULT_ADMIN_EMAIL,
              name: 'Administrator',
              role: 'admin'
            };
            currentRole = 'admin';
            
            showAlert('Welcome, Administrator! Please configure Firebase to continue.', 'info');
            closeModal();
            showAdminDashboard();
            
            setTimeout(() => {
              showFirebaseConfigPanel();
            }, 500);
            
            return;
          } else {
            showAlert('Invalid credentials. First-time login requires default credentials.', 'danger');
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
            return;
          }
        }
        
        if (firebase.apps.length === 0) {
          showAlert('Firebase configuration error. Please reconfigure.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        
        const adminDoc = await firebase.firestore().collection('admins').doc(userCredential.user.uid).get();
        
        if (adminDoc.exists) {
          currentUser = {
            uid: userCredential.user.uid,
            email: userCredential.user.email,
            name: adminDoc.data().name || 'Administrator',
            role: 'admin'
          };
          currentRole = 'admin';
          
          await loadUserSettings();
          
          showAlert('Welcome back, Administrator!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        } else {
          await firebase.firestore().collection('admins').doc(userCredential.user.uid).set({
            email: email,
            name: email.split('@')[0],
            role: 'admin',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          
          currentUser = {
            uid: userCredential.user.uid,
            email: email,
            name: email.split('@')[0],
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Admin account created! Welcome!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        }
        
      } catch (error) {
        console.error('Admin login error:', error);
        
        switch(error.code) {
          case 'auth/user-not-found':
            showAlert('No account found with this email. Please contact administrator.', 'danger');
            break;
          case 'auth/wrong-password':
            showAlert('Incorrect password. Please try again or use "Forgot Password".', 'danger');
            break;
          case 'auth/invalid-email':
            showAlert('Invalid email format.', 'danger');
            break;
          case 'auth/user-disabled':
            showAlert('This account has been disabled. Contact administrator.', 'danger');
            break;
          case 'auth/too-many-requests':
            showAlert('Too many failed attempts. Please try again later.', 'danger');
            break;
          case 'auth/network-request-failed':
            showAlert('Network error. Please check your connection.', 'danger');
            break;
          default:
            showAlert('Login failed: ' + error.message, 'danger');
        }
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    async function loadUserSettings() {
      if (!currentUser?.uid) return;
      
      filterStates.students = await loadUserFilter(currentUser.uid, 'students', filterStates.students);
      filterStates.leaveHistory = await loadUserFilter(currentUser.uid, 'leaveHistory', filterStates.leaveHistory);
      filterStates.leaveApprovals = await loadUserFilter(currentUser.uid, 'leaveApprovals', filterStates.leaveApprovals);
      filterStates.reports = await loadUserFilter(currentUser.uid, 'reports', filterStates.reports);
      
      window.GOOGLE_APPS_SCRIPT_URL = await loadGoogleAppsScriptUrl();
    }

    // ==================== FORGOT PASSWORD FUNCTIONS ====================
    function showForgotPasswordModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-key"></i> Reset Password</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your registered admin email address. We'll check if it exists in our system before sending a reset link.
          </div>
          
          <form onsubmit="sendPasswordResetEmail(event)">
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" class="form-control" id="resetEmail" required 
                     placeholder="Enter your admin email">
            </div>
            
            <div id="resetStatus" style="margin-bottom: 15px;"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;" id="sendResetBtn">
                <i class="fas fa-paper-plane"></i> Send Reset Link
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
          
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
            <p style="color: #666; font-size: 0.9rem;">
              <i class="fas fa-clock"></i> Reset link expires in 1 hour
            </p>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function sendPasswordResetEmail(event) {
      event.preventDefault();
      
      const email = document.getElementById('resetEmail').value.trim();
      const sendBtn = document.getElementById('sendResetBtn');
      const resetStatus = document.getElementById('resetStatus');
      
      sendBtn.innerHTML = '<div class="loading-spinner"></div> Verifying email...';
      sendBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          if (email === DEFAULT_ADMIN_EMAIL) {
            resetStatus.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <strong>Default Admin Account</strong>
                  <p>You're using the default admin account. Please configure Firebase first to enable password reset functionality.</p>
                </div>
              </div>
            `;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
            sendBtn.disabled = false;
            return;
          } else {
            resetStatus.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                  <strong>Email Not Found</strong>
                  <p>The email "${email}" is not registered as an admin.</p>
                </div>
              </div>
            `;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
            sendBtn.disabled = false;
            return;
          }
        }
        
        const db = firebase.firestore();
        const adminsSnapshot = await db.collection('admins')
          .where('email', '==', email)
          .get();
        
        if (adminsSnapshot.empty) {
          resetStatus.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Email Not Found</strong>
                <p>The email "${email}" is not registered as an admin in our system.</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">Please check the email or contact system administrator.</p>
              </div>
            </div>
          `;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
          sendBtn.disabled = false;
          return;
        }
        
        await firebase.auth().sendPasswordResetEmail(email, {
          url: window.location.href,
          handleCodeInApp: false
        });
        
        resetStatus.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>Reset Email Sent!</strong>
              <p>Password reset instructions have been sent to <strong>${email}</strong>.</p>
              <p style="margin-top: 10px; font-size: 0.9rem;">Please check your inbox (and spam folder).</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-check"></i> Email Sent';
        
        setTimeout(() => {
          closeModal();
        }, 5000);
        
      } catch (error) {
        console.error('Password reset error:', error);
        
        let errorMessage = '';
        let errorTitle = 'Failed to Send Reset Email';
        
        switch(error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email address.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email format. Please enter a valid email address.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many reset attempts. Please try again later.';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your internet connection.';
            break;
          case 'auth/internal-error':
            errorMessage = 'Internal error occurred. Please try again.';
            break;
          default:
            errorMessage = error.message;
        }
        
        resetStatus.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <strong>${errorTitle}</strong>
              <p>${errorMessage}</p>
              <p style="margin-top: 10px; font-size: 0.9rem;">Please try again or contact system administrator.</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
        sendBtn.disabled = false;
      }
    }

    async function checkAdminEmailExists(email) {
      try {
        if (firebase.apps.length === 0) {
          return email === DEFAULT_ADMIN_EMAIL;
        }
        
        const db = firebase.firestore();
        const adminsSnapshot = await db.collection('admins')
          .where('email', '==', email)
          .get();
        
        return !adminsSnapshot.empty;
      } catch (error) {
        console.error('Error checking admin email:', error);
        return false;
      }
    }

    function showStudentLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-graduate"></i> Student Login</h2>
          <form onsubmit="studentLogin(event)">
            <div class="form-group">
              <label>Student ID / Roll Number</label>
              <input type="text" class="form-control" id="studentIdInput" placeholder="Enter your student ID" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="studentLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function studentLogin(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('studentIdInput').value.trim();
      
      const loginBtn = document.getElementById('studentLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
      loginBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured. Please contact administrator.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentsRef = firebase.firestore().collection('students');
        const snapshot = await studentsRef.where('ID', '==', studentId).limit(1).get();
        
        if (snapshot.empty) {
          showAlert('Student not found with this ID', 'danger');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentDoc = snapshot.docs[0];
        const studentData = studentDoc.data();
        
        currentUser = {
          uid: studentDoc.id,
          ...studentData,
          id: studentData.ID
        };
        currentRole = 'student';
        currentStudent = currentUser;
        
        await loadUserSettings();
        
        showAlert(`Welcome, ${studentData.Name}!`, 'success');
        closeModal();
        showStudentDashboard();
        startAutoRefresh();
        
      } catch (error) {
        console.error('Student login error:', error);
        showAlert('Login failed: ' + error.message, 'danger');
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function showAdminDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('studentDashboard').style.display = 'none';
      
      if (currentUser) {
        document.getElementById('adminName').textContent = currentUser.name || 'Administrator';
      }
      
      showAdminSection('dashboard');
    }

    function showStudentDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'block';
      
      if (currentUser) {
        document.getElementById('studentName').textContent = currentUser.name || 'Student';
      }
      
      showStudentSection('dashboard');
    }

    async function logout(role) {
      stopAutoRefresh();
      
      try {
        if (firebase.apps.length > 0 && firebase.auth().currentUser) {
          await firebase.auth().signOut();
        }
      } catch (error) {
        console.error('Firebase signout error:', error);
      }
      
      currentUser = null;
      currentRole = null;
      currentStudent = null;
      selectedStudentInfo = null;
      selectedStudents.clear();
      
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      
      showAlert('Logged out successfully', 'info');
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshInterval = setInterval(() => {
        if (currentRole === 'admin') {
          refreshAdminData(true);
        } else if (currentRole === 'student') {
          refreshStudentData(true);
        }
      }, 30000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function refreshAdminData(silent = false) {
      const refreshBtn = document.getElementById('adminRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#adminDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getAdminSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('admin', () => {
            showAdminSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function refreshStudentData(silent = false) {
      const refreshBtn = document.getElementById('studentRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#studentDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getStudentSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('student', () => {
            showStudentSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function smoothRefresh(role, callback) {
      const contentDiv = document.getElementById(role === 'admin' ? 'adminMainContent' : 'studentMainContent');
      if (contentDiv) {
        contentDiv.classList.add('hidden');
        
        setTimeout(() => {
          if (callback) callback();
          setTimeout(() => {
            contentDiv.classList.remove('hidden');
            contentDiv.classList.add('visible');
          }, 50);
        }, 300);
      } else {
        if (callback) callback();
      }
    }

    function getAdminSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-user-graduate')) return 'students';
      if (icon.classList.contains('fa-list-alt')) return 'leaveTypes';
      if (icon.classList.contains('fa-users-cog')) return 'categories';
      if (icon.classList.contains('fa-calendar-alt')) return 'yearCredits';
      if (icon.classList.contains('fa-check-circle')) return 'leaveApprovals';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      if (icon.classList.contains('fa-file-upload')) return 'bulkUpload';
      if (icon.classList.contains('fa-chart-bar')) return 'reports';
      if (icon.classList.contains('fa-database')) return 'backup';
      if (icon.classList.contains('fa-fire')) return 'firebaseConfig';
      if (icon.classList.contains('fa-cogs')) return 'systemSettings';
      return 'dashboard';
    }

    function getStudentSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-chart-pie')) return 'leaveBalance';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      return 'dashboard';
    }

    function showAdminSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#adminDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showAdminDashboardHome();
          break;
        case 'students':
          showStudentsManagement();
          break;
        case 'leaveTypes':
          showLeaveTypesManagement();
          break;
        case 'categories':
          showCategoriesManagement();
          break;
        case 'yearCredits':
          showYearCreditsManagement();
          break;
        case 'leaveApprovals':
          showLeaveApprovals();
          break;
        case 'leaveHistory':
          showLeaveHistory();
          break;
        case 'bulkUpload':
          showBulkUpload();
          break;
        case 'reports':
          showReports();
          break;
        case 'backup':
          showBackupManagement();
          break;
        case 'firebaseConfig':
          showFirebaseConfigPanel();
          break;
        case 'systemSettings':
          showSystemSettings();
          break;
      }
    }

    function showStudentSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#studentDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showStudentDashboardHome();
          break;
        case 'leaveBalance':
          showStudentLeaveBalance();
          break;
        case 'leaveHistory':
          showStudentLeaveHistory();
          break;
      }
    }

    // ==================== ENHANCED ADMIN PROFILE FUNCTIONS ====================
    function showAdminProfile() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-circle"></i> Admin Profile</h2>
          
          <div class="profile-header">
            <div class="profile-avatar">
              <i class="fas fa-user-shield"></i>
            </div>
            <div class="profile-info">
              <h2>${currentUser?.name || 'Administrator'}</h2>
              <p><i class="fas fa-envelope"></i> ${currentUser?.email || 'N/A'}</p>
              <p><i class="fas fa-user-tag"></i> ${currentUser?.role === 'admin' ? 'Administrator' : 'User'}</p>
              <p><i class="fas fa-calendar"></i> Member since: ${currentUser?.createdAt ? formatDate(currentUser.createdAt) : 'N/A'}</p>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="editAdminProfile()" style="flex: 1;">
              <i class="fas fa-edit"></i> Edit Profile
            </button>
            <button class="btn btn-info" onclick="changeAdminPassword()" style="flex: 1;">
              <i class="fas fa-key"></i> Change Password
            </button>
            <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
              Close
            </button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    // Edit Admin Profile (with editable email)
    function editAdminProfile() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-edit"></i> Edit Admin Profile</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            You can update your display name and email address below.
          </div>
          
          <form onsubmit="updateAdminProfile(event)">
            <div class="form-group">
              <label>Display Name <span style="color: red;">*</span></label>
              <input type="text" class="form-control" id="adminDisplayName" 
                     value="${currentUser?.name || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Email Address <span style="color: red;">*</span></label>
              <input type="email" class="form-control" id="adminEmail" 
                     value="${currentUser?.email || ''}" required>
              <small style="color: #666;">Changing email will require re-authentication</small>
            </div>
            
            <div class="form-group">
              <label>Role</label>
              <input type="text" class="form-control" value="${currentUser?.role === 'admin' ? 'Administrator' : 'User'}" readonly disabled>
            </div>
            
            <div id="emailVerificationSection" style="display: none; margin-bottom: 15px;">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Email Change Verification</strong>
                <p>Please enter your current password to verify email change:</p>
                <input type="password" class="form-control" id="verifyPassword" placeholder="Enter current password" style="margin-top: 10px;">
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;" id="updateProfileBtn">
                <i class="fas fa-save"></i> Update Profile
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="showAdminProfile()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
      
      // Add email change detection
      const emailInput = document.getElementById('adminEmail');
      const originalEmail = currentUser?.email || '';
      const verificationSection = document.getElementById('emailVerificationSection');
      
      emailInput.addEventListener('input', function() {
        if (this.value !== originalEmail) {
          verificationSection.style.display = 'block';
        } else {
          verificationSection.style.display = 'none';
        }
      });
    }

    // Update Admin Profile (with email change support)
    async function updateAdminProfile(event) {
      event.preventDefault();
      
      const newName = document.getElementById('adminDisplayName').value.trim();
      const newEmail = document.getElementById('adminEmail').value.trim();
      const originalEmail = currentUser?.email || '';
      
      if (!newName || !newEmail) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(newEmail)) {
        showAlert('Please enter a valid email address', 'warning');
        return;
      }
      
      const updateBtn = document.getElementById('updateProfileBtn');
      const originalText = updateBtn.innerHTML;
      updateBtn.innerHTML = '<div class="loading-spinner"></div> Updating...';
      updateBtn.disabled = true;
      
      try {
        // Check if email is being changed
        if (newEmail !== originalEmail) {
          const verifyPassword = document.getElementById('verifyPassword')?.value;
          
          if (!verifyPassword) {
            showAlert('Please enter your current password to change email', 'warning');
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
            return;
          }
          
          // Check if using default admin (no Firebase)
          if (currentUser?.uid === 'default-admin') {
            showAlert('Cannot change email for default admin account. Please configure Firebase first.', 'warning');
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
            return;
          }
          
          // Re-authenticate user before email change
          if (firebase.apps.length > 0) {
            const user = firebase.auth().currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(
              originalEmail,
              verifyPassword
            );
            
            try {
              await user.reauthenticateWithCredential(credential);
              
              // Update email in Firebase Auth
              await user.updateEmail(newEmail);
              
              // Update email in Firestore
              const db = firebase.firestore();
              await db.collection('admins').doc(currentUser.uid).update({
                email: newEmail,
                name: newName,
                updatedAt: new Date().toISOString()
              });
              
              // Send verification email to new address
              await user.sendEmailVerification();
              
              showAlert('Email updated successfully! Please verify your new email address.', 'success');
              
            } catch (authError) {
              console.error('Re-authentication error:', authError);
              if (authError.code === 'auth/wrong-password') {
                showAlert('Incorrect password. Please try again.', 'danger');
              } else {
                showAlert('Authentication failed: ' + authError.message, 'danger');
              }
              updateBtn.innerHTML = originalText;
              updateBtn.disabled = false;
              return;
            }
          }
        } else {
          // Only name is being changed
          if (currentUser?.uid === 'default-admin') {
            currentUser.name = newName;
            document.getElementById('adminName').textContent = newName;
            showAlert('Profile updated successfully!', 'success');
            closeModal();
            return;
          }
          
          if (firebase.apps.length > 0) {
            const db = firebase.firestore();
            await db.collection('admins').doc(currentUser.uid).update({
              name: newName,
              updatedAt: new Date().toISOString()
            });
          }
        }
        
        // Update local user object
        currentUser.name = newName;
        currentUser.email = newEmail;
        document.getElementById('adminName').textContent = newName;
        
        showAlert('Profile updated successfully!', 'success');
        closeModal();
        
      } catch (error) {
        console.error('Update profile error:', error);
        showAlert('Failed to update profile: ' + error.message, 'danger');
      } finally {
        updateBtn.innerHTML = originalText;
        updateBtn.disabled = false;
      }
    }

    // Change Admin Password
    function changeAdminPassword() {
      const modal = document.getElementById('operationModal');
      
      // Check if using default admin
      if (currentUser?.uid === 'default-admin') {
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-key"></i> Change Password</h2>
            
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              You're using the default admin account. Please configure Firebase first to enable password change.
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="showFirebaseConfigPanel()">
                Configure Firebase
              </button>
              <button class="btn btn-secondary" onclick="closeModal()">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        return;
      }
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-key"></i> Change Password</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your current password and a new password.
          </div>
          
          <form onsubmit="updateAdminPassword(event)">
            <div class="form-group">
              <label>Current Password</label>
              <input type="password" class="form-control" id="currentPassword" required 
                     placeholder="Enter your current password">
            </div>
            
            <div class="form-group">
              <label>New Password</label>
              <input type="password" class="form-control" id="newPassword" required 
                     placeholder="Enter new password"
                     onkeyup="checkPasswordStrength()" oninput="checkPasswordStrength()">
              <div id="passwordStrength" style="margin-top: 5px;"></div>
              <small style="color: #666;">Minimum 8 characters with at least 1 uppercase, 1 lowercase, and 1 number</small>
            </div>
            
            <div class="form-group">
              <label>Confirm New Password</label>
              <input type="password" class="form-control" id="confirmPassword" required 
                     placeholder="Confirm new password"
                     onkeyup="checkPasswordMatch()" oninput="checkPasswordMatch()">
              <div id="passwordMatch" style="margin-top: 5px;"></div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;" id="changePasswordBtn">
                <i class="fas fa-save"></i> Update Password
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="showAdminProfile()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    // Password Strength Indicator
    function checkPasswordStrength() {
      const password = document.getElementById('newPassword').value;
      const strengthDiv = document.getElementById('passwordStrength');
      
      if (!password) {
        strengthDiv.innerHTML = '';
        return;
      }
      
      // Strength criteria
      const criteria = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
      };
      
      // Calculate strength score (0-5)
      const score = Object.values(criteria).filter(Boolean).length;
      
      // Determine strength level
      let strengthText = '';
      let strengthClass = '';
      let percentage = 0;
      
      switch(score) {
        case 0:
        case 1:
          strengthText = 'Very Weak';
          strengthClass = 'badge-danger';
          percentage = 20;
          break;
        case 2:
          strengthText = 'Weak';
          strengthClass = 'badge-danger';
          percentage = 40;
          break;
        case 3:
          strengthText = 'Fair';
          strengthClass = 'badge-warning';
          percentage = 60;
          break;
        case 4:
          strengthText = 'Good';
          strengthClass = 'badge-info';
          percentage = 80;
          break;
        case 5:
          strengthText = 'Strong';
          strengthClass = 'badge-success';
          percentage = 100;
          break;
      }
      
      // Create strength meter HTML
      strengthDiv.innerHTML = `
        <div style="margin-bottom: 5px;">
          <span class="badge ${strengthClass}">${strengthText}</span>
          <span style="float: right; font-size: 0.85rem;">${score}/5 criteria met</span>
        </div>
        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
          <div style="width: ${percentage}%; height: 100%; background: ${getStrengthColor(score)}; transition: width 0.3s ease;"></div>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; font-size: 0.8rem;">
          <span style="color: ${criteria.length ? '#27ae60' : '#e74c3c'};">
            <i class="fas fa-${criteria.length ? 'check-circle' : 'times-circle'}"></i> 8+ chars
          </span>
          <span style="color: ${criteria.lowercase ? '#27ae60' : '#e74c3c'};">
            <i class="fas fa-${criteria.lowercase ? 'check-circle' : 'times-circle'}"></i> lowercase
          </span>
          <span style="color: ${criteria.uppercase ? '#27ae60' : '#e74c3c'};">
            <i class="fas fa-${criteria.uppercase ? 'check-circle' : 'times-circle'}"></i> uppercase
          </span>
          <span style="color: ${criteria.number ? '#27ae60' : '#e74c3c'};">
            <i class="fas fa-${criteria.number ? 'check-circle' : 'times-circle'}"></i> number
          </span>
          <span style="color: ${criteria.special ? '#27ae60' : '#e74c3c'};">
            <i class="fas fa-${criteria.special ? 'check-circle' : 'times-circle'}"></i> special
          </span>
        </div>
      `;
    }

    // Helper function to get strength color
    function getStrengthColor(score) {
      switch(score) {
        case 0:
        case 1:
          return '#e74c3c'; // red
        case 2:
          return '#e67e22'; // orange
        case 3:
          return '#f39c12'; // yellow
        case 4:
          return '#3498db'; // blue
        case 5:
          return '#27ae60'; // green
        default:
          return '#95a5a6'; // grey
      }
    }

    // Password Match Validation
    function checkPasswordMatch() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const matchDiv = document.getElementById('passwordMatch');
      const changeBtn = document.getElementById('changePasswordBtn');
      
      if (!confirmPassword) {
        matchDiv.innerHTML = '';
        if (changeBtn) changeBtn.disabled = false;
        return;
      }
      
      if (newPassword === confirmPassword) {
        matchDiv.innerHTML = `
          <span style="color: #27ae60;">
            <i class="fas fa-check-circle"></i> Passwords match
          </span>
        `;
        if (changeBtn) changeBtn.disabled = false;
      } else {
        matchDiv.innerHTML = `
          <span style="color: #e74c3c;">
            <i class="fas fa-times-circle"></i> Passwords do not match
          </span>
        `;
        if (changeBtn) changeBtn.disabled = true;
      }
    }

    // Update Admin Password (with current password verification)
    async function updateAdminPassword(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validate inputs
      if (!currentPassword || !newPassword || !confirmPassword) {
        showAlert('Please fill in all password fields', 'warning');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'danger');
        return;
      }
      
      // Password strength validation
      if (newPassword.length < 8) {
        showAlert('Password must be at least 8 characters long', 'warning');
        return;
      }
      
      if (!/[a-z]/.test(newPassword)) {
        showAlert('Password must contain at least one lowercase letter', 'warning');
        return;
      }
      
      if (!/[A-Z]/.test(newPassword)) {
        showAlert('Password must contain at least one uppercase letter', 'warning');
        return;
      }
      
      if (!/\d/.test(newPassword)) {
        showAlert('Password must contain at least one number', 'warning');
        return;
      }
      
      const changeBtn = document.getElementById('changePasswordBtn');
      const originalText = changeBtn.innerHTML;
      changeBtn.innerHTML = '<div class="loading-spinner"></div> Updating...';
      changeBtn.disabled = true;
      
      try {
        // Check if Firebase is configured
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured. Please configure Firebase first.', 'warning');
          changeBtn.innerHTML = originalText;
          changeBtn.disabled = false;
          return;
        }
        
        const user = firebase.auth().currentUser;
        
        if (!user) {
          showAlert('No authenticated user found', 'danger');
          changeBtn.innerHTML = originalText;
          changeBtn.disabled = false;
          return;
        }
        
        // Re-authenticate user with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          currentPassword
        );
        
        try {
          await user.reauthenticateWithCredential(credential);
        } catch (authError) {
          console.error('Re-authentication error:', authError);
          if (authError.code === 'auth/wrong-password') {
            showAlert('Current password is incorrect', 'danger');
          } else if (authError.code === 'auth/too-many-requests') {
            showAlert('Too many failed attempts. Please try again later.', 'danger');
          } else {
            showAlert('Authentication failed: ' + authError.message, 'danger');
          }
          changeBtn.innerHTML = originalText;
          changeBtn.disabled = false;
          return;
        }
        
        // Update password
        await user.updatePassword(newPassword);
        
        // Update password change timestamp in Firestore
        const db = firebase.firestore();
        await db.collection('admins').doc(currentUser.uid).update({
          passwordLastChanged: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        
        showAlert('Password updated successfully!', 'success');
        closeModal();
        
      } catch (error) {
        console.error('Password update error:', error);
        
        let errorMessage = '';
        switch(error.code) {
          case 'auth/weak-password':
            errorMessage = 'New password is too weak';
            break;
          case 'auth/requires-recent-login':
            errorMessage = 'Please log out and log in again to change password';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your connection.';
            break;
          default:
            errorMessage = error.message;
        }
        
        showAlert('Failed to update password: ' + errorMessage, 'danger');
        
      } finally {
        changeBtn.innerHTML = originalText;
        changeBtn.disabled = false;
      }
    }

    // ==================== ADMIN DASHBOARD HOME ====================
    function showAdminDashboardHome() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 30px;">
              <h3>Quick Overview</h3>
              <div class="stats-grid" id="adminStats">
                <div class="stat-card">
                  <h3 id="totalStudents">0</h3>
                  <p>Total Students</p>
                </div>
                <div class="stat-card">
                  <h3 id="pendingApplications">0</h3>
                  <p>Pending Applications</p>
                </div>
                <div class="stat-card">
                  <h3 id="approvedApplications">0</h3>
                  <p>Approved Applications</p>
                </div>
                <div class="stat-card">
                  <h3 id="rejectedApplications">0</h3>
                  <p>Rejected Applications</p>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3>Quick Actions</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <button class="btn btn-primary" onclick="showLeaveEntryForm()">
                  <i class="fas fa-file-signature"></i> Enter Leave Request
                </button>
                <button class="btn btn-success" onclick="showAdminSection('students')">
                  <i class="fas fa-user-graduate"></i> Manage Students
                </button>
                <button class="btn btn-info" onclick="showAdminSection('leaveApprovals')">
                  <i class="fas fa-check-circle"></i> Pending Approvals
                </button>
                <button class="btn btn-warning" onclick="showAdminSection('reports')">
                  <i class="fas fa-chart-bar"></i> Generate Report
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadAdminStats();
    }

    async function loadAdminStats() {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        const pending = applications.filter(app => app.Status === 'pending').length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const rejected = applications.filter(app => app.Status === 'rejected').length;
        
        document.getElementById('totalStudents').textContent = studentsSnapshot.size;
        document.getElementById('pendingApplications').textContent = pending;
        document.getElementById('approvedApplications').textContent = approved;
        document.getElementById('rejectedApplications').textContent = rejected;
        
      } catch (error) {
        console.error('Load admin stats error:', error);
      }
    }

    // ==================== LEAVE APPROVALS ====================
    async function showLeaveApprovals() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const uniqueStudentIds = [...new Set(applications.map(a => a.StudentID))];
        const uniqueLeaveTypes = [...new Set(applications.map(a => a.LeaveType))];
        
        const savedFilters = await loadFilterState('leaveApprovals');
        filterStates.leaveApprovals = savedFilters;
        
        const filteredApps = filterLeaveApprovals(applications, savedFilters);
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-check-circle"></i> Leave Approvals</h2>
              <span class="badge badge-warning">${applications.length} Pending</span>
            </div>
            
            <div class="filters-container">
              <div class="filter-group search-box">
                <label>Search</label>
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="approvalSearch" placeholder="Search by ID, Student ID or Name..." 
                       oninput="filterApprovalList()" value="${savedFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>Student ID</label>
                <select class="form-control" id="filterApprovalStudentId" onchange="filterApprovalList()">
                  <option value="">All Students</option>
                  ${uniqueStudentIds.map(id => `
                    <option value="${id}" ${savedFilters.studentId === id ? 'selected' : ''}>${id}</option>
                  `).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Leave Type</label>
                <select class="form-control" id="filterApprovalLeaveType" onchange="filterApprovalList()">
                  <option value="">All Types</option>
                  ${uniqueLeaveTypes.map(lt => `
                    <option value="${lt}" ${savedFilters.leaveType === lt ? 'selected' : ''}>${lt}</option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> pending applications
              <button class="btn btn-sm btn-secondary" onclick="clearApprovalFilters()" style="margin-left: 15px;">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
            
            <div class="table-container">
              ${renderLeaveApprovalsTable(filteredApps)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave approvals error:', error);
        showAlert('Failed to load leave approvals: ' + error.message, 'danger');
      }
    }

    function renderLeaveApprovalsTable(applications) {
      if (applications.length === 0) {
        return '<p>No pending leave applications found.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Application ID</th>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.ID || ''}</td>
                <td>
                  <div><strong>${app.StudentName || ''}</strong></div>
                  <small>${app.StudentID || ''}</small>
                </td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>${app.Reason ? app.Reason.substring(0, 30) + (app.Reason.length > 30 ? '...' : '') : ''}</td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-success" onclick="approveLeave('${app.id}')" title="Approve">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectLeave('${app.id}')" title="Reject">
                      <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function filterApprovalList() {
      const filters = {
        search: document.getElementById('approvalSearch').value.toLowerCase(),
        studentId: document.getElementById('filterApprovalStudentId').value,
        leaveType: document.getElementById('filterApprovalLeaveType').value
      };
      
      await saveFilterState('leaveApprovals', filters);
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = filterLeaveApprovals(applications, filters);
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderLeaveApprovalsTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> pending applications
            <button class="btn btn-sm btn-secondary" onclick="clearApprovalFilters()" style="margin-left: 15px;">
              <i class="fas fa-times"></i> Clear Filters
            </button>
          `;
        }
      } catch (error) {
        console.error('Filter approval error:', error);
      }
    }

    function filterLeaveApprovals(applications, filters) {
      return applications.filter(app => {
        if (filters.search) {
          const searchMatch = 
            (app.StudentID && app.StudentID.toString().toLowerCase().includes(filters.search)) ||
            (app.StudentName && app.StudentName.toLowerCase().includes(filters.search)) ||
            (app.ID && app.ID.toString().toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.studentId && app.StudentID !== filters.studentId) return false;
        if (filters.leaveType && app.LeaveType !== filters.leaveType) return false;
        
        return true;
      });
    }

    async function clearApprovalFilters() {
      const filters = {
        search: '',
        studentId: '',
        leaveType: ''
      };
      
      await saveFilterState('leaveApprovals', filters);
      
      if (document.getElementById('approvalSearch')) document.getElementById('approvalSearch').value = '';
      if (document.getElementById('filterApprovalStudentId')) document.getElementById('filterApprovalStudentId').value = '';
      if (document.getElementById('filterApprovalLeaveType')) document.getElementById('filterApprovalLeaveType').value = '';
      
      filterApprovalList();
    }

    // ==================== LEAVE HISTORY ====================
    async function showLeaveHistory() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const uniqueStatuses = [...new Set(applications.map(a => a.Status))];
        const uniqueLeaveTypes = [...new Set(applications.map(a => a.LeaveType))];
        const uniqueStudentIds = [...new Set(applications.map(a => a.StudentID))];
        
        const savedFilters = await loadFilterState('leaveHistory');
        filterStates.leaveHistory = savedFilters;
        
        const filteredApps = filterLeaveHistory(applications, savedFilters);
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> Leave History</h2>
              <span class="badge badge-info">Total: ${applications.length}</span>
            </div>
            
            <div class="filters-container">
              <div class="filter-group search-box">
                <label>Search</label>
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="historySearch" placeholder="Search by ID, Student ID, Name or Reason..." 
                       oninput="filterHistoryList()" value="${savedFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>Status</label>
                <select class="form-control" id="filterStatus" onchange="filterHistoryList()">
                  <option value="">All Status</option>
                  ${uniqueStatuses.map(status => `
                    <option value="${status}" ${savedFilters.status === status ? 'selected' : ''}>${status.charAt(0).toUpperCase() + status.slice(1)}</option>
                  `).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Leave Type</label>
                <select class="form-control" id="filterLeaveType" onchange="filterHistoryList()">
                  <option value="">All Types</option>
                  ${uniqueLeaveTypes.map(lt => `
                    <option value="${lt}" ${savedFilters.leaveType === lt ? 'selected' : ''}>${lt}</option>
                  `).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Student ID</label>
                <select class="form-control" id="filterStudentId" onchange="filterHistoryList()">
                  <option value="">All Students</option>
                  ${uniqueStudentIds.map(id => `
                    <option value="${id}" ${savedFilters.studentId === id ? 'selected' : ''}>${id}</option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> applications
              <button class="btn btn-sm btn-secondary" onclick="clearHistoryFilters()" style="margin-left: 15px;">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
            
            <div class="table-container">
              ${renderLeaveHistoryTable(filteredApps)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave history error:', error);
        showAlert('Failed to load leave history: ' + error.message, 'danger');
      }
    }

    function renderLeaveHistoryTable(applications) {
      if (applications.length === 0) {
        return '<p>No leave applications found.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Application ID</th>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.ID || ''}</td>
                <td>
                  <div><strong>${app.StudentName || ''}</strong></div>
                  <small>${app.StudentID || ''}</small>
                </td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>${app.Reason ? app.Reason.substring(0, 30) + (app.Reason.length > 30 ? '...' : '') : ''}</td>
                <td>
                  <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                    ${(app.Status || '').toUpperCase()}
                  </span>
                </td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-primary" onclick="editLeaveApplication('${app.id}')" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLeaveApplication('${app.id}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function filterHistoryList() {
      const filters = {
        search: document.getElementById('historySearch').value.toLowerCase(),
        status: document.getElementById('filterStatus').value,
        leaveType: document.getElementById('filterLeaveType').value,
        studentId: document.getElementById('filterStudentId').value
      };
      
      await saveFilterState('leaveHistory', filters);
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = filterLeaveHistory(applications, filters);
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderLeaveHistoryTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> applications
            <button class="btn btn-sm btn-secondary" onclick="clearHistoryFilters()" style="margin-left: 15px;">
              <i class="fas fa-times"></i> Clear Filters
            </button>
          `;
        }
      } catch (error) {
        console.error('Filter history error:', error);
      }
    }

    function filterLeaveHistory(applications, filters) {
      return applications.filter(app => {
        if (filters.search) {
          const searchMatch = 
            (app.StudentID && app.StudentID.toString().toLowerCase().includes(filters.search)) ||
            (app.StudentName && app.StudentName.toLowerCase().includes(filters.search)) ||
            (app.ID && app.ID.toString().toLowerCase().includes(filters.search)) ||
            (app.Reason && app.Reason.toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.status && app.Status !== filters.status) return false;
        if (filters.leaveType && app.LeaveType !== filters.leaveType) return false;
        if (filters.studentId && app.StudentID !== filters.studentId) return false;
        
        return true;
      });
    }

    async function clearHistoryFilters() {
      const filters = {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      };
      
      await saveFilterState('leaveHistory', filters);
      
      if (document.getElementById('historySearch')) document.getElementById('historySearch').value = '';
      if (document.getElementById('filterStatus')) document.getElementById('filterStatus').value = '';
      if (document.getElementById('filterLeaveType')) document.getElementById('filterLeaveType').value = '';
      if (document.getElementById('filterStudentId')) document.getElementById('filterStudentId').value = '';
      
      filterHistoryList();
    }

    // ==================== STUDENT DASHBOARD HOME (No Profile) ====================
    function showStudentDashboardHome() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
              <div style="width: 60px; height: 60px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                <i class="fas fa-user-graduate"></i>
              </div>
              <div>
                <h3 style="margin-bottom: 5px;">${student.Name || 'Student'}</h3>
                <p style="color: #666; margin: 0;">
                  ${student.ID || ''} | ${student.Category || ''} ${student.Year ? '- ' + student.Year : ''}
                  ${student.Semester ? '| ' + student.Semester : ''}
                  ${student.Specialization ? '| ' + student.Specialization : ''}
                  ${student.Email ? '| Email: ' + student.Email : ''}
                </p>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Quick Overview</h3>
              <div class="stats-grid" id="studentStats">
                <div class="stat-card">
                  <h3 id="studentTotalLeaves">0</h3>
                  <p>Total Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentApprovedLeaves">0</h3>
                  <p>Approved</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentPendingLeaves">0</h3>
                  <p>Pending</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentRejectedLeaves">0</h3>
                  <p>Rejected</p>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="margin-bottom: 15px;"><i class="fas fa-bolt"></i> Quick Actions</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button class="btn btn-primary" onclick="showStudentSection('leaveBalance')">
                  <i class="fas fa-chart-pie"></i> View Leave Balance
                </button>
                <button class="btn btn-info" onclick="showStudentSection('leaveHistory')">
                  <i class="fas fa-history"></i> View Leave History
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentStats();
    }

    async function loadStudentStats() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .get();
        
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        
        const total = applications.length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const pending = applications.filter(app => app.Status === 'pending').length;
        const rejected = applications.filter(app => app.Status === 'rejected').length;
        
        document.getElementById('studentTotalLeaves').textContent = total;
        document.getElementById('studentApprovedLeaves').textContent = approved;
        document.getElementById('studentPendingLeaves').textContent = pending;
        document.getElementById('studentRejectedLeaves').textContent = rejected;
        
      } catch (error) {
        console.error('Load student stats error:', error);
      }
    }

    // ==================== STUDENT LEAVE BALANCE ====================
    function showStudentLeaveBalance() {
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> My Leave Balance</h2>
            <button class="btn btn-sm btn-info" onclick="refreshStudentData()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Your available leave credits based on your category and year.
            </div>
            <div class="leave-balance-container" id="leaveBalanceContainer">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave balance...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveBalance();
    }

    async function loadStudentLeaveBalance() {
      if (firebase.apps.length === 0) {
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Firebase not configured. Cannot load leave balance.
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        // Get year credits for student's category and year
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .where('Active', '==', true)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>No Leave Credits Found</strong>
              <p>No credit records found for ${student.Category} - ${student.Year}. Please contact administrator.</p>
            </div>
          `;
          return;
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        
        // Get all approved leave applications for this student
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .where('Status', '==', 'approved')
          .get();
        
        const approvedLeaves = applicationsSnapshot.docs.map(doc => doc.data());
        
        // Calculate used credits by leave type
        const usedCredits = {};
        approvedLeaves.forEach(app => {
          if (!usedCredits[app.LeaveType]) {
            usedCredits[app.LeaveType] = 0;
          }
          usedCredits[app.LeaveType] += app.NoOfDays || 0;
        });
        
        // Get all credit leave types
        const leaveTypesSnapshot = await db.collection('leaveTypes')
          .where('ApprovalType', '==', 'credit')
          .where('Enabled', '==', true)
          .get();
        
        const creditLeaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        if (creditLeaveTypes.length === 0) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Credit Leave Types</h3>
              <p>No credit-based leave types have been configured.</p>
            </div>
          `;
          return;
        }
        
        // Build balance display
        let balanceHTML = '';
        let hasAnyCredits = false;
        
        creditLeaveTypes.forEach(lt => {
          const totalCredits = yearCredit[lt.Code] || 0;
          const used = usedCredits[lt.Code] || 0;
          const remaining = Math.max(0, totalCredits - used);
          
          if (totalCredits > 0) hasAnyCredits = true;
          
          balanceHTML += `
            <div class="leave-balance-card" style="border-top-color: ${totalCredits > 0 ? '#27ae60' : '#95a5a6'}">
              <div class="leave-name">${lt.Name} (${lt.Code})</div>
              <div class="leave-count ${remaining === 0 ? 'text-danger' : ''}">${remaining}</div>
              <div>Days Available</div>
              <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                Total: ${totalCredits} | Used: ${used}
              </div>
              ${lt.MaxDaysPerYear ? `
                <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">
                  Max/Year: ${lt.MaxDaysPerYear}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        if (!hasAnyCredits) {
          balanceHTML = `
            <div class="alert alert-warning" style="grid-column: 1/-1;">
              <i class="fas fa-exclamation-triangle"></i>
              No credit values have been set for ${student.Category} - ${student.Year}. Please contact administrator.
            </div>
          ` + balanceHTML;
        }
        
        document.getElementById('leaveBalanceContainer').innerHTML = balanceHTML;
        
      } catch (error) {
        console.error('Load leave balance error:', error);
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave balance: ${error.message}
          </div>
        `;
      }
    }

    // ==================== STUDENT LEAVE HISTORY ====================
    function showStudentLeaveHistory() {
      const contentDiv = document.getElementById('studentMainContent');
      const student = currentStudent || currentUser;
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> My Leave History</h2>
            <button class="btn btn-sm btn-info" onclick="refreshStudentData()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div style="padding: 20px;">
            <div class="table-container" id="studentHistoryTable">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave history...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveHistory();
    }

    async function loadStudentLeaveHistory() {
      if (firebase.apps.length === 0) {
        document.getElementById('studentHistoryTable').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Firebase not configured. Cannot load leave history.
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .orderBy('AppliedDate', 'desc')
          .get();
        
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tableDiv = document.getElementById('studentHistoryTable');
        
        if (applications.length === 0) {
          tableDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Leave Applications Found</h3>
              <p>You haven't applied for any leaves yet.</p>
              <p><small>Contact your administrator to apply for leave.</small></p>
            </div>
          `;
          return;
        }
        
        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Application ID</th>
                <th>Leave Type</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>Days</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Applied Date</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        applications.forEach(app => {
          let statusBadge = '';
          switch(app.Status) {
            case 'approved':
              statusBadge = 'badge-success';
              break;
            case 'rejected':
              statusBadge = 'badge-danger';
              break;
            default:
              statusBadge = 'badge-warning';
          }
          
          tableHTML += `
            <tr>
              <td><strong>${app.ID || 'N/A'}</strong></td>
              <td><span class="badge badge-primary">${app.LeaveType || 'N/A'}</span></td>
              <td>${formatDate(app.FromDate)}</td>
              <td>${formatDate(app.ToDate)}</td>
              <td>${app.NoOfDays || 0}</td>
              <td>${app.Reason ? app.Reason.substring(0, 30) + (app.Reason.length > 30 ? '...' : '') : 'N/A'}</td>
              <td><span class="badge ${statusBadge}">${(app.Status || 'pending').toUpperCase()}</span></td>
              <td>${formatDate(app.AppliedDate)}</td>
            </tr>
          `;
        });
        
        tableHTML += '</tbody></table>';
        
        // Add summary stats
        const approved = applications.filter(app => app.Status === 'approved').length;
        const pending = applications.filter(app => app.Status === 'pending').length;
        const rejected = applications.filter(app => app.Status === 'rejected').length;
        
        tableHTML = `
          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="stat-card" style="flex: 1; min-width: 100px;">
              <h3>${applications.length}</h3>
              <p>Total</p>
            </div>
            <div class="stat-card" style="flex: 1; min-width: 100px; background: #d4edda;">
              <h3>${approved}</h3>
              <p>Approved</p>
            </div>
            <div class="stat-card" style="flex: 1; min-width: 100px; background: #fff3cd;">
              <h3>${pending}</h3>
              <p>Pending</p>
            </div>
            <div class="stat-card" style="flex: 1; min-width: 100px; background: #f8d7da;">
              <h3>${rejected}</h3>
              <p>Rejected</p>
            </div>
          </div>
        ` + tableHTML;
        
        tableDiv.innerHTML = tableHTML;
        
      } catch (error) {
        console.error('Load student history error:', error);
        document.getElementById('studentHistoryTable').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave history: ${error.message}
          </div>
        `;
      }
    }

    // ==================== STUDENT DATA REFRESH ====================
    function refreshStudentData(silent = false) {
      const refreshBtn = document.getElementById('studentRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#studentDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getStudentSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('student', () => {
            showStudentSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
        if (!silent) {
          showAlert('Data refreshed successfully', 'success');
        }
      }, 1000);
    }

    // ==================== SYSTEM SETTINGS (Placeholder) ====================
    function showSystemSettings() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-cogs"></i> System Settings</h2>
          </div>
          
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              All settings are now stored in Firebase Firestore instead of localStorage.
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
              <div class="card">
                <h3><i class="fas fa-fire"></i> Firebase Configuration</h3>
                <p>Your Firebase configuration is now stored securely in Firestore.</p>
                <button class="btn btn-primary" onclick="showFirebaseConfigPanel()">
                  <i class="fas fa-cog"></i> Configure
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-envelope"></i> Email Settings</h3>
                <p>Email configuration is stored in Firestore for all users.</p>
                <button class="btn btn-primary" onclick="showEmailConfig()">
                  <i class="fas fa-cog"></i> Configure
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-filter"></i> User Filters</h3>
                <p>User filter preferences are stored per user in Firestore.</p>
                <button class="btn btn-primary" onclick="showFilterSettings()">
                  <i class="fas fa-eye"></i> View Filters
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-database"></i> Backup History</h3>
                <p>Backup timestamps are stored in Firestore.</p>
                <button class="btn btn-primary" onclick="showBackupHistory()">
                  <i class="fas fa-history"></i> View History
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showFilterSettings() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-filter"></i> User Filter Settings</h2>
          
          <div style="margin: 20px 0;">
            <h3>Current Filter States (Firestore Stored)</h3>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">
              ${JSON.stringify(filterStates, null, 2)}
            </pre>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-danger" onclick="clearAllFilters()">
              <i class="fas fa-trash"></i> Clear All Filters
            </button>
            <button class="btn btn-secondary" onclick="closeModal()">
              Close
            </button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    // ==================== EMAIL CONFIGURATION (Placeholder) ====================
    async function showEmailConfig() {
      const modal = document.getElementById('operationModal');
      const savedUrl = await loadGoogleAppsScriptUrl() || '';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-envelope"></i> Email Configuration</h2>
          
          <div class="email-config-card">
            <h3 style="margin-top: 0;">Google Apps Script Configuration</h3>
            <p>Configure your Google Apps Script URL to enable email notifications. This will be stored in Firestore.</p>
          </div>
          
          <form onsubmit="saveEmailConfig(event)">
            <div class="form-group">
              <label>Google Apps Script URL <span style="color: red;">*</span></label>
              <input type="url" class="form-control" id="appsScriptUrl" 
                     placeholder="https://script.google.com/macros/s/your-script-id/exec"
                     value="${savedUrl}" required>
              <small style="color: #666;">Paste your deployed Google Apps Script web app URL here</small>
            </div>
            
            <div class="alert alert-info" style="margin: 20px 0;">
              <i class="fas fa-info-circle"></i>
              <strong>Email Service Status:</strong> 
              ${savedUrl ? 
                '<span class="badge badge-success">Configured in Firestore</span>' : 
                '<span class="badge badge-danger">Not Configured</span>'}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Configuration
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function saveEmailConfig(event) {
      event.preventDefault();
      
      const url = document.getElementById('appsScriptUrl').value.trim();
      
      if (!url) {
        showAlert('Please enter a valid Google Apps Script URL', 'warning');
        return;
      }
      
      const success = await saveGoogleAppsScriptUrl(url);
      
      if (success) {
        window.GOOGLE_APPS_SCRIPT_URL = url;
        showAlert('Email configuration saved to Firestore successfully!', 'success');
        setTimeout(() => {
          closeModal();
        }, 1500);
      } else {
        showAlert('Failed to save configuration to Firestore', 'danger');
      }
    }

    // ==================== FIREBASE CONFIGURATION ====================
    function showFirebaseConfigPanel() {
      const contentDiv = document.getElementById('adminMainContent');
      const isConfigured = firebase.apps.length > 0;
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-fire"></i> Firebase Configuration</h2>
            <span class="badge ${isConfigured ? 'badge-success' : 'badge-danger'}">
              ${isConfigured ? 'CONNECTED' : 'NOT CONNECTED'}
            </span>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Firestore Storage:</strong> Configuration will be stored in Firestore for all users.
          </div>
          
          <div class="connection-status">
            <div class="status-indicator ${isConfigured ? 'success' : 'error'}"></div>
            <div>
              <strong>Status:</strong> 
              ${isConfigured ? 'Firebase is connected and ready' : 'Firebase is not configured'}
            </div>
          </div>
          
          ${!isConfigured ? `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              Firebase is not configured. Please enter your Firebase configuration below.
            </div>
          ` : ''}
          
          <form onsubmit="saveFirebaseConfig(event)">
            <h3 style="margin: 20px 0 10px 0;">1. Firebase Configuration</h3>
            <div class="form-group">
              <label>apiKey</label>
              <input type="text" class="form-control" id="fb_apiKey" required 
                     value="">
            </div>
            <div class="form-group">
              <label>authDomain</label>
              <input type="text" class="form-control" id="fb_authDomain" required
                     value="">
            </div>
            <div class="form-group">
              <label>projectId</label>
              <input type="text" class="form-control" id="fb_projectId" required
                     value="">
            </div>
            <div class="form-group">
              <label>storageBucket</label>
              <input type="text" class="form-control" id="fb_storageBucket" required
                     value="">
            </div>
            <div class="form-group">
              <label>messagingSenderId</label>
              <input type="text" class="form-control" id="fb_messagingSenderId" required
                     value="">
            </div>
            <div class="form-group">
              <label>appId</label>
              <input type="text" class="form-control" id="fb_appId" required
                     value="">
            </div>
            <div class="form-group">
              <label>measurementId (optional)</label>
              <input type="text" class="form-control" id="fb_measurementId"
                     value="">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save & Connect
              </button>
              ${isConfigured ? `
                <button type="button" class="btn btn-danger" onclick="clearFirebaseConfig()" style="flex: 1;">
                  <i class="fas fa-trash"></i> Clear Config
                </button>
              ` : ''}
            </div>
          </form>
        </div>
      `;
    }

    async function saveFirebaseConfig(event) {
      event.preventDefault();
      
      const config = {
        apiKey: document.getElementById('fb_apiKey').value,
        authDomain: document.getElementById('fb_authDomain').value,
        projectId: document.getElementById('fb_projectId').value,
        storageBucket: document.getElementById('fb_storageBucket').value,
        messagingSenderId: document.getElementById('fb_messagingSenderId').value,
        appId: document.getElementById('fb_appId').value
      };
      
      const measurementId = document.getElementById('fb_measurementId').value;
      if (measurementId) config.measurementId = measurementId;
      
      await saveFirebaseConfigToFirestore(config);
      
      localStorage.setItem('firebaseConfig', JSON.stringify(config));
      
      showAlert('Initializing Firebase...', 'info');
      
      const result = initializeFirebase(config);
      
      if (result.success) {
        showAlert('Firebase connected successfully! Configuration saved to Firestore.', 'success');
        await initializeDefaultData();
        showFirebaseConfigPanel();
      } else {
        showAlert('Firebase connection failed: ' + result.error, 'danger');
      }
    }

    async function initializeDefaultData() {
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').limit(1).get();
        
        if (leaveTypesSnapshot.empty) {
          const defaultLeaveTypes = [
            { Code: 'CL', Name: 'Casual Leave', Description: 'For casual/emergency leaves', ApprovalType: 'credit', MaxDaysPerApplication: 5, MaxDaysPerYear: 12, Enabled: true },
            { Code: 'RH', Name: 'Restricted Holiday', Description: 'Optional holidays', ApprovalType: 'approval', MaxDaysPerApplication: 1, MaxDaysPerYear: 2, Enabled: true },
            { Code: 'ML', Name: 'Medical Leave', Description: 'For medical reasons', ApprovalType: 'approval', MaxDaysPerApplication: 10, MaxDaysPerYear: 20, Enabled: true },
            { Code: 'EL', Name: 'Earned Leave', Description: 'Accumulated leave', ApprovalType: 'credit', MaxDaysPerApplication: 15, MaxDaysPerYear: 30, Enabled: true }
          ];
          
          for (const lt of defaultLeaveTypes) {
            await db.collection('leaveTypes').add(lt);
          }
        }
        
        const categoriesSnapshot = await db.collection('categories').limit(1).get();
        
        if (categoriesSnapshot.empty) {
          const defaultCategories = [
            { 
              Category: 'B.Tech', 
              Years: '1st Year,2nd Year,3rd Year,4th Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4,Semester 5,Semester 6,Semester 7,Semester 8',
              Specializations: 'Computer Science,Information Technology,Electronics,Mechanical,Civil,Electrical',
              Enabled: true
            },
            { 
              Category: 'M.Tech', 
              Years: '1st Year,2nd Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4',
              Specializations: 'Computer Science,Electronics,Mechanical,Structural Engineering',
              Enabled: true
            }
          ];
          
          for (const cat of defaultCategories) {
            await db.collection('categories').add(cat);
          }
        }
        
        console.log('Default data initialized');
        
      } catch (error) {
        console.error('Error initializing default data:', error);
      }
    }

    function clearFirebaseConfig() {
      showConfirmationDialog(
        "Clear Configuration",
        "This will remove Firebase configuration from Firestore and localStorage. Continue?",
        async () => {
          try {
            if (firebase.apps.length > 0) {
              const db = firebase.firestore();
              await db.collection(SETTINGS_COLLECTION).doc('firebaseConfig').delete();
            }
          } catch (error) {
            console.error('Error removing from Firestore:', error);
          }
          
          localStorage.removeItem('firebaseConfig');
          
          showAlert('Configuration cleared. Refreshing page...', 'success');
          
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      );
    }

    // ==================== BACKUP MANAGEMENT (Placeholder) ====================
    async function showBackupManagement() {
      const contentDiv = document.getElementById('adminMainContent');
      const lastBackup = await loadBackupTimestamp();
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-database"></i> Backup & Restore</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Note:</strong> This is a simplified backup system. For production use, use Firebase Console's export feature.
              <br>Backup timestamps are now stored in Firestore.
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <h3 id="studentCount">0</h3>
                <p>Students</p>
              </div>
              <div class="stat-card">
                <h3 id="applicationCount">0</h3>
                <p>Applications</p>
              </div>
              <div class="stat-card">
                <h3 id="backupTime">${lastBackup ? formatDate(lastBackup) : 'Never'}</h3>
                <p>Last Backup</p>
              </div>
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-success" onclick="createFirestoreBackup()" style="margin-right: 10px;">
                <i class="fas fa-save"></i> Export Data (JSON)
              </button>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>Backup History:</strong> All backup timestamps are saved to Firestore.
            </div>
          </div>
        </div>
      `;
      
      loadBackupStats();
    }

    async function loadBackupStats() {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        const studentCountEl = document.getElementById('studentCount');
        const applicationCountEl = document.getElementById('applicationCount');
        
        if (studentCountEl) studentCountEl.textContent = studentsSnapshot.size;
        if (applicationCountEl) applicationCountEl.textContent = applicationsSnapshot.size;
        
        const lastBackup = await loadBackupTimestamp();
        const backupTimeEl = document.getElementById('backupTime');
        if (backupTimeEl) {
          backupTimeEl.textContent = lastBackup ? formatDate(lastBackup) : 'Never';
        }
        
      } catch (error) {
        console.error('Load backup stats error:', error);
      }
    }

    async function createFirestoreBackup() {
      showAlert('Exporting data...', 'info');
      
      try {
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins', 'systemSettings', 'userFilters'];
        const backupData = {};
        
        for (const collection of collections) {
          const snapshot = await db.collection(collection).get();
          backupData[collection] = snapshot.docs.map(doc => ({
            id: doc.id,
            data: doc.data()
          }));
        }
        
        backupData.timestamp = new Date().toISOString();
        backupData.version = '2.0';
        
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `firestore_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        await saveBackupTimestamp(new Date().toISOString());
        
        showAlert('Data exported successfully! Backup timestamp saved to Firestore.', 'success');
        
        const backupTimeEl = document.getElementById('backupTime');
        if (backupTimeEl) {
          backupTimeEl.textContent = formatDate(new Date().toISOString());
        }
        
      } catch (error) {
        console.error('Export error:', error);
        showAlert('Failed to export data: ' + error.message, 'danger');
      }
    }

    function showBackupHistory() {
      showAlert('Backup history feature coming soon!', 'info');
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      const mainContent = currentRole === 'admin' ? document.getElementById('adminMainContent') : document.getElementById('studentMainContent');
      if (mainContent && mainContent.firstChild) {
        mainContent.insertBefore(alertDiv, mainContent.firstChild);
      } else if (mainContent) {
        mainContent.appendChild(alertDiv);
      } else {
        const loginCard = document.querySelector('.login-card');
        if (loginCard) {
          loginCard.insertBefore(alertDiv, loginCard.firstChild);
        }
      }
      
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function closeModal() {
      document.getElementById('operationModal').style.display = 'none';
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return 'N/A';
      }
    }

    function formatDateDDMMYYYY(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return 'N/A';
      }
    }

    function showConfirmationDialog(title, message, confirmCallback, cancelCallback) {
      const overlay = document.createElement('div');
      overlay.className = 'confirmation-overlay';
      
      const dialog = document.createElement('div');
      dialog.className = 'confirmation-dialog';
      dialog.innerHTML = `
        <h3 style="margin-bottom: 10px;">${title}</h3>
        <p style="color: #666; margin-bottom: 20px;">${message}</p>
        <div class="confirmation-buttons">
          <button class="btn btn-danger" onclick="window.confirmAction()">Confirm</button>
          <button class="btn btn-secondary" onclick="window.cancelAction()">Cancel</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      window.confirmAction = function() {
        if (confirmCallback) confirmCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
      
      window.cancelAction = function() {
        if (cancelCallback) cancelCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
    }

    function closeConfirmationDialog() {
      const overlay = document.querySelector('.confirmation-overlay');
      if (overlay) overlay.remove();
    }

    // Placeholder functions for unimplemented sections
    function showStudentsManagement() { showAlert('Students management page loading...', 'info'); }
    function showLeaveTypesManagement() { showAlert('Leave types management page loading...', 'info'); }
    function showCategoriesManagement() { showAlert('Categories management page loading...', 'info'); }
    function showYearCreditsManagement() { showAlert('Year credits management page loading...', 'info'); }
    function showLeaveEntryForm() { showAlert('Leave entry form loading...', 'info'); }
    function showBulkUpload() { showAlert('Bulk upload page loading...', 'info'); }
    function showReports() { showAlert('Reports page loading...', 'info'); }
    function showFilterSettings() { showAlert('Filter settings loading...', 'info'); }
    function clearAllFilters() { showAlert('Filters cleared', 'success'); }
    function approveLeave(appId) { showAlert('Approve feature - coming soon', 'info'); }
    function rejectLeave(appId) { showAlert('Reject feature - coming soon', 'info'); }
    function viewApplicationDetails(appId) { showAlert('View details - coming soon', 'info'); }
    function editLeaveApplication(appId) { showAlert('Edit application - coming soon', 'info'); }
    function deleteLeaveApplication(appId) { showAlert('Delete application - coming soon', 'info'); }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async function() {
      await loadFirebaseConfig();
      
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          if (currentRole === 'admin') {
            refreshAdminData();
          } else if (currentRole === 'student') {
            refreshStudentData();
          }
        }
        
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>