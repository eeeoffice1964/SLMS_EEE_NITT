<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Leave Management System - Firebase</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Add jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #17a2b8;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --admin-color: #8e44ad;
      --student-color: #16a085;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 2.2rem;
    }

    .role-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
    }

    .role-btn {
      padding: 18px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .role-btn i {
      font-size: 1.3rem;
    }

    .admin-btn {
      background: var(--admin-color);
      color: white;
    }

    .admin-btn:hover {
      background: #7d3c98;
      transform: translateY(-2px);
    }

    .student-btn {
      background: var(--student-color);
      color: white;
    }

    .student-btn:hover {
      background: #138a72;
      transform: translateY(-2px);
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #27ae60;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #e74c3c;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #f39c12;
    }

    .close-btn {
      margin-left: auto;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .dashboard-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      min-height: 90vh;
      display: none;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-right button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right button:hover {
      background: rgba(255,255,255,0.3);
    }

    .dashboard-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 0;
      min-height: calc(90vh - 100px);
    }

    .sidebar {
      background: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #e9ecef;
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .menu-btn {
      width: 100%;
      text-align: left;
      padding: 12px 15px;
      border: none;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--dark);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid transparent;
    }

    .menu-btn.active {
      background: var(--secondary);
      color: white;
      border-left-color: var(--primary);
    }

    .menu-btn:hover:not(.active) {
      background: #e9ecef;
      border-left-color: #adb5bd;
    }

    .main-content {
      padding: 25px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
      transition: opacity 0.3s ease;
    }

    .main-content.hidden {
      opacity: 0;
    }

    .main-content.visible {
      opacity: 1;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .card-header h2 {
      color: var(--primary);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #d6eaf8; color: #1a5276; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .offline-notice {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #f39c12;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 5px solid var(--secondary);
    }

    .stat-card h3 {
      color: var(--secondary);
      font-size: 2rem;
      margin: 5px 0;
    }

    .leave-balance-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .leave-balance-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border-top: 5px solid #3498db;
    }

    .leave-count {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .leave-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .refresh-btn {
      background: var(--info);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #138496;
      transform: rotate(180deg);
    }

    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .student-info-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--secondary);
    }

    .student-info-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ced4da;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 5px;
    }

    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s ease;
    }

    .search-result-item:hover {
      background: #f8f9fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-id {
      font-weight: 600;
      color: var(--primary);
    }

    .search-result-name {
      color: #666;
      font-size: 0.9rem;
    }

    .btn-pdf {
      background: #e74c3c;
      color: white;
    }

    .btn-pdf:hover {
      background: #c0392b;
    }

    .filters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .search-box {
      position: relative;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-box input {
      padding-left: 35px;
    }

    .backup-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .backup-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .backup-stat {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .backup-stat h3 {
      font-size: 2rem;
      margin: 10px 0;
    }

    .confirmation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .confirmation-dialog {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 400px;
      width: 90%;
    }

    .confirmation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .backup-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .backup-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backup-info h4 {
      margin-bottom: 5px;
    }

    .backup-meta {
      font-size: 0.85rem;
      color: #666;
    }

    .year-credit-actions {
      display: flex;
      gap: 5px;
    }

    .bulk-select-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .bulk-select-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .bulk-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    .file-upload-area {
      border: 2px dashed #3498db;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-area:hover {
      background: #e9ecef;
      border-color: #2980b9;
    }

    .file-upload-area.dragover {
      background: #d1ecf1;
      border-color: #17a2b8;
    }

    .file-preview {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 15px;
      padding: 10px;
      background: white;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      border-radius: 12px;
      color: white;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      border: 3px solid white;
    }

    .profile-info h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .profile-info p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .profile-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .profile-field {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .profile-field label {
      display: block;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .profile-field .value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
    }

    .edit-profile-btn {
      margin-top: 20px;
      padding: 15px 30px;
    }

    .security-rule-card {
      background: #f8f9fa;
      border-left: 4px solid var(--success);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .security-rule-card.warning {
      border-left-color: var(--warning);
    }

    .security-rule-card.danger {
      border-left-color: var(--danger);
    }

    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .rule-code {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.success {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }

    .status-indicator.error {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    .status-indicator.warning {
      background: var(--warning);
      box-shadow: 0 0 10px var(--warning);
    }

    .email-config-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .email-template-preview {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background: #f8f9fa;
      max-height: 300px;
      overflow-y: auto;
    }

    .template-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
    }

    .template-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .template-tab.active {
      color: var(--secondary);
      border-bottom: 3px solid var(--secondary);
      background: #e8f4fd;
    }

    .template-tab:hover:not(.active) {
      background: #f8f9fa;
      color: var(--dark);
    }

    @media (max-width: 768px) {
      .dashboard-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .login-card {
        padding: 25px;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .header-right {
        flex-direction: column;
        align-items: flex-end;
      }
      
      .filters-container {
        grid-template-columns: 1fr;
      }
      
      .confirmation-dialog {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <div class="login-card">
      <h1><i class="fas fa-graduation-cap"></i> Leave Management System</h1>
      <p style="color: #666; margin-bottom: 20px;">Version 5.0 | Enhanced Email Notifications</p>
      
      <div class="role-selector">
        <button onclick="showAdminLoginForm()" class="role-btn admin-btn">
          <i class="fas fa-user-shield"></i> Admin Login
        </button>
        <button onclick="showStudentLoginForm()" class="role-btn student-btn">
          <i class="fas fa-user-graduate"></i> Student Login
        </button>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: #666; font-size: 0.9rem;">
          <i class="fas fa-shield-alt"></i> Secure Authentication System
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        <p>Welcome, <span id="adminName">Administrator</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="firebaseStatusBadge">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshAdminData()" title="Refresh Data" id="adminRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showAdminProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="showEmailConfig()">
          <i class="fas fa-envelope"></i> Email Config
        </button>
        <button onclick="logout('admin')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showAdminSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('students')">
            <i class="fas fa-user-graduate"></i> Students
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveTypes')">
            <i class="fas fa-list-alt"></i> Leave Types
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('categories')">
            <i class="fas fa-users-cog"></i> Categories
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('yearCredits')">
            <i class="fas fa-calendar-alt"></i> Year Credits
          </button></li>
          <li><button class="menu-btn" onclick="showLeaveEntryForm()">
            <i class="fas fa-file-signature"></i> Enter Leave Request
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveApprovals')">
            <i class="fas fa-check-circle"></i> Leave Approvals
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveHistory')">
            <i class="fas fa-history"></i> Leave History
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('bulkUpload')">
            <i class="fas fa-file-upload"></i> Bulk Upload
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('reports')">
            <i class="fas fa-chart-bar"></i> Reports
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('backup')">
            <i class="fas fa-database"></i> Backup & Restore
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('firebaseConfig')">
            <i class="fas fa-fire"></i> Firebase Config
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('systemSettings')">
            <i class="fas fa-cogs"></i> System Settings
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="adminMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Student Dashboard -->
  <div id="studentDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-graduate"></i> Student Dashboard</h1>
        <p>Welcome, <span id="studentName">Student</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="studentFirebaseStatus">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshStudentData()" title="Refresh Data" id="studentRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showStudentProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="logout('student')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showStudentSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveBalance')">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveHistory')">
            <i class="fas fa-history"></i> My Leave History
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="studentMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal for Operations -->
  <div id="operationModal" class="modal"></div>

  <script>
    // ==================== GLOBAL VARIABLES ====================
    let firebaseInitialized = false;
    let currentUser = null;
    let currentRole = null;
    let currentStudent = null;
    let refreshInterval = null;
    let selectedStudentInfo = null;
    
    let currentReportData = null;
    let currentReportType = null;
    let currentFromDate = null;
    let currentToDate = null;
    let allStudents = [];
    let selectedStudents = new Set();
    let currentFilters = {
      search: '',
      category: '',
      year: '',
      semester: '',
      specialization: ''
    };

    let filterStates = {
      students: {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      },
      leaveHistory: {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      },
      leaveApprovals: {
        search: '',
        studentId: '',
        leaveType: ''
      },
      reports: {
        fromDate: '',
        toDate: '',
        reportType: 'all'
      }
    };

    const DEFAULT_ADMIN_EMAIL = 'admin@leavemanagement.com';
    const DEFAULT_ADMIN_PASSWORD = 'Admin@123';

    const SETTINGS_COLLECTION = 'systemSettings';
    const FILTERS_COLLECTION = 'userFilters';
    const BACKUP_COLLECTION = 'systemBackups';

    // ==================== FIREBASE STORAGE UTILITIES ====================
    
    async function saveSetting(key, value, userId = 'system') {
      try {
        if (firebase.apps.length === 0) return false;
        
        const db = firebase.firestore();
        const settingRef = db.collection(SETTINGS_COLLECTION).doc(key);
        
        await settingRef.set({
          key: key,
          value: value,
          updatedAt: new Date().toISOString(),
          updatedBy: userId
        }, { merge: true });
        
        return true;
      } catch (error) {
        console.error('Error saving setting:', error);
        return false;
      }
    }

    async function getSetting(key, defaultValue = null) {
      try {
        if (firebase.apps.length === 0) return defaultValue;
        
        const db = firebase.firestore();
        const settingDoc = await db.collection(SETTINGS_COLLECTION).doc(key).get();
        
        if (settingDoc.exists) {
          return settingDoc.data().value;
        }
        return defaultValue;
      } catch (error) {
        console.error('Error getting setting:', error);
        return defaultValue;
      }
    }

    async function saveUserFilter(userId, section, filters) {
      try {
        if (firebase.apps.length === 0 || !userId) return false;
        
        const db = firebase.firestore();
        const filterRef = db.collection(FILTERS_COLLECTION).doc(`${userId}_${section}`);
        
        await filterRef.set({
          userId: userId,
          section: section,
          filters: filters,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        return true;
      } catch (error) {
        console.error('Error saving filter:', error);
        return false;
      }
    }

    async function loadUserFilter(userId, section, defaultFilters) {
      try {
        if (firebase.apps.length === 0 || !userId) return defaultFilters;
        
        const db = firebase.firestore();
        const filterDoc = await db.collection(FILTERS_COLLECTION).doc(`${userId}_${section}`).get();
        
        if (filterDoc.exists) {
          return filterDoc.data().filters || defaultFilters;
        }
        return defaultFilters;
      } catch (error) {
        console.error('Error loading filter:', error);
        return defaultFilters;
      }
    }

    async function saveGoogleAppsScriptUrl(url) {
      return await saveSetting('googleAppsScriptUrl', url, currentUser?.uid || 'system');
    }

    async function loadGoogleAppsScriptUrl() {
      return await getSetting('googleAppsScriptUrl', '');
    }

    async function saveFirebaseConfigToFirestore(config) {
      return await saveSetting('firebaseConfig', config, currentUser?.uid || 'system');
    }

    async function loadFirebaseConfigFromFirestore() {
      return await getSetting('firebaseConfig', null);
    }

    async function saveBackupTimestamp(timestamp) {
      return await saveSetting('lastBackupTimestamp', timestamp, currentUser?.uid || 'system');
    }

    async function loadBackupTimestamp() {
      return await getSetting('lastBackupTimestamp', null);
    }

    async function saveFilterState(section, filters) {
      filterStates[section] = { ...filters };
      
      if (currentUser?.uid) {
        await saveUserFilter(currentUser.uid, section, filters);
      }
    }

    async function loadFilterState(section) {
      if (currentUser?.uid) {
        const saved = await loadUserFilter(currentUser.uid, section, filterStates[section]);
        filterStates[section] = saved;
      }
      return filterStates[section];
    }

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase(config) {
      try {
        if (firebase.apps.length > 0) {
          return { success: true, message: 'Firebase already initialized' };
        }
        
        firebase.initializeApp(config);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        firebase.firestore().enablePersistence()
          .catch((err) => {
            console.warn('Firebase persistence error:', err);
          });
        
        firebaseInitialized = true;
        updateFirebaseStatusBadges(true);
        
        return { success: true };
      } catch (error) {
        console.error('Firebase initialization error:', error);
        updateFirebaseStatusBadges(false);
        return { success: false, error: error.message };
      }
    }

    function updateFirebaseStatusBadges(isConnected) {
      const adminBadge = document.getElementById('firebaseStatusBadge');
      const studentBadge = document.getElementById('studentFirebaseStatus');
      
      if (adminBadge) {
        adminBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        adminBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
      
      if (studentBadge) {
        studentBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        studentBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
    }

    async function loadFirebaseConfig() {
      const firestoreConfig = await loadFirebaseConfigFromFirestore();
      
      if (firestoreConfig) {
        try {
          const result = initializeFirebase(firestoreConfig);
          if (result.success) {
            console.log('Firebase initialized from Firestore config');
            await loadGoogleAppsScriptUrlFromFirestore();
            return;
          }
        } catch (error) {
          console.error('Failed to load Firebase config from Firestore:', error);
        }
      }
      
      const savedConfig = localStorage.getItem('firebaseConfig');
      if (savedConfig) {
        try {
          const config = JSON.parse(savedConfig);
          const result = initializeFirebase(config);
          if (result.success) {
            console.log('Firebase initialized from localStorage config');
          }
        } catch (error) {
          console.error('Failed to load saved Firebase config:', error);
        }
      }
    }

    async function loadGoogleAppsScriptUrlFromFirestore() {
      const url = await loadGoogleAppsScriptUrl();
      if (url) {
        window.GOOGLE_APPS_SCRIPT_URL = url;
      }
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    function showAdminLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
          <form onsubmit="adminLogin(event)">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="adminEmail" required 
                     placeholder="Enter your registered email">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" class="form-control" id="adminPassword" required 
                     placeholder="Enter your password">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
              <button type="button" class="btn btn-link" onclick="showForgotPasswordModal()" 
                      style="color: var(--secondary); padding: 0; background: none; border: none; cursor: pointer;">
                <i class="fas fa-key"></i> Forgot Password?
              </button>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;" id="adminLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function adminLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      
      const loginBtn = document.getElementById('adminLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Verifying...';
      loginBtn.disabled = true;
      
      try {
        const firestoreConfig = await loadFirebaseConfigFromFirestore();
        const localStorageConfig = localStorage.getItem('firebaseConfig');
        const isFirebaseConfigured = firestoreConfig !== null || localStorageConfig !== null;
        
        if (!isFirebaseConfigured) {
          if (email === DEFAULT_ADMIN_EMAIL && password === DEFAULT_ADMIN_PASSWORD) {
            currentUser = {
              uid: 'default-admin',
              email: DEFAULT_ADMIN_EMAIL,
              name: 'Administrator',
              role: 'admin'
            };
            currentRole = 'admin';
            
            showAlert('Welcome, Administrator! Please configure Firebase to continue.', 'info');
            closeModal();
            showAdminDashboard();
            
            setTimeout(() => {
              showFirebaseConfigPanel();
            }, 500);
            
            return;
          } else {
            showAlert('Invalid credentials. First-time login requires default credentials.', 'danger');
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
            return;
          }
        }
        
        if (firebase.apps.length === 0) {
          showAlert('Firebase configuration error. Please reconfigure.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        
        const adminDoc = await firebase.firestore().collection('admins').doc(userCredential.user.uid).get();
        
        if (adminDoc.exists) {
          currentUser = {
            uid: userCredential.user.uid,
            email: userCredential.user.email,
            name: adminDoc.data().name || 'Administrator',
            role: 'admin'
          };
          currentRole = 'admin';
          
          await loadUserSettings();
          
          showAlert('Welcome back, Administrator!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        } else {
          await firebase.firestore().collection('admins').doc(userCredential.user.uid).set({
            email: email,
            name: email.split('@')[0],
            role: 'admin',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          
          currentUser = {
            uid: userCredential.user.uid,
            email: email,
            name: email.split('@')[0],
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Admin account created! Welcome!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        }
        
      } catch (error) {
        console.error('Admin login error:', error);
        
        switch(error.code) {
          case 'auth/user-not-found':
            showAlert('No account found with this email. Please contact administrator.', 'danger');
            break;
          case 'auth/wrong-password':
            showAlert('Incorrect password. Please try again or use "Forgot Password".', 'danger');
            break;
          case 'auth/invalid-email':
            showAlert('Invalid email format.', 'danger');
            break;
          case 'auth/user-disabled':
            showAlert('This account has been disabled. Contact administrator.', 'danger');
            break;
          case 'auth/too-many-requests':
            showAlert('Too many failed attempts. Please try again later.', 'danger');
            break;
          case 'auth/network-request-failed':
            showAlert('Network error. Please check your connection.', 'danger');
            break;
          default:
            showAlert('Login failed: ' + error.message, 'danger');
        }
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    async function loadUserSettings() {
      if (!currentUser?.uid) return;
      
      filterStates.students = await loadUserFilter(currentUser.uid, 'students', filterStates.students);
      filterStates.leaveHistory = await loadUserFilter(currentUser.uid, 'leaveHistory', filterStates.leaveHistory);
      filterStates.leaveApprovals = await loadUserFilter(currentUser.uid, 'leaveApprovals', filterStates.leaveApprovals);
      filterStates.reports = await loadUserFilter(currentUser.uid, 'reports', filterStates.reports);
      
      window.GOOGLE_APPS_SCRIPT_URL = await loadGoogleAppsScriptUrl();
    }

    // ==================== FORGOT PASSWORD FUNCTIONS ====================
    function showForgotPasswordModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-key"></i> Reset Password</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your registered admin email address. We'll check if it exists in our system before sending a reset link.
          </div>
          
          <form onsubmit="sendPasswordResetEmail(event)">
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" class="form-control" id="resetEmail" required 
                     placeholder="Enter your admin email">
            </div>
            
            <div id="resetStatus" style="margin-bottom: 15px;"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;" id="sendResetBtn">
                <i class="fas fa-paper-plane"></i> Send Reset Link
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
          
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
            <p style="color: #666; font-size: 0.9rem;">
              <i class="fas fa-clock"></i> Reset link expires in 1 hour
            </p>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function sendPasswordResetEmail(event) {
      event.preventDefault();
      
      const email = document.getElementById('resetEmail').value.trim();
      const sendBtn = document.getElementById('sendResetBtn');
      const resetStatus = document.getElementById('resetStatus');
      
      sendBtn.innerHTML = '<div class="loading-spinner"></div> Verifying email...';
      sendBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          if (email === DEFAULT_ADMIN_EMAIL) {
            resetStatus.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <strong>Default Admin Account</strong>
                  <p>You're using the default admin account. Please configure Firebase first to enable password reset functionality.</p>
                </div>
              </div>
            `;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
            sendBtn.disabled = false;
            return;
          } else {
            resetStatus.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                  <strong>Email Not Found</strong>
                  <p>The email "${email}" is not registered as an admin.</p>
                </div>
              </div>
            `;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
            sendBtn.disabled = false;
            return;
          }
        }
        
        const db = firebase.firestore();
        const adminsSnapshot = await db.collection('admins')
          .where('email', '==', email)
          .get();
        
        if (adminsSnapshot.empty) {
          resetStatus.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Email Not Found</strong>
                <p>The email "${email}" is not registered as an admin in our system.</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">Please check the email or contact system administrator.</p>
              </div>
            </div>
          `;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
          sendBtn.disabled = false;
          return;
        }
        
        await firebase.auth().sendPasswordResetEmail(email, {
          url: window.location.href,
          handleCodeInApp: false
        });
        
        resetStatus.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>Reset Email Sent!</strong>
              <p>Password reset instructions have been sent to <strong>${email}</strong>.</p>
              <p style="margin-top: 10px; font-size: 0.9rem;">Please check your inbox (and spam folder).</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-check"></i> Email Sent';
        
        setTimeout(() => {
          closeModal();
        }, 5000);
        
      } catch (error) {
        console.error('Password reset error:', error);
        
        let errorMessage = '';
        let errorTitle = 'Failed to Send Reset Email';
        
        switch(error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email address.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email format. Please enter a valid email address.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many reset attempts. Please try again later.';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your internet connection.';
            break;
          case 'auth/internal-error':
            errorMessage = 'Internal error occurred. Please try again.';
            break;
          default:
            errorMessage = error.message;
        }
        
        resetStatus.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <strong>${errorTitle}</strong>
              <p>${errorMessage}</p>
              <p style="margin-top: 10px; font-size: 0.9rem;">Please try again or contact system administrator.</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
        sendBtn.disabled = false;
      }
    }

    async function checkAdminEmailExists(email) {
      try {
        if (firebase.apps.length === 0) {
          return email === DEFAULT_ADMIN_EMAIL;
        }
        
        const db = firebase.firestore();
        const adminsSnapshot = await db.collection('admins')
          .where('email', '==', email)
          .get();
        
        return !adminsSnapshot.empty;
      } catch (error) {
        console.error('Error checking admin email:', error);
        return false;
      }
    }

    function showStudentLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-graduate"></i> Student Login</h2>
          <form onsubmit="studentLogin(event)">
            <div class="form-group">
              <label>Student ID / Roll Number</label>
              <input type="text" class="form-control" id="studentIdInput" placeholder="Enter your student ID" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="studentLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function studentLogin(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('studentIdInput').value.trim();
      
      const loginBtn = document.getElementById('studentLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
      loginBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured. Please contact administrator.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentsRef = firebase.firestore().collection('students');
        const snapshot = await studentsRef.where('ID', '==', studentId).limit(1).get();
        
        if (snapshot.empty) {
          showAlert('Student not found with this ID', 'danger');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentDoc = snapshot.docs[0];
        const studentData = studentDoc.data();
        
        currentUser = {
          uid: studentDoc.id,
          ...studentData,
          id: studentData.ID
        };
        currentRole = 'student';
        currentStudent = currentUser;
        
        await loadUserSettings();
        
        showAlert(`Welcome, ${studentData.Name}!`, 'success');
        closeModal();
        showStudentDashboard();
        startAutoRefresh();
        
      } catch (error) {
        console.error('Student login error:', error);
        showAlert('Login failed: ' + error.message, 'danger');
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function showAdminDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('studentDashboard').style.display = 'none';
      
      if (currentUser) {
        document.getElementById('adminName').textContent = currentUser.name || 'Administrator';
      }
      
      showAdminSection('dashboard');
    }

    function showStudentDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'block';
      
      if (currentUser) {
        document.getElementById('studentName').textContent = currentUser.name || 'Student';
      }
      
      showStudentSection('dashboard');
    }

    async function logout(role) {
      stopAutoRefresh();
      
      try {
        if (firebase.apps.length > 0 && firebase.auth().currentUser) {
          await firebase.auth().signOut();
        }
      } catch (error) {
        console.error('Firebase signout error:', error);
      }
      
      currentUser = null;
      currentRole = null;
      currentStudent = null;
      selectedStudentInfo = null;
      selectedStudents.clear();
      
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      
      showAlert('Logged out successfully', 'info');
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshInterval = setInterval(() => {
        if (currentRole === 'admin') {
          refreshAdminData(true);
        } else if (currentRole === 'student') {
          refreshStudentData(true);
        }
      }, 30000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function refreshAdminData(silent = false) {
      const refreshBtn = document.getElementById('adminRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#adminDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getAdminSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('admin', () => {
            showAdminSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function refreshStudentData(silent = false) {
      const refreshBtn = document.getElementById('studentRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#studentDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getStudentSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('student', () => {
            showStudentSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function smoothRefresh(role, callback) {
      const contentDiv = document.getElementById(role === 'admin' ? 'adminMainContent' : 'studentMainContent');
      if (contentDiv) {
        contentDiv.classList.add('hidden');
        
        setTimeout(() => {
          if (callback) callback();
          setTimeout(() => {
            contentDiv.classList.remove('hidden');
            contentDiv.classList.add('visible');
          }, 50);
        }, 300);
      } else {
        if (callback) callback();
      }
    }

    function getAdminSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-user-graduate')) return 'students';
      if (icon.classList.contains('fa-list-alt')) return 'leaveTypes';
      if (icon.classList.contains('fa-users-cog')) return 'categories';
      if (icon.classList.contains('fa-calendar-alt')) return 'yearCredits';
      if (icon.classList.contains('fa-check-circle')) return 'leaveApprovals';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      if (icon.classList.contains('fa-file-upload')) return 'bulkUpload';
      if (icon.classList.contains('fa-chart-bar')) return 'reports';
      if (icon.classList.contains('fa-database')) return 'backup';
      if (icon.classList.contains('fa-fire')) return 'firebaseConfig';
      if (icon.classList.contains('fa-cogs')) return 'systemSettings';
      return 'dashboard';
    }

    function getStudentSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-chart-pie')) return 'leaveBalance';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      return 'dashboard';
    }

    function showAdminSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#adminDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showAdminDashboardHome();
          break;
        case 'students':
          showStudentsManagement();
          break;
        case 'leaveTypes':
          showLeaveTypesManagement();
          break;
        case 'categories':
          showCategoriesManagement();
          break;
        case 'yearCredits':
          showYearCreditsManagement();
          break;
        case 'leaveApprovals':
          showLeaveApprovals();
          break;
        case 'leaveHistory':
          showLeaveHistory();
          break;
        case 'bulkUpload':
          showBulkUpload();
          break;
        case 'reports':
          showReports();
          break;
        case 'backup':
          showBackupManagement();
          break;
        case 'firebaseConfig':
          showFirebaseConfigPanel();
          break;
        case 'systemSettings':
          showSystemSettings();
          break;
      }
    }

    function showStudentSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#studentDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showStudentDashboardHome();
          break;
        case 'leaveBalance':
          showStudentLeaveBalance();
          break;
        case 'leaveHistory':
          showStudentLeaveHistory();
          break;
      }
    }

    // ==================== ADMIN DASHBOARD HOME ====================
    function showAdminDashboardHome() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 30px;">
              <h3>Quick Overview</h3>
              <div class="stats-grid" id="adminStats">
                <div class="stat-card">
                  <h3 id="totalStudents">0</h3>
                  <p>Total Students</p>
                </div>
                <div class="stat-card">
                  <h3 id="pendingApplications">0</h3>
                  <p>Pending Applications</p>
                </div>
                <div class="stat-card">
                  <h3 id="approvedApplications">0</h3>
                  <p>Approved Applications</p>
                </div>
                <div class="stat-card">
                  <h3 id="rejectedApplications">0</h3>
                  <p>Rejected Applications</p>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3>Quick Actions</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <button class="btn btn-primary" onclick="showLeaveEntryForm()">
                  <i class="fas fa-file-signature"></i> Enter Leave Request
                </button>
                <button class="btn btn-success" onclick="showAdminSection('students')">
                  <i class="fas fa-user-graduate"></i> Manage Students
                </button>
                <button class="btn btn-info" onclick="showAdminSection('leaveApprovals')">
                  <i class="fas fa-check-circle"></i> Pending Approvals
                </button>
                <button class="btn btn-warning" onclick="showAdminSection('reports')">
                  <i class="fas fa-chart-bar"></i> Generate Report
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadAdminStats();
    }

    async function loadAdminStats() {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        const pending = applications.filter(app => app.Status === 'pending').length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const rejected = applications.filter(app => app.Status === 'rejected').length;
        
        document.getElementById('totalStudents').textContent = studentsSnapshot.size;
        document.getElementById('pendingApplications').textContent = pending;
        document.getElementById('approvedApplications').textContent = approved;
        document.getElementById('rejectedApplications').textContent = rejected;
        
      } catch (error) {
        console.error('Load admin stats error:', error);
      }
    }

    // ==================== SYSTEM SETTINGS ====================
    function showSystemSettings() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-cogs"></i> System Settings</h2>
          </div>
          
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              All settings are now stored in Firebase Firestore instead of localStorage.
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
              <div class="card">
                <h3><i class="fas fa-fire"></i> Firebase Configuration</h3>
                <p>Your Firebase configuration is now stored securely in Firestore.</p>
                <button class="btn btn-primary" onclick="showFirebaseConfigPanel()">
                  <i class="fas fa-cog"></i> Configure
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-envelope"></i> Email Settings</h3>
                <p>Email configuration is stored in Firestore for all users.</p>
                <button class="btn btn-primary" onclick="showEmailConfig()">
                  <i class="fas fa-cog"></i> Configure
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-filter"></i> User Filters</h3>
                <p>User filter preferences are stored per user in Firestore.</p>
                <button class="btn btn-primary" onclick="showFilterSettings()">
                  <i class="fas fa-eye"></i> View Filters
                </button>
              </div>
              
              <div class="card">
                <h3><i class="fas fa-database"></i> Backup History</h3>
                <p>Backup timestamps are stored in Firestore.</p>
                <button class="btn btn-primary" onclick="showBackupHistory()">
                  <i class="fas fa-history"></i> View History
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showFilterSettings() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-filter"></i> User Filter Settings</h2>
          
          <div style="margin: 20px 0;">
            <h3>Current Filter States (Firestore Stored)</h3>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">
              ${JSON.stringify(filterStates, null, 2)}
            </pre>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-danger" onclick="clearAllFilters()">
              <i class="fas fa-trash"></i> Clear All Filters
            </button>
            <button class="btn btn-secondary" onclick="closeModal()">
              Close
            </button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function clearAllFilters() {
      if (!currentUser?.uid) return;
      
      showConfirmationDialog(
        "Clear All Filters",
        "Are you sure you want to clear all your saved filter preferences?",
        async () => {
          try {
            const db = firebase.firestore();
            const filtersRef = db.collection(FILTERS_COLLECTION);
            const snapshot = await filtersRef.where('userId', '==', currentUser.uid).get();
            
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
            
            filterStates = {
              students: { search: '', category: '', year: '', semester: '', specialization: '' },
              leaveHistory: { search: '', status: '', leaveType: '', studentId: '' },
              leaveApprovals: { search: '', studentId: '', leaveType: '' },
              reports: { fromDate: '', toDate: '', reportType: 'all' }
            };
            
            showAlert('All filters cleared successfully!', 'success');
            closeModal();
            
          } catch (error) {
            console.error('Error clearing filters:', error);
            showAlert('Failed to clear filters: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== ENHANCED EMAIL CONFIGURATION ====================
    async function showEmailConfig() {
      const modal = document.getElementById('operationModal');
      const savedUrl = await loadGoogleAppsScriptUrl() || '';
      
      const appsScriptCode = `// Google Apps Script for Leave Management System Email Notifications
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    
    const to_email = params.to_email;
    const to_name = params.to_name;
    const student_id = params.student_id;
    const application_id = params.application_id;
    const leave_type = params.leave_type;
    const from_date = params.from_date;
    const to_date = params.to_date;
    const days = params.days;
    const reason = params.reason;
    const status = params.status;
    const action = params.action;
    const approved_by = params.approved_by || 'Admin';
    const approved_date = params.approved_date;
    const category_year = params.category_year || '';
    const html_content = params.html_content;
    
    let subject = '';
    if (action === 'approved') {
      subject = 'Leave Application Approved - ' + application_id;
    } else if (action === 'updated') {
      subject = 'Leave Application Updated & Approved - ' + application_id;
    } else if (action === 'multiple-changes') {
      subject = 'Leave Application Updated with Changes - ' + application_id;
    } else if (action === 'rejected') {
      subject = 'Leave Application Rejected - ' + application_id;
    } else {
      subject = 'Leave Application Status Update - ' + application_id;
    }
    
    MailApp.sendEmail({
      to: to_email,
      subject: subject,
      htmlBody: html_content
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: true, message: 'Email sent successfully' }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet() {
  return ContentService
    .createTextOutput('Leave Management System Email Service is running!')
    .setMimeType(ContentService.MimeType.TEXT);
}`;
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-envelope"></i> Email Configuration</h2>
          
          <div class="email-config-card">
            <h3 style="margin-top: 0;">Google Apps Script Configuration</h3>
            <p>Configure your Google Apps Script URL to enable email notifications. This will be stored in Firestore.</p>
          </div>
          
          <form onsubmit="saveEmailConfig(event)">
            <div class="form-group">
              <label>Google Apps Script URL <span style="color: red;">*</span></label>
              <input type="url" class="form-control" id="appsScriptUrl" 
                     placeholder="https://script.google.com/macros/s/your-script-id/exec"
                     value="${savedUrl}" required>
              <small style="color: #666;">Paste your deployed Google Apps Script web app URL here</small>
            </div>
            
            <div class="alert alert-info" style="margin: 20px 0;">
              <i class="fas fa-info-circle"></i>
              <strong>Email Service Status:</strong> 
              ${savedUrl ? 
                '<span class="badge badge-success">Configured in Firestore</span>' : 
                '<span class="badge badge-danger">Not Configured</span>'}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Configuration
              </button>
              <button type="button" class="btn btn-primary" onclick="testEmailConfiguration()" style="flex: 1;">
                <i class="fas fa-paper-plane"></i> Test Email
              </button>
            </div>
          </form>
          
          <div style="margin-top: 30px;">
            <h3>Google Apps Script Code</h3>
            <p>Copy and paste this code into your Google Apps Script project:</p>
            <div class="rule-code" style="max-height: 300px; overflow-y: auto;">
              <pre style="white-space: pre-wrap;">${appsScriptCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            </div>
            <div style="margin-top: 10px;">
              <button class="btn btn-sm btn-info" onclick="copyAppsScriptCode()">
                <i class="fas fa-copy"></i> Copy Code
              </button>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h3>Email Templates Preview</h3>
            <div class="template-tabs">
              <button class="template-tab active" onclick="showTemplatePreview('approved')">Approved</button>
              <button class="template-tab" onclick="showTemplatePreview('updated')">Updated & Approved</button>
              <button class="template-tab" onclick="showTemplatePreview('multiple')">With Multiple Changes</button>
            </div>
            
            <div id="templatePreview" class="email-template-preview">
              ${generateApprovedEmailHTML({
                to_name: 'John Doe',
                application_id: 'LA-2024-0123',
                student_id: '2024001',
                leave_type: 'Medical Leave',
                from_date: '15/03/2024',
                to_date: '18/03/2024',
                days: '4',
                reason: 'Family function',
                approved_date: '14/03/2024',
                category_year: 'M.Tech - 1st Year'
              })}
            </div>
          </div>
          
          <div class="alert alert-info" style="margin-top: 20px;">
            <i class="fas fa-code"></i>
            <div>
              <strong>Setup Instructions:</strong>
              <ol style="margin-top: 10px; margin-left: 20px;">
                <li>Go to <a href="https://script.google.com" target="_blank">script.google.com</a> and create a new project</li>
                <li>Paste the provided Apps Script code (see above)</li>
                <li>Save the project and click on "Deploy"  "New deployment"</li>
                <li>Select type: "Web app"</li>
                <li>Set "Execute as" to "Me" and "Who has access" to "Anyone"</li>
                <li>Click "Deploy" and copy the generated URL</li>
                <li>Paste the URL in the field above and save</li>
              </ol>
            </div>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
      
      window.showTemplatePreview = function(templateType) {
        const tabs = document.querySelectorAll('.template-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        
        const previewDiv = document.getElementById('templatePreview');
        let previewHTML = '';
        
        switch(templateType) {
          case 'approved':
            previewHTML = generateApprovedEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Medical Leave',
              from_date: '15/03/2024',
              to_date: '18/03/2024',
              days: '4',
              reason: 'Family function',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year'
            });
            break;
          case 'updated':
            previewHTML = generateUpdatedApprovedEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Casual Leave',
              from_date: '20/03/2024',
              to_date: '22/03/2024',
              days: '3',
              reason: 'Family function',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year',
              old_from_date: '15/03/2024',
              old_to_date: '18/03/2024',
              old_days: '4'
            });
            break;
          case 'multiple':
            previewHTML = generateMultipleChangesEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Medical Leave',
              from_date: '20/03/2024',
              to_date: '22/03/2024',
              days: '3',
              reason: 'Medical appointment with doctor',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year',
              changes: {
                'From Date': { old: '15/03/2024', new: '20/03/2024' },
                'To Date': { old: '18/03/2024', new: '22/03/2024' },
                'Number of Days': { old: '4', new: '3' },
                'Reason': { old: 'Family function', new: 'Medical appointment with doctor' }
              }
            });
            break;
        }
        
        previewDiv.innerHTML = previewHTML;
      };
      
      window.copyAppsScriptCode = function() {
        navigator.clipboard.writeText(appsScriptCode).then(() => {
          showAlert('Code copied to clipboard!', 'success');
        }).catch(err => {
          showAlert('Failed to copy code', 'danger');
        });
      };
    }

    async function saveEmailConfig(event) {
      event.preventDefault();
      
      const url = document.getElementById('appsScriptUrl').value.trim();
      
      if (!url) {
        showAlert('Please enter a valid Google Apps Script URL', 'warning');
        return;
      }
      
      const success = await saveGoogleAppsScriptUrl(url);
      
      if (success) {
        window.GOOGLE_APPS_SCRIPT_URL = url;
        showAlert('Email configuration saved to Firestore successfully!', 'success');
        setTimeout(() => {
          closeModal();
        }, 1500);
      } else {
        showAlert('Failed to save configuration to Firestore', 'danger');
      }
    }

    async function testEmailConfiguration() {
      const url = await loadGoogleAppsScriptUrl();
      
      if (!url) {
        showAlert('Please save email configuration first', 'warning');
        return;
      }
      
      if (!currentUser || !currentUser.email) {
        showAlert('No admin email found for testing', 'warning');
        return;
      }
      
      try {
        showAlert('Sending test email...', 'info');
        
        const testParams = {
          to_email: currentUser.email,
          to_name: currentUser.name || 'Administrator',
          student_id: 'TEST001',
          application_id: 'TEST-001',
          leave_type: 'Test Leave',
          from_date: formatDateDDMMYYYY(new Date().toISOString()),
          to_date: formatDateDDMMYYYY(new Date().toISOString()),
          days: '1',
          reason: 'This is a test email from the Leave Management System',
          status: 'approved',
          action: 'approved',
          approved_by: 'System',
          approved_date: formatDateDDMMYYYY(new Date().toISOString()),
          category_year: 'Test Category - Test Year',
          html_content: generateApprovedEmailHTML({
            to_name: 'Administrator',
            application_id: 'TEST-001',
            student_id: 'TEST001',
            leave_type: 'Test Leave',
            from_date: formatDateDDMMYYYY(new Date().toISOString()),
            to_date: formatDateDDMMYYYY(new Date().toISOString()),
            days: '1',
            reason: 'This is a test email from the Leave Management System',
            approved_date: formatDateDDMMYYYY(new Date().toISOString()),
            category_year: 'Test Category - Test Year'
          })
        };
        
        const response = await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testParams)
        });
        
        showAlert('Test email sent! Please check your inbox.', 'success');
        
      } catch (error) {
        console.error('Test email error:', error);
        showAlert('Failed to send test email: ' + error.message, 'danger');
      }
    }

    function generateApprovedEmailHTML(params) {
      return `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
                .header { background: #4a6fa5; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .details { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #4CAF50; margin: 15px 0; }
                table { width: 100%; border-collapse: collapse; }
                td { padding: 10px; border-bottom: 1px solid #eee; }
                .label { font-weight: bold; width: 40%; }
                .instructions { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #2196F3; }
                .footer { background: #f1f1f1; padding: 15px; text-align: center; font-size: 12px; color: #666; }
                .status-approved { color: #28a745; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2 style="margin: 0;">Student Leave Management System</h2>
                <h3 style="margin: 10px 0 0 0;">Leave Application Approved</h3>
            </div>
            
            <div class="content">
                <p>Dear <strong>${params.to_name}</strong>,</p>
                <p>Your leave application has been <strong style="color: #28a745;">APPROVED</strong>. Below are the details:</p>
                
                <div class="details">
                    <table>
                        <tr>
                            <td class="label">Application ID:</td>
                            <td><strong>${params.application_id}</strong></td>
                        </tr>
                        <tr>
                            <td class="label">Student ID:</td>
                            <td>${params.student_id}</td>
                        </tr>
                        <tr>
                            <td class="label">Student Name:</td>
                            <td>${params.to_name}</td>
                        </tr>
                        <tr>
                            <td class="label">Category/Year:</td>
                            <td>${params.category_year || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td class="label">Leave Type:</td>
                            <td>${params.leave_type}</td>
                        </tr>
                        <tr>
                            <td class="label">From Date:</td>
                            <td>${params.from_date}</td>
                        </tr>
                        <tr>
                            <td class="label">To Date:</td>
                            <td>${params.to_date}</td>
                        </tr>
                        <tr>
                            <td class="label">Number of Days:</td>
                            <td>${params.days}</td>
                        </tr>
                        <tr>
                            <td class="label">Reason:</td>
                            <td>${params.reason}</td>
                        </tr>
                        <tr>
                            <td class="label">Approved Date:</td>
                            <td>${params.approved_date}</td>
                        </tr>
                        <tr>
                            <td class="label">Status:</td>
                            <td class="status-approved">APPROVED</td>
                        </tr>
                    </table>
                </div>
                
                <div class="instructions">
                    <p style="margin: 0;"><strong>Important Instructions for Student:</strong></p>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>Please Collect one office copy (OC) for your reference about your approved leave</li>
                        <li>Keep this approval email for your records</li>
                        <li>Contact your department if you have any questions</li>
                        <li>Please go through the Instructions on Attendance, Leave, and TA Procedures Circular Date: 05.02.2026</li>
                    </ul>
                </div>
                
                <p>Best regards,<br>
                <strong>Student Leave Management System Administration</strong></p>
            </div>
            
            <div class="footer">
                <p style="margin: 0;">This is an automated email. Please do not reply to this message.</p>
                <p style="margin: 5px 0 0 0;">System Version: 5.0</p>
            </div>
        </body>
        </html>
      `;
    }

    function generateUpdatedApprovedEmailHTML(params) {
      return `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
                .header { background: #4a6fa5; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .details { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #4CAF50; margin: 15px 0; }
                table { width: 100%; border-collapse: collapse; }
                td { padding: 10px; border-bottom: 1px solid #eee; }
                .label { font-weight: bold; width: 40%; }
                .instructions { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #2196F3; }
                .footer { background: #f1f1f1; padding: 15px; text-align: center; font-size: 12px; color: #666; }
                .status-updated { color: #ff9800; font-weight: bold; }
                .old-value { text-decoration: line-through; color: #999; margin-right: 10px; }
                .new-value { color: #28a745; font-weight: bold; }
                .note { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2 style="margin: 0;">Student Leave Management System</h2>
                <h3 style="margin: 10px 0 0 0;">Leave Application Updated & Approved</h3>
            </div>
            
            <div class="content">
                <p>Dear <strong>${params.to_name}</strong>,</p>
                <p>Your leave application has been <strong style="color: #ff9800;">UPDATED & APPROVED</strong>. Below are the details:</p>
                
                <div class="details">
                    <table>
                        <tr>
                            <td class="label">Application ID:</td>
                            <td><strong>${params.application_id}</strong></td>
                        </tr>
                        <tr>
                            <td class="label">Student ID:</td>
                            <td>${params.student_id}</td>
                        </tr>
                        <tr>
                            <td class="label">Student Name:</td>
                            <td>${params.to_name}</td>
                        </tr>
                        <tr>
                            <td class="label">Category/Year:</td>
                            <td>${params.category_year || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td class="label">Leave Type:</td>
                            <td>${params.leave_type}</td>
                        </tr>
                        <tr>
                            <td class="label">From Date:</td>
                            <td>
                                <span class="old-value">${params.old_from_date || ''}</span>
                                 <span class="new-value">${params.from_date}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">To Date:</td>
                            <td>
                                <span class="old-value">${params.old_to_date || ''}</span>
                                 <span class="new-value">${params.to_date}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Number of Days:</td>
                            <td>
                                <span class="old-value">${params.old_days || ''}</span>
                                 <span class="new-value">${params.days}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Reason:</td>
                            <td>${params.reason}</td>
                        </tr>
                        <tr>
                            <td class="label">Approved Date:</td>
                            <td>${params.approved_date}</td>
                        </tr>
                        <tr>
                            <td class="label">Status:</td>
                            <td class="status-updated">UPDATED & APPROVED</td>
                        </tr>
                    </table>
                </div>
                
                <div class="note">
                    <p style="margin: 0; color: #856404;"><strong>Note:</strong> This approved leave application has been updated. Please note the changes highlighted above.</p>
                </div>
                
                <div class="instructions">
                    <p style="margin: 0;"><strong>Important Instructions for Student:</strong></p>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>Please Collect one office copy (OC) for your reference about your approved leave</li>
                        <li>Keep this approval email for your records</li>
                        <li>Contact your department if you have any questions</li>
                        <li>Please go through the Instructions on Attendance, Leave, and TA Procedures Circular Date: 05.02.2026</li>
                    </ul>
                </div>
                
                <p>Best regards,<br>
                <strong>Student Leave Management System Administration</strong></p>
            </div>
            
            <div class="footer">
                <p style="margin: 0;">This is an automated email. Please do not reply to this message.</p>
                <p style="margin: 5px 0 0 0;">System Version: 5.0</p>
            </div>
        </body>
        </html>
      `;
    }

    function generateMultipleChangesEmailHTML(params) {
      const changesTable = params.changes ? Object.entries(params.changes).map(([field, values]) => {
        return `
          <tr>
              <td class="label">${field}:</td>
              <td>
                  <span class="old-value">${values.old}</span>
                   <span class="new-value">${values.new}</span>
              </td>
          </tr>
        `;
      }).join('') : '';
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
                .header { background: #4a6fa5; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .details { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #4CAF50; margin: 15px 0; }
                table { width: 100%; border-collapse: collapse; }
                td { padding: 10px; border-bottom: 1px solid #eee; }
                .label { font-weight: bold; width: 40%; }
                .instructions { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #2196F3; }
                .footer { background: #f1f1f1; padding: 15px; text-align: center; font-size: 12px; color: #666; }
                .status-updated { color: #ff9800; font-weight: bold; }
                .old-value { text-decoration: line-through; color: #999; margin-right: 10px; }
                .new-value { color: #28a745; font-weight: bold; }
                .note { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107; }
                .reason-old { font-size: 12px; color: #666; }
                .reason-new { font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2 style="margin: 0;">Student Leave Management System</h2>
                <h3 style="margin: 10px 0 0 0;">Leave Application Updated & Approved</h3>
            </div>
            
            <div class="content">
                <p>Dear <strong>${params.to_name}</strong>,</p>
                <p>Your leave application has been <strong style="color: #ff9800;">UPDATED & APPROVED</strong>. Below are the details:</p>
                
                <div class="details">
                    <table>
                        <tr>
                            <td class="label">Application ID:</td>
                            <td><strong>${params.application_id}</strong></td>
                        </tr>
                        <tr>
                            <td class="label">Student ID:</td>
                            <td>${params.student_id}</td>
                        </tr>
                        <tr>
                            <td class="label">Student Name:</td>
                            <td>${params.to_name}</td>
                        </tr>
                        <tr>
                            <td class="label">Category/Year:</td>
                            <td>${params.category_year || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td class="label">Leave Type:</td>
                            <td>${params.leave_type}</td>
                        </tr>
                        
                        ${params.changes ? changesTable : `
                            <tr>
                                <td class="label">From Date:</td>
                                <td>
                                    <span class="old-value">${params.old_from_date || ''}</span>
                                     <span class="new-value">${params.from_date}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">To Date:</td>
                                <td>
                                    <span class="old-value">${params.old_to_date || ''}</span>
                                     <span class="new-value">${params.to_date}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">Number of Days:</td>
                                <td>
                                    <span class="old-value">${params.old_days || ''}</span>
                                     <span class="new-value">${params.days}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">Reason:</td>
                                <td>
                                    <div class="reason-old">Previous: ${params.old_reason || 'N/A'}</div>
                                    <div class="reason-new">Updated: ${params.reason}</div>
                                </td>
                            </tr>
                        `}
                        
                        <tr>
                            <td class="label">Approved Date:</td>
                            <td>${params.approved_date}</td>
                        </tr>
                        <tr>
                            <td class="label">Status:</td>
                            <td class="status-updated">UPDATED & APPROVED</td>
                        </tr>
                    </table>
                </div>
                
                <div class="note">
                    <p style="margin: 0; color: #856404;"><strong>Note:</strong> This approved leave application has been updated. Please note the changes highlighted above.</p>
                </div>
                
                <div class="instructions">
                    <p style="margin: 0;"><strong>Important Instructions for Student:</strong></p>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>Please Collect one office copy (OC) for your reference about your approved leave</li>
                        <li>Keep this approval email for your records</li>
                        <li>Contact your department if you have any questions</li>
                        <li>Please go through the Instructions on Attendance, Leave, and TA Procedures Circular Date: 05.02.2026</li>
                    </ul>
                </div>
                
                <p>Best regards,<br>
                <strong>Student Leave Management System Administration</strong></p>
            </div>
            
            <div class="footer">
                <p style="margin: 0;">This is an automated email. Please do not reply to this message.</p>
                <p style="margin: 5px 0 0 0;">System Version: 5.0</p>
            </div>
        </body>
        </html>
      `;
    }

    async function sendApprovalEmail(applicationData, studentData, action, oldData = null) {
      if (!studentData.Email) {
        console.log('Student has no email - skipping notification');
        return;
      }
      
      const scriptUrl = await loadGoogleAppsScriptUrl();
      if (!scriptUrl) {
        console.warn('Google Apps Script URL not configured - skipping email notification');
        showAlert('Email notification not sent: Google Apps Script URL not configured. Please set it in Email Configuration.', 'warning');
        return;
      }
      
      try {
        const emailParams = {
          to_email: studentData.Email,
          to_name: studentData.Name,
          student_id: studentData.ID,
          application_id: applicationData.ID,
          leave_type: applicationData.LeaveType,
          from_date: formatDateDDMMYYYY(applicationData.FromDate),
          to_date: formatDateDDMMYYYY(applicationData.ToDate),
          days: applicationData.NoOfDays,
          reason: applicationData.Reason,
          status: applicationData.Status,
          action: action,
          approved_by: currentUser?.email || 'Admin',
          approved_date: formatDateDDMMYYYY(new Date().toISOString()),
          category_year: `${studentData.Category || ''} - ${studentData.Year || ''}`.trim()
        };
        
        if (oldData) {
          emailParams.old_from_date = formatDateDDMMYYYY(oldData.FromDate);
          emailParams.old_to_date = formatDateDDMMYYYY(oldData.ToDate);
          emailParams.old_days = oldData.NoOfDays;
          emailParams.old_reason = oldData.Reason;
          
          emailParams.changes = {};
          if (oldData.FromDate !== applicationData.FromDate) {
            emailParams.changes['From Date'] = { old: formatDateDDMMYYYY(oldData.FromDate), new: formatDateDDMMYYYY(applicationData.FromDate) };
          }
          if (oldData.ToDate !== applicationData.ToDate) {
            emailParams.changes['To Date'] = { old: formatDateDDMMYYYY(oldData.ToDate), new: formatDateDDMMYYYY(applicationData.ToDate) };
          }
          if (oldData.NoOfDays !== applicationData.NoOfDays) {
            emailParams.changes['Number of Days'] = { old: oldData.NoOfDays, new: applicationData.NoOfDays };
          }
          if (oldData.Reason !== applicationData.Reason) {
            emailParams.changes['Reason'] = { old: oldData.Reason, new: applicationData.Reason };
          }
        }
        
        let emailType = 'approved';
        if (action === 'updated') {
          emailType = 'updated';
        } else if (action === 'multiple-changes') {
          emailType = 'multiple-changes';
        }
        
        let htmlContent = '';
        if (emailType === 'multiple-changes' && oldData) {
          htmlContent = generateMultipleChangesEmailHTML(emailParams);
        } else if (emailType === 'updated' && oldData) {
          htmlContent = generateUpdatedApprovedEmailHTML(emailParams);
        } else {
          htmlContent = generateApprovedEmailHTML(emailParams);
        }
        
        emailParams.html_content = htmlContent;
        
        const response = await fetch(scriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailParams)
        });
        
        console.log('Email sent successfully to:', studentData.Email);
        return true;
        
      } catch (error) {
        console.error('Error sending email via Google Apps Script:', error);
        return false;
      }
    }

    // ==================== LEAVE APPROVALS ====================
    async function approveLeave(applicationId) {
      showConfirmationDialog(
        "Approve Leave",
        "Are you sure you want to approve this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
            if (!appDoc.exists) {
              showAlert('Application not found', 'danger');
              return;
            }
            
            const application = appDoc.data();
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'approved',
              ApprovedDate: new Date().toISOString(),
              ApprovedBy: currentUser?.email || 'admin',
              updatedAt: new Date().toISOString()
            });
            
            if (application.StudentID) {
              const studentSnapshot = await db.collection('students').where('ID', '==', application.StudentID).get();
              if (!studentSnapshot.empty) {
                const student = studentSnapshot.docs[0].data();
                await sendApprovalEmail({...application, Status: 'approved'}, student, 'approved');
              }
            }
            
            showAlert('Leave application approved successfully!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            console.error('Approve leave error:', error);
            showAlert('Failed to approve leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function rejectLeave(applicationId) {
      showConfirmationDialog(
        "Reject Leave",
        "Are you sure you want to reject this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
            if (!appDoc.exists) {
              showAlert('Application not found', 'danger');
              return;
            }
            
            const application = appDoc.data();
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'rejected',
              RejectedDate: new Date().toISOString(),
              RejectedBy: currentUser?.email || 'admin',
              updatedAt: new Date().toISOString()
            });
            
            if (application.StudentID) {
              const studentSnapshot = await db.collection('students').where('ID', '==', application.StudentID).get();
              if (!studentSnapshot.empty) {
                const student = studentSnapshot.docs[0].data();
                await sendApprovalEmail({...application, Status: 'rejected'}, student, 'rejected');
              }
            }
            
            showAlert('Leave application rejected!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            console.error('Reject leave error:', error);
            showAlert('Failed to reject leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function updateLeaveApplicationForm(event, applicationId) {
      event.preventDefault();
      
      const fromDate = document.getElementById('editLeaveFromDate').value;
      const toDate = document.getElementById('editLeaveToDate').value;
      const noOfDays = parseInt(document.getElementById('editLeaveNoOfDays').value) || 0;
      const reason = document.getElementById('editLeaveReason').value;
      const status = document.getElementById('editLeaveStatus').value;
      
      if (!fromDate || !toDate) {
        showAlert('Please fill in both date fields', 'warning');
        return;
      }
      
      if (new Date(toDate) < new Date(fromDate)) {
        showAlert('To Date cannot be earlier than From Date', 'warning');
        return;
      }
      
      if (noOfDays <= 0) {
        showAlert('Number of days must be greater than 0', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const oldAppDoc = await db.collection('leaveApplications').doc(applicationId).get();
        const oldAppData = oldAppDoc.data();
        
        const applicationData = {
          FromDate: fromDate,
          ToDate: toDate,
          NoOfDays: noOfDays,
          Reason: reason,
          Status: status,
          UpdatedAt: new Date().toISOString(),
          UpdatedBy: currentUser?.email || 'admin'
        };
        
        await db.collection('leaveApplications').doc(applicationId).update(applicationData);
        
        if (oldAppData.Status !== status || status === 'approved') {
          const updatedApp = { ...oldAppData, ...applicationData };
          
          if (updatedApp.StudentID) {
            const studentSnapshot = await db.collection('students').where('ID', '==', updatedApp.StudentID).get();
            if (!studentSnapshot.empty) {
              const student = studentSnapshot.docs[0].data();
              
              let changes = 0;
              if (oldAppData.FromDate !== fromDate) changes++;
              if (oldAppData.ToDate !== toDate) changes++;
              if (oldAppData.NoOfDays !== noOfDays) changes++;
              if (oldAppData.Reason !== reason) changes++;
              if (oldAppData.Status !== status) changes++;
              
              const action = changes > 2 ? 'multiple-changes' : 'updated';
              await sendApprovalEmail({...updatedApp, Status: status}, student, action, oldAppData);
            }
          }
        }
        
        showAlert('Leave application updated successfully!', 'success');
        closeModal();
        showLeaveHistory();
        
      } catch (error) {
        console.error('Update application error:', error);
        showAlert('Failed to update application: ' + error.message, 'danger');
      }
    }

    // ==================== APPLICATION ID GENERATOR ====================
    async function generateApplicationId() {
      try {
        const currentYear = new Date().getFullYear().toString();
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('Year', '==', currentYear)
          .orderBy('SequenceNumber', 'desc')
          .limit(1)
          .get();
        
        let nextSequence = 1;
        
        if (!applicationsSnapshot.empty) {
          const lastApplication = applicationsSnapshot.docs[0].data();
          nextSequence = (lastApplication.SequenceNumber || 0) + 1;
        }
        
        const formattedSequence = nextSequence.toString().padStart(4, '0');
        const applicationId = `LA-${currentYear}-${formattedSequence}`;
        
        return {
          id: applicationId,
          year: currentYear,
          sequence: nextSequence
        };
      } catch (error) {
        console.error('Error generating application ID:', error);
        const timestamp = Date.now();
        return {
          id: `LA-${new Date().getFullYear()}-${timestamp.toString().slice(-4).padStart(4, '0')}`,
          year: new Date().getFullYear().toString(),
          sequence: parseInt(timestamp.toString().slice(-4))
        };
      }
    }

    // ==================== DUPLICATE LEAVE CHECK ====================
    async function checkDuplicateLeaveApplication(studentId, leaveType, fromDate, toDate, excludeAppId = null) {
      try {
        const db = firebase.firestore();
        
        const from = new Date(fromDate).toISOString().split('T')[0];
        const to = new Date(toDate).toISOString().split('T')[0];
        
        let query = db.collection('leaveApplications')
          .where('StudentID', '==', studentId);
        
        const snapshot = await query.get();
        
        for (const doc of snapshot.docs) {
          const app = doc.data();
          
          if (excludeAppId && doc.id === excludeAppId) continue;
          
          const appFrom = app.FromDate.split('T')[0];
          const appTo = app.ToDate.split('T')[0];
          
          if (from <= appTo && to >= appFrom) {
            if (app.LeaveType === leaveType) {
              return {
                duplicate: true,
                message: `You already have a ${app.LeaveType} leave application from ${formatDate(appFrom)} to ${formatDate(appTo)}`
              };
            }
            
            if (from === appFrom && to === appTo) {
              return {
                duplicate: true,
                message: `You already have a ${app.LeaveType} leave application for the exact same dates. Please modify dates or choose a different date range.`
              };
            }
          }
        }
        
        return { duplicate: false };
      } catch (error) {
        console.error('Error checking duplicate leave:', error);
        return { duplicate: false, error: error.message };
      }
    }

    // ==================== CREDIT AVAILABILITY CHECK ====================
    async function checkCreditAvailability(studentId, leaveType, daysToApply) {
      try {
        const db = firebase.firestore();
        
        const studentSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentSnapshot.empty) {
          return { available: false, message: 'Student not found' };
        }
        
        const student = studentSnapshot.docs[0].data();
        
        const leaveTypeSnapshot = await db.collection('leaveTypes').where('Code', '==', leaveType).get();
        if (leaveTypeSnapshot.empty) {
          return { available: false, message: 'Leave type not found' };
        }
        
        const leaveTypeData = leaveTypeSnapshot.docs[0].data();
        
        if (leaveTypeData.ApprovalType !== 'credit') {
          return { available: true };
        }
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .where('Active', '==', true)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          return { available: false, message: `No credit records found for ${student.Category} - ${student.Year}. Please contact administrator.` };
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        const totalCredits = yearCredit[leaveType] || 0;
        
        if (totalCredits === 0) {
          return { available: false, message: `No credits available for ${leaveType} in ${student.Category} - ${student.Year}` };
        }
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', studentId)
          .where('LeaveType', '==', leaveType)
          .where('Status', '==', 'approved')
          .get();
        
        const usedCredits = applicationsSnapshot.docs.reduce((sum, doc) => {
          return sum + (doc.data().NoOfDays || 0);
        }, 0);
        
        const availableCredits = totalCredits - usedCredits;
        
        if (availableCredits < daysToApply) {
          return { 
            available: false, 
            message: `Insufficient ${leaveType} credits. Available: ${availableCredits}, Requested: ${daysToApply}`,
            availableCredits,
            totalCredits,
            usedCredits
          };
        }
        
        return { 
          available: true, 
          availableCredits,
          totalCredits,
          usedCredits
        };
        
      } catch (error) {
        console.error('Error checking credit availability:', error);
        return { available: false, message: 'Error checking credit availability' };
      }
    }

    // ==================== LEAVE APPLICATION FORM ====================
    async function showLeaveEntryForm(prefilledStudentId = null) {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const modal = document.getElementById('operationModal');
        
        let leaveTypesOptions = '<option value="">Select Leave Type</option>';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesOptions += leaveTypes.filter(lt => lt.Enabled === true).map(lt => `
            <option value="${lt.Code}">${lt.Name} (${lt.Code}) - ${lt.ApprovalType === 'credit' ? 'Credit-based' : 'Approval-based'}</option>
          `).join('');
        }
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-file-signature"></i> Enter Leave Request</h2>
            <div id="creditAvailabilityMessage" class="alert" style="display: none;"></div>
            <form onsubmit="submitLeaveRequest(event)">
              <div class="form-group">
                <label>Select Student ID <span style="color: red;">*</span></label>
                <div style="position: relative;">
                  <input type="text" class="form-control" id="studentSearchInput" 
                         placeholder="Search Student ID..." 
                         oninput="searchStudent(this.value)"
                         autocomplete="off"
                         ${prefilledStudentId ? `value="${prefilledStudentId}" readonly` : ''}>
                  <div id="studentSearchResults" class="search-results" style="display: none;"></div>
                </div>
                <input type="hidden" id="leaveStudentId" required>
              </div>
              
              <div id="studentInfoBox" class="student-info-box" style="display: none;">
                <h4><i class="fas fa-user-graduate"></i> Selected Student Information</h4>
                <div class="student-info-row">
                  <div class="info-item">
                    <span class="info-label">Student ID:</span>
                    <span class="info-value" id="selectedStudentId">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Name:</span>
                    <span class="info-value" id="selectedStudentName">-</span>
                  </div>
                </div>
                <div class="student-info-row">
                  <div class="info-item">
                    <span class="info-label">Category:</span>
                    <span class="info-value" id="selectedStudentCategory">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Year:</span>
                    <span class="info-value" id="selectedStudentYear">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Semester:</span>
                    <span class="info-value" id="selectedStudentSemester">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Specialization:</span>
                    <span class="info-value" id="selectedStudentSpecialization">-</span>
                  </div>
                </div>
                <div class="info-item" style="margin-top: 10px;">
                  <span class="info-label">Email:</span>
                  <span class="info-value" id="selectedStudentEmail">-</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Leave Type <span style="color: red;">*</span></label>
                <select class="form-control" id="leaveType" required onchange="checkCreditOnLeaveTypeChange()">
                  ${leaveTypesOptions}
                </select>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>From Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveFromDate" value="${tomorrowStr}" required onchange="checkDuplicateDates()">
                </div>
                <div class="form-group">
                  <label>To Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveToDate" value="${tomorrowStr}" required onchange="checkDuplicateDates()">
                </div>
              </div>
              
              <div class="form-group">
                <label>Number of Days <span style="color: red;">*</span></label>
                <input type="number" class="form-control" id="leaveNoOfDays" min="1" value="1" required onchange="checkCreditOnDaysChange()">
              </div>
              
              <div class="form-group">
                <label>Reason for Leave <span style="color: red;">*</span></label>
                <textarea class="form-control" id="leaveReason" rows="4" required></textarea>
              </div>
              
              <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="leaveStatus">
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="submitLeaveBtn">
                  <i class="fas fa-paper-plane"></i> Submit Leave Request
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        if (prefilledStudentId) {
          document.getElementById('leaveStudentId').value = prefilledStudentId;
          loadStudentDetails(prefilledStudentId);
        }
        
        document.getElementById('leaveFromDate').addEventListener('change', calculateDays);
        document.getElementById('leaveToDate').addEventListener('change', calculateDays);
        
        window.searchStudent = async function(searchTerm) {
          const searchResults = document.getElementById('studentSearchResults');
          
          if (!searchTerm || searchTerm.trim() === '') {
            searchResults.style.display = 'none';
            return;
          }
          
          try {
            const db = firebase.firestore();
            const searchTermLower = searchTerm.toLowerCase();
            
            const snapshot = await db.collection('students').get();
            const matchedStudents = snapshot.docs
              .map(doc => doc.data())
              .filter(student => 
                student.ID && student.ID.toString().toLowerCase().includes(searchTermLower) ||
                student.Name && student.Name.toLowerCase().includes(searchTermLower)
              )
              .sort((a, b) => a.ID.localeCompare(b.ID))
              .slice(0, 10);
            
            if (matchedStudents.length > 0) {
              let resultsHTML = '';
              matchedStudents.forEach(student => {
                resultsHTML += `
                  <div class="search-result-item" onclick="selectStudent('${student.ID}', '${student.Name.replace(/'/g, "\\'")}')">
                    <div class="search-result-id">${student.ID}</div>
                    <div class="search-result-name">${student.Name}</div>
                  </div>
                `;
              });
              searchResults.innerHTML = resultsHTML;
              searchResults.style.display = 'block';
            } else {
              searchResults.style.display = 'none';
            }
          } catch (error) {
            console.error('Search student error:', error);
            searchResults.style.display = 'none';
          }
        };
        
        window.selectStudent = function(studentId, studentName) {
          document.getElementById('studentSearchInput').value = studentId;
          document.getElementById('leaveStudentId').value = studentId;
          document.getElementById('studentSearchResults').style.display = 'none';
          loadStudentDetails(studentId);
        };
        
        async function loadStudentDetails(studentId) {
          try {
            const db = firebase.firestore();
            const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
            
            if (!studentsSnapshot.empty) {
              const student = studentsSnapshot.docs[0].data();
              document.getElementById('selectedStudentId').textContent = student.ID || '-';
              document.getElementById('selectedStudentName').textContent = student.Name || '-';
              document.getElementById('selectedStudentCategory').textContent = student.Category || '-';
              document.getElementById('selectedStudentYear').textContent = student.Year || '-';
              document.getElementById('selectedStudentSemester').textContent = student.Semester || '-';
              document.getElementById('selectedStudentSpecialization').textContent = student.Specialization || '-';
              document.getElementById('selectedStudentEmail').textContent = student.Email || 'No email';
              document.getElementById('studentInfoBox').style.display = 'block';
            } else {
              document.getElementById('studentInfoBox').style.display = 'none';
            }
          } catch (error) {
            console.error('Load student details error:', error);
            document.getElementById('studentInfoBox').style.display = 'none';
          }
        }
        
        function calculateDays() {
          const fromDate = new Date(document.getElementById('leaveFromDate').value);
          const toDate = new Date(document.getElementById('leaveToDate').value);
          
          if (fromDate && toDate && fromDate <= toDate) {
            const timeDiff = toDate.getTime() - fromDate.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            document.getElementById('leaveNoOfDays').value = dayDiff > 0 ? dayDiff : 1;
          }
        }
        
        window.checkCreditOnLeaveTypeChange = async function() {
          const studentId = document.getElementById('leaveStudentId').value;
          const leaveType = document.getElementById('leaveType').value;
          const days = parseInt(document.getElementById('leaveNoOfDays').value) || 1;
          
          if (studentId && leaveType) {
            await checkCreditAndUpdateUI(studentId, leaveType, days);
          }
        };
        
        window.checkCreditOnDaysChange = async function() {
          const studentId = document.getElementById('leaveStudentId').value;
          const leaveType = document.getElementById('leaveType').value;
          const days = parseInt(document.getElementById('leaveNoOfDays').value) || 1;
          
          if (studentId && leaveType) {
            await checkCreditAndUpdateUI(studentId, leaveType, days);
          }
        };
        
        window.checkDuplicateDates = async function() {
          const studentId = document.getElementById('leaveStudentId').value;
          const leaveType = document.getElementById('leaveType').value;
          const fromDate = document.getElementById('leaveFromDate').value;
          const toDate = document.getElementById('leaveToDate').value;
          
          if (studentId && leaveType && fromDate && toDate) {
            const duplicateCheck = await checkDuplicateLeaveApplication(studentId, leaveType, fromDate, toDate);
            
            const creditMessageDiv = document.getElementById('creditAvailabilityMessage');
            if (duplicateCheck.duplicate) {
              creditMessageDiv.className = 'alert alert-danger';
              creditMessageDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${duplicateCheck.message}`;
              creditMessageDiv.style.display = 'flex';
              document.getElementById('submitLeaveBtn').disabled = true;
            } else {
              if (creditMessageDiv.style.display === 'flex' && creditMessageDiv.className === 'alert alert-danger') {
                creditMessageDiv.style.display = 'none';
              }
              document.getElementById('submitLeaveBtn').disabled = false;
            }
          }
        };
        
        async function checkCreditAndUpdateUI(studentId, leaveType, days) {
          const creditCheck = await checkCreditAvailability(studentId, leaveType, days);
          const creditMessageDiv = document.getElementById('creditAvailabilityMessage');
          
          if (!creditCheck.available) {
            creditMessageDiv.className = 'alert alert-warning';
            creditMessageDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${creditCheck.message}`;
            creditMessageDiv.style.display = 'flex';
            document.getElementById('submitLeaveBtn').disabled = true;
          } else {
            if (creditCheck.availableCredits !== undefined) {
              creditMessageDiv.className = 'alert alert-info';
              creditMessageDiv.innerHTML = `<i class="fas fa-info-circle"></i> Credits available: ${creditCheck.availableCredits} (Total: ${creditCheck.totalCredits}, Used: ${creditCheck.usedCredits})`;
              creditMessageDiv.style.display = 'flex';
            } else {
              creditMessageDiv.style.display = 'none';
            }
            document.getElementById('submitLeaveBtn').disabled = false;
          }
        }
        
      } catch (error) {
        console.error('Leave entry form error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function submitLeaveRequest(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('leaveStudentId').value;
      const leaveType = document.getElementById('leaveType').value;
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const days = parseInt(document.getElementById('leaveNoOfDays').value) || 1;
      const reason = document.getElementById('leaveReason').value;
      const status = document.getElementById('leaveStatus').value;
      
      if (!studentId || !leaveType || !fromDate || !toDate || !reason) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      const duplicateCheck = await checkDuplicateLeaveApplication(studentId, leaveType, fromDate, toDate);
      if (duplicateCheck.duplicate) {
        showAlert(duplicateCheck.message, 'danger');
        return;
      }
      
      const creditCheck = await checkCreditAvailability(studentId, leaveType, days);
      if (!creditCheck.available) {
        showAlert(creditCheck.message, 'warning');
        return;
      }
      
      const appIdInfo = await generateApplicationId();
      
      const applicationData = {
        ID: appIdInfo.id,
        Year: appIdInfo.year,
        SequenceNumber: appIdInfo.sequence,
        StudentID: studentId,
        LeaveType: leaveType,
        FromDate: fromDate,
        ToDate: toDate,
        NoOfDays: days,
        Reason: reason,
        Status: status,
        AppliedDate: new Date().toISOString(),
        AppliedBy: currentUser?.email || 'admin',
        Semester: document.getElementById('selectedStudentSemester').textContent !== '-' ? document.getElementById('selectedStudentSemester').textContent : ''
      };
      
      const submitBtn = document.getElementById('submitLeaveBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner"></div> Submitting...';
      submitBtn.disabled = true;
      
      try {
        const db = firebase.firestore();
        
        await db.collection('leaveApplications').add(applicationData);
        
        if (applicationData.Status === 'approved' && applicationData.StudentID) {
          const studentSnapshot = await db.collection('students').where('ID', '==', applicationData.StudentID).get();
          if (!studentSnapshot.empty) {
            const student = studentSnapshot.docs[0].data();
            await sendApprovalEmail(applicationData, student, 'approved');
          }
        }
        
        showAlert(`Leave request submitted successfully! (ID: ${applicationData.ID})`, 'success');
        closeModal();
        showLeaveApprovals();
        
      } catch (error) {
        console.error('Submit leave request error:', error);
        showAlert('Failed to submit leave request: ' + error.message, 'danger');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    // ==================== ADD STUDENT MODAL WITH DUPLICATE CHECK ====================
    async function showAddStudentModal() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const studentsSnapshot = await db.collection('students').get();
        const existingStudentIds = new Set();
        studentsSnapshot.docs.forEach(doc => {
          existingStudentIds.add(doc.data().ID);
        });
        
        const modal = document.getElementById('operationModal');
        
        let categoriesHTML = '<option value="">Select Category</option>';
        if (categories && categories.length > 0) {
          categoriesHTML += categories.filter(c => c.Enabled === true).map(cat => `
            <option value="${cat.Category}">${cat.Category}</option>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-plus"></i> Add New Student</h2>
            <form onsubmit="addStudent(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentId" required 
                         onkeyup="checkStudentIdDuplicate(this.value)" onblur="checkStudentIdDuplicate(this.value)">
                  <div id="studentIdStatus" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentName" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category <span style="color: red;">*</span></label>
                <select class="form-control" id="newStudentCategory" required onchange="updateYearSemesterOptions(this.value)">
                  ${categoriesHTML}
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <select class="form-control" id="newStudentYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Semester</label>
                  <select class="form-control" id="newStudentSemester">
                    <option value="">Select Semester</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Specialization</label>
                <select class="form-control" id="newStudentSpecialization">
                  <option value="">Select Specialization</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="newStudentEmail">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" class="form-control" id="newStudentPhone">
                </div>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="saveStudentBtn">
                  <i class="fas fa-save"></i> Save Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        window.existingStudentIds = existingStudentIds;
        
        window.checkStudentIdDuplicate = function(studentId) {
          const statusDiv = document.getElementById('studentIdStatus');
          const saveBtn = document.getElementById('saveStudentBtn');
          
          if (!studentId || studentId.trim() === '') {
            statusDiv.innerHTML = '';
            if (saveBtn) saveBtn.disabled = false;
            return;
          }
          
          if (window.existingStudentIds.has(studentId)) {
            statusDiv.innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> Student ID already exists!</span>';
            if (saveBtn) saveBtn.disabled = true;
          } else {
            statusDiv.innerHTML = '<span style="color: #27ae60;"><i class="fas fa-check-circle"></i> Student ID is available</span>';
            if (saveBtn) saveBtn.disabled = false;
          }
        };
        
        window.updateYearSemesterOptions = function(category) {
          const selectedCat = categories.find(c => c.Category === category);
          const yearSelect = document.getElementById('newStudentYear');
          const semesterSelect = document.getElementById('newStudentSemester');
          const specSelect = document.getElementById('newStudentSpecialization');
          
          if (selectedCat) {
            const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
            const semesters = selectedCat.Semesters ? selectedCat.Semesters.split(',').map(s => s.trim()) : [];
            const specializations = selectedCat.Specializations ? selectedCat.Specializations.split(',').map(s => s.trim()) : [];
            
            yearSelect.innerHTML = '<option value="">Select Year</option>' + 
              years.map(year => `<option value="${year}">${year}</option>`).join('');
            
            semesterSelect.innerHTML = '<option value="">Select Semester</option>' + 
              semesters.map(sem => `<option value="${sem}">${sem}</option>`).join('');
            
            specSelect.innerHTML = '<option value="">Select Specialization</option>' + 
              specializations.map(spec => `<option value="${spec}">${spec}</option>`).join('');
          }
        };
        
      } catch (error) {
        console.error('Add student modal error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function addStudent(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('newStudentId').value.trim();
      const studentName = document.getElementById('newStudentName').value.trim();
      const category = document.getElementById('newStudentCategory').value;
      
      if (!studentId || !studentName || !category) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      if (window.existingStudentIds && window.existingStudentIds.has(studentId)) {
        showAlert('Student ID already exists! Please use a different ID.', 'danger');
        return;
      }
      
      const studentData = {
        ID: studentId,
        Name: studentName,
        Category: category,
        Year: document.getElementById('newStudentYear').value,
        Semester: document.getElementById('newStudentSemester').value,
        Specialization: document.getElementById('newStudentSpecialization').value,
        Email: document.getElementById('newStudentEmail').value.trim(),
        Phone: document.getElementById('newStudentPhone').value.trim(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      const saveBtn = document.getElementById('saveStudentBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<div class="loading-spinner"></div> Saving...';
      saveBtn.disabled = true;
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (!existingSnapshot.empty) {
          showAlert('Student ID already exists! Please use a different ID.', 'danger');
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
          return;
        }
        
        await db.collection('students').add(studentData);
        
        showAlert('Student added successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        console.error('Add student error:', error);
        showAlert('Failed to add student: ' + error.message, 'danger');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    // ==================== STUDENTS MANAGEMENT ====================
    async function showStudentsManagement() {
      try {
        const db = firebase.firestore();
        const studentsSnapshot = await db.collection('students').get();
        let students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        students.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        window.allStudents = students;
        selectedStudents.clear();
        
        const savedFilters = await loadFilterState('students');
        currentFilters = { ...savedFilters };
        
        const filteredStudents = filterStudents(students, currentFilters);
        
        const uniqueCategories = [...new Set(students.map(s => s.Category).filter(Boolean))];
        const uniqueYears = [...new Set(students.map(s => s.Year).filter(Boolean))];
        const uniqueSemesters = [...new Set(students.map(s => s.Semester).filter(Boolean))];
        const uniqueSpecializations = [...new Set(students.map(s => s.Specialization).filter(Boolean))];
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-user-graduate"></i> Students Management</h2>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="showAddStudentModal()">
                  <i class="fas fa-plus"></i> Add Student
                </button>
                <button class="btn btn-primary" onclick="showBulkUpdateModal()" ${selectedStudents.size === 0 ? 'disabled' : ''}>
                  <i class="fas fa-users"></i> Bulk Update (${selectedStudents.size})
                </button>
              </div>
            </div>
            
            <div class="filters-container">
              <div class="filter-group search-box">
                <label>Search</label>
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="studentSearch" placeholder="Search by ID or Name..." 
                       oninput="filterStudentList()" value="${currentFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>Category</label>
                <select class="form-control" id="filterCategory" onchange="filterStudentList()">
                  <option value="">All Categories</option>
                  ${uniqueCategories.map(cat => `<option value="${cat}" ${currentFilters.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Year</label>
                <select class="form-control" id="filterYear" onchange="filterStudentList()">
                  <option value="">All Years</option>
                  ${uniqueYears.map(year => `<option value="${year}" ${currentFilters.year === year ? 'selected' : ''}>${year}</option>`).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Semester</label>
                <select class="form-control" id="filterSemester" onchange="filterStudentList()">
                  <option value="">All Semesters</option>
                  ${uniqueSemesters.map(sem => `<option value="${sem}" ${currentFilters.semester === sem ? 'selected' : ''}>${sem}</option>`).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Specialization</label>
                <select class="form-control" id="filterSpecialization" onchange="filterStudentList()">
                  <option value="">All Specializations</option>
                  ${uniqueSpecializations.map(spec => `<option value="${spec}" ${currentFilters.specialization === spec ? 'selected' : ''}>${spec}</option>`).join('')}
                </select>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredStudents.length}</strong> of <strong>${students.length}</strong> students
              <button class="btn btn-sm btn-secondary" onclick="clearStudentFilters()" style="margin-left: 15px;">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
            
            ${filteredStudents.length > 0 ? `
              <div class="bulk-select-header">
                <input type="checkbox" id="selectAllStudents" class="bulk-select-checkbox" onchange="toggleSelectAllStudents(this.checked)">
                <span>Select All</span>
                <span style="margin-left: auto; color: #666;">
                  Selected: <span id="selectedCount">${selectedStudents.size}</span> students
                </span>
              </div>
              
              <div class="bulk-actions" id="bulkActions" style="display: ${selectedStudents.size > 0 ? 'flex' : 'none'};">
                <button class="btn btn-sm btn-primary" onclick="showBulkUpdateModal()">
                  <i class="fas fa-exchange-alt"></i> Update Semester/Year
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSelectedStudents()">
                  <i class="fas fa-trash"></i> Delete Selected
                </button>
              </div>
            ` : ''}
            
            <div class="table-container">
              ${renderStudentsTable(filteredStudents)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Students data error:', error);
        showAlert('Failed to load students: ' + error.message, 'danger');
      }
    }

    function renderStudentsTable(students) {
      if (students.length === 0) {
        return '<p>No students found. Add your first student using the "Add Student" button.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 30px;">
                <input type="checkbox" class="bulk-select-checkbox" id="selectAllVisible" onchange="toggleSelectAllVisible(this.checked)">
              </th>
              <th>Student ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Year</th>
              <th>Semester</th>
              <th>Specialization</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr>
                <td>
                  <input type="checkbox" class="bulk-select-checkbox student-checkbox" 
                         data-student-id="${student.ID}"
                         onchange="toggleStudentSelection('${student.ID}', this.checked)"
                         ${selectedStudents.has(student.ID.toString()) ? 'checked' : ''}>
                </td>
                <td>${student.ID || ''}</td>
                <td>${student.Name || ''}</td>
                <td>${student.Category || ''}</td>
                <td>${student.Year || 'N/A'}</td>
                <td>${student.Semester || 'N/A'}</td>
                <td>${student.Specialization || 'N/A'}</td>
                <td>${student.Email || 'N/A'}</td>
                <td>${student.Phone || 'N/A'}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-primary" onclick="editStudent('${student.ID}')" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.ID}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="applyLeaveForStudent('${student.ID}')" title="Apply Leave">
                      <i class="fas fa-file-signature"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function filterStudentList() {
      currentFilters = {
        search: document.getElementById('studentSearch').value.toLowerCase(),
        category: document.getElementById('filterCategory').value,
        year: document.getElementById('filterYear').value,
        semester: document.getElementById('filterSemester').value,
        specialization: document.getElementById('filterSpecialization').value
      };
      
      saveFilterState('students', currentFilters);
      
      const filteredStudents = filterStudents(window.allStudents, currentFilters);
      
      const tableContainer = document.querySelector('.table-container');
      if (tableContainer) {
        tableContainer.innerHTML = renderStudentsTable(filteredStudents);
      }
      
      const infoAlert = document.querySelector('.alert-info');
      if (infoAlert) {
        infoAlert.innerHTML = `
          <i class="fas fa-info-circle"></i> 
          Showing <strong>${filteredStudents.length}</strong> of <strong>${window.allStudents.length}</strong> students
          <button class="btn btn-sm btn-secondary" onclick="clearStudentFilters()" style="margin-left: 15px;">
            <i class="fas fa-times"></i> Clear Filters
          </button>
        `;
      }
    }

    function filterStudents(students, filters) {
      return students.filter(student => {
        if (filters.search) {
          const searchMatch = 
            (student.ID && student.ID.toString().toLowerCase().includes(filters.search)) ||
            (student.Name && student.Name.toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.category && student.Category !== filters.category) return false;
        if (filters.year && student.Year !== filters.year) return false;
        if (filters.semester && student.Semester !== filters.semester) return false;
        if (filters.specialization && student.Specialization !== filters.specialization) return false;
        
        return true;
      });
    }

    function toggleStudentSelection(studentId, isChecked) {
      if (isChecked) {
        selectedStudents.add(studentId.toString());
      } else {
        selectedStudents.delete(studentId.toString());
      }
      updateSelectionUI();
    }

    function toggleSelectAllStudents(isChecked) {
      selectedStudents.clear();
      if (isChecked) {
        window.allStudents.forEach(student => {
          selectedStudents.add(student.ID.toString());
        });
      }
      updateSelectionUI();
    }

    function toggleSelectAllVisible(isChecked) {
      const visibleCheckboxes = document.querySelectorAll('.student-checkbox');
      visibleCheckboxes.forEach(cb => {
        const studentId = cb.getAttribute('data-student-id');
        cb.checked = isChecked;
        if (isChecked) {
          selectedStudents.add(studentId);
        } else {
          selectedStudents.delete(studentId);
        }
      });
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const selectedCount = selectedStudents.size;
      const selectedElement = document.getElementById('selectedCount');
      if (selectedElement) selectedElement.textContent = selectedCount;
      
      const bulkActions = document.getElementById('bulkActions');
      if (bulkActions) {
        bulkActions.style.display = selectedCount > 0 ? 'flex' : 'none';
      }
      
      const bulkUpdateBtn = document.querySelector('.btn-primary[onclick="showBulkUpdateModal()"]');
      if (bulkUpdateBtn) {
        bulkUpdateBtn.disabled = selectedCount === 0;
      }
      
      const selectAllCheckbox = document.getElementById('selectAllStudents');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = selectedCount === window.allStudents.length && window.allStudents.length > 0;
        selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < window.allStudents.length;
      }
    }

    async function clearStudentFilters() {
      currentFilters = {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      };
      
      await saveFilterState('students', currentFilters);
      
      if (document.getElementById('studentSearch')) document.getElementById('studentSearch').value = '';
      if (document.getElementById('filterCategory')) document.getElementById('filterCategory').value = '';
      if (document.getElementById('filterYear')) document.getElementById('filterYear').value = '';
      if (document.getElementById('filterSemester')) document.getElementById('filterSemester').value = '';
      if (document.getElementById('filterSpecialization')) document.getElementById('filterSpecialization').value = '';
      
      filterStudentList();
    }

    async function editStudent(studentId) {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        const student = { id: studentDoc.id, ...studentDoc.data() };
        
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const modal = document.getElementById('operationModal');
        
        let categoriesHTML = '<option value="">Select Category</option>';
        if (categories && categories.length > 0) {
          categoriesHTML += categories.filter(c => c.Enabled === true).map(cat => `
            <option value="${cat.Category}" ${student.Category === cat.Category ? 'selected' : ''}>${cat.Category}</option>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Student</h2>
            <form onsubmit="updateStudent(event, '${studentId}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID</label>
                  <input type="text" class="form-control" value="${student.ID}" readonly>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editStudentName" value="${student.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category <span style="color: red;">*</span></label>
                <select class="form-control" id="editStudentCategory" required onchange="updateEditYearSemesterOptions(this.value)">
                  ${categoriesHTML}
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <select class="form-control" id="editStudentYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Semester</label>
                  <select class="form-control" id="editStudentSemester">
                    <option value="">Select Semester</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Specialization</label>
                <select class="form-control" id="editStudentSpecialization">
                  <option value="">Select Specialization</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="editStudentEmail" value="${student.Email || ''}">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" class="form-control" id="editStudentPhone" value="${student.Phone || ''}">
                </div>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        const selectedCat = categories.find(c => c.Category === student.Category);
        if (selectedCat) {
          const yearSelect = document.getElementById('editStudentYear');
          const semesterSelect = document.getElementById('editStudentSemester');
          const specSelect = document.getElementById('editStudentSpecialization');
          
          const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
          const semesters = selectedCat.Semesters ? selectedCat.Semesters.split(',').map(s => s.trim()) : [];
          const specializations = selectedCat.Specializations ? selectedCat.Specializations.split(',').map(s => s.trim()) : [];
          
          yearSelect.innerHTML = '<option value="">Select Year</option>' + 
            years.map(year => `<option value="${year}" ${student.Year === year ? 'selected' : ''}>${year}</option>`).join('');
          
          semesterSelect.innerHTML = '<option value="">Select Semester</option>' + 
            semesters.map(sem => `<option value="${sem}" ${student.Semester === sem ? 'selected' : ''}>${sem}</option>`).join('');
          
          specSelect.innerHTML = '<option value="">Select Specialization</option>' + 
            specializations.map(spec => `<option value="${spec}" ${student.Specialization === spec ? 'selected' : ''}>${spec}</option>`).join('');
        }
        
        window.updateEditYearSemesterOptions = function(category) {
          const selectedCat = categories.find(c => c.Category === category);
          const yearSelect = document.getElementById('editStudentYear');
          const semesterSelect = document.getElementById('editStudentSemester');
          const specSelect = document.getElementById('editStudentSpecialization');
          
          if (selectedCat) {
            const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
            const semesters = selectedCat.Semesters ? selectedCat.Semesters.split(',').map(s => s.trim()) : [];
            const specializations = selectedCat.Specializations ? selectedCat.Specializations.split(',').map(s => s.trim()) : [];
            
            yearSelect.innerHTML = '<option value="">Select Year</option>' + 
              years.map(year => `<option value="${year}">${year}</option>`).join('');
            
            semesterSelect.innerHTML = '<option value="">Select Semester</option>' + 
              semesters.map(sem => `<option value="${sem}">${sem}</option>`).join('');
            
            specSelect.innerHTML = '<option value="">Select Specialization</option>' + 
              specializations.map(spec => `<option value="${spec}">${spec}</option>`).join('');
          }
        };
        
      } catch (error) {
        console.error('Edit student error:', error);
        showAlert('Failed to load student: ' + error.message, 'danger');
      }
    }

    async function updateStudent(event, studentId) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        
        const studentData = {
          Name: document.getElementById('editStudentName').value.trim(),
          Category: document.getElementById('editStudentCategory').value,
          Year: document.getElementById('editStudentYear').value,
          Semester: document.getElementById('editStudentSemester').value,
          Specialization: document.getElementById('editStudentSpecialization').value,
          Email: document.getElementById('editStudentEmail').value.trim(),
          Phone: document.getElementById('editStudentPhone').value.trim(),
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!studentData.Name || !studentData.Category) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('students').doc(studentDoc.id).update(studentData);
        
        showAlert('Student updated successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        console.error('Update student error:', error);
        showAlert('Failed to update student: ' + error.message, 'danger');
      }
    }

    async function deleteStudent(studentId) {
      showConfirmationDialog(
        "Delete Student",
        "Are you sure you want to delete this student? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
            if (studentsSnapshot.empty) {
              showAlert('Student not found', 'danger');
              return;
            }
            
            await db.collection('students').doc(studentsSnapshot.docs[0].id).delete();
            
            selectedStudents.delete(studentId.toString());
            
            showAlert('Student deleted successfully!', 'success');
            showStudentsManagement();
            
          } catch (error) {
            console.error('Delete student error:', error);
            showAlert('Failed to delete student: ' + error.message, 'danger');
          }
        }
      );
    }

    function applyLeaveForStudent(studentId) {
      showLeaveEntryForm(studentId);
    }

    // ==================== BULK UPDATE FUNCTIONS ====================
    async function showBulkUpdateModal() {
      if (selectedStudents.size === 0) {
        showAlert('No students selected', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const firstStudentId = Array.from(selectedStudents)[0];
        const firstStudentSnapshot = await db.collection('students').where('ID', '==', firstStudentId).get();
        let currentCategory = '';
        if (!firstStudentSnapshot.empty) {
          currentCategory = firstStudentSnapshot.docs[0].data().Category || '';
        }
        
        let allSameCategory = true;
        for (const studentId of selectedStudents) {
          const snapshot = await db.collection('students').where('ID', '==', studentId).get();
          if (!snapshot.empty && snapshot.docs[0].data().Category !== currentCategory) {
            allSameCategory = false;
            break;
          }
        }
        
        const modal = document.getElementById('operationModal');
        
        let categoryOptions = '<option value="">Keep Current Category</option>';
        categories.filter(c => c.Enabled === true).forEach(cat => {
          categoryOptions += `<option value="${cat.Category}">${cat.Category}</option>`;
        });
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-exchange-alt"></i> Bulk Update Students</h2>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>${selectedStudents.size}</strong> students selected for bulk update.
              ${!allSameCategory ? '<br><span class="text-warning">Warning: Selected students have different categories. Updating category may affect all.</span>' : ''}
            </div>
            
            <form onsubmit="performBulkUpdate(event)">
              <div class="form-group">
                <label>Update Category</label>
                <select class="form-control" id="bulkUpdateCategory" onchange="loadBulkUpdateYearOptions(this.value)">
                  ${categoryOptions}
                </select>
                <small style="color: #666;">Select to change category for all selected students</small>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Update Year</label>
                  <select class="form-control" id="bulkUpdateYear">
                    <option value="">Keep Current Year</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Update Semester</label>
                  <select class="form-control" id="bulkUpdateSemester">
                    <option value="">Keep Current Semester</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label>Update Specialization</label>
                <select class="form-control" id="bulkUpdateSpecialization">
                  <option value="">Keep Current Specialization</option>
                </select>
              </div>
              
              <div style="margin: 20px 0;">
                <h4>Preview of Changes:</h4>
                <p>Selected students: <strong>${selectedStudents.size}</strong></p>
                <p>Fields to update (empty means keep current):</p>
                <ul id="bulkPreviewList">
                  <li>Category: <span id="previewCategory">No change</span></li>
                  <li>Year: <span id="previewYear">No change</span></li>
                  <li>Semester: <span id="previewSemester">No change</span></li>
                  <li>Specialization: <span id="previewSpecialization">No change</span></li>
                </ul>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-check"></i> Apply Updates
                </button>
                <button type="button" class="btn btn-danger" style="flex: 1;" onclick="deleteSelectedStudents()">
                  <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        document.getElementById('bulkUpdateCategory').addEventListener('change', updateBulkPreview);
        document.getElementById('bulkUpdateYear').addEventListener('change', updateBulkPreview);
        document.getElementById('bulkUpdateSemester').addEventListener('change', updateBulkPreview);
        document.getElementById('bulkUpdateSpecialization').addEventListener('change', updateBulkPreview);
        
        window.loadBulkUpdateYearOptions = function(category) {
          const yearSelect = document.getElementById('bulkUpdateYear');
          const semesterSelect = document.getElementById('bulkUpdateSemester');
          const specSelect = document.getElementById('bulkUpdateSpecialization');
          
          if (category) {
            const selectedCat = categories.find(c => c.Category === category);
            if (selectedCat) {
              const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
              const semesters = selectedCat.Semesters ? selectedCat.Semesters.split(',').map(s => s.trim()) : [];
              const specializations = selectedCat.Specializations ? selectedCat.Specializations.split(',').map(s => s.trim()) : [];
              
              yearSelect.innerHTML = '<option value="">Keep Current Year</option>' + 
                years.map(year => `<option value="${year}">${year}</option>`).join('');
              
              semesterSelect.innerHTML = '<option value="">Keep Current Semester</option>' + 
                semesters.map(sem => `<option value="${sem}">${sem}</option>`).join('');
              
              specSelect.innerHTML = '<option value="">Keep Current Specialization</option>' + 
                specializations.map(spec => `<option value="${spec}">${spec}</option>`).join('');
            }
          } else {
            yearSelect.innerHTML = '<option value="">Keep Current Year</option>';
            semesterSelect.innerHTML = '<option value="">Keep Current Semester</option>';
            specSelect.innerHTML = '<option value="">Keep Current Specialization</option>';
          }
          updateBulkPreview();
        };
        
        function updateBulkPreview() {
          const category = document.getElementById('bulkUpdateCategory').value;
          const year = document.getElementById('bulkUpdateYear').value;
          const semester = document.getElementById('bulkUpdateSemester').value;
          const spec = document.getElementById('bulkUpdateSpecialization').value;
          
          document.getElementById('previewCategory').textContent = category || 'No change';
          document.getElementById('previewYear').textContent = year || 'No change';
          document.getElementById('previewSemester').textContent = semester || 'No change';
          document.getElementById('previewSpecialization').textContent = spec || 'No change';
        }
        
      } catch (error) {
        console.error('Bulk update modal error:', error);
        showAlert('Failed to load bulk update options: ' + error.message, 'danger');
      }
    }

    async function performBulkUpdate(event) {
      event.preventDefault();
      
      if (selectedStudents.size === 0) {
        showAlert('No students selected', 'warning');
        closeModal();
        return;
      }
      
      const category = document.getElementById('bulkUpdateCategory').value;
      const year = document.getElementById('bulkUpdateYear').value;
      const semester = document.getElementById('bulkUpdateSemester').value;
      const spec = document.getElementById('bulkUpdateSpecialization').value;
      
      if (!category && !year && !semester && !spec) {
        showAlert('No changes selected to update', 'warning');
        return;
      }
      
      showConfirmationDialog(
        "Confirm Bulk Update",
        `Are you sure you want to update ${selectedStudents.size} students?`,
        async () => {
          try {
            const db = firebase.firestore();
            let successCount = 0;
            let errorCount = 0;
            
            for (const studentId of selectedStudents) {
              try {
                const snapshot = await db.collection('students').where('ID', '==', studentId).get();
                if (!snapshot.empty) {
                  const studentDoc = snapshot.docs[0];
                  const updateData = {
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || 'admin'
                  };
                  
                  if (category) updateData.Category = category;
                  if (year) updateData.Year = year;
                  if (semester) updateData.Semester = semester;
                  if (spec) updateData.Specialization = spec;
                  
                  await db.collection('students').doc(studentDoc.id).update(updateData);
                  successCount++;
                }
              } catch (err) {
                console.error(`Error updating student ${studentId}:`, err);
                errorCount++;
              }
            }
            
            showAlert(`Bulk update completed. Success: ${successCount}, Failed: ${errorCount}`, successCount > 0 ? 'success' : 'warning');
            closeModal();
            
            selectedStudents.clear();
            showStudentsManagement();
            
          } catch (error) {
            console.error('Bulk update error:', error);
            showAlert('Failed to perform bulk update: ' + error.message, 'danger');
          }
        }
      );
    }

    async function deleteSelectedStudents() {
      if (selectedStudents.size === 0) {
        showAlert('No students selected', 'warning');
        return;
      }
      
      showConfirmationDialog(
        "Delete Selected Students",
        `Are you sure you want to delete ${selectedStudents.size} students? This action cannot be undone.`,
        async () => {
          try {
            const db = firebase.firestore();
            let successCount = 0;
            let errorCount = 0;
            
            for (const studentId of selectedStudents) {
              try {
                const snapshot = await db.collection('students').where('ID', '==', studentId).get();
                if (!snapshot.empty) {
                  await db.collection('students').doc(snapshot.docs[0].id).delete();
                  successCount++;
                }
              } catch (err) {
                console.error(`Error deleting student ${studentId}:`, err);
                errorCount++;
              }
            }
            
            showAlert(`Deletion completed. Deleted: ${successCount}, Failed: ${errorCount}`, successCount > 0 ? 'success' : 'warning');
            
            selectedStudents.clear();
            showStudentsManagement();
            
          } catch (error) {
            console.error('Bulk delete error:', error);
            showAlert('Failed to delete students: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== LEAVE TYPES MANAGEMENT ====================
    async function showLeaveTypesManagement() {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let leaveTypesHTML = '';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th>Max/App</th>
                  <th>Max/Year</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${leaveTypes.map(lt => `
                  <tr>
                    <td><span class="badge badge-primary">${lt.Code || ''}</span></td>
                    <td>${lt.Name || ''}</td>
                    <td>${lt.Description || ''}</td>
                    <td><span class="badge ${lt.ApprovalType === 'credit' ? 'badge-info' : 'badge-warning'}">
                      ${lt.ApprovalType === 'credit' ? 'Credit' : 'Approval'}
                    </span></td>
                    <td>${lt.MaxDaysPerApplication || 0}</td>
                    <td>${lt.MaxDaysPerYear || 0}</td>
                    <td>
                      <span class="badge ${lt.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${lt.Enabled === true ? 'ENABLED' : 'DISABLED'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editLeaveType('${lt.Code}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteLeaveType('${lt.Code}')" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          leaveTypesHTML = '<p>No leave types found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-list-alt"></i> Leave Types Management</h2>
              <button class="btn btn-success" onclick="showAddLeaveTypeModal()">
                <i class="fas fa-plus"></i> Add Leave Type
              </button>
            </div>
            <div class="table-container">
              ${leaveTypesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave types error:', error);
        showAlert('Failed to load leave types: ' + error.message, 'danger');
      }
    }

    function showAddLeaveTypeModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add Leave Type</h2>
          <form onsubmit="addLeaveType(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Code <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeCode" required maxlength="10">
                <small style="color: #666;">Short code (e.g., CL, RH, ML)</small>
              </div>
              <div class="form-group">
                <label>Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeName" required>
                <small style="color: #666;">Full name of the leave type</small>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="leaveTypeDescription" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Approval Type <span style="color: red;">*</span></label>
              <select class="form-control" id="leaveTypeApprovalType" required>
                <option value="credit">Credit-based</option>
                <option value="approval">Approval-based</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Max Days per Application</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerApp" value="5" min="1" required>
              </div>
              <div class="form-group">
                <label>Max Days per Year</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerYear" value="10" min="1" required>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="leaveTypeEnabled" checked> Enabled
              </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Leave Type
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addLeaveType(event) {
      event.preventDefault();
      
      const leaveTypeData = {
        Code: document.getElementById('leaveTypeCode').value.trim().toUpperCase(),
        Name: document.getElementById('leaveTypeName').value.trim(),
        Description: document.getElementById('leaveTypeDescription').value.trim(),
        ApprovalType: document.getElementById('leaveTypeApprovalType').value,
        MaxDaysPerApplication: parseInt(document.getElementById('leaveTypeMaxPerApp').value) || 0,
        MaxDaysPerYear: parseInt(document.getElementById('leaveTypeMaxPerYear').value) || 0,
        Enabled: document.getElementById('leaveTypeEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!leaveTypeData.Code || !leaveTypeData.Name) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('leaveTypes').where('Code', '==', leaveTypeData.Code).get();
        if (!existingSnapshot.empty) {
          showAlert('Leave type code already exists', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').add(leaveTypeData);
        
        showAlert('Leave type added successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        console.error('Add leave type error:', error);
        showAlert('Failed to add leave type: ' + error.message, 'danger');
      }
    }

    async function editLeaveType(code) {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        const leaveType = leaveTypeDoc.data();
        
        const modal = document.getElementById('operationModal');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Leave Type</h2>
            <form onsubmit="updateLeaveType(event, '${code}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Code</label>
                  <input type="text" class="form-control" value="${leaveType.Code}" readonly>
                </div>
                <div class="form-group">
                  <label>Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editLeaveTypeName" value="${leaveType.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="editLeaveTypeDescription" rows="2">${leaveType.Description || ''}</textarea>
              </div>
              <div class="form-group">
                <label>Approval Type <span style="color: red;">*</span></label>
                <select class="form-control" id="editLeaveTypeApprovalType" required>
                  <option value="credit" ${leaveType.ApprovalType === 'credit' ? 'selected' : ''}>Credit-based</option>
                  <option value="approval" ${leaveType.ApprovalType === 'approval' ? 'selected' : ''}>Approval-based</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Max Days per Application</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerApp" value="${leaveType.MaxDaysPerApplication || 0}" min="1" required>
                </div>
                <div class="form-group">
                  <label>Max Days per Year</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerYear" value="${leaveType.MaxDaysPerYear || 0}" min="1" required>
                </div>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editLeaveTypeEnabled" ${leaveType.Enabled === true ? 'checked' : ''}> Enabled
                </label>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Leave Type
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit leave type error:', error);
        showAlert('Failed to load leave type: ' + error.message, 'danger');
      }
    }

    async function updateLeaveType(event, code) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        
        const leaveTypeData = {
          Name: document.getElementById('editLeaveTypeName').value.trim(),
          Description: document.getElementById('editLeaveTypeDescription').value.trim(),
          ApprovalType: document.getElementById('editLeaveTypeApprovalType').value,
          MaxDaysPerApplication: parseInt(document.getElementById('editLeaveTypeMaxPerApp').value) || 0,
          MaxDaysPerYear: parseInt(document.getElementById('editLeaveTypeMaxPerYear').value) || 0,
          Enabled: document.getElementById('editLeaveTypeEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!leaveTypeData.Name) {
          showAlert('Please fill in the required fields', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').doc(leaveTypeDoc.id).update(leaveTypeData);
        
        showAlert('Leave type updated successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        console.error('Update leave type error:', error);
        showAlert('Failed to update leave type: ' + error.message, 'danger');
      }
    }

    async function deleteLeaveType(code) {
      showConfirmationDialog(
        "Delete Leave Type",
        "Are you sure you want to delete this leave type? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
            if (leaveTypesSnapshot.empty) {
              showAlert('Leave type not found', 'danger');
              return;
            }
            
            await db.collection('leaveTypes').doc(leaveTypesSnapshot.docs[0].id).delete();
            
            showAlert('Leave type deleted successfully!', 'success');
            showLeaveTypesManagement();
            
          } catch (error) {
            console.error('Delete leave type error:', error);
            showAlert('Failed to delete leave type: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== CATEGORIES MANAGEMENT ====================
    async function showCategoriesManagement() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let categoriesHTML = '';
        if (categories && categories.length > 0) {
          categoriesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Years</th>
                  <th>Semesters</th>
                  <th>Specializations</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${categories.map(cat => `
                  <tr>
                    <td><strong>${cat.Category || ''}</strong></td>
                    <td>${cat.Years || ''}</td>
                    <td>${cat.Semesters || ''}</td>
                    <td>${cat.Specializations || ''}</td>
                    <td>
                      <span class="badge ${cat.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${cat.Enabled === true ? 'ACTIVE' : 'INACTIVE'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editCategory('${cat.Category}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.Category}')" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          categoriesHTML = '<p>No categories found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-users-cog"></i> Categories Management</h2>
              <button class="btn btn-success" onclick="showAddCategoryModal()">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>
            <div class="table-container">
              ${categoriesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Categories error:', error);
        showAlert('Failed to load categories: ' + error.message, 'danger');
      }
    }

    function showAddCategoryModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add New Category</h2>
          <form onsubmit="addCategory(event)">
            <div class="form-group">
              <label>Category Name <span style="color: red;">*</span></label>
              <input type="text" class="form-control" id="categoryName" required>
              <small style="color: #666;">e.g., M.Tech, B.Tech, PhD</small>
            </div>
            
            <div class="form-group">
              <label>Years (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categoryYears" rows="2" required>1st Year, 2nd Year, 3rd Year, 4th Year</textarea>
              <small style="color: #666;">Enter years separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Semesters (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySemesters" rows="2" required>Semester 1, Semester 2, Semester 3, Semester 4</textarea>
              <small style="color: #666;">Enter semesters separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Specializations (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySpecializations" rows="2" required>Computer Science, IT, ECE, Mechanical</textarea>
              <small style="color: #666;">Enter specializations separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="categoryEnabled" checked> Active
              </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Category
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addCategory(event) {
      event.preventDefault();
      
      const categoryData = {
        Category: document.getElementById('categoryName').value.trim(),
        Years: document.getElementById('categoryYears').value.trim(),
        Semesters: document.getElementById('categorySemesters').value.trim(),
        Specializations: document.getElementById('categorySpecializations').value.trim(),
        Enabled: document.getElementById('categoryEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('categories').where('Category', '==', categoryData.Category).get();
        if (!existingSnapshot.empty) {
          showAlert('Category already exists', 'warning');
          return;
        }
        
        await db.collection('categories').add(categoryData);
        
        showAlert('Category added successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        console.error('Add category error:', error);
        showAlert('Failed to add category: ' + error.message, 'danger');
      }
    }

    async function editCategory(categoryName) {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', categoryName).get();
        
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        const category = categoryDoc.data();
        
        const modal = document.getElementById('operationModal');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Category</h2>
            <form onsubmit="updateCategory(event, '${categoryName}')">
              <div class="form-group">
                <label>Category Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="editCategoryName" value="${category.Category || ''}" required>
              </div>
              
              <div class="form-group">
                <label>Years (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategoryYears" rows="2" required>${category.Years || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Semesters (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySemesters" rows="2" required>${category.Semesters || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Specializations (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySpecializations" rows="2" required>${category.Specializations || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editCategoryEnabled" ${category.Enabled === true ? 'checked' : ''}> Active
                </label>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Category
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit category error:', error);
        showAlert('Failed to load category: ' + error.message, 'danger');
      }
    }

    async function updateCategory(event, oldCategoryName) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', oldCategoryName).get();
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        
        const categoryData = {
          Category: document.getElementById('editCategoryName').value.trim(),
          Years: document.getElementById('editCategoryYears').value.trim(),
          Semesters: document.getElementById('editCategorySemesters').value.trim(),
          Specializations: document.getElementById('editCategorySpecializations').value.trim(),
          Enabled: document.getElementById('editCategoryEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('categories').doc(categoryDoc.id).update(categoryData);
        
        showAlert('Category updated successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        console.error('Update category error:', error);
        showAlert('Failed to update category: ' + error.message, 'danger');
      }
    }

    async function deleteCategory(categoryName) {
      showConfirmationDialog(
        "Delete Category",
        "Are you sure you want to delete this category? All students in this category will be affected.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const categoriesSnapshot = await db.collection('categories').where('Category', '==', categoryName).get();
            if (categoriesSnapshot.empty) {
              showAlert('Category not found', 'danger');
              return;
            }
            
            await db.collection('categories').doc(categoriesSnapshot.docs[0].id).delete();
            
            showAlert('Category deleted successfully!', 'success');
            showCategoriesManagement();
            
          } catch (error) {
            console.error('Delete category error:', error);
            showAlert('Failed to delete category: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== LEAVE APPROVALS ====================
    async function filterApprovalList() {
      const filters = {
        search: document.getElementById('approvalSearch').value.toLowerCase(),
        studentId: document.getElementById('filterApprovalStudentId').value,
        leaveType: document.getElementById('filterApprovalLeaveType').value
      };
      
      await saveFilterState('leaveApprovals', filters);
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = filterApplications(applications, filters);
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderApprovalsTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> pending applications
          `;
        }
      } catch (error) {
        console.error('Filter approval error:', error);
      }
    }

    function filterApplications(applications, filters) {
      return applications.filter(app => {
        if (filters.search) {
          const searchMatch = 
            (app.StudentID && app.StudentID.toString().toLowerCase().includes(filters.search)) ||
            (app.StudentName && app.StudentName.toLowerCase().includes(filters.search)) ||
            (app.ID && app.ID.toString().toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.studentId && app.StudentID !== filters.studentId) return false;
        if (filters.leaveType && app.LeaveType !== filters.leaveType) return false;
        
        return true;
      });
    }

    async function clearApprovalFilters() {
      const filters = {
        search: '',
        studentId: '',
        leaveType: ''
      };
      
      await saveFilterState('leaveApprovals', filters);
      
      if (document.getElementById('approvalSearch')) document.getElementById('approvalSearch').value = '';
      if (document.getElementById('filterApprovalStudentId')) document.getElementById('filterApprovalStudentId').value = '';
      if (document.getElementById('filterApprovalLeaveType')) document.getElementById('filterApprovalLeaveType').value = '';
      
      filterApprovalList();
    }

    async function viewApplicationDetails(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        
        let studentName = 'Unknown';
        let studentEmail = 'No email';
        if (app.StudentID) {
          const studentsSnapshot = await db.collection('students').where('ID', '==', app.StudentID).get();
          if (!studentsSnapshot.empty) {
            studentName = studentsSnapshot.docs[0].data().Name;
            studentEmail = studentsSnapshot.docs[0].data().Email || 'No email';
          }
        }
        
        const modal = document.getElementById('operationModal');
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-info-circle"></i> Application Details</h2>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
              <h3>Application ID: ${app.ID}</h3>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">Student ID:</span>
                  <span class="info-value">${app.StudentID}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Student Name:</span>
                  <span class="info-value">${studentName}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Student Email:</span>
                  <span class="info-value">${studentEmail}</span>
                </div>
              </div>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">Leave Type:</span>
                  <span class="info-value">${app.LeaveType}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Status:</span>
                  <span class="info-value badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                    ${(app.Status || '').toUpperCase()}
                  </span>
                </div>
              </div>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">From Date:</span>
                  <span class="info-value">${formatDate(app.FromDate)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">To Date:</span>
                  <span class="info-value">${formatDate(app.ToDate)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Days:</span>
                  <span class="info-value">${app.NoOfDays}</span>
                </div>
              </div>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">Applied Date:</span>
                  <span class="info-value">${formatDate(app.AppliedDate)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Semester:</span>
                  <span class="info-value">${app.Semester || 'N/A'}</span>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <strong>Reason:</strong>
                <p style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">${app.Reason || 'No reason provided'}</p>
              </div>
              ${app.ApprovedDate ? `
                <div style="margin-top: 15px;">
                  <strong>Approved Date:</strong>
                  <p>${formatDate(app.ApprovedDate)}</p>
                </div>
              ` : ''}
              <div style="margin-top: 15px;">
                <strong>Applied By:</strong>
                <p>${app.AppliedBy || 'Admin'}</p>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              ${app.Status === 'pending' ? `
                <button class="btn btn-success" onclick="approveLeave('${app.id}')" style="flex: 1;">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger" onclick="rejectLeave('${app.id}')" style="flex: 1;">
                  <i class="fas fa-times"></i> Reject
                </button>
              ` : ''}
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('View application error:', error);
        showAlert('Failed to load application details: ' + error.message, 'danger');
      }
    }

    // ==================== LEAVE HISTORY ====================
    async function filterHistoryList() {
      const filters = {
        search: document.getElementById('historySearch').value.toLowerCase(),
        status: document.getElementById('filterStatus').value,
        leaveType: document.getElementById('filterLeaveType').value,
        studentId: document.getElementById('filterStudentId').value
      };
      
      await saveFilterState('leaveHistory', filters);
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        let applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = filterLeaveHistory(applications, filters);
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderLeaveHistoryTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> applications
          `;
        }
      } catch (error) {
        console.error('Filter history error:', error);
      }
    }

    function filterLeaveHistory(applications, filters) {
      return applications.filter(app => {
        if (filters.search) {
          const searchMatch = 
            (app.StudentID && app.StudentID.toString().toLowerCase().includes(filters.search)) ||
            (app.StudentName && app.StudentName.toLowerCase().includes(filters.search)) ||
            (app.ID && app.ID.toString().toLowerCase().includes(filters.search)) ||
            (app.Reason && app.Reason.toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.status && app.Status !== filters.status) return false;
        if (filters.leaveType && app.LeaveType !== filters.leaveType) return false;
        if (filters.studentId && app.StudentID !== filters.studentId) return false;
        
        return true;
      });
    }

    async function clearHistoryFilters() {
      const filters = {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      };
      
      await saveFilterState('leaveHistory', filters);
      
      if (document.getElementById('historySearch')) document.getElementById('historySearch').value = '';
      if (document.getElementById('filterStatus')) document.getElementById('filterStatus').value = '';
      if (document.getElementById('filterLeaveType')) document.getElementById('filterLeaveType').value = '';
      if (document.getElementById('filterStudentId')) document.getElementById('filterStudentId').value = '';
      
      filterHistoryList();
    }

    async function editLeaveApplication(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        
        let studentName = 'Unknown';
        if (app.StudentID) {
          const studentSnapshot = await db.collection('students').where('ID', '==', app.StudentID).get();
          if (!studentSnapshot.empty) {
            studentName = studentSnapshot.docs[0].data().Name;
          }
        }
        
        const modal = document.getElementById('operationModal');
        
        const fromDate = app.FromDate ? app.FromDate.split('T')[0] : '';
        const toDate = app.ToDate ? app.ToDate.split('T')[0] : '';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Leave Application #${app.ID}</h2>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Editing application for: <strong>${studentName}</strong> (${app.StudentID})
            </div>
            
            <form onsubmit="updateLeaveApplicationForm(event, '${applicationId}')">
              <div class="form-row">
                <div class="form-group">
                  <label>From Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="editLeaveFromDate" value="${fromDate}" required>
                </div>
                <div class="form-group">
                  <label>To Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="editLeaveToDate" value="${toDate}" required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Number of Days <span style="color: red;">*</span></label>
                  <input type="number" class="form-control" id="editLeaveNoOfDays" value="${app.NoOfDays || 0}" min="1" required>
                </div>
                <div class="form-group">
                  <label>Leave Type</label>
                  <input type="text" class="form-control" value="${app.LeaveType || ''}" readonly>
                </div>
              </div>
              
              <div class="form-group">
                <label>Reason for Leave <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editLeaveReason" rows="4" required>${app.Reason || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Status <span style="color: red;">*</span></label>
                <select class="form-control" id="editLeaveStatus" required>
                  <option value="pending" ${app.Status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="approved" ${app.Status === 'approved' ? 'selected' : ''}>Approved</option>
                  <option value="rejected" ${app.Status === 'rejected' ? 'selected' : ''}>Rejected</option>
                </select>
              </div>
              
              <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>Current Information:</h4>
                <p><strong>Applied Date:</strong> ${formatDate(app.AppliedDate)}</p>
                <p><strong>Current Status:</strong> ${(app.Status || '').toUpperCase()}</p>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Application
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        document.getElementById('editLeaveFromDate').addEventListener('change', calculateEditDays);
        document.getElementById('editLeaveToDate').addEventListener('change', calculateEditDays);
        
        function calculateEditDays() {
          const fromDate = new Date(document.getElementById('editLeaveFromDate').value);
          const toDate = new Date(document.getElementById('editLeaveToDate').value);
          
          if (fromDate && toDate && fromDate <= toDate) {
            const timeDiff = toDate.getTime() - fromDate.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            document.getElementById('editLeaveNoOfDays').value = dayDiff > 0 ? dayDiff : 1;
          }
        }
        
      } catch (error) {
        console.error('Edit application error:', error);
        showAlert('Failed to load application: ' + error.message, 'danger');
      }
    }

    async function deleteLeaveApplication(applicationId) {
      showConfirmationDialog(
        "Delete Leave Application",
        "Are you sure you want to delete this leave application? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            await db.collection('leaveApplications').doc(applicationId).delete();
            
            showAlert('Leave application deleted successfully!', 'success');
            showLeaveHistory();
            
          } catch (error) {
            console.error('Delete application error:', error);
            showAlert('Failed to delete application: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== YEAR CREDITS MANAGEMENT ====================
    async function showYearCreditsManagement() {
      try {
        const db = firebase.firestore();
        
        const yearCreditsSnapshot = await db.collection('yearCredits').get();
        const yearCredits = yearCreditsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let creditsHTML = '';
        if (yearCredits && yearCredits.length > 0) {
          let tableHeaders = '<tr><th>Category</th><th>Year</th>';
          creditLeaveTypes.forEach(lt => {
            tableHeaders += `<th>${lt.Code} (${lt.Name})</th>`;
          });
          tableHeaders += '<th>Status</th><th>Last Updated</th><th>Actions</th></tr>';
          
          let tableRows = '';
          yearCredits.forEach(yc => {
            tableRows += '<tr>';
            tableRows += `<td>${yc.Category || ''}</td>`;
            tableRows += `<td>${yc.Year || ''}</td>`;
            
            creditLeaveTypes.forEach(lt => {
              const value = yc[lt.Code] || 0;
              tableRows += `<td><span class="badge badge-info">${value}</span></td>`;
            });
            
            tableRows += `<td>
              <span class="badge ${yc.Active === true ? 'badge-success' : 'badge-danger'}">
                ${yc.Active === true ? 'ACTIVE' : 'INACTIVE'}
              </span>
            </td>`;
            
            tableRows += `<td>${yc.updatedAt ? formatDate(yc.updatedAt) : 'N/A'}</td>`;
            
            tableRows += `<td>
              <div class="year-credit-actions">
                <button class="btn btn-sm btn-primary" onclick="editYearCredit('${yc.Category}', '${yc.Year}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteYearCredit('${yc.Category}', '${yc.Year}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm btn-info" onclick="viewYearCreditDetails('${yc.Category}', '${yc.Year}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </td></tr>`;
          });
          
          creditsHTML = `
            <div class="table-container">
              <table class="data-table">
                <thead>${tableHeaders}</thead>
                <tbody>${tableRows}</tbody>
              </table>
            </div>
          `;
        } else {
          creditsHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Year Credits Found</h3>
              <p>Add year credits for different categories and years to manage student leave balances.</p>
            </div>
          `;
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-calendar-alt"></i> Year Credits Management</h2>
              <button class="btn btn-success" onclick="showAddYearCreditModal()">
                <i class="fas fa-plus"></i> Add Year Credit
              </button>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>How Year Credits Work:</strong> Year credits determine how many leave days students have available for credit-based leave types (CL, EL, etc.). Each student's available balance = Total Credits - Used Approved Leaves.
            </div>
            
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card">
                <h3>${yearCredits.length}</h3>
                <p>Total Credit Records</p>
              </div>
              <div class="stat-card">
                <h3>${creditLeaveTypes.length}</h3>
                <p>Credit Leave Types</p>
              </div>
              <div class="stat-card">
                <h3>${categories.length}</h3>
                <p>Categories</p>
              </div>
            </div>
            
            ${creditsHTML}
          </div>
        `;
        
      } catch (error) {
        console.error('Year credits error:', error);
        showAlert('Failed to load year credits: ' + error.message, 'danger');
      }
    }

    function showAddYearCreditModal() {
      Promise.all([
        firebase.firestore().collection('categories').get(),
        firebase.firestore().collection('leaveTypes').get(),
        firebase.firestore().collection('yearCredits').get()
      ]).then(([categoriesSnapshot, leaveTypesSnapshot, existingCreditsSnapshot]) => {
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        const existingCredits = existingCreditsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const activeCategories = (categories || []).filter(c => c.Enabled === true);
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const existingCombinations = new Set();
        existingCredits.forEach(credit => {
          existingCombinations.add(`${credit.Category}|${credit.Year}`);
        });
        
        const modal = document.getElementById('operationModal');
        
        let creditFields = '';
        if (creditLeaveTypes.length > 0) {
          creditFields = creditLeaveTypes.map(lt => `
            <div class="form-group">
              <label>${lt.Name} (${lt.Code}) - Max per year: ${lt.MaxDaysPerYear || 'Unlimited'}</label>
              <input type="number" class="form-control" id="credit_${lt.Code}" value="0" min="0" max="${lt.MaxDaysPerYear || 999}" required>
              <small style="color: #666;">Maximum allowed: ${lt.MaxDaysPerYear || 'Unlimited'} days</small>
            </div>
          `).join('');
        } else {
          creditFields = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              No credit-based leave types found. Please add credit leave types first.
            </div>
          `;
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-plus"></i> Add Year Credit</h2>
            <form onsubmit="addYearCredit(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>Category <span style="color: red;">*</span></label>
                  <select class="form-control" id="yearCreditCategory" required onchange="updateYearOptionsForYearCredits(this.value)">
                    <option value="">Select Category</option>
                    ${activeCategories.map(cat => `
                      <option value="${cat.Category}">${cat.Category}</option>
                    `).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label>Year <span style="color: red;">*</span></label>
                  <select class="form-control" id="yearCreditYear" required>
                    <option value="">Select Year</option>
                  </select>
                </div>
              </div>
              
              <div id="duplicateWarning" style="display: none; margin-bottom: 15px;" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>A credit record for this category and year already exists. Editing will update the existing record.</span>
              </div>
              
              <h4 style="margin: 20px 0 10px 0;">Leave Credits</h4>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                ${creditFields}
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="yearCreditActive" checked> Active
                </label>
                <small style="color: #666; display: block;">Inactive credits won't be used for student balance calculations</small>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" ${creditLeaveTypes.length === 0 ? 'disabled' : ''}>
                  <i class="fas fa-save"></i> Save Year Credit
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        window.updateYearOptionsForYearCredits = async function(category) {
          const yearSelect = document.getElementById('yearCreditYear');
          const warningDiv = document.getElementById('duplicateWarning');
          
          if (category) {
            try {
              const categoriesSnapshot = await firebase.firestore().collection('categories').where('Category', '==', category).get();
              if (!categoriesSnapshot.empty) {
                const selectedCat = categoriesSnapshot.docs[0].data();
                const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
                
                yearSelect.innerHTML = '<option value="">Select Year</option>' + 
                  years.map(year => `<option value="${year}">${year}</option>`).join('');
                
                yearSelect.onchange = function() {
                  const selectedYear = this.value;
                  if (selectedYear) {
                    const combination = `${category}|${selectedYear}`;
                    if (existingCombinations.has(combination)) {
                      warningDiv.style.display = 'flex';
                    } else {
                      warningDiv.style.display = 'none';
                    }
                  }
                };
              }
            } catch (error) {
              console.error('Error loading years:', error);
            }
          } else {
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            warningDiv.style.display = 'none';
          }
        };
        
      }).catch(error => {
        console.error('Add year credit modal error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      });
    }

    async function addYearCredit(event) {
      event.preventDefault();
      
      const category = document.getElementById('yearCreditCategory').value;
      const year = document.getElementById('yearCreditYear').value;
      const active = document.getElementById('yearCreditActive').checked;
      
      if (!category || !year) {
        showAlert('Please select category and year', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const existingSnapshot = await db.collection('yearCredits')
          .where('Category', '==', category)
          .where('Year', '==', year)
          .get();
        
        const creditData = {
          Category: category,
          Year: year,
          Active: active,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        let hasValues = false;
        creditLeaveTypes.forEach(lt => {
          const input = document.getElementById(`credit_${lt.Code}`);
          if (input) {
            const value = parseInt(input.value) || 0;
            creditData[lt.Code] = value;
            if (value > 0) hasValues = true;
          }
        });
        
        if (!hasValues) {
          showAlert('Please set at least one credit value', 'warning');
          return;
        }
        
        if (!existingSnapshot.empty) {
          await db.collection('yearCredits').doc(existingSnapshot.docs[0].id).update(creditData);
          showAlert('Year credit updated successfully!', 'success');
        } else {
          creditData.createdAt = new Date().toISOString();
          creditData.createdBy = currentUser?.email || 'admin';
          await db.collection('yearCredits').add(creditData);
          showAlert('Year credit added successfully!', 'success');
        }
        
        closeModal();
        showYearCreditsManagement();
        
      } catch (error) {
        console.error('Add year credit error:', error);
        showAlert('Failed to save year credit: ' + error.message, 'danger');
      }
    }

    async function editYearCredit(category, year) {
      try {
        const db = firebase.firestore();
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', category)
          .where('Year', '==', year)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          showAlert('Year credit not found', 'danger');
          return;
        }
        
        const creditDoc = yearCreditsSnapshot.docs[0];
        const credit = creditDoc.data();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', category).get();
        const selectedCategory = !categoriesSnapshot.empty ? categoriesSnapshot.docs[0].data() : null;
        
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const modal = document.getElementById('operationModal');
        
        let creditFields = '';
        creditLeaveTypes.forEach(lt => {
          const value = credit[lt.Code] || 0;
          creditFields += `
            <div class="form-group">
              <label>${lt.Name} (${lt.Code}) - Max per year: ${lt.MaxDaysPerYear || 'Unlimited'}</label>
              <input type="number" class="form-control" id="editCredit_${lt.Code}" value="${value}" min="0" max="${lt.MaxDaysPerYear || 999}" required>
              <small style="color: #666;">Current value: ${value} days</small>
            </div>
          `;
        });
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Year Credit</h2>
            <form onsubmit="updateYearCredit(event, '${category}', '${year}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Category</label>
                  <input type="text" class="form-control" value="${credit.Category}" readonly>
                </div>
                <div class="form-group">
                  <label>Year</label>
                  <select class="form-control" id="editYearCreditYear" required>
                    ${selectedCategory && selectedCategory.Years ? 
                      selectedCategory.Years.split(',').map(y => y.trim()).map(yr => 
                        `<option value="${yr}" ${credit.Year === yr ? 'selected' : ''}>${yr}</option>`
                      ).join('') : 
                      `<option value="${credit.Year}">${credit.Year}</option>`
                    }
                  </select>
                </div>
              </div>
              
              <h4 style="margin: 20px 0 10px 0;">Leave Credits</h4>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                ${creditFields}
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editYearCreditActive" ${credit.Active === true ? 'checked' : ''}> Active
                </label>
              </div>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Last updated:</strong> ${credit.updatedAt ? formatDate(credit.updatedAt) : 'Never'} by ${credit.updatedBy || 'Unknown'}
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Year Credit
                </button>
                <button type="button" class="btn btn-danger" style="flex: 1;" onclick="deleteYearCredit('${category}', '${year}')">
                  <i class="fas fa-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit year credit error:', error);
        showAlert('Failed to load year credit: ' + error.message, 'danger');
      }
    }

    async function updateYearCredit(event, oldCategory, oldYear) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const year = document.getElementById('editYearCreditYear').value;
        const active = document.getElementById('editYearCreditActive').checked;
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', oldCategory)
          .where('Year', '==', oldYear)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          showAlert('Year credit not found', 'danger');
          return;
        }
        
        const creditDoc = yearCreditsSnapshot.docs[0];
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const updateData = {
          Year: year,
          Active: active,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        let hasValues = false;
        creditLeaveTypes.forEach(lt => {
          const input = document.getElementById(`editCredit_${lt.Code}`);
          if (input) {
            const value = parseInt(input.value) || 0;
            updateData[lt.Code] = value;
            if (value > 0) hasValues = true;
          }
        });
        
        if (!hasValues) {
          showAlert('Please set at least one credit value', 'warning');
          return;
        }
        
        await db.collection('yearCredits').doc(creditDoc.id).update(updateData);
        
        showAlert('Year credit updated successfully!', 'success');
        closeModal();
        showYearCreditsManagement();
        
      } catch (error) {
        console.error('Update year credit error:', error);
        showAlert('Failed to update year credit: ' + error.message, 'danger');
      }
    }

    async function deleteYearCredit(category, year) {
      showConfirmationDialog(
        "Delete Year Credit",
        `Are you sure you want to delete year credits for ${category} - ${year}? This will affect leave balance calculations for all students in this category/year.`,
        async () => {
          try {
            const db = firebase.firestore();
            
            const yearCreditsSnapshot = await db.collection('yearCredits')
              .where('Category', '==', category)
              .where('Year', '==', year)
              .get();
            
            if (yearCreditsSnapshot.empty) {
              showAlert('Year credit not found', 'danger');
              return;
            }
            
            await db.collection('yearCredits').doc(yearCreditsSnapshot.docs[0].id).delete();
            
            showAlert('Year credit deleted successfully!', 'success');
            showYearCreditsManagement();
            
          } catch (error) {
            console.error('Delete year credit error:', error);
            showAlert('Failed to delete year credit: ' + error.message, 'danger');
          }
        }
      );
    }

    function viewYearCreditDetails(category, year) {
      showAlert(`Viewing details for ${category} - ${year}`, 'info');
    }

    // ==================== STUDENT LEAVE BALANCE ====================
    async function loadStudentLeaveBalance() {
      if (firebase.apps.length === 0) {
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Firebase not configured. Cannot load leave balance.
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .where('Active', '==', true)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>No Leave Credits Found</strong>
              <p>No credit records found for ${student.Category} - ${student.Year}. Please contact administrator.</p>
            </div>
          `;
          return;
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .where('Status', '==', 'approved')
          .get();
        
        const approvedLeaves = applicationsSnapshot.docs.map(doc => doc.data());
        
        const usedCredits = {};
        approvedLeaves.forEach(app => {
          if (!usedCredits[app.LeaveType]) {
            usedCredits[app.LeaveType] = 0;
          }
          usedCredits[app.LeaveType] += app.NoOfDays || 0;
        });
        
        const leaveTypesSnapshot = await db.collection('leaveTypes')
          .where('ApprovalType', '==', 'credit')
          .where('Enabled', '==', true)
          .get();
        
        const creditLeaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        if (creditLeaveTypes.length === 0) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Credit Leave Types</h3>
              <p>No credit-based leave types have been configured.</p>
            </div>
          `;
          return;
        }
        
        let balanceHTML = '';
        let hasAnyCredits = false;
        
        creditLeaveTypes.forEach(lt => {
          const totalCredits = yearCredit[lt.Code] || 0;
          const used = usedCredits[lt.Code] || 0;
          const remaining = Math.max(0, totalCredits - used);
          
          if (totalCredits > 0) hasAnyCredits = true;
          
          balanceHTML += `
            <div class="leave-balance-card" style="border-top-color: ${totalCredits > 0 ? '#27ae60' : '#95a5a6'}">
              <div class="leave-name">${lt.Name} (${lt.Code})</div>
              <div class="leave-count ${remaining === 0 ? 'text-danger' : ''}">${remaining}</div>
              <div>Days Available</div>
              <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                Total: ${totalCredits} | Used: ${used}
              </div>
              ${lt.MaxDaysPerYear ? `
                <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">
                  Max/Year: ${lt.MaxDaysPerYear}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        if (!hasAnyCredits) {
          balanceHTML = `
            <div class="alert alert-warning" style="grid-column: 1/-1;">
              <i class="fas fa-exclamation-triangle"></i>
              No credit values have been set for ${student.Category} - ${student.Year}. Please contact administrator.
            </div>
          ` + balanceHTML;
        }
        
        document.getElementById('leaveBalanceContainer').innerHTML = balanceHTML;
        
      } catch (error) {
        console.error('Load leave balance error:', error);
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave balance: ${error.message}
          </div>
        `;
      }
    }

    // ==================== BULK UPLOAD ====================
    let uploadedData = [];

    function showBulkUpload() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-file-upload"></i> Bulk Student Upload</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Upload a CSV file with student data. Required columns: Student ID, Name, Category, Year, Semester, Specialization, Email, Phone
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-primary" onclick="downloadSampleTemplate()">
                <i class="fas fa-download"></i> Download Sample Template
              </button>
            </div>
            
            <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
              <h3>Click to Upload CSV File</h3>
              <p>Supports .csv files with comma separator</p>
              <p><small>Maximum file size: 5MB</small></p>
            </div>
            
            <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleBulkUpload(event)">
            
            <div id="uploadPreview" style="display: none; margin-top: 20px;">
              <h3>Preview (First 10 rows)</h3>
              <div id="previewTable" class="file-preview"></div>
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-success" onclick="processBulkUpload()">
                  <i class="fas fa-check"></i> Confirm Upload
                </button>
                <button class="btn btn-danger" onclick="clearUpload()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
            
            <div id="uploadResult" style="display: none; margin-top: 20px;"></div>
          </div>
        </div>
      `;
      
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleBulkUpload({ target: { files: files } });
        }
      });
    }

    function downloadSampleTemplate() {
      const csvContent = [
        ['Student ID', 'Name', 'Category', 'Year', 'Semester', 'Specialization', 'Email', 'Phone'],
        ['S001', 'John Doe', 'B.Tech', '2nd Year', 'Semester 3', 'Computer Science', 'john@example.com', '1234567890'],
        ['S002', 'Jane Smith', 'B.Tech', '1st Year', 'Semester 1', 'Information Technology', 'jane@example.com', '0987654321']
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "student_upload_template.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Template downloaded successfully!', 'success');
    }

    function handleBulkUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        showAlert('File size exceeds 5MB limit', 'danger');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = [];
          const lines = text.split('\n');
          
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const row = [];
            let current = '';
            let insideQuotes = false;
            
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              
              if (char === '"') {
                insideQuotes = !insideQuotes;
              } else if (char === ',' && !insideQuotes) {
                row.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            row.push(current.trim());
            rows.push(row);
          }
          
          if (rows.length < 2) {
            showAlert('CSV file must have at least a header row and one data row', 'warning');
            return;
          }
          
          const previewDiv = document.getElementById('uploadPreview');
          const previewTable = document.getElementById('previewTable');
          
          let previewHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
          previewHTML += '<thead><tr style="background: #f8f9fa;">';
          rows[0].forEach((cell, index) => {
            previewHTML += `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${cell}</th>`;
          });
          previewHTML += '</tr></thead><tbody>';
          
          const previewRows = Math.min(10, rows.length - 1);
          for (let i = 1; i <= previewRows; i++) {
            previewHTML += '<tr>';
            rows[i].forEach((cell, index) => {
              previewHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
            });
            previewHTML += '</tr>';
          }
          previewHTML += '</tbody></table>';
          
          if (rows.length > 11) {
            previewHTML += `<p style="text-align: center; color: #666; margin-top: 10px;">... and ${rows.length - 11} more rows</p>`;
          }
          
          previewTable.innerHTML = previewHTML;
          previewDiv.style.display = 'block';
          document.getElementById('uploadArea').style.display = 'none';
          
          uploadedData = rows.slice(1).filter(row => row.length >= 3 && row[0] && row[1] && row[2]);
          
          showAlert(`Loaded ${uploadedData.length} student records for upload`, 'info');
          
        } catch (error) {
          console.error('CSV parsing error:', error);
          showAlert('Error parsing CSV file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function processBulkUpload() {
      if (uploadedData.length === 0) {
        showAlert('No data to upload!', 'warning');
        return;
      }
      
      showAlert(`Processing ${uploadedData.length} student records...`, 'info');
      
      try {
        const db = firebase.firestore();
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        const existingSnapshot = await db.collection('students').get();
        const existingIds = new Set();
        existingSnapshot.docs.forEach(doc => {
          existingIds.add(doc.data().ID);
        });
        
        for (const row of uploadedData) {
          try {
            const studentId = row[0];
            
            if (existingIds.has(studentId)) {
              errors.push(`Student ID ${studentId} already exists - skipped`);
              errorCount++;
              continue;
            }
            
            const studentData = {
              ID: studentId,
              Name: row[1],
              Category: row[2],
              Year: row[3] || '',
              Semester: row[4] || '',
              Specialization: row[5] || '',
              Email: row[6] || '',
              Phone: row[7] || '',
              createdAt: new Date().toISOString(),
              createdBy: currentUser?.email || 'admin'
            };
            
            await db.collection('students').add(studentData);
            successCount++;
            
            existingIds.add(studentId);
            
          } catch (err) {
            errors.push(`Error adding student ${row[0]}: ${err.message}`);
            errorCount++;
          }
        }
        
        const resultDiv = document.getElementById('uploadResult');
        let resultHTML = `
          <div class="alert ${successCount > 0 ? 'alert-success' : 'alert-warning'}">
            <i class="fas ${successCount > 0 ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
            <div>
              <strong>Upload Complete</strong>
              <p>Successfully uploaded: ${successCount} students</p>
              <p>Errors: ${errorCount}</p>
            </div>
          </div>
        `;
        
        if (errors.length > 0) {
          resultHTML += `
            <div class="alert alert-danger" style="margin-top: 15px;">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Errors encountered:</strong>
                <ul style="margin: 10px 0 0 20px; max-height: 200px; overflow-y: auto;">
                  ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        resultDiv.innerHTML = resultHTML;
        resultDiv.style.display = 'block';
        
        if (successCount > 0) {
          setTimeout(() => {
            showStudentsManagement();
          }, 3000);
        }
        
      } catch (error) {
        console.error('Bulk upload error:', error);
        showAlert('Failed to process upload: ' + error.message, 'danger');
      }
    }

    function clearUpload() {
      uploadedData = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadPreview').style.display = 'none';
      document.getElementById('uploadResult').style.display = 'none';
      document.getElementById('uploadArea').style.display = 'block';
    }

    // ==================== REPORTS ====================
    function showReports() {
      const contentDiv = document.getElementById('adminMainContent');
      
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      const lastMonthStr = lastMonth.toISOString().split('T')[0];
      
      loadFilterState('reports').then(savedFilters => {
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-bar"></i> Reports</h2>
            </div>
            <div style="padding: 20px;">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Generate reports with date range filters. Export to PDF available.
              </div>
              
              <div style="margin: 20px 0;">
                <div class="form-row">
                  <div class="form-group">
                    <label>From Date</label>
                    <input type="date" class="form-control" id="reportFromDate" value="${savedFilters.fromDate || lastMonthStr}">
                  </div>
                  <div class="form-group">
                    <label>To Date</label>
                    <input type="date" class="form-control" id="reportToDate" value="${savedFilters.toDate || today}">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Report Type</label>
                  <select class="form-control" id="reportType">
                    <option value="all" ${savedFilters.reportType === 'all' ? 'selected' : ''}>All Leave Applications</option>
                    <option value="pending" ${savedFilters.reportType === 'pending' ? 'selected' : ''}>Pending Applications</option>
                    <option value="approved" ${savedFilters.reportType === 'approved' ? 'selected' : ''}>Approved Applications</option>
                    <option value="rejected" ${savedFilters.reportType === 'rejected' ? 'selected' : ''}>Rejected Applications</option>
                    <option value="students" ${savedFilters.reportType === 'students' ? 'selected' : ''}>Student List</option>
                  </select>
                </div>
                
                <div style="margin-top: 20px;">
                  <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-search"></i> Generate Report
                  </button>
                  <button class="btn btn-pdf" onclick="exportToPDF()" style="margin-left: 10px;">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                  </button>
                  <button class="btn btn-secondary" onclick="clearReportFilters()" style="margin-left: 10px;">
                    <i class="fas fa-times"></i> Clear Filters
                  </button>
                </div>
              </div>
              
              <div id="reportResult"></div>
            </div>
          </div>
        `;
      });
    }

    async function generateReport() {
      const fromDate = document.getElementById('reportFromDate').value;
      const toDate = document.getElementById('reportToDate').value;
      const reportType = document.getElementById('reportType').value;
      
      await saveFilterState('reports', {
        fromDate: fromDate,
        toDate: toDate,
        reportType: reportType
      });
      
      showAlert('Generating report...', 'info');
      
      try {
        const db = firebase.firestore();
        let data = [];
        let title = '';
        
        if (reportType === 'students') {
          const snapshot = await db.collection('students').get();
          data = snapshot.docs.map(doc => doc.data());
          data.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
          title = 'Student List Report';
        } else {
          let query = db.collection('leaveApplications');
          
          if (reportType !== 'all') {
            query = query.where('Status', '==', reportType);
          }
          
          const snapshot = await query.get();
          let applications = snapshot.docs.map(doc => doc.data());
          
          if (fromDate) {
            applications = applications.filter(app => app.FromDate >= fromDate);
          }
          if (toDate) {
            applications = applications.filter(app => app.ToDate <= toDate);
          }
          
          applications.sort((a, b) => (a.ID || '').localeCompare(b.ID || ''));
          
          const studentsSnapshot = await db.collection('students').get();
          const studentsMap = {};
          studentsSnapshot.docs.forEach(doc => {
            const student = doc.data();
            studentsMap[student.ID] = student.Name;
          });
          
          applications.forEach(app => {
            app.StudentName = studentsMap[app.StudentID] || 'Unknown';
          });
          
          data = applications;
          title = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Leave Applications Report`;
        }
        
        const reportResult = {
          title: title,
          fromDate: fromDate,
          toDate: toDate,
          generatedDate: new Date().toLocaleString(),
          total: data.length,
          data: data
        };
        
        currentReportData = reportResult;
        currentReportType = reportType;
        
        displayReport(reportResult, reportType);
        
      } catch (error) {
        console.error('Generate report error:', error);
        showAlert('Failed to generate report: ' + error.message, 'danger');
      }
    }

    function displayReport(reportData, reportType) {
      const reportDiv = document.getElementById('reportResult');
      
      let reportHTML = `
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> ${reportData.title}</h3>
            <div>
              <span class="badge badge-info">Total: ${reportData.total || 0}</span>
              <button class="btn btn-sm btn-pdf" onclick="exportCurrentReportToPDF()" style="margin-left: 10px;">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
          <div style="padding: 15px;">
            <p><strong>Date Range:</strong> ${reportData.fromDate ? formatDate(reportData.fromDate) : 'Any'} to ${reportData.toDate ? formatDate(reportData.toDate) : 'Any'}</p>
            <p><strong>Generated:</strong> ${reportData.generatedDate}</p>
      `;
      
      if (reportData.data && reportData.data.length > 0) {
        if (reportType === 'students') {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Specialization</th>
                    <th>Email</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(student => `
                    <tr>
                      <td>${student.ID || ''}</td>
                      <td>${student.Name || ''}</td>
                      <td>${student.Category || ''}</td>
                      <td>${student.Year || 'N/A'}</td>
                      <td>${student.Semester || 'N/A'}</td>
                      <td>${student.Specialization || 'N/A'}</td>
                      <td>${student.Email || 'N/A'}</td>
                      <td>${student.Phone || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Application ID</th>
                    <th>Student</th>
                    <th>Leave Type</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Days</th>
                    <th>Status</th>
                    <th>Applied Date</th>
                    <th>Semester</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(app => `
                    <tr>
                      <td>${app.ID || ''}</td>
                      <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                      <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                      <td>${formatDate(app.FromDate)}</td>
                      <td>${formatDate(app.ToDate)}</td>
                      <td>${app.NoOfDays || 0}</td>
                      <td>
                        <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                          ${(app.Status || '').toUpperCase()}
                        </span>
                      </td>
                      <td>${formatDate(app.AppliedDate)}</td>
                      <td>${app.Semester || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } else {
        reportHTML += '<p>No data found for the selected criteria.</p>';
      }
      
      reportHTML += `
          </div>
        </div>
      `;
      
      reportDiv.innerHTML = reportHTML;
      
      showAlert('Report generated successfully', 'success');
    }

    async function clearReportFilters() {
      const filters = {
        fromDate: '',
        toDate: '',
        reportType: 'all'
      };
      
      await saveFilterState('reports', filters);
      
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      const lastMonthStr = lastMonth.toISOString().split('T')[0];
      
      if (document.getElementById('reportFromDate')) document.getElementById('reportFromDate').value = lastMonthStr;
      if (document.getElementById('reportToDate')) document.getElementById('reportToDate').value = today;
      if (document.getElementById('reportType')) document.getElementById('reportType').value = 'all';
      
      document.getElementById('reportResult').innerHTML = '';
      currentReportData = null;
    }

    function exportToPDF() {
      if (!currentReportData) {
        showAlert('Please generate a report first', 'warning');
        return;
      }
      
      exportCurrentReportToPDF();
    }

    function exportCurrentReportToPDF() {
      if (!currentReportData) {
        showAlert('No report data available', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      doc.setFontSize(20);
      doc.setTextColor(40, 40, 40);
      doc.text("Student Leave Management System", 150, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(currentReportData.title, 150, 30, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Date Range: ${currentReportData.fromDate ? formatDate(currentReportData.fromDate) : 'Any'} to ${currentReportData.toDate ? formatDate(currentReportData.toDate) : 'Any'}`, 14, 40);
      doc.text(`Generated: ${currentReportData.generatedDate}`, 14, 46);
      doc.text(`Total Records: ${currentReportData.total}`, 14, 52);
      
      let startY = 60;
      
      if (currentReportData.data.length > 0) {
        if (currentReportType === 'students') {
          const headers = [['Student ID', 'Name', 'Category', 'Year', 'Semester', 'Specialization', 'Email', 'Phone']];
          const rows = currentReportData.data.map(student => [
            student.ID || '',
            student.Name || '',
            student.Category || '',
            student.Year || 'N/A',
            student.Semester || 'N/A',
            student.Specialization || 'N/A',
            student.Email || 'N/A',
            student.Phone || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] },
            margin: { top: 10 }
          });
        } else {
          const headers = [['App ID', 'Student ID', 'Student Name', 'Leave Type', 'From Date', 'To Date', 'Days', 'Status', 'Semester']];
          const rows = currentReportData.data.map(app => [
            app.ID || '',
            app.StudentID || '',
            app.StudentName || '',
            app.LeaveType || '',
            formatDate(app.FromDate),
            formatDate(app.ToDate),
            app.NoOfDays || 0,
            (app.Status || '').toUpperCase(),
            app.Semester || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] },
            margin: { top: 10 }
          });
        }
      } else {
        doc.text('No data found for the selected criteria.', 14, startY);
      }
      
      const fileName = `${currentReportData.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      showAlert('PDF exported successfully!', 'success');
    }

    // ==================== BACKUP MANAGEMENT ====================
    async function showBackupManagement() {
      const contentDiv = document.getElementById('adminMainContent');
      const lastBackup = await loadBackupTimestamp();
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-database"></i> Backup & Restore</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Note:</strong> This is a simplified backup system. For production use, use Firebase Console's export feature.
              <br>Backup timestamps are now stored in Firestore.
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <h3 id="studentCount">0</h3>
                <p>Students</p>
              </div>
              <div class="stat-card">
                <h3 id="applicationCount">0</h3>
                <p>Applications</p>
              </div>
              <div class="stat-card">
                <h3 id="backupTime">${lastBackup ? formatDate(lastBackup) : 'Never'}</h3>
                <p>Last Backup</p>
              </div>
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-success" onclick="createFirestoreBackup()" style="margin-right: 10px;">
                <i class="fas fa-save"></i> Export Data (JSON)
              </button>
              <button class="btn btn-primary" onclick="importFirestoreBackup()">
                <i class="fas fa-upload"></i> Import Data (JSON)
              </button>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>Backup History:</strong> All backup timestamps are saved to Firestore.
            </div>
          </div>
        </div>
      `;
      
      loadBackupStats();
    }

    async function loadBackupStats() {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        const studentCountEl = document.getElementById('studentCount');
        const applicationCountEl = document.getElementById('applicationCount');
        
        if (studentCountEl) studentCountEl.textContent = studentsSnapshot.size;
        if (applicationCountEl) applicationCountEl.textContent = applicationsSnapshot.size;
        
        const lastBackup = await loadBackupTimestamp();
        const backupTimeEl = document.getElementById('backupTime');
        if (backupTimeEl) {
          backupTimeEl.textContent = lastBackup ? formatDate(lastBackup) : 'Never';
        }
        
      } catch (error) {
        console.error('Load backup stats error:', error);
      }
    }

    async function createFirestoreBackup() {
      showAlert('Exporting data...', 'info');
      
      try {
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins', 'systemSettings', 'userFilters'];
        const backupData = {};
        
        for (const collection of collections) {
          const snapshot = await db.collection(collection).get();
          backupData[collection] = snapshot.docs.map(doc => ({
            id: doc.id,
            data: doc.data()
          }));
        }
        
        backupData.timestamp = new Date().toISOString();
        backupData.version = '2.0';
        
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `firestore_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        await saveBackupTimestamp(new Date().toISOString());
        
        showAlert('Data exported successfully! Backup timestamp saved to Firestore.', 'success');
        
        const backupTimeEl = document.getElementById('backupTime');
        if (backupTimeEl) {
          backupTimeEl.textContent = formatDate(new Date().toISOString());
        }
        
      } catch (error) {
        console.error('Export error:', error);
        showAlert('Failed to export data: ' + error.message, 'danger');
      }
    }

    function importFirestoreBackup() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-upload"></i> Import Backup</h2>
          
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> This will overwrite ALL existing data. This action cannot be undone.
          </div>
          
          <div class="file-upload-area" onclick="document.getElementById('importFileInput').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
            <h3>Click to Select Backup File</h3>
            <p>Select a JSON backup file</p>
          </div>
          
          <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
              Cancel
            </button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          showConfirmationDialog(
            "Confirm Import",
            `This will import ${Object.keys(backupData).length} collections and overwrite all existing data. Are you sure?`,
            async () => {
              await processImport(backupData);
            }
          );
          
        } catch (error) {
          console.error('Parse backup error:', error);
          showAlert('Invalid backup file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function processImport(backupData) {
      showAlert('Importing data... This may take a moment.', 'info');
      
      try {
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins', 'systemSettings', 'userFilters'];
        
        for (const collection of collections) {
          if (backupData[collection]) {
            const snapshot = await db.collection(collection).get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          }
        }
        
        for (const collection of collections) {
          if (backupData[collection] && backupData[collection].length > 0) {
            const batch = db.batch();
            backupData[collection].forEach(item => {
              const docRef = db.collection(collection).doc(item.id);
              batch.set(docRef, item.data);
            });
            await batch.commit();
          }
        }
        
        showAlert('Data imported successfully!', 'success');
        closeModal();
        
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('Import error:', error);
        showAlert('Failed to import data: ' + error.message, 'danger');
      }
    }

    // ==================== FIREBASE CONFIGURATION PANEL ====================
    function showFirebaseConfigPanel() {
      const contentDiv = document.getElementById('adminMainContent');
      const isConfigured = firebase.apps.length > 0;
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-fire"></i> Firebase Configuration</h2>
            <span class="badge ${isConfigured ? 'badge-success' : 'badge-danger'}">
              ${isConfigured ? 'CONNECTED' : 'NOT CONNECTED'}
            </span>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Firestore Storage:</strong> Configuration will be stored in Firestore for all users.
          </div>
          
          <div class="connection-status">
            <div class="status-indicator ${isConfigured ? 'success' : 'error'}"></div>
            <div>
              <strong>Status:</strong> 
              ${isConfigured ? 'Firebase is connected and ready' : 'Firebase is not configured'}
            </div>
          </div>
          
          ${!isConfigured ? `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              Firebase is not configured. Please enter your Firebase configuration below.
            </div>
          ` : ''}
          
          <form onsubmit="saveFirebaseConfig(event)">
            <h3 style="margin: 20px 0 10px 0;">1. Firebase Configuration</h3>
            <div class="form-group">
              <label>apiKey</label>
              <input type="text" class="form-control" id="fb_apiKey" required 
                     value="">
            </div>
            <div class="form-group">
              <label>authDomain</label>
              <input type="text" class="form-control" id="fb_authDomain" required
                     value="">
            </div>
            <div class="form-group">
              <label>projectId</label>
              <input type="text" class="form-control" id="fb_projectId" required
                     value="">
            </div>
            <div class="form-group">
              <label>storageBucket</label>
              <input type="text" class="form-control" id="fb_storageBucket" required
                     value="">
            </div>
            <div class="form-group">
              <label>messagingSenderId</label>
              <input type="text" class="form-control" id="fb_messagingSenderId" required
                     value="">
            </div>
            <div class="form-group">
              <label>appId</label>
              <input type="text" class="form-control" id="fb_appId" required
                     value="">
            </div>
            <div class="form-group">
              <label>measurementId (optional)</label>
              <input type="text" class="form-control" id="fb_measurementId"
                     value="">
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">2. Connection Test</h3>
            <button type="button" class="btn btn-info" onclick="testFirebaseConnection()" style="margin-bottom: 20px;">
              <i class="fas fa-plug"></i> Test Connection
            </button>
            <div id="connectionTestResult"></div>
            
            <h3 style="margin: 20px 0 10px 0;">3. Security Rules</h3>
            <div class="security-rule-card">
              <div class="rule-header">
                <strong>Firestore Security Rules</strong>
                <span class="badge badge-success">Recommended</span>
              </div>
              <p>Copy and paste these rules in Firebase Console  Firestore Database  Rules</p>
              <div class="rule-code">
                rules_version = '2';<br>
                service cloud.firestore {<br>
                &nbsp;&nbsp;match /databases/{database}/documents {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Admin access<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /admins/{adminId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.auth.uid == adminId;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Students collection<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /students/{studentId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists(/databases/$(database)/documents/admins/$(request.auth.uid));<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Leave applications<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /leaveApplications/{appId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource.data.StudentID == request.auth.uid);<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// System settings<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /systemSettings/{settingId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists(/databases/$(database)/documents/admins/$(request.auth.uid));<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// User filters<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /userFilters/{filterId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resource.data.userId == request.auth.uid;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Leave types<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /leaveTypes/{typeId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists(/databases/$(database)/documents/admins/$(request.auth.uid));<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Categories<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /categories/{categoryId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists(/databases/$(database)/documents/admins/$(request.auth.uid));<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                &nbsp;&nbsp;&nbsp;&nbsp;// Year credits<br>
                &nbsp;&nbsp;&nbsp;&nbsp;match /yearCredits/{creditId} {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null && <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists(/databases/$(database)/documents/admins/$(request.auth.uid));<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                &nbsp;&nbsp;}<br>
                }
              </div>
            </div>
            
            <div class="security-rule-card">
              <div class="rule-header">
                <strong>Authentication Settings</strong>
                <span class="badge badge-success">Required</span>
              </div>
              <p>Enable these sign-in methods in Firebase Console  Authentication  Sign-in method</p>
              <ul style="margin-left: 20px;">
                <li>Email/Password - Enabled</li>
              </ul>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save & Connect
              </button>
              ${isConfigured ? `
                <button type="button" class="btn btn-danger" onclick="clearFirebaseConfig()" style="flex: 1;">
                  <i class="fas fa-trash"></i> Clear Config
                </button>
              ` : ''}
            </div>
          </form>
        </div>
      `;
    }

    async function saveFirebaseConfig(event) {
      event.preventDefault();
      
      const config = {
        apiKey: document.getElementById('fb_apiKey').value,
        authDomain: document.getElementById('fb_authDomain').value,
        projectId: document.getElementById('fb_projectId').value,
        storageBucket: document.getElementById('fb_storageBucket').value,
        messagingSenderId: document.getElementById('fb_messagingSenderId').value,
        appId: document.getElementById('fb_appId').value
      };
      
      const measurementId = document.getElementById('fb_measurementId').value;
      if (measurementId) config.measurementId = measurementId;
      
      await saveFirebaseConfigToFirestore(config);
      
      localStorage.setItem('firebaseConfig', JSON.stringify(config));
      
      showAlert('Initializing Firebase...', 'info');
      
      const result = initializeFirebase(config);
      
      if (result.success) {
        showAlert('Firebase connected successfully! Configuration saved to Firestore.', 'success');
        await initializeDefaultData();
        showFirebaseConfigPanel();
      } else {
        showAlert('Firebase connection failed: ' + result.error, 'danger');
      }
    }

    async function testFirebaseConnection() {
      const resultDiv = document.getElementById('connectionTestResult');
      resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Testing connection...</div>';
      
      try {
        if (firebase.apps.length === 0) {
          throw new Error('Firebase not initialized');
        }
        
        const db = firebase.firestore();
        await db.collection('test').doc('test').get();
        
        resultDiv.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>Connection Successful!</strong>
              <p> Firestore is accessible</p>
              <p> Authentication is working</p>
              <p>Project: ${firebase.app().options.projectId}</p>
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-times-circle"></i>
            <div>
              <strong>Connection Failed!</strong>
              <p>Error: ${error.message}</p>
              <p>Please check your Firebase configuration.</p>
            </div>
          </div>
        `;
      }
    }

    async function initializeDefaultData() {
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').limit(1).get();
        
        if (leaveTypesSnapshot.empty) {
          const defaultLeaveTypes = [
            { Code: 'CL', Name: 'Casual Leave', Description: 'For casual/emergency leaves', ApprovalType: 'credit', MaxDaysPerApplication: 5, MaxDaysPerYear: 12, Enabled: true },
            { Code: 'RH', Name: 'Restricted Holiday', Description: 'Optional holidays', ApprovalType: 'approval', MaxDaysPerApplication: 1, MaxDaysPerYear: 2, Enabled: true },
            { Code: 'ML', Name: 'Medical Leave', Description: 'For medical reasons', ApprovalType: 'approval', MaxDaysPerApplication: 10, MaxDaysPerYear: 20, Enabled: true },
            { Code: 'EL', Name: 'Earned Leave', Description: 'Accumulated leave', ApprovalType: 'credit', MaxDaysPerApplication: 15, MaxDaysPerYear: 30, Enabled: true }
          ];
          
          for (const lt of defaultLeaveTypes) {
            await db.collection('leaveTypes').add(lt);
          }
        }
        
        const categoriesSnapshot = await db.collection('categories').limit(1).get();
        
        if (categoriesSnapshot.empty) {
          const defaultCategories = [
            { 
              Category: 'B.Tech', 
              Years: '1st Year,2nd Year,3rd Year,4th Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4,Semester 5,Semester 6,Semester 7,Semester 8',
              Specializations: 'Computer Science,Information Technology,Electronics,Mechanical,Civil,Electrical',
              Enabled: true
            },
            { 
              Category: 'M.Tech', 
              Years: '1st Year,2nd Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4',
              Specializations: 'Computer Science,Electronics,Mechanical,Structural Engineering',
              Enabled: true
            }
          ];
          
          for (const cat of defaultCategories) {
            await db.collection('categories').add(cat);
          }
        }
        
        console.log('Default data initialized');
        
      } catch (error) {
        console.error('Error initializing default data:', error);
      }
    }

    function clearFirebaseConfig() {
      showConfirmationDialog(
        "Clear Configuration",
        "This will remove Firebase configuration from Firestore and localStorage. Continue?",
        async () => {
          try {
            if (firebase.apps.length > 0) {
              const db = firebase.firestore();
              await db.collection(SETTINGS_COLLECTION).doc('firebaseConfig').delete();
            }
          } catch (error) {
            console.error('Error removing from Firestore:', error);
          }
          
          localStorage.removeItem('firebaseConfig');
          
          showAlert('Configuration cleared. Refreshing page...', 'success');
          
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      );
    }

    // ==================== STUDENT DASHBOARD HOME ====================
    function showStudentDashboardHome() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
              <div style="width: 60px; height: 60px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                <i class="fas fa-user-graduate"></i>
              </div>
              <div>
                <h3 style="margin-bottom: 5px;">${student.Name || 'Student'}</h3>
                <p style="color: #666; margin: 0;">
                  ${student.ID || ''} | ${student.Category || ''} ${student.Year ? '- ' + student.Year : ''}
                  ${student.Semester ? '| ' + student.Semester : ''}
                  ${student.Specialization ? '| ' + student.Specialization : ''}
                  ${student.Email ? '| Email: ' + student.Email : ''}
                </p>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Quick Info</h3>
              <div class="stats-grid">
                <div class="stat-card">
                  <h3 id="studentTotalLeaves">0</h3>
                  <p>Total Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentApprovedLeaves">0</h3>
                  <p>Approved Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentPendingLeaves">0</h3>
                  <p>Pending Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentCreditTypes">0</h3>
                  <p>Credit Types</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentStats();
    }

    async function loadStudentStats() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('StudentID', '==', student.ID).get();
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        
        const total = applications.length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const pending = applications.filter(app => app.Status === 'pending').length;
        
        const totalEl = document.getElementById('studentTotalLeaves');
        const approvedEl = document.getElementById('studentApprovedLeaves');
        const pendingEl = document.getElementById('studentPendingLeaves');
        
        if (totalEl) totalEl.textContent = total;
        if (approvedEl) approvedEl.textContent = approved;
        if (pendingEl) pendingEl.textContent = pending;
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
        const creditTypesEl = document.getElementById('studentCreditTypes');
        if (creditTypesEl) creditTypesEl.textContent = leaveTypesSnapshot.size;
        
      } catch (error) {
        console.error('Load student stats error:', error);
      }
    }

    function showStudentLeaveBalance() {
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> My Leave Balance</h2>
          </div>
          <div style="padding: 20px;">
            <div class="leave-balance-container" id="leaveBalanceContainer">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave balance...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveBalance();
    }

    function showStudentLeaveHistory() {
      const contentDiv = document.getElementById('studentMainContent');
      const student = currentStudent || currentUser;
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> My Leave History</h2>
          </div>
          <div style="padding: 20px;">
            <div class="table-container" id="studentHistoryTable">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave history...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveHistory();
    }

    async function loadStudentLeaveHistory() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .orderBy('AppliedDate', 'desc')
          .get();
        
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tableDiv = document.getElementById('studentHistoryTable');
        
        if (applications.length === 0) {
          tableDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Leave Applications Found</h3>
              <p>You haven't applied for any leaves yet.</p>
            </div>
          `;
          return;
        }
        
        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Application ID</th>
                <th>Leave Type</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>Days</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Applied Date</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        applications.forEach(app => {
          tableHTML += `
            <tr>
              <td>${app.ID || ''}</td>
              <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
              <td>${formatDate(app.FromDate)}</td>
              <td>${formatDate(app.ToDate)}</td>
              <td>${app.NoOfDays || 0}</td>
              <td>${app.Reason || ''}</td>
              <td>
                <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                  ${(app.Status || '').toUpperCase()}
                </span>
              </td>
              <td>${formatDate(app.AppliedDate)}</td>
            </tr>
          `;
        });
        
        tableHTML += '</tbody></table>';
        tableDiv.innerHTML = tableHTML;
        
      } catch (error) {
        console.error('Load student history error:', error);
        document.getElementById('studentHistoryTable').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave history: ${error.message}
          </div>
        `;
      }
    }

    function showAdminProfile() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-circle"></i> Admin Profile</h2>
          <div style="padding: 20px;">
            <p><strong>Name:</strong> ${currentUser?.name || 'Administrator'}</p>
            <p><strong>Email:</strong> ${currentUser?.email || 'N/A'}</p>
            <p><strong>Role:</strong> Administrator</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function showStudentProfile() {
      const student = currentStudent || currentUser;
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-circle"></i> Student Profile</h2>
          <div style="padding: 20px;">
            <p><strong>Student ID:</strong> ${student?.ID || 'N/A'}</p>
            <p><strong>Name:</strong> ${student?.Name || 'N/A'}</p>
            <p><strong>Category:</strong> ${student?.Category || 'N/A'}</p>
            <p><strong>Year:</strong> ${student?.Year || 'N/A'}</p>
            <p><strong>Semester:</strong> ${student?.Semester || 'N/A'}</p>
            <p><strong>Specialization:</strong> ${student?.Specialization || 'N/A'}</p>
            <p><strong>Email:</strong> ${student?.Email || 'N/A'}</p>
            <p><strong>Phone:</strong> ${student?.Phone || 'N/A'}</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function showBackupHistory() {
      showAlert('Backup history feature coming soon!', 'info');
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      const mainContent = currentRole === 'admin' ? document.getElementById('adminMainContent') : document.getElementById('studentMainContent');
      if (mainContent && mainContent.firstChild) {
        mainContent.insertBefore(alertDiv, mainContent.firstChild);
      } else if (mainContent) {
        mainContent.appendChild(alertDiv);
      } else {
        const loginCard = document.querySelector('.login-card');
        if (loginCard) {
          loginCard.insertBefore(alertDiv, loginCard.firstChild);
        }
      }
      
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function closeModal() {
      document.getElementById('operationModal').style.display = 'none';
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return 'N/A';
      }
    }

    function formatDateForStorage(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return date.toISOString().split('T')[0];
      } catch (e) {
        return '';
      }
    }

    function formatDateDDMMYYYY(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return 'N/A';
      }
    }

    function showConfirmationDialog(title, message, confirmCallback, cancelCallback) {
      const overlay = document.createElement('div');
      overlay.className = 'confirmation-overlay';
      
      const dialog = document.createElement('div');
      dialog.className = 'confirmation-dialog';
      dialog.innerHTML = `
        <h3 style="margin-bottom: 10px;">${title}</h3>
        <p style="color: #666; margin-bottom: 20px;">${message}</p>
        <div class="confirmation-buttons">
          <button class="btn btn-danger" onclick="window.confirmAction()">Confirm</button>
          <button class="btn btn-secondary" onclick="window.cancelAction()">Cancel</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      window.confirmAction = function() {
        if (confirmCallback) confirmCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
      
      window.cancelAction = function() {
        if (cancelCallback) cancelCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
    }

    function closeConfirmationDialog() {
      const overlay = document.querySelector('.confirmation-overlay');
      if (overlay) overlay.remove();
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async function() {
      await loadFirebaseConfig();
      
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          if (currentRole === 'admin') {
            refreshAdminData();
          } else if (currentRole === 'student') {
            refreshStudentData();
          }
        }
        
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>