<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Leave Management System - Firebase</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Add jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #17a2b8;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --admin-color: #8e44ad;
      --student-color: #16a085;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 2.2rem;
    }

    .role-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
    }

    .role-btn {
      padding: 18px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .role-btn i {
      font-size: 1.3rem;
    }

    .admin-btn {
      background: var(--admin-color);
      color: white;
    }

    .admin-btn:hover {
      background: #7d3c98;
      transform: translateY(-2px);
    }

    .student-btn {
      background: var(--student-color);
      color: white;
    }

    .student-btn:hover {
      background: #138a72;
      transform: translateY(-2px);
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #27ae60;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #e74c3c;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #f39c12;
    }

    .close-btn {
      margin-left: auto;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .close-btn:hover {
      opacity: 1;
    }

    /* Dashboard Styles */
    .dashboard-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      min-height: 90vh;
      display: none;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-right button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right button:hover {
      background: rgba(255,255,255,0.3);
    }

    .dashboard-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 0;
      min-height: calc(90vh - 100px);
    }

    .sidebar {
      background: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #e9ecef;
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .menu-btn {
      width: 100%;
      text-align: left;
      padding: 12px 15px;
      border: none;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--dark);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid transparent;
    }

    .menu-btn.active {
      background: var(--secondary);
      color: white;
      border-left-color: var(--primary);
    }

    .menu-btn:hover:not(.active) {
      background: #e9ecef;
      border-left-color: #adb5bd;
    }

    .main-content {
      padding: 25px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
      transition: opacity 0.3s ease;
    }

    .main-content.hidden {
      opacity: 0;
    }

    .main-content.visible {
      opacity: 1;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .card-header h2 {
      color: var(--primary);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #d6eaf8; color: #1a5276; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .offline-notice {
      background: #fff3cd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #f39c12;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 5px solid var(--secondary);
    }

    .stat-card h3 {
      color: var(--secondary);
      font-size: 2rem;
      margin: 5px 0;
    }

    .leave-balance-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .leave-balance-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border-top: 5px solid #3498db;
    }

    .leave-count {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .leave-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    /* Refresh Button */
    .refresh-btn {
      background: var(--info);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #138496;
      transform: rotate(180deg);
    }

    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .student-info-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--secondary);
    }

    .student-info-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    /* Search Results Dropdown */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ced4da;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 5px;
    }

    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s ease;
    }

    .search-result-item:hover {
      background: #f8f9fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-id {
      font-weight: 600;
      color: var(--primary);
    }

    .search-result-name {
      color: #666;
      font-size: 0.9rem;
    }

    /* PDF Button */
    .btn-pdf {
      background: #e74c3c;
      color: white;
    }

    .btn-pdf:hover {
      background: #c0392b;
    }

    /* Filter styles */
    .filters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .search-box {
      position: relative;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-box input {
      padding-left: 35px;
    }

    /* Backup styles */
    .backup-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .backup-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .backup-stat {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .backup-stat h3 {
      font-size: 2rem;
      margin: 10px 0;
    }

    /* Confirmation dialog */
    .confirmation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .confirmation-dialog {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 400px;
      width: 90%;
    }

    .confirmation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Backup list styles */
    .backup-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .backup-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backup-info h4 {
      margin-bottom: 5px;
    }

    .backup-meta {
      font-size: 0.85rem;
      color: #666;
    }

    /* Year credit actions */
    .year-credit-actions {
      display: flex;
      gap: 5px;
    }

    /* Checkbox styles for bulk selection */
    .bulk-select-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .bulk-select-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .bulk-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    /* File upload styles */
    .file-upload-area {
      border: 2px dashed #3498db;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-area:hover {
      background: #e9ecef;
      border-color: #2980b9;
    }

    .file-upload-area.dragover {
      background: #d1ecf1;
      border-color: #17a2b8;
    }

    .file-preview {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 15px;
      padding: 10px;
      background: white;
    }

    /* Profile section styles */
    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      border-radius: 12px;
      color: white;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      border: 3px solid white;
    }

    .profile-info h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .profile-info p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .profile-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .profile-field {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .profile-field label {
      display: block;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .profile-field .value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
    }

    .edit-profile-btn {
      margin-top: 20px;
      padding: 15px 30px;
    }

    /* Security rule styles */
    .security-rule-card {
      background: #f8f9fa;
      border-left: 4px solid var(--success);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .security-rule-card.warning {
      border-left-color: var(--warning);
    }

    .security-rule-card.danger {
      border-left-color: var(--danger);
    }

    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #dee2e6;
    }

    .rule-code {
      background: #1e2b3a !important;
      color: #e6e6e6 !important;
      padding: 15px !important;
      border-radius: 8px !important;
      font-family: 'Courier New', monospace !important;
      font-size: 13px !important;
      overflow-x: auto !important;
      border: 1px solid #34495e !important;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3) !important;
    }

    .rule-code pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #e6e6e6;
      font-family: 'Courier New', monospace;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.success {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }

    .status-indicator.error {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    .status-indicator.warning {
      background: var(--warning);
      box-shadow: 0 0 10px var(--warning);
    }

    /* Email configuration styles */
    .email-config-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .email-template-preview {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background: #f8f9fa;
      max-height: 300px;
      overflow-y: auto;
    }

    .template-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
    }

    .template-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .template-tab.active {
      color: var(--secondary);
      border-bottom: 3px solid var(--secondary);
      background: #e8f4fd;
    }

    .template-tab:hover:not(.active) {
      background: #f8f9fa;
      color: var(--dark);
    }

    /* Validation message styles */
    .validation-message {
      margin-top: 5px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .validation-success {
      color: #27ae60;
    }
    
    .validation-error {
      color: #e74c3c;
    }
    
    .validation-warning {
      color: #f39c12;
    }

    /* Debug Panel */
    .debug-panel {
      background: #1e2b3a;
      color: #fff;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 9999;
      border-radius: 5px;
      max-width: 300px;
      display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid #34495e;
    }

    .debug-panel.visible {
      display: block;
    }

    .debug-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      cursor: pointer;
      padding: 5px;
      background: #2c3e50;
      border-radius: 3px;
    }

    .debug-content {
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }

    .debug-content div {
      margin: 5px 0;
      padding: 3px;
      border-bottom: 1px solid #34495e;
    }

    .debug-content button {
      background: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      width: 100%;
      margin-top: 5px;
    }

    .debug-content button:hover {
      background: #2980b9;
    }

    @media (max-width: 768px) {
      .dashboard-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .login-card {
        padding: 25px;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .header-right {
        flex-direction: column;
        align-items: flex-end;
      }
      
      .filters-container {
        grid-template-columns: 1fr;
      }
      
      .confirmation-dialog {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Debug Panel (hidden by default, press Ctrl+Shift+D to show) -->
  <div id="debugPanel" class="debug-panel">
    <div class="debug-header" onclick="toggleDebugContent()">
      <strong>üîß Firebase Debug</strong>
      <span id="debugToggle">‚ñº</span>
    </div>
    <div id="debugContent" class="debug-content">
      <div id="debugStatus">Initializing...</div>
      <div id="debugProjectId">Project ID: --</div>
      <div id="debugConfigSource">Config Source: --</div>
      <div id="debugError">Error: --</div>
      <button onclick="forceReloadConfig()">üîÑ Force Reload Config</button>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <div class="login-card">
      <h1><i class="fas fa-graduation-cap"></i> Leave Management System</h1>
      <p style="color: #666; margin-bottom: 20px;">Version 5.0 | Enhanced Auto-Load</p>
      
      <div class="role-selector">
        <button onclick="showAdminLoginForm()" class="role-btn admin-btn">
          <i class="fas fa-user-shield"></i> Admin Login
        </button>
        <button onclick="showStudentLoginForm()" class="role-btn student-btn">
          <i class="fas fa-user-graduate"></i> Student Login
        </button>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: #666; font-size: 0.9rem;">
          <i class="fas fa-shield-alt"></i> Secure Authentication System
        </p>
        <p style="color: #666; font-size: 0.8rem; margin-top: 10px;">
          Press <kbd>Ctrl+Shift+D</kbd> for debug panel
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        <p>Welcome, <span id="adminName">Administrator</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="firebaseStatusBadge">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshAdminData()" title="Refresh Data" id="adminRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showAdminProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="showEmailConfig()">
          <i class="fas fa-envelope"></i> Email Config
        </button>
        <button onclick="showConfigHistory()">
          <i class="fas fa-history"></i> Config History
        </button>
        <button onclick="syncConfigurations()">
          <i class="fas fa-sync"></i> Sync Config
        </button>
        <button onclick="logout('admin')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showAdminSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('students')">
            <i class="fas fa-user-graduate"></i> Students
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveTypes')">
            <i class="fas fa-list-alt"></i> Leave Types
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('categories')">
            <i class="fas fa-users-cog"></i> Categories
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('yearCredits')">
            <i class="fas fa-calendar-alt"></i> Year Credits
          </button></li>
          <li><button class="menu-btn" onclick="showLeaveEntryForm()">
            <i class="fas fa-file-signature"></i> Enter Leave Request
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveApprovals')">
            <i class="fas fa-check-circle"></i> Leave Approvals
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveHistory')">
            <i class="fas fa-history"></i> Leave History
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('bulkUpload')">
            <i class="fas fa-file-upload"></i> Bulk Upload
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('reports')">
            <i class="fas fa-chart-bar"></i> Reports
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('backup')">
            <i class="fas fa-database"></i> Backup & Restore
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('firebaseConfig')">
            <i class="fas fa-fire"></i> Firebase Config
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="adminMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Student Dashboard -->
  <div id="studentDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-graduate"></i> Student Dashboard</h1>
        <p>Welcome, <span id="studentName">Student</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="studentFirebaseStatus">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshStudentData()" title="Refresh Data" id="studentRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showStudentProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="logout('student')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showStudentSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveBalance')">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveHistory')">
            <i class="fas fa-history"></i> My Leave History
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="studentMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal for Operations -->
  <div id="operationModal" class="modal"></div>

  <script>
    // ==================== GLOBAL VARIABLES ====================
    let firebaseInitialized = false;
    let currentUser = null;
    let currentRole = null;
    let currentStudent = null;
    let refreshInterval = null;
    let selectedStudentInfo = null;
    
    // Global variables for filtering and reports
    let currentReportData = null;
    let currentReportType = null;
    let currentFromDate = null;
    let currentToDate = null;
    let allStudents = [];
    let selectedStudents = new Set();
    let currentFilters = {
      search: '',
      category: '',
      year: '',
      semester: '',
      specialization: ''
    };

    // Store filter states globally
    let filterStates = {
      students: {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      },
      leaveHistory: {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      },
      leaveApprovals: {
        search: '',
        studentId: '',
        leaveType: ''
      },
      reports: {
        fromDate: '',
        toDate: '',
        reportType: 'all'
      }
    };

    // Default admin credentials
    const DEFAULT_ADMIN_EMAIL = 'admin@leavemanagement.com';
    const DEFAULT_ADMIN_PASSWORD = 'Admin@123';

    // Google Apps Script URL - will be loaded from localStorage
    let GOOGLE_APPS_SCRIPT_URL = localStorage.getItem('googleAppsScriptUrl') || '';

    // ==================== DEBUG FUNCTIONS ====================
    function updateDebugInfo(message, type = 'info') {
      const debugEl = document.getElementById('debugStatus');
      const errorEl = document.getElementById('debugError');
      if (debugEl) debugEl.innerHTML = `Status: ${message}`;
      if (errorEl && type === 'error') errorEl.innerHTML = `Error: ${message}`;
      console.log(`[Firebase Debug] ${message}`);
    }

    function showDebugPanel() {
      document.getElementById('debugPanel').classList.add('visible');
    }

    function toggleDebugContent() {
      const content = document.getElementById('debugContent');
      const toggle = document.getElementById('debugToggle');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }

    // ==================== ENHANCED AUTO-LOAD FUNCTION ====================
    async function autoLoadFirebaseConfig() {
      updateDebugInfo('Starting auto-load...');
      
      try {
        // Check if already initialized
        if (firebase.apps.length > 0) {
          updateDebugInfo('Firebase already initialized');
          document.getElementById('debugProjectId').textContent = `Project ID: ${firebase.app().options.projectId}`;
          return;
        }

        // METHOD 1: Try to load from localStorage first (fastest)
        const savedConfig = localStorage.getItem('firebaseConfig');
        if (savedConfig) {
          try {
            const config = JSON.parse(savedConfig);
            firebase.initializeApp(config);
            window.db = firebase.firestore();
            window.auth = firebase.auth();
            
            updateDebugInfo('‚úÖ Loaded from localStorage');
            document.getElementById('debugConfigSource').textContent = 'Config Source: localStorage';
            document.getElementById('debugProjectId').textContent = `Project ID: ${config.projectId}`;
            
            // Still try to sync with Firestore in background
            setTimeout(() => loadConfigFromFirestore(), 1000);
            return;
          } catch (e) {
            updateDebugInfo('localStorage config invalid: ' + e.message, 'error');
          }
        }

        // METHOD 2: Try to load from Firestore (main method)
        updateDebugInfo('Attempting to load from Firestore...');
        
        // We need to know our project ID to create temp connection
        let projectId = null;
        
        // Try from any saved data
        projectId = projectId || localStorage.getItem('fb_projectId');
        
        // Try to discover from URL
        if (!projectId) {
          const hostname = window.location.hostname;
          if (hostname.includes('github.io')) {
            updateDebugInfo(`Running on GitHub Pages: ${hostname}`);
          }
        }
        
        // If we still don't have projectId, try to discover it
        if (!projectId) {
          updateDebugInfo('No project ID found, attempting discovery...');
          
          // Try to discover project ID by making a request to Firebase
          try {
            // Make a request that might reveal the project ID
            const testConfig = {
              apiKey: "AIzaSyBxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx", // Public key format
              authDomain: window.location.hostname,
              projectId: "temp"
            };
            
            const testApp = firebase.initializeApp(testConfig, "discovery");
            const testDb = testApp.firestore();
            
            // Try to read a non-existent document - this will fail but may reveal project ID
            try {
              await testDb.collection('_discovery_').doc('test').get();
            } catch (e) {
              // Error message might contain project ID
              const match = e.message.match(/projects\/([^/]+)/);
              if (match && match[1]) {
                projectId = match[1];
                updateDebugInfo(`Discovered project ID: ${projectId}`);
              }
            }
            
            // Clean up
            await testApp.delete();
          } catch (e) {
            console.log('Discovery attempt failed:', e);
          }
        }
        
        // If still no project ID, use a default approach
        projectId = projectId || "temp";
        
        // METHOD 3: Try with discovered or default project ID
        const tempConfig = {
          apiKey: "temp",
          authDomain: `${projectId}.firebaseapp.com`,
          projectId: projectId
        };
        
        updateDebugInfo(`Using temp config with projectId: ${projectId}`);
        
        // Initialize temp app
        let tempApp;
        try {
          tempApp = firebase.app('temp');
        } catch {
          tempApp = firebase.initializeApp(tempConfig, 'temp');
        }
        
        const tempDb = tempApp.firestore();
        
        // Set a timeout for the Firestore request
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Firestore request timeout')), 10000)
        );
        
        // Try to read the config
        const docPromise = tempDb.collection('systemConfig').doc('firebase').get();
        
        const doc = await Promise.race([docPromise, timeoutPromise]);
        
        if (doc.exists) {
          const realConfig = doc.data().config;
          
          // Validate the config
          if (!realConfig.apiKey || !realConfig.projectId) {
            throw new Error('Invalid config in Firestore');
          }
          
          // Initialize REAL Firebase
          firebase.initializeApp(realConfig);
          window.db = firebase.firestore();
          window.auth = firebase.auth();
          
          // Save to localStorage for faster future loads
          localStorage.setItem('firebaseConfig', JSON.stringify(realConfig));
          localStorage.setItem('fb_projectId', realConfig.projectId);
          
          updateDebugInfo('‚úÖ Successfully loaded from Firestore!');
          document.getElementById('debugConfigSource').textContent = 'Config Source: Firestore';
          document.getElementById('debugProjectId').textContent = `Project ID: ${realConfig.projectId}`;
          
          console.log('‚úÖ Firebase auto loaded from Firestore');
        } else {
          updateDebugInfo('‚ùå No config found in Firestore', 'error');
          console.log('No Firebase config found in Firestore');
          
          // METHOD 4: Fallback to manual entry
          showManualConfigPrompt();
        }
        
      } catch (error) {
        updateDebugInfo(`‚ùå Auto-load failed: ${error.message}`, 'error');
        console.error('Auto load failed:', error);
        
        // METHOD 5: Final fallback - show manual config form
        showManualConfigPrompt();
      }
    }

    // ==================== MANUAL CONFIG PROMPT ====================
    function showManualConfigPrompt() {
      // Only show if we're on login screen and no Firebase
      if (document.getElementById('loginScreen').style.display !== 'none' && firebase.apps.length === 0) {
        const loginCard = document.querySelector('.login-card');
        if (loginCard) {
          // Check if prompt already exists
          if (document.getElementById('manualConfigPrompt')) return;
          
          const manualDiv = document.createElement('div');
          manualDiv.className = 'alert alert-warning';
          manualDiv.id = 'manualConfigPrompt';
          manualDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>Firebase Configuration Required</strong>
              <p>Please enter your Firebase configuration to continue.</p>
              <button class="btn btn-primary btn-sm" onclick="showFirebaseConfigModal()">
                <i class="fas fa-cog"></i> Configure Now
              </button>
            </div>
          `;
          loginCard.insertBefore(manualDiv, loginCard.firstChild);
        }
      }
    }

    // ==================== FIREBASE CONFIG MODAL (Manual Entry) ====================
    function showFirebaseConfigModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-fire"></i> Firebase Configuration</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your Firebase configuration. You can find this in your Firebase Console.
          </div>
          
          <form onsubmit="saveManualFirebaseConfig(event)">
            <div class="form-group">
              <label>apiKey <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="manual_apiKey" required 
                     placeholder="AIzaSyBxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx">
            </div>
            <div class="form-group">
              <label>authDomain <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="manual_authDomain" required 
                     placeholder="your-project.firebaseapp.com">
            </div>
            <div class="form-group">
              <label>projectId <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="manual_projectId" required 
                     placeholder="your-project-id">
            </div>
            <div class="form-group">
              <label>storageBucket</label>
              <input type="text" class="form-control" id="manual_storageBucket" 
                     placeholder="your-project.appspot.com">
            </div>
            <div class="form-group">
              <label>messagingSenderId</label>
              <input type="text" class="form-control" id="manual_messagingSenderId" 
                     placeholder="123456789012">
            </div>
            <div class="form-group">
              <label>appId</label>
              <input type="text" class="form-control" id="manual_appId" 
                     placeholder="1:123456789012:web:abc123def456">
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="manual_saveToFirestore" checked> 
                Save to Firestore (for auto-load on other devices)
              </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save & Connect
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function saveManualFirebaseConfig(event) {
      event.preventDefault();
      
      const config = {
        apiKey: document.getElementById('manual_apiKey').value.trim(),
        authDomain: document.getElementById('manual_authDomain').value.trim(),
        projectId: document.getElementById('manual_projectId').value.trim(),
        storageBucket: document.getElementById('manual_storageBucket').value.trim(),
        messagingSenderId: document.getElementById('manual_messagingSenderId').value.trim(),
        appId: document.getElementById('manual_appId').value.trim()
      };
      
      const saveToFirestore = document.getElementById('manual_saveToFirestore')?.checked || true;
      
      try {
        // Initialize Firebase
        firebase.initializeApp(config);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        // Save to localStorage
        localStorage.setItem('firebaseConfig', JSON.stringify(config));
        localStorage.setItem('fb_projectId', config.projectId);
        localStorage.setItem('fb_apiKey', config.apiKey);
        localStorage.setItem('fb_authDomain', config.authDomain);
        localStorage.setItem('fb_storageBucket', config.storageBucket);
        localStorage.setItem('fb_messagingSenderId', config.messagingSenderId);
        localStorage.setItem('fb_appId', config.appId);
        
        // Save to Firestore for other devices if requested
        if (saveToFirestore) {
          try {
            await firebase.firestore()
              .collection('systemConfig')
              .doc('firebase')
              .set({ 
                config: config,
                updatedAt: new Date().toISOString()
              });
            console.log('‚úÖ Config saved to Firestore');
          } catch (e) {
            console.log('Could not save to Firestore:', e);
            showAlert('Config saved locally but failed to save to Firestore. Check permissions.', 'warning');
          }
        }
        
        showAlert('Firebase configured successfully!', 'success');
        closeModal();
        
        // Remove manual prompt if exists
        const prompt = document.getElementById('manualConfigPrompt');
        if (prompt) prompt.remove();
        
        updateDebugInfo('‚úÖ Manual config loaded');
        document.getElementById('debugProjectId').textContent = `Project ID: ${config.projectId}`;
        document.getElementById('debugConfigSource').textContent = 'Config Source: Manual Entry';
        
        // Refresh the page to apply changes
        setTimeout(() => {
          window.location.reload();
        }, 1500);
        
      } catch (error) {
        showAlert('Failed to initialize Firebase: ' + error.message, 'danger');
      }
    }

    // ==================== FORCE RELOAD CONFIG ====================
    async function forceReloadConfig() {
      updateDebugInfo('Force reloading config...');
      
      // Clear existing Firebase apps
      try {
        const apps = firebase.apps;
        for (const app of apps) {
          await app.delete();
        }
      } catch (e) {
        console.log('Error deleting apps:', e);
      }
      
      // Reload the page
      window.location.reload();
    }

    // ==================== LOAD CONFIG FROM FIRESTORE (Background) ====================
    async function loadConfigFromFirestore() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const doc = await db.collection('systemConfig').doc('firebase').get();
        
        if (doc.exists) {
          const firestoreConfig = doc.data().config;
          const localConfig = localStorage.getItem('firebaseConfig');
          
          // Compare and update if different
          if (JSON.stringify(firestoreConfig) !== localConfig) {
            console.log('Config updated in Firestore, updating localStorage...');
            localStorage.setItem('firebaseConfig', JSON.stringify(firestoreConfig));
            localStorage.setItem('fb_projectId', firestoreConfig.projectId);
            
            // Show notification to user
            showAlert('Firebase configuration updated. Refresh to apply changes?', 'info');
          }
        }
      } catch (e) {
        console.log('Background sync failed:', e);
      }
    }

    // ==================== FIREBASE INITIALIZATION ====================
    function initializeFirebase(config) {
      try {
        if (firebase.apps.length > 0) {
          return { success: true, message: 'Firebase already initialized' };
        }
        
        firebase.initializeApp(config);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        firebase.firestore().enablePersistence()
          .catch((err) => {
            console.warn('Firebase persistence error:', err);
          });
        
        firebaseInitialized = true;
        updateFirebaseStatusBadges(true);
        
        return { success: true };
      } catch (error) {
        console.error('Firebase initialization error:', error);
        updateFirebaseStatusBadges(false);
        return { success: false, error: error.message };
      }
    }

    function updateFirebaseStatusBadges(isConnected) {
      const adminBadge = document.getElementById('firebaseStatusBadge');
      const studentBadge = document.getElementById('studentFirebaseStatus');
      
      if (adminBadge) {
        adminBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        adminBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
      
      if (studentBadge) {
        studentBadge.textContent = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
        studentBadge.className = isConnected ? 'badge badge-success' : 'badge badge-danger';
      }
    }

    // ==================== CONFIGURATION STORAGE FUNCTIONS ====================
    async function saveFirebaseConfig(event) {
      event.preventDefault();
      
      const config = {
        apiKey: document.getElementById('fb_apiKey').value,
        authDomain: document.getElementById('fb_authDomain').value,
        projectId: document.getElementById('fb_projectId').value,
        storageBucket: document.getElementById('fb_storageBucket').value,
        messagingSenderId: document.getElementById('fb_messagingSenderId').value,
        appId: document.getElementById('fb_appId').value
      };
      
      const measurementId = document.getElementById('fb_measurementId').value;
      if (measurementId) config.measurementId = measurementId;
      
      // Save to localStorage
      localStorage.setItem('firebaseConfig', JSON.stringify(config));
      localStorage.setItem('fb_apiKey', config.apiKey);
      localStorage.setItem('fb_authDomain', config.authDomain);
      localStorage.setItem('fb_projectId', config.projectId);
      localStorage.setItem('fb_storageBucket', config.storageBucket);
      localStorage.setItem('fb_messagingSenderId', config.messagingSenderId);
      localStorage.setItem('fb_appId', config.appId);
      if (measurementId) localStorage.setItem('fb_measurementId', measurementId);
      
      showAlert('Initializing Firebase...', 'info');
      
      const result = initializeFirebase(config);
      
      if (result.success) {
        // Save to Firestore if Firebase is now initialized
        try {
          const db = firebase.firestore();
          
          // Save to system config collection
          await db.collection('systemConfig').doc('firebase').set({
            config: config,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system',
            version: '1.0'
          });
          
          // Also save as a backup
          await db.collection('configBackups').add({
            type: 'firebase',
            config: config,
            timestamp: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system'
          });
          
          showAlert('Firebase connected and configuration saved to database!', 'success');
        } catch (dbError) {
          console.error('Error saving config to Firestore:', dbError);
          showAlert('Firebase connected but config could not be saved to database. Check permissions.', 'warning');
        }
        
        await initializeDefaultData();
        showFirebaseConfigPanel();
      } else {
        showAlert('Firebase connection failed: ' + result.error, 'danger');
      }
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    function showAdminLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
          <form onsubmit="adminLogin(event)">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="adminEmail" required 
                     placeholder="Enter your registered email">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" class="form-control" id="adminPassword" required 
                     placeholder="Enter your password">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
              <button type="button" class="btn btn-link" onclick="showForgotPasswordModal()" 
                      style="color: var(--secondary); padding: 0; background: none; border: none; cursor: pointer;">
                <i class="fas fa-key"></i> Forgot Password?
              </button>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;" id="adminLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function adminLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      
      const loginBtn = document.getElementById('adminLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Verifying...';
      loginBtn.disabled = true;
      
      try {
        // Check if Firebase is configured
        const isFirebaseConfigured = localStorage.getItem('firebaseConfig') !== null;
        
        if (!isFirebaseConfigured) {
          // First-time login with default credentials
          if (email === DEFAULT_ADMIN_EMAIL && password === DEFAULT_ADMIN_PASSWORD) {
            currentUser = {
              uid: 'default-admin',
              email: DEFAULT_ADMIN_EMAIL,
              name: 'Administrator',
              role: 'admin'
            };
            currentRole = 'admin';
            
            showAlert('Welcome, Administrator! Please configure Firebase to continue.', 'info');
            closeModal();
            showAdminDashboard();
            
            // Automatically show Firebase config panel
            setTimeout(() => {
              showFirebaseConfigPanel();
            }, 500);
            
            return;
          } else {
            showAlert('Invalid credentials. First-time login requires default credentials.', 'danger');
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
            return;
          }
        }
        
        // Firebase is configured - use Firebase Auth
        if (firebase.apps.length === 0) {
          showAlert('Firebase configuration error. Please reconfigure.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        // Attempt Firebase Authentication
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        
        // Verify this is an admin account
        const adminDoc = await firebase.firestore().collection('admins').doc(userCredential.user.uid).get();
        
        if (adminDoc.exists) {
          // Admin exists - login successful
          currentUser = {
            uid: userCredential.user.uid,
            email: userCredential.user.email,
            name: adminDoc.data().name || 'Administrator',
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Welcome back, Administrator!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        } else {
          // User exists but not in admins collection - create admin record
          await firebase.firestore().collection('admins').doc(userCredential.user.uid).set({
            email: email,
            name: email.split('@')[0],
            role: 'admin',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          
          currentUser = {
            uid: userCredential.user.uid,
            email: email,
            name: email.split('@')[0],
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Admin account created! Welcome!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        }
        
      } catch (error) {
        console.error('Admin login error:', error);
        
        // Handle specific Firebase Auth errors
        switch(error.code) {
          case 'auth/user-not-found':
            showAlert('No account found with this email. Please contact administrator.', 'danger');
            break;
          case 'auth/wrong-password':
            showAlert('Incorrect password. Please try again or use "Forgot Password".', 'danger');
            break;
          case 'auth/invalid-email':
            showAlert('Invalid email format.', 'danger');
            break;
          case 'auth/user-disabled':
            showAlert('This account has been disabled. Contact administrator.', 'danger');
            break;
          case 'auth/too-many-requests':
            showAlert('Too many failed attempts. Please try again later.', 'danger');
            break;
          case 'auth/network-request-failed':
            showAlert('Network error. Please check your connection.', 'danger');
            break;
          default:
            showAlert('Login failed: ' + error.message, 'danger');
        }
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    // ==================== FORGOT PASSWORD FUNCTIONS ====================
    function showForgotPasswordModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-key"></i> Reset Password</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your registered email address. You will receive a password reset link via email.
          </div>
          
          <form onsubmit="sendPasswordResetEmail(event)">
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" class="form-control" id="resetEmail" required 
                     placeholder="Enter your admin email">
            </div>
            
            <div id="resetStatus" style="margin-bottom: 15px;"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;" id="sendResetBtn">
                <i class="fas fa-paper-plane"></i> Send Reset Link
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
          
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
            <p style="color: #666; font-size: 0.9rem;">
              <i class="fas fa-clock"></i> Reset link expires in 1 hour
            </p>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function sendPasswordResetEmail(event) {
      event.preventDefault();
      
      const email = document.getElementById('resetEmail').value;
      const sendBtn = document.getElementById('sendResetBtn');
      const resetStatus = document.getElementById('resetStatus');
      
      sendBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';
      sendBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          throw new Error('Firebase not configured. Please contact administrator.');
        }
        
        await firebase.auth().sendPasswordResetEmail(email, {
          url: window.location.href,
          handleCodeInApp: false
        });
        
        resetStatus.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>Reset email sent!</strong>
              <p>Check your inbox for password reset instructions.</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-check"></i> Email Sent';
        
        setTimeout(() => {
          closeModal();
        }, 5000);
        
      } catch (error) {
        console.error('Password reset error:', error);
        
        let errorMessage = '';
        switch(error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email address.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email format.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many requests. Please try again later.';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your connection.';
            break;
          default:
            errorMessage = error.message;
        }
        
        resetStatus.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <strong>Failed to send reset email</strong>
              <p>${errorMessage}</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
        sendBtn.disabled = false;
      }
    }

    function showStudentLoginForm() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-graduate"></i> Student Login</h2>
          <form onsubmit="studentLogin(event)">
            <div class="form-group">
              <label>Student ID / Roll Number</label>
              <input type="text" class="form-control" id="studentIdInput" placeholder="Enter your student ID" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="studentLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function studentLogin(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('studentIdInput').value.trim();
      
      const loginBtn = document.getElementById('studentLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
      loginBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured. Please contact administrator.', 'warning');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentsRef = firebase.firestore().collection('students');
        const snapshot = await studentsRef.where('ID', '==', studentId).limit(1).get();
        
        if (snapshot.empty) {
          showAlert('Student not found with this ID', 'danger');
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
          return;
        }
        
        const studentDoc = snapshot.docs[0];
        const studentData = studentDoc.data();
        
        currentUser = {
          uid: studentDoc.id,
          ...studentData,
          id: studentData.ID
        };
        currentRole = 'student';
        currentStudent = currentUser;
        
        showAlert(`Welcome, ${studentData.Name}!`, 'success');
        closeModal();
        showStudentDashboard();
        startAutoRefresh();
        
      } catch (error) {
        console.error('Student login error:', error);
        showAlert('Login failed: ' + error.message, 'danger');
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function showAdminDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('studentDashboard').style.display = 'none';
      
      if (currentUser) {
        document.getElementById('adminName').textContent = currentUser.name || 'Administrator';
      }
      
      showAdminSection('dashboard');
    }

    function showStudentDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'block';
      
      if (currentUser) {
        document.getElementById('studentName').textContent = currentUser.name || 'Student';
      }
      
      showStudentSection('dashboard');
    }

    async function logout(role) {
      stopAutoRefresh();
      
      try {
        if (firebase.apps.length > 0 && firebase.auth().currentUser) {
          await firebase.auth().signOut();
        }
      } catch (error) {
        console.error('Firebase signout error:', error);
      }
      
      currentUser = null;
      currentRole = null;
      currentStudent = null;
      selectedStudentInfo = null;
      selectedStudents.clear();
      
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      
      showAlert('Logged out successfully', 'info');
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshInterval = setInterval(() => {
        if (currentRole === 'admin') {
          refreshAdminData(true);
        } else if (currentRole === 'student') {
          refreshStudentData(true);
        }
      }, 30000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function refreshAdminData(silent = false) {
      const refreshBtn = document.getElementById('adminRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#adminDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getAdminSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('admin', () => {
            showAdminSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function refreshStudentData(silent = false) {
      const refreshBtn = document.getElementById('studentRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
      }
      
      const activeBtn = document.querySelector('#studentDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getStudentSectionFromButton(activeBtn);
        if (section) {
          smoothRefresh('student', () => {
            showStudentSection(section, true);
          });
        }
      }
      
      setTimeout(() => {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
        }
      }, 1000);
    }

    function smoothRefresh(role, callback) {
      const contentDiv = document.getElementById(role === 'admin' ? 'adminMainContent' : 'studentMainContent');
      if (contentDiv) {
        contentDiv.classList.add('hidden');
        
        setTimeout(() => {
          if (callback) callback();
          setTimeout(() => {
            contentDiv.classList.remove('hidden');
            contentDiv.classList.add('visible');
          }, 50);
        }, 300);
      } else {
        if (callback) callback();
      }
    }

    function getAdminSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-user-graduate')) return 'students';
      if (icon.classList.contains('fa-list-alt')) return 'leaveTypes';
      if (icon.classList.contains('fa-users-cog')) return 'categories';
      if (icon.classList.contains('fa-calendar-alt')) return 'yearCredits';
      if (icon.classList.contains('fa-check-circle')) return 'leaveApprovals';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      if (icon.classList.contains('fa-file-upload')) return 'bulkUpload';
      if (icon.classList.contains('fa-chart-bar')) return 'reports';
      if (icon.classList.contains('fa-database')) return 'backup';
      if (icon.classList.contains('fa-fire')) return 'firebaseConfig';
      return 'dashboard';
    }

    function getStudentSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-chart-pie')) return 'leaveBalance';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      return 'dashboard';
    }

    function showAdminSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#adminDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showAdminDashboardHome();
          break;
        case 'students':
          showStudentsManagement();
          break;
        case 'leaveTypes':
          showLeaveTypesManagement();
          break;
        case 'categories':
          showCategoriesManagement();
          break;
        case 'yearCredits':
          showYearCreditsManagement();
          break;
        case 'leaveApprovals':
          showLeaveApprovals();
          break;
        case 'leaveHistory':
          showLeaveHistory();
          break;
        case 'bulkUpload':
          showBulkUpload();
          break;
        case 'reports':
          showReports();
          break;
        case 'backup':
          showBackupManagement();
          break;
        case 'firebaseConfig':
          showFirebaseConfigPanel();
          break;
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      const mainContent = currentRole === 'admin' ? document.getElementById('adminMainContent') : document.getElementById('studentMainContent');
      if (mainContent && mainContent.firstChild) {
        mainContent.insertBefore(alertDiv, mainContent.firstChild);
      } else if (mainContent) {
        mainContent.appendChild(alertDiv);
      } else {
        const loginCard = document.querySelector('.login-card');
        if (loginCard) {
          loginCard.insertBefore(alertDiv, loginCard.firstChild);
        }
      }
      
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function closeModal() {
      document.getElementById('operationModal').style.display = 'none';
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return 'N/A';
      }
    }

    function formatDateForStorage(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return date.toISOString().split('T')[0];
      } catch (e) {
        return '';
      }
    }

    function formatDateDDMMYYYY(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return 'N/A';
      }
    }

    function saveFilterState(section, filters) {
      filterStates[section] = { ...filters };
      localStorage.setItem(`filterState_${section}`, JSON.stringify(filters));
    }

    function loadFilterState(section) {
      const saved = localStorage.getItem(`filterState_${section}`);
      if (saved) {
        filterStates[section] = JSON.parse(saved);
      }
      return filterStates[section];
    }

    function showConfirmationDialog(title, message, confirmCallback, cancelCallback) {
      const overlay = document.createElement('div');
      overlay.className = 'confirmation-overlay';
      
      const dialog = document.createElement('div');
      dialog.className = 'confirmation-dialog';
      dialog.innerHTML = `
        <h3 style="margin-bottom: 10px;">${title}</h3>
        <p style="color: #666; margin-bottom: 20px;">${message}</p>
        <div class="confirmation-buttons">
          <button class="btn btn-danger" onclick="window.confirmAction()">Confirm</button>
          <button class="btn btn-secondary" onclick="window.cancelAction()">Cancel</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      window.confirmAction = function() {
        if (confirmCallback) confirmCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
      
      window.cancelAction = function() {
        if (cancelCallback) cancelCallback();
        closeConfirmationDialog();
        delete window.confirmAction;
        delete window.cancelAction;
      };
    }

    function closeConfirmationDialog() {
      const overlay = document.querySelector('.confirmation-overlay');
      if (overlay) overlay.remove();
    }

    // ==================== ADMIN DASHBOARD HOME ====================
    async function showAdminDashboardHome() {
      try {
        let stats = {
          totalStudents: 0,
          totalLeaveTypes: 0,
          pendingLeaves: 0,
          creditLeaveTypes: 0
        };
        
        if (firebase.apps.length > 0) {
          const db = firebase.firestore();
          
          const studentsSnapshot = await db.collection('students').get();
          const leaveTypesSnapshot = await db.collection('leaveTypes').get();
          const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
          
          stats = {
            totalStudents: studentsSnapshot.size,
            totalLeaveTypes: leaveTypesSnapshot.size,
            pendingLeaves: applicationsSnapshot.size,
            creditLeaveTypes: leaveTypesSnapshot.docs.filter(doc => doc.data().ApprovalType === 'credit').length
          };
        }
        
        const isFirebaseConfigured = localStorage.getItem('firebaseConfig') !== null;
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-tachometer-alt"></i> System Overview</h2>
              <span class="badge ${isFirebaseConfigured ? 'badge-success' : 'badge-warning'}">
                ${isFirebaseConfigured ? 'FIREBASE CONFIGURED' : 'FIREBASE NOT CONFIGURED'}
              </span>
            </div>
            ${!isFirebaseConfigured ? `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <strong>Firebase Not Configured</strong>
                  <p>Please configure Firebase to start using the system with full functionality.</p>
                  <button class="btn btn-primary" onclick="showFirebaseConfigPanel()" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> Configure Firebase
                  </button>
                </div>
              </div>
            ` : ''}
            <div class="stats-grid">
              <div class="stat-card">
                <h3>${stats.totalStudents}</h3>
                <p>Total Students</p>
              </div>
              <div class="stat-card">
                <h3>${stats.totalLeaveTypes}</h3>
                <p>Leave Types</p>
              </div>
              <div class="stat-card">
                <h3>${stats.pendingLeaves}</h3>
                <p>Pending Leaves</p>
              </div>
              <div class="stat-card">
                <h3>${stats.creditLeaveTypes}</h3>
                <p>Credit Leaves</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <button class="btn btn-primary" onclick="showAddStudentModal()">
                <i class="fas fa-user-plus"></i> Add Student
              </button>
              <button class="btn btn-success" onclick="showLeaveEntryForm()">
                <i class="fas fa-file-medical"></i> New Leave
              </button>
              <button class="btn btn-info" onclick="showAdminSection('leaveApprovals')">
                <i class="fas fa-check-double"></i> Approve Leaves
              </button>
              <button class="btn btn-warning" onclick="showAdminSection('reports')">
                <i class="fas fa-chart-line"></i> Generate Report
              </button>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Dashboard error:', error);
        showAlert('Failed to load dashboard: ' + error.message, 'danger');
      }
    }

   // ==================== FIREBASE CONFIG PANEL ====================
function showFirebaseConfigPanel() {
  console.log('Opening Firebase Config Panel');
  const contentDiv = document.getElementById('adminMainContent');
  if (!contentDiv) {
    console.error('Admin main content div not found');
    return;
  }
  
  const isConfigured = firebase.apps.length > 0;
  const config = isConfigured ? firebase.app().options : null;
  
  // Get saved values from localStorage
  const savedApiKey = localStorage.getItem('fb_apiKey') || '';
  const savedAuthDomain = localStorage.getItem('fb_authDomain') || '';
  const savedProjectId = localStorage.getItem('fb_projectId') || '';
  const savedStorageBucket = localStorage.getItem('fb_storageBucket') || '';
  const savedMessagingSenderId = localStorage.getItem('fb_messagingSenderId') || '';
  const savedAppId = localStorage.getItem('fb_appId') || '';
  const savedMeasurementId = localStorage.getItem('fb_measurementId') || '';
  
  contentDiv.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-fire"></i> Firebase Configuration</h2>
        <div>
          <span class="badge ${isConfigured ? 'badge-success' : 'badge-danger'}" id="firebaseStatus">
            ${isConfigured ? 'CONNECTED' : 'NOT CONNECTED'}
          </span>
        </div>
      </div>
      
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <div>
          <strong>Auto-Load System:</strong> Configurations are stored in Firestore and automatically loaded on all devices.
        </div>
      </div>
      
      <div class="connection-status">
        <div class="status-indicator ${isConfigured ? 'success' : 'error'}"></div>
        <div>
          <strong>Status:</strong> 
          ${isConfigured ? 'Firebase is connected and ready' : 'Firebase is not configured'}
        </div>
      </div>
      
      ${!isConfigured ? `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          Firebase is not configured. Please enter your Firebase configuration below.
        </div>
      ` : ''}
      
      <form onsubmit="saveFirebaseConfig(event)">
        <h3 style="margin: 20px 0 10px 0;">Firebase Configuration</h3>
        <div class="form-group">
          <label>apiKey <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_apiKey" required 
                 value="${savedApiKey}" placeholder="AIzaSyBxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx">
        </div>
        <div class="form-group">
          <label>authDomain <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_authDomain" required
                 value="${savedAuthDomain}" placeholder="your-project.firebaseapp.com">
        </div>
        <div class="form-group">
          <label>projectId <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_projectId" required
                 value="${savedProjectId}" placeholder="your-project-id">
        </div>
        <div class="form-group">
          <label>storageBucket <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_storageBucket" required
                 value="${savedStorageBucket}" placeholder="your-project.appspot.com">
        </div>
        <div class="form-group">
          <label>messagingSenderId <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_messagingSenderId" required
                 value="${savedMessagingSenderId}" placeholder="123456789012">
        </div>
        <div class="form-group">
          <label>appId <span style="color:red;">*</span></label>
          <input type="text" class="form-control" id="fb_appId" required
                 value="${savedAppId}" placeholder="1:123456789012:web:abc123def456">
        </div>
        <div class="form-group">
          <label>measurementId (optional)</label>
          <input type="text" class="form-control" id="fb_measurementId"
                 value="${savedMeasurementId}" placeholder="G-XXXXXXXXXX">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="fb_saveToFirestore" checked> 
            Save to Firestore (for auto-load on other devices)
          </label>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-success" style="flex: 1;" id="saveFirebaseBtn">
            <i class="fas fa-save"></i> Save & Connect
          </button>
          <button type="button" class="btn btn-info" onclick="testFirebaseConnection()" style="flex: 1;">
            <i class="fas fa-plug"></i> Test Connection
          </button>
        </div>
        
        <div id="connectionTestResult" style="margin-top: 15px;"></div>
      </form>
      
      ${isConfigured ? `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
          <h4>Current Configuration</h4>
          <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto;">
Project ID: ${config?.projectId || 'N/A'}
Auth Domain: ${config?.authDomain || 'N/A'}
          </pre>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn btn-warning" onclick="syncConfigurations()" style="flex: 1;">
              <i class="fas fa-sync"></i> Sync to Firestore
            </button>
            <button class="btn btn-info" onclick="showConfigHistory()" style="flex: 1;">
              <i class="fas fa-history"></i> View History
            </button>
            <button class="btn btn-danger" onclick="clearFirebaseConfig()" style="flex: 1;">
              <i class="fas fa-trash"></i> Clear Config
            </button>
          </div>
        </div>
      ` : ''}
    </div>
  `;
  
  // Add a hidden div for test results if needed
  if (!document.getElementById('connectionTestResult')) {
    const testDiv = document.createElement('div');
    testDiv.id = 'connectionTestResult';
    testDiv.style.marginTop = '15px';
    document.querySelector('form').appendChild(testDiv);
  }
}
    // ==================== TEST FIREBASE CONNECTION ====================
async function testFirebaseConnection() {
  const resultDiv = document.getElementById('connectionTestResult');
  if (!resultDiv) {
    // Create if doesn't exist
    const newDiv = document.createElement('div');
    newDiv.id = 'connectionTestResult';
    newDiv.style.marginTop = '15px';
    const form = document.querySelector('form');
    if (form) form.appendChild(newDiv);
  }
  
  const testDiv = document.getElementById('connectionTestResult');
  testDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Testing connection...</div>';
  
  try {
    // Check if Firebase is initialized
    if (firebase.apps.length === 0) {
      // Try to initialize with current form values
      const apiKey = document.getElementById('fb_apiKey')?.value;
      const authDomain = document.getElementById('fb_authDomain')?.value;
      const projectId = document.getElementById('fb_projectId')?.value;
      const storageBucket = document.getElementById('fb_storageBucket')?.value;
      const messagingSenderId = document.getElementById('fb_messagingSenderId')?.value;
      const appId = document.getElementById('fb_appId')?.value;
      
      if (!apiKey || !authDomain || !projectId || !storageBucket || !messagingSenderId || !appId) {
        throw new Error('Please fill in all required fields first');
      }
      
      const testConfig = {
        apiKey, authDomain, projectId, storageBucket, messagingSenderId, appId
      };
      
      firebase.initializeApp(testConfig);
      window.db = firebase.firestore();
      window.auth = firebase.auth();
    }
    
    // Test Firestore access
    const db = firebase.firestore();
    await db.collection('systemConfig').doc('test').get();
    
    // Test Auth
    const auth = firebase.auth();
    
    testDiv.innerHTML = `
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <div>
          <strong>Connection Successful!</strong>
          <p>‚úì Firestore is accessible</p>
          <p>‚úì Authentication is working</p>
          <p>Project: ${firebase.app().options.projectId}</p>
        </div>
      </div>
    `;
  } catch (error) {
    testDiv.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        <div>
          <strong>Connection Failed!</strong>
          <p>Error: ${error.message}</p>
          <p>Please check your Firebase configuration and Firestore rules.</p>
        </div>
      </div>
    `;
  }
}
// ==================== SAVE FIREBASE CONFIG ====================
async function saveFirebaseConfig(event) {
  event.preventDefault();
  
  const config = {
    apiKey: document.getElementById('fb_apiKey').value.trim(),
    authDomain: document.getElementById('fb_authDomain').value.trim(),
    projectId: document.getElementById('fb_projectId').value.trim(),
    storageBucket: document.getElementById('fb_storageBucket').value.trim(),
    messagingSenderId: document.getElementById('fb_messagingSenderId').value.trim(),
    appId: document.getElementById('fb_appId').value.trim()
  };
  
  const measurementId = document.getElementById('fb_measurementId').value.trim();
  if (measurementId) config.measurementId = measurementId;
  
  const saveToFirestore = document.getElementById('fb_saveToFirestore')?.checked || true;
  
  // Validate required fields
  if (!config.apiKey || !config.authDomain || !config.projectId || !config.storageBucket || !config.messagingSenderId || !config.appId) {
    showAlert('Please fill in all required fields', 'warning');
    return;
  }
  
  const saveBtn = document.getElementById('saveFirebaseBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<div class="loading-spinner"></div> Connecting...';
  saveBtn.disabled = true;
  
  showAlert('Initializing Firebase...', 'info');
  
  try {
    // Clear any existing Firebase apps
    if (firebase.apps.length > 0) {
      for (const app of firebase.apps) {
        try {
          await app.delete();
        } catch (e) {
          console.log('Error deleting app:', e);
        }
      }
    }
    
    // Initialize Firebase with new config
    firebase.initializeApp(config);
    window.db = firebase.firestore();
    window.auth = firebase.auth();
    
    // Enable persistence
    try {
      await firebase.firestore().enablePersistence();
    } catch (err) {
      console.warn('Firebase persistence error:', err);
    }
    
    // Save to localStorage
    localStorage.setItem('firebaseConfig', JSON.stringify(config));
    localStorage.setItem('fb_apiKey', config.apiKey);
    localStorage.setItem('fb_authDomain', config.authDomain);
    localStorage.setItem('fb_projectId', config.projectId);
    localStorage.setItem('fb_storageBucket', config.storageBucket);
    localStorage.setItem('fb_messagingSenderId', config.messagingSenderId);
    localStorage.setItem('fb_appId', config.appId);
    if (measurementId) localStorage.setItem('fb_measurementId', measurementId);
    
    // Save to Firestore if requested
    if (saveToFirestore) {
      try {
        await firebase.firestore().collection('systemConfig').doc('firebase').set({
          config: config,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'system',
          version: '1.0'
        });
        
        // Also save as backup
        await firebase.firestore().collection('configBackups').add({
          type: 'firebase',
          config: config,
          timestamp: new Date().toISOString(),
          updatedBy: currentUser?.email || 'system'
        });
        
        showAlert('Firebase connected and configuration saved to database!', 'success');
      } catch (dbError) {
        console.error('Error saving config to Firestore:', dbError);
        showAlert('Firebase connected but config could not be saved to database. Check Firestore rules.', 'warning');
      }
    } else {
      showAlert('Firebase connected successfully!', 'success');
    }
    
    firebaseInitialized = true;
    updateFirebaseStatusBadges(true);
    
    // Initialize default data if needed
    await initializeDefaultData();
    
    // Refresh the config panel
    setTimeout(() => {
      showFirebaseConfigPanel();
    }, 1000);
    
  } catch (error) {
    console.error('Firebase initialization error:', error);
    showAlert('Firebase connection failed: ' + error.message, 'danger');
    updateFirebaseStatusBadges(false);
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}
// ==================== CLEAR FIREBASE CONFIG ====================
function clearFirebaseConfig() {
  showConfirmationDialog(
    "Clear Firebase Configuration",
    "This will remove Firebase configuration from this device. Continue?",
    async () => {
      // Clear from localStorage
      localStorage.removeItem('firebaseConfig');
      localStorage.removeItem('fb_apiKey');
      localStorage.removeItem('fb_authDomain');
      localStorage.removeItem('fb_projectId');
      localStorage.removeItem('fb_storageBucket');
      localStorage.removeItem('fb_messagingSenderId');
      localStorage.removeItem('fb_appId');
      localStorage.removeItem('fb_measurementId');
      
      showAlert('Configuration cleared. Refreshing page...', 'success');
      
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }
  );
}
    async function initializeDefaultData() {
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').limit(1).get();
        
        if (leaveTypesSnapshot.empty) {
          const defaultLeaveTypes = [
            { Code: 'CL', Name: 'Casual Leave', Description: 'For casual/emergency leaves', ApprovalType: 'credit', MaxDaysPerApplication: 5, MaxDaysPerYear: 12, Enabled: true },
            { Code: 'RH', Name: 'Restricted Holiday', Description: 'Optional holidays', ApprovalType: 'approval', MaxDaysPerApplication: 1, MaxDaysPerYear: 2, Enabled: true },
            { Code: 'ML', Name: 'Medical Leave', Description: 'For medical reasons', ApprovalType: 'approval', MaxDaysPerApplication: 10, MaxDaysPerYear: 20, Enabled: true },
            { Code: 'EL', Name: 'Earned Leave', Description: 'Accumulated leave', ApprovalType: 'credit', MaxDaysPerApplication: 15, MaxDaysPerYear: 30, Enabled: true }
          ];
          
          for (const lt of defaultLeaveTypes) {
            await db.collection('leaveTypes').add(lt);
          }
        }
        
        const categoriesSnapshot = await db.collection('categories').limit(1).get();
        
        if (categoriesSnapshot.empty) {
          const defaultCategories = [
            { 
              Category: 'B.Tech', 
              Years: '1st Year,2nd Year,3rd Year,4th Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4,Semester 5,Semester 6,Semester 7,Semester 8',
              Specializations: 'Computer Science,Information Technology,Electronics,Mechanical,Civil,Electrical',
              Enabled: true
            },
            { 
              Category: 'M.Tech', 
              Years: '1st Year,2nd Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4',
              Specializations: 'Computer Science,Electronics,Mechanical,Structural Engineering',
              Enabled: true
            }
          ];
          
          for (const cat of defaultCategories) {
            await db.collection('categories').add(cat);
          }
        }
        
        console.log('Default data initialized');
        
      } catch (error) {
        console.error('Error initializing default data:', error);
      }
    }

    // ==================== EMAIL CONFIG FUNCTIONS ====================
    function showEmailConfig() {
      const savedUrl = localStorage.getItem('googleAppsScriptUrl') || '';
      
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-envelope"></i> Email Configuration</h2>
          
          <div class="email-config-card">
            <h3 style="margin-top: 0;">Google Apps Script Configuration</h3>
            <p>Configure your Google Apps Script URL to enable email notifications.</p>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>Email notifications will be sent when leaves are approved or updated.</strong>
            </div>
          </div>
          
          <form onsubmit="saveEmailConfig(event)">
            <div class="form-group">
              <label>Google Apps Script URL <span style="color: red;">*</span></label>
              <input type="url" class="form-control" id="appsScriptUrl" 
                     placeholder="https://script.google.com/macros/s/your-script-id/exec"
                     value="${savedUrl}" required>
              <small style="color: #666;">Paste your deployed Google Apps Script web app URL here</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Configuration
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function saveEmailConfig(event) {
      event.preventDefault();
      
      const url = document.getElementById('appsScriptUrl').value.trim();
      
      if (!url) {
        showAlert('Please enter a valid Google Apps Script URL', 'warning');
        return;
      }
      
      localStorage.setItem('googleAppsScriptUrl', url);
      GOOGLE_APPS_SCRIPT_URL = url;
      
      showAlert('Email configuration saved!', 'success');
      closeModal();
    }

    // ==================== SYNC CONFIGURATIONS ====================
    async function syncConfigurations() {
      if (firebase.apps.length === 0) {
        showAlert('Firebase not configured', 'warning');
        return;
      }
      
      showAlert('Syncing configurations...', 'info');
      
      try {
        const db = firebase.firestore();
        const localFirebaseConfig = localStorage.getItem('firebaseConfig');
        
        if (localFirebaseConfig) {
          const firebaseConfig = JSON.parse(localFirebaseConfig);
          await db.collection('systemConfig').doc('firebase').set({
            config: firebaseConfig,
            syncedAt: new Date().toISOString(),
            syncedBy: currentUser?.email || 'system'
          }, { merge: true });
        }
        
        showAlert('Configurations synced successfully!', 'success');
        
      } catch (error) {
        console.error('Error syncing configurations:', error);
        showAlert('Failed to sync configurations: ' + error.message, 'danger');
      }
    }

    // ==================== SHOW CONFIG HISTORY ====================
    async function showConfigHistory() {
      if (firebase.apps.length === 0) {
        showAlert('Firebase not configured', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const backupsSnapshot = await db.collection('configBackups')
          .orderBy('timestamp', 'desc')
          .limit(20)
          .get();
        
        const backups = backupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const modal = document.getElementById('operationModal');
        
        let backupsHTML = '';
        if (backups.length > 0) {
          backupsHTML = backups.map(backup => `
            <div class="backup-item">
              <div class="backup-info">
                <h4><i class="fas fa-history"></i> ${backup.type.toUpperCase()} Backup</h4>
                <div class="backup-meta">
                  <p><strong>Date:</strong> ${formatDate(backup.timestamp)}</p>
                  <p><strong>By:</strong> ${backup.syncedBy || backup.updatedBy || 'Unknown'}</p>
                </div>
              </div>
              <button class="btn btn-sm btn-info" onclick="restoreConfigFromBackup('${backup.id}')">
                <i class="fas fa-undo"></i> Restore
              </button>
            </div>
          `).join('');
        } else {
          backupsHTML = '<p>No configuration history found.</p>';
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-history"></i> Configuration History</h2>
            
            <div class="backup-list">
              ${backupsHTML}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="syncConfigurations()" style="flex: 1;">
                <i class="fas fa-sync"></i> Sync Now
              </button>
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Error loading config history:', error);
        showAlert('Failed to load configuration history', 'danger');
      }
    }

    // ==================== RESTORE CONFIG FROM BACKUP ====================
    async function restoreConfigFromBackup(backupId) {
      try {
        const db = firebase.firestore();
        
        const backupDoc = await db.collection('configBackups').doc(backupId).get();
        if (!backupDoc.exists) {
          showAlert('Backup not found', 'danger');
          return;
        }
        
        const backup = backupDoc.data();
        
        showConfirmationDialog(
          "Restore Configuration",
          `Are you sure you want to restore the ${backup.type} configuration from ${formatDate(backup.timestamp)}?`,
          async () => {
            if (backup.type === 'firebase' && backup.config) {
              // Restore Firebase config
              localStorage.setItem('firebaseConfig', JSON.stringify(backup.config));
              localStorage.setItem('fb_apiKey', backup.config.apiKey);
              localStorage.setItem('fb_authDomain', backup.config.authDomain);
              localStorage.setItem('fb_projectId', backup.config.projectId);
              localStorage.setItem('fb_storageBucket', backup.config.storageBucket);
              localStorage.setItem('fb_messagingSenderId', backup.config.messagingSenderId);
              localStorage.setItem('fb_appId', backup.config.appId);
              if (backup.config.measurementId) localStorage.setItem('fb_measurementId', backup.config.measurementId);
              
              showAlert('Firebase config restored. Refreshing...', 'success');
              setTimeout(() => location.reload(), 2000);
              
            } else if (backup.type === 'email' && backup.config) {
              // Restore Email config
              if (backup.config.googleAppsScriptUrl) {
                localStorage.setItem('googleAppsScriptUrl', backup.config.googleAppsScriptUrl);
                GOOGLE_APPS_SCRIPT_URL = backup.config.googleAppsScriptUrl;
              }
              showAlert('Email config restored successfully!', 'success');
              closeModal();
            }
          }
        );
        
      } catch (error) {
        console.error('Error restoring backup:', error);
        showAlert('Failed to restore configuration', 'danger');
      }
    }

    // ==================== LEAVE ENTRY FORM ====================
    async function showLeaveEntryForm(prefilledStudentId = null) {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const modal = document.getElementById('operationModal');
        
        let leaveTypesOptions = '<option value="">Select Leave Type</option>';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesOptions += leaveTypes.filter(lt => lt.Enabled === true).map(lt => `
            <option value="${lt.Code}">${lt.Name} (${lt.Code})</option>
          `).join('');
        }
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-file-signature"></i> Enter Leave Request</h2>
            <form onsubmit="submitLeaveRequest(event)">
              <div class="form-group">
                <label>Select Student ID <span style="color: red;">*</span></label>
                <div style="position: relative;">
                  <input type="text" class="form-control" id="studentSearchInput" 
                         placeholder="Search Student ID..." 
                         oninput="searchStudent(this.value)"
                         autocomplete="off"
                         ${prefilledStudentId ? `value="${prefilledStudentId}" readonly` : ''}>
                  <div id="studentSearchResults" class="search-results" style="display: none;"></div>
                </div>
                <input type="hidden" id="leaveStudentId" required>
              </div>
              
              <div id="studentInfoBox" class="student-info-box" style="display: none;">
                <h4><i class="fas fa-user-graduate"></i> Selected Student Information</h4>
                <div class="student-info-row">
                  <div class="info-item">
                    <span class="info-label">Student ID:</span>
                    <span class="info-value" id="selectedStudentId">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Name:</span>
                    <span class="info-value" id="selectedStudentName">-</span>
                  </div>
                </div>
                <div class="student-info-row">
                  <div class="info-item">
                    <span class="info-label">Category:</span>
                    <span class="info-value" id="selectedStudentCategory">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Year:</span>
                    <span class="info-value" id="selectedStudentYear">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Semester:</span>
                    <span class="info-value" id="selectedStudentSemester">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Specialization:</span>
                    <span class="info-value" id="selectedStudentSpecialization">-</span>
                  </div>
                </div>
                <div class="info-item" style="margin-top: 10px;">
                  <span class="info-label">Email:</span>
                  <span class="info-value" id="selectedStudentEmail">-</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Leave Type <span style="color: red;">*</span></label>
                <select class="form-control" id="leaveType" required onchange="validateLeaveOnChange()">
                  ${leaveTypesOptions}
                </select>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>From Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveFromDate" value="${tomorrowStr}" required onchange="validateLeaveOnChange()">
                </div>
                <div class="form-group">
                  <label>To Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveToDate" value="${tomorrowStr}" required onchange="validateLeaveOnChange()">
                </div>
              </div>
              
              <div class="form-group">
                <label>Number of Days <span style="color: red;">*</span></label>
                <input type="number" class="form-control" id="leaveNoOfDays" min="1" value="1" required onchange="validateLeaveOnChange()">
              </div>
              
              <div id="validationMessages" style="margin-bottom: 15px;"></div>
              
              <div class="form-group">
                <label>Reason for Leave <span style="color: red;">*</span></label>
                <textarea class="form-control" id="leaveReason" rows="4" required></textarea>
              </div>
              
              <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="leaveStatus">
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="submitLeaveBtn">
                  <i class="fas fa-paper-plane"></i> Submit Leave Request
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        if (prefilledStudentId) {
          document.getElementById('leaveStudentId').value = prefilledStudentId;
          loadStudentDetails(prefilledStudentId);
        }
        
        document.getElementById('leaveFromDate').addEventListener('change', calculateDays);
        document.getElementById('leaveToDate').addEventListener('change', calculateDays);
        
        window.searchStudent = async function(searchTerm) {
          const searchResults = document.getElementById('studentSearchResults');
          
          if (!searchTerm || searchTerm.trim() === '') {
            searchResults.style.display = 'none';
            return;
          }
          
          try {
            const db = firebase.firestore();
            const searchTermLower = searchTerm.toLowerCase();
            
            const snapshot = await db.collection('students').get();
            const matchedStudents = snapshot.docs
              .map(doc => doc.data())
              .filter(student => 
                student.ID && student.ID.toString().toLowerCase().includes(searchTermLower) ||
                student.Name && student.Name.toLowerCase().includes(searchTermLower)
              )
              .slice(0, 10);
            
            if (matchedStudents.length > 0) {
              let resultsHTML = '';
              matchedStudents.forEach(student => {
                resultsHTML += `
                  <div class="search-result-item" onclick="selectStudent('${student.ID}', '${student.Name.replace(/'/g, "\\'")}')">
                    <div class="search-result-id">${student.ID}</div>
                    <div class="search-result-name">${student.Name}</div>
                  </div>
                `;
              });
              searchResults.innerHTML = resultsHTML;
              searchResults.style.display = 'block';
            } else {
              searchResults.style.display = 'none';
            }
          } catch (error) {
            console.error('Search student error:', error);
            searchResults.style.display = 'none';
          }
        };
        
        window.selectStudent = function(studentId, studentName) {
          document.getElementById('studentSearchInput').value = studentId;
          document.getElementById('leaveStudentId').value = studentId;
          document.getElementById('studentSearchResults').style.display = 'none';
          loadStudentDetails(studentId);
        };
        
        async function loadStudentDetails(studentId) {
          try {
            const db = firebase.firestore();
            const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
            
            if (!studentsSnapshot.empty) {
              const student = studentsSnapshot.docs[0].data();
              document.getElementById('selectedStudentId').textContent = student.ID || '-';
              document.getElementById('selectedStudentName').textContent = student.Name || '-';
              document.getElementById('selectedStudentCategory').textContent = student.Category || '-';
              document.getElementById('selectedStudentYear').textContent = student.Year || '-';
              document.getElementById('selectedStudentSemester').textContent = student.Semester || '-';
              document.getElementById('selectedStudentSpecialization').textContent = student.Specialization || '-';
              document.getElementById('selectedStudentEmail').textContent = student.Email || 'No email';
              document.getElementById('studentInfoBox').style.display = 'block';
              
              window.selectedStudent = student;
            } else {
              document.getElementById('studentInfoBox').style.display = 'none';
              window.selectedStudent = null;
            }
          } catch (error) {
            console.error('Load student details error:', error);
            document.getElementById('studentInfoBox').style.display = 'none';
          }
        }
        
        function calculateDays() {
          const fromDate = new Date(document.getElementById('leaveFromDate').value);
          const toDate = new Date(document.getElementById('leaveToDate').value);
          
          if (fromDate && toDate && fromDate <= toDate) {
            const timeDiff = toDate.getTime() - fromDate.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            document.getElementById('leaveNoOfDays').value = dayDiff > 0 ? dayDiff : 1;
          }
        }
        
        window.validateLeaveOnChange = async function() {
          const studentId = document.getElementById('leaveStudentId').value;
          const leaveType = document.getElementById('leaveType').value;
          const fromDate = document.getElementById('leaveFromDate').value;
          const toDate = document.getElementById('leaveToDate').value;
          const days = parseInt(document.getElementById('leaveNoOfDays').value) || 0;
          
          const validationDiv = document.getElementById('validationMessages');
          
          if (!studentId || !leaveType || !fromDate || !toDate) {
            validationDiv.innerHTML = '';
            return;
          }
          
          // Check date overlap
          const overlapCheck = await checkDateOverlap(studentId, fromDate, toDate);
          
          if (overlapCheck.overlap) {
            validationDiv.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Date Overlap Error:</strong> This student already has a leave application for these dates.
                ${overlapCheck.application ? `<br>Existing: ${overlapCheck.application.LeaveType} (${formatDate(overlapCheck.application.FromDate)} to ${formatDate(overlapCheck.application.ToDate)})` : ''}
              </div>
            `;
            return;
          }
          
          // Check leave credits if student is selected
          if (window.selectedStudent) {
            const creditCheck = await checkLeaveCreditAvailability(window.selectedStudent, leaveType, days);
            
            if (!creditCheck.available) {
              validationDiv.innerHTML = `
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Credit Error:</strong> ${creditCheck.message}
                </div>
              `;
              return;
            } else {
              validationDiv.innerHTML = `
                <div class="alert alert-success">
                  <i class="fas fa-check-circle"></i>
                  <strong>Validation Passed:</strong> ${creditCheck.message}
                </div>
              `;
            }
          }
        };
        
      } catch (error) {
        console.error('Leave entry form error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function submitLeaveRequest(event) {
      event.preventDefault();
      
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const studentId = document.getElementById('leaveStudentId').value;
      const leaveType = document.getElementById('leaveType').value;
      const days = parseInt(document.getElementById('leaveNoOfDays').value) || 1;
      
      // Validate date overlap again before submission
      const overlapCheck = await checkDateOverlap(studentId, fromDate, toDate);
      if (overlapCheck.overlap) {
        showAlert('This student already has a leave application for these dates.', 'danger');
        return;
      }
      
      // Validate leave credits
      if (window.selectedStudent) {
        const creditCheck = await checkLeaveCreditAvailability(window.selectedStudent, leaveType, days);
        if (!creditCheck.available) {
          showAlert(creditCheck.message, 'warning');
          return;
        }
      }
      
      // Generate application ID with proper format
      const appIdInfo = await generateApplicationId();
      
      const applicationData = {
        ID: appIdInfo.id,
        Year: appIdInfo.year,
        SequenceNumber: appIdInfo.sequence,
        StudentID: studentId,
        LeaveType: leaveType,
        FromDate: fromDate,
        ToDate: toDate,
        NoOfDays: days,
        Reason: document.getElementById('leaveReason').value,
        Status: document.getElementById('leaveStatus').value,
        AppliedDate: new Date().toISOString(),
        AppliedBy: currentUser?.email || 'admin',
        Semester: document.getElementById('selectedStudentSemester').textContent !== '-' ? document.getElementById('selectedStudentSemester').textContent : ''
      };
      
      if (!applicationData.StudentID || !applicationData.LeaveType) {
        showAlert('Please select a student and leave type', 'warning');
        return;
      }
      
      if (!applicationData.FromDate || !applicationData.ToDate) {
        showAlert('Please select valid dates', 'warning');
        return;
      }
      
      const submitBtn = document.getElementById('submitLeaveBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner"></div> Submitting...';
      submitBtn.disabled = true;
      
      try {
        const db = firebase.firestore();
        
        await db.collection('leaveApplications').add(applicationData);
        
        // If status is approved, send email notification
        if (applicationData.Status === 'approved' && applicationData.StudentID && window.selectedStudent) {
          await sendApprovalEmail(applicationData, window.selectedStudent, 'approved');
        }
        
        showAlert(`Leave request submitted successfully! (ID: ${applicationData.ID})`, 'success');
        closeModal();
        showLeaveApprovals();
        
      } catch (error) {
        console.error('Submit leave request error:', error);
        showAlert('Failed to submit leave request: ' + error.message, 'danger');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    // ==================== APPLICATION ID GENERATOR ====================
    async function generateApplicationId() {
      try {
        const currentYear = new Date().getFullYear().toString();
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('Year', '==', currentYear)
          .orderBy('SequenceNumber', 'desc')
          .limit(1)
          .get();
        
        let nextSequence = 1;
        
        if (!applicationsSnapshot.empty) {
          const lastApplication = applicationsSnapshot.docs[0].data();
          nextSequence = (lastApplication.SequenceNumber || 0) + 1;
        }
        
        const formattedSequence = nextSequence.toString().padStart(4, '0');
        const applicationId = `LA-${currentYear}-${formattedSequence}`;
        
        return {
          id: applicationId,
          year: currentYear,
          sequence: nextSequence
        };
      } catch (error) {
        console.error('Error generating application ID:', error);
        const timestamp = Date.now();
        return {
          id: `LA-${new Date().getFullYear()}-${timestamp.toString().slice(-4)}`,
          year: new Date().getFullYear().toString(),
          sequence: parseInt(timestamp.toString().slice(-4))
        };
      }
    }

    // ==================== LEAVE VALIDATION FUNCTIONS ====================
    async function checkDateOverlap(studentId, fromDate, toDate, excludeApplicationId = null) {
      try {
        const db = firebase.firestore();
        
        const newFromDate = new Date(fromDate);
        const newToDate = new Date(toDate);
        
        let query = db.collection('leaveApplications')
          .where('StudentID', '==', studentId);
        
        const snapshot = await query.get();
        
        let hasOverlap = false;
        let overlappingApp = null;
        
        snapshot.forEach(doc => {
          const app = doc.data();
          
          if (excludeApplicationId && doc.id === excludeApplicationId) {
            return;
          }
          
          if (app.Status !== 'rejected') {
            const existingFromDate = new Date(app.FromDate);
            const existingToDate = new Date(app.ToDate);
            
            if (newFromDate <= existingToDate && newToDate >= existingFromDate) {
              hasOverlap = true;
              overlappingApp = app;
            }
          }
        });
        
        return {
          overlap: hasOverlap,
          application: overlappingApp
        };
      } catch (error) {
        console.error('Error checking date overlap:', error);
        return { overlap: false, application: null };
      }
    }

    async function checkLeaveCreditAvailability(student, leaveType, daysRequested) {
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes')
          .where('Code', '==', leaveType)
          .limit(1)
          .get();
        
        if (leaveTypesSnapshot.empty) {
          return { available: false, message: 'Leave type not found' };
        }
        
        const leaveTypeData = leaveTypesSnapshot.docs[0].data();
        
        if (leaveTypeData.ApprovalType !== 'credit') {
          return { available: true, message: 'Approval-based leave - no credit check needed' };
        }
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          return { available: false, message: 'No leave credits configured for your category/year' };
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        const totalCredits = yearCredit[leaveType] || 0;
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .where('LeaveType', '==', leaveType)
          .where('Status', '==', 'approved')
          .get();
        
        const usedCredits = applicationsSnapshot.docs.reduce((sum, doc) => {
          return sum + (doc.data().NoOfDays || 0);
        }, 0);
        
        const remainingCredits = totalCredits - usedCredits;
        
        if (daysRequested > remainingCredits) {
          return {
            available: false,
            message: `Insufficient ${leaveType} credits. Available: ${remainingCredits}, Requested: ${daysRequested}`,
            remaining: remainingCredits,
            total: totalCredits,
            used: usedCredits
          };
        }
        
        return {
          available: true,
          message: `Sufficient credits available. Remaining: ${remainingCredits}`,
          remaining: remainingCredits,
          total: totalCredits,
          used: usedCredits
        };
      } catch (error) {
        console.error('Error checking leave credits:', error);
        return { available: false, message: 'Error checking leave credits' };
      }
    }

    // ==================== STUDENT SECTIONS ====================
    function showStudentSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#studentDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showStudentDashboardHome();
          break;
        case 'leaveBalance':
          showStudentLeaveBalance();
          break;
        case 'leaveHistory':
          showStudentLeaveHistory();
          break;
      }
    }

    function showStudentDashboardHome() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
              <div style="width: 60px; height: 60px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                <i class="fas fa-user-graduate"></i>
              </div>
              <div>
                <h3 style="margin-bottom: 5px;">${student.Name || 'Student'}</h3>
                <p style="color: #666; margin: 0;">
                  ${student.ID || ''} | ${student.Category || ''} ${student.Year ? '- ' + student.Year : ''}
                  ${student.Semester ? '| ' + student.Semester : ''}
                  ${student.Specialization ? '| ' + student.Specialization : ''}
                  ${student.Email ? '| Email: ' + student.Email : ''}
                </p>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Quick Info</h3>
              <div class="stats-grid">
                <div class="stat-card">
                  <h3 id="studentTotalLeaves">0</h3>
                  <p>Total Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentApprovedLeaves">0</h3>
                  <p>Approved Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentPendingLeaves">0</h3>
                  <p>Pending Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentCreditTypes">0</h3>
                  <p>Credit Types</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentStats();
    }

    async function loadStudentStats() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('StudentID', '==', student.ID).get();
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        
        const total = applications.length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const pending = applications.filter(app => app.Status === 'pending').length;
        
        document.getElementById('studentTotalLeaves').textContent = total;
        document.getElementById('studentApprovedLeaves').textContent = approved;
        document.getElementById('studentPendingLeaves').textContent = pending;
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
        document.getElementById('studentCreditTypes').textContent = leaveTypesSnapshot.size;
        
      } catch (error) {
        console.error('Load student stats error:', error);
      }
    }

    function showStudentLeaveBalance() {
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> My Leave Balance</h2>
          </div>
          <div style="padding: 20px;">
            <div class="leave-balance-container" id="leaveBalanceContainer">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave balance...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveBalance();
    }

    async function loadStudentLeaveBalance() {
      if (firebase.apps.length === 0) {
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Firebase not configured. Cannot load leave balance.
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Leave Credits Found</h3>
              <p>Please contact administrator.</p>
            </div>
          `;
          return;
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .where('Status', '==', 'approved')
          .get();
        
        const approvedLeaves = applicationsSnapshot.docs.map(doc => doc.data());
        
        const usedCredits = {};
        approvedLeaves.forEach(app => {
          if (!usedCredits[app.LeaveType]) {
            usedCredits[app.LeaveType] = 0;
          }
          usedCredits[app.LeaveType] += app.NoOfDays || 0;
        });
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
        const creditLeaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        let balanceHTML = '';
        creditLeaveTypes.forEach(lt => {
          const totalCredits = yearCredit[lt.Code] || 0;
          const used = usedCredits[lt.Code] || 0;
          const remaining = Math.max(0, totalCredits - used);
          
          balanceHTML += `
            <div class="leave-balance-card">
              <div class="leave-name">${lt.Name} (${lt.Code})</div>
              <div class="leave-count">${remaining}</div>
              <div>Days Available</div>
              <small style="color: #666;">Total: ${totalCredits} | Used: ${used}</small>
            </div>
          `;
        });
        
        if (balanceHTML === '') {
          balanceHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Credit Leave Types</h3>
            </div>
          `;
        }
        
        document.getElementById('leaveBalanceContainer').innerHTML = balanceHTML;
        
      } catch (error) {
        console.error('Load leave balance error:', error);
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave balance: ${error.message}
          </div>
        `;
      }
    }

    // ==================== STUDENT LEAVE HISTORY ====================
    async function showStudentLeaveHistory() {
      if (firebase.apps.length === 0) {
        document.getElementById('studentMainContent').innerHTML = `
          <div class="card">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              Firebase not configured. Cannot load leave history.
            </div>
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        if (!student || !student.ID) {
          document.getElementById('studentMainContent').innerHTML = `
            <div class="card">
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                Student information not found. Please login again.
              </div>
            </div>
          `;
          return;
        }
        
        const contentDiv = document.getElementById('studentMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> My Leave History</h2>
            </div>
            <div style="text-align: center; padding: 40px;">
              <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--secondary);"></i>
              <p style="margin-top: 15px; color: #666;">Loading your leave applications...</p>
            </div>
          </div>
        `;
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .orderBy('AppliedDate', 'desc')
          .get();
        
        const applications = applicationsSnapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data
          };
        });
        
        let applicationsHTML = '';
        
        if (applications.length > 0) {
          const approved = applications.filter(app => app.Status === 'approved').length;
          const pending = applications.filter(app => app.Status === 'pending').length;
          const rejected = applications.filter(app => app.Status === 'rejected').length;
          const totalDays = applications.reduce((sum, app) => sum + (app.NoOfDays || 0), 0);
          
          applicationsHTML = `
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card" style="background: #d4edda;">
                <h3 style="color: #155724;">${approved}</h3>
                <p>Approved</p>
              </div>
              <div class="stat-card" style="background: #fff3cd;">
                <h3 style="color: #856404;">${pending}</h3>
                <p>Pending</p>
              </div>
              <div class="stat-card" style="background: #f8d7da;">
                <h3 style="color: #721c24;">${rejected}</h3>
                <p>Rejected</p>
              </div>
              <div class="stat-card" style="background: #d1ecf1;">
                <h3 style="color: #0c5460;">${totalDays}</h3>
                <p>Total Days</p>
              </div>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Application ID</th>
                    <th>Leave Type</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Days</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Applied Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${applications.map(app => {
                    const fromDate = app.FromDate ? formatDateForDisplay(app.FromDate) : 'N/A';
                    const toDate = app.ToDate ? formatDateForDisplay(app.ToDate) : 'N/A';
                    const appliedDate = app.AppliedDate ? formatDateForDisplay(app.AppliedDate) : 'N/A';
                    
                    let statusClass = 'badge-warning';
                    if (app.Status === 'approved') statusClass = 'badge-success';
                    if (app.Status === 'rejected') statusClass = 'badge-danger';
                    
                    return `
                      <tr>
                        <td><span class="badge badge-primary">${app.ID || 'N/A'}</span></td>
                        <td><span class="badge badge-info">${app.LeaveType || 'N/A'}</span></td>
                        <td>${fromDate}</td>
                        <td>${toDate}</td>
                        <td><strong>${app.NoOfDays || 0}</strong></td>
                        <td>${app.Reason || '-'}</td>
                        <td>
                          <span class="badge ${statusClass}">
                            ${(app.Status || 'pending').toUpperCase()}
                          </span>
                        </td>
                        <td>${appliedDate}</td>
                        <td>
                          <button class="btn btn-sm btn-info" onclick="viewStudentApplicationDetails('${app.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                          </button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          applicationsHTML = `
            <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px;">
              <i class="fas fa-calendar-times" style="font-size: 4rem; color: #6c757d; margin-bottom: 15px;"></i>
              <h3 style="color: #495057; margin-bottom: 10px;">No Leave Applications Found</h3>
              <p style="color: #6c757d; margin-bottom: 20px;">You haven't applied for any leave yet.</p>
            </div>
          `;
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> My Leave History</h2>
              <div>
                <span class="badge badge-info">Total: ${applications.length}</span>
                <button class="btn btn-sm btn-primary" onclick="refreshStudentLeaveHistory()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="student-info-box" style="margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div>
                  <h4 style="margin-bottom: 5px;">${student.Name || 'Student'}</h4>
                  <p style="color: #666; margin: 0;">
                    <strong>ID:</strong> ${student.ID || 'N/A'} | 
                    <strong>Category:</strong> ${student.Category || 'N/A'} | 
                    <strong>Year:</strong> ${student.Year || 'N/A'}
                  </p>
                </div>
              </div>
            </div>
            
            ${applicationsHTML}
          </div>
        `;
        
      } catch (error) {
        console.error('Student leave history error:', error);
        
        document.getElementById('studentMainContent').innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> My Leave History</h2>
            </div>
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Failed to load leave history</strong>
                <p>${error.message}</p>
                <button class="btn btn-sm btn-primary" onclick="showStudentLeaveHistory()" style="margin-top: 10px;">
                  <i class="fas fa-redo"></i> Try Again
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }

    function refreshStudentLeaveHistory() {
      showStudentLeaveHistory();
    }

    function formatDateForDisplay(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return 'N/A';
      }
    }

    async function viewStudentApplicationDetails(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        const student = currentStudent || currentUser;
        
        const modal = document.getElementById('operationModal');
        
        const fromDate = app.FromDate ? formatDateForDisplay(app.FromDate) : 'N/A';
        const toDate = app.ToDate ? formatDateForDisplay(app.ToDate) : 'N/A';
        const appliedDate = app.AppliedDate ? formatDateForDisplay(app.AppliedDate) : 'N/A';
        const approvedDate = app.ApprovedDate ? formatDateForDisplay(app.ApprovedDate) : 'Not approved yet';
        
        let statusColor = '#f39c12';
        if (app.Status === 'approved') statusColor = '#27ae60';
        if (app.Status === 'rejected') statusColor = '#e74c3c';
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-file-alt"></i> Application Details</h2>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <div style="text-align: center; margin-bottom: 20px;">
                <span class="badge" style="background: ${statusColor}; color: white; font-size: 1rem; padding: 8px 20px;">
                  ${(app.Status || 'pending').toUpperCase()}
                </span>
              </div>
              
              <div style="border-bottom: 1px solid #dee2e6; padding-bottom: 15px; margin-bottom: 15px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">Application ID: ${app.ID || 'N/A'}</h4>
              </div>
              
              <table style="width: 100%; border-collapse: collapse;">
                <tr>
                  <td style="padding: 8px 0; color: #666; width: 40%;">Student Name:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${student.Name || 'N/A'}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Student ID:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${student.ID || 'N/A'}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Leave Type:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${app.LeaveType || 'N/A'}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">From Date:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${fromDate}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">To Date:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${toDate}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Number of Days:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${app.NoOfDays || 0}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Applied Date:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${appliedDate}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Approved Date:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${approvedDate}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #666;">Semester:</td>
                  <td style="padding: 8px 0; font-weight: 600;">${app.Semester || 'N/A'}</td>
                </tr>
              </table>
              
              <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="display: block; margin-bottom: 8px;">Reason:</strong>
                <p style="background: white; padding: 12px; border-radius: 5px; margin: 0; color: #333;">
                  ${app.Reason || 'No reason provided'}
                </p>
              </div>
              
              ${app.ApprovedBy ? `
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666; text-align: right;">
                  Approved by: ${app.ApprovedBy}
                </div>
              ` : ''}
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('View application details error:', error);
        showAlert('Failed to load application details: ' + error.message, 'danger');
      }
    }

    // ==================== LEAVE APPROVALS ====================
    async function showLeaveApprovals() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const contentDiv = document.getElementById('adminMainContent');
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-check-circle"></i> Pending Leave Approvals</h2>
              <div>
                <span class="badge badge-warning">Pending: ${applications.length}</span>
                <button class="btn btn-sm btn-info" onclick="refreshAdminData()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="table-container">
              ${renderApprovalsTable(applications)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave approvals error:', error);
        showAlert('Failed to load leave applications: ' + error.message, 'danger');
      }
    }

    function renderApprovalsTable(applications) {
      if (applications.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>No Pending Approvals</h3>
            <p>All leave applications have been processed.</p>
            <button class="btn btn-primary" onclick="showAdminSection('leaveHistory')">
              <i class="fas fa-history"></i> View Leave History
            </button>
          </div>
        `;
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Application ID</th>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.ID || ''}</td>
                <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>${app.Reason || ''}</td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-success" onclick="approveLeave('${app.id}')" title="Approve">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectLeave('${app.id}')" title="Reject">
                      <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function approveLeave(applicationId) {
      showConfirmationDialog(
        "Approve Leave",
        "Are you sure you want to approve this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
            if (!appDoc.exists) {
              showAlert('Application not found', 'danger');
              return;
            }
            
            const application = appDoc.data();
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'approved',
              ApprovedDate: new Date().toISOString(),
              ApprovedBy: currentUser?.email || 'admin',
              updatedAt: new Date().toISOString()
            });
            
            // Send email notification if student has email and URL is configured
            if (application.StudentID && GOOGLE_APPS_SCRIPT_URL) {
              const studentSnapshot = await db.collection('students').where('ID', '==', application.StudentID).get();
              if (!studentSnapshot.empty) {
                const student = studentSnapshot.docs[0].data();
                if (student.Email) {
                  await sendApprovalEmail({...application, Status: 'approved'}, student, 'approved');
                }
              }
            }
            
            showAlert('Leave application approved successfully!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            console.error('Approve leave error:', error);
            showAlert('Failed to approve leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function rejectLeave(applicationId) {
      showConfirmationDialog(
        "Reject Leave",
        "Are you sure you want to reject this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
            if (!appDoc.exists) {
              showAlert('Application not found', 'danger');
              return;
            }
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'rejected',
              RejectedDate: new Date().toISOString(),
              RejectedBy: currentUser?.email || 'admin',
              updatedAt: new Date().toISOString()
            });
            
            showAlert('Leave application rejected!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            console.error('Reject leave error:', error);
            showAlert('Failed to reject leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function viewApplicationDetails(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        
        let studentName = 'Unknown';
        if (app.StudentID) {
          const studentsSnapshot = await db.collection('students').where('ID', '==', app.StudentID).get();
          if (!studentsSnapshot.empty) {
            studentName = studentsSnapshot.docs[0].data().Name;
          }
        }
        
        const modal = document.getElementById('operationModal');
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-info-circle"></i> Application Details</h2>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
              <h3>Application ID: ${app.ID}</h3>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">Student ID:</span>
                  <span class="info-value">${app.StudentID}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Student Name:</span>
                  <span class="info-value">${studentName}</span>
                </div>
              </div>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">Leave Type:</span>
                  <span class="info-value">${app.LeaveType}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Status:</span>
                  <span class="info-value badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                    ${(app.Status || '').toUpperCase()}
                  </span>
                </div>
              </div>
              <div class="student-info-row">
                <div class="info-item">
                  <span class="info-label">From Date:</span>
                  <span class="info-value">${formatDate(app.FromDate)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">To Date:</span>
                  <span class="info-value">${formatDate(app.ToDate)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Days:</span>
                  <span class="info-value">${app.NoOfDays}</span>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <strong>Reason:</strong>
                <p style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">${app.Reason || 'No reason provided'}</p>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('View application error:', error);
        showAlert('Failed to load application details: ' + error.message, 'danger');
      }
    }

    // ==================== LEAVE HISTORY ====================
    async function showLeaveHistory() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        applications.sort((a, b) => new Date(b.AppliedDate) - new Date(a.AppliedDate));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> All Leave Applications</h2>
              <div>
                <span class="badge badge-info">Total: ${applications.length}</span>
                <button class="btn btn-sm btn-info" onclick="refreshAdminData()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="table-container">
              ${renderLeaveHistoryTable(applications)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave history error:', error);
        showAlert('Failed to load leave applications: ' + error.message, 'danger');
      }
    }

    function renderLeaveHistoryTable(applications) {
      if (applications.length === 0) {
        return '<p>No leave applications found.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Application ID</th>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Status</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.ID || ''}</td>
                <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>
                  <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                    ${(app.Status || '').toUpperCase()}
                  </span>
                </td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ==================== STUDENTS MANAGEMENT ====================
    async function showStudentsManagement() {
      try {
        const db = firebase.firestore();
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        window.allStudents = students;
        
        const contentDiv = document.getElementById('adminMainContent');
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-user-graduate"></i> Students Management</h2>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="showAddStudentModal()">
                  <i class="fas fa-plus"></i> Add Student
                </button>
              </div>
            </div>
            
            <div class="table-container">
              ${renderStudentsTable(students)}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Students data error:', error);
        showAlert('Failed to load students: ' + error.message, 'danger');
      }
    }

    function renderStudentsTable(students) {
      if (students.length === 0) {
        return '<p>No students found. Add your first student using the "Add Student" button.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Year</th>
              <th>Semester</th>
              <th>Specialization</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr>
                <td>${student.ID || ''}</td>
                <td>${student.Name || ''}</td>
                <td>${student.Category || ''}</td>
                <td>${student.Year || 'N/A'}</td>
                <td>${student.Semester || 'N/A'}</td>
                <td>${student.Specialization || 'N/A'}</td>
                <td>${student.Email || 'N/A'}</td>
                <td>${student.Phone || 'N/A'}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-primary" onclick="editStudent('${student.ID}')" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.ID}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="applyLeaveForStudent('${student.ID}')" title="Apply Leave">
                      <i class="fas fa-file-signature"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function showAddStudentModal() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const studentsSnapshot = await db.collection('students').get();
        const existingStudentIds = new Set();
        studentsSnapshot.docs.forEach(doc => {
          existingStudentIds.add(doc.data().ID);
        });
        
        const modal = document.getElementById('operationModal');
        
        let categoriesHTML = '<option value="">Select Category</option>';
        if (categories && categories.length > 0) {
          categoriesHTML += categories.filter(c => c.Enabled === true).map(cat => `
            <option value="${cat.Category}">${cat.Category}</option>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-plus"></i> Add New Student</h2>
            <form onsubmit="addStudent(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentId" required 
                         onkeyup="checkStudentIdDuplicate(this.value)" onblur="checkStudentIdDuplicate(this.value)">
                  <div id="studentIdStatus" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentName" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category <span style="color: red;">*</span></label>
                <select class="form-control" id="newStudentCategory" required>
                  ${categoriesHTML}
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <input type="text" class="form-control" id="newStudentYear">
                </div>
                <div class="form-group">
                  <label>Semester</label>
                  <input type="text" class="form-control" id="newStudentSemester">
                </div>
              </div>
              <div class="form-group">
                <label>Specialization</label>
                <input type="text" class="form-control" id="newStudentSpecialization">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="newStudentEmail">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" class="form-control" id="newStudentPhone">
                </div>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="saveStudentBtn">
                  <i class="fas fa-save"></i> Save Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        window.existingStudentIds = existingStudentIds;
        
        window.checkStudentIdDuplicate = function(studentId) {
          const statusDiv = document.getElementById('studentIdStatus');
          const saveBtn = document.getElementById('saveStudentBtn');
          
          if (!studentId || studentId.trim() === '') {
            statusDiv.innerHTML = '';
            if (saveBtn) saveBtn.disabled = false;
            return;
          }
          
          if (window.existingStudentIds.has(studentId)) {
            statusDiv.innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> Student ID already exists!</span>';
            if (saveBtn) saveBtn.disabled = true;
          } else {
            statusDiv.innerHTML = '<span style="color: #27ae60;"><i class="fas fa-check-circle"></i> Student ID is available</span>';
            if (saveBtn) saveBtn.disabled = false;
          }
        };
        
      } catch (error) {
        console.error('Add student modal error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function addStudent(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('newStudentId').value.trim();
      const studentName = document.getElementById('newStudentName').value.trim();
      const category = document.getElementById('newStudentCategory').value;
      
      if (!studentId || !studentName || !category) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      if (window.existingStudentIds && window.existingStudentIds.has(studentId)) {
        showAlert('Student ID already exists! Please use a different ID.', 'danger');
        return;
      }
      
      const studentData = {
        ID: studentId,
        Name: studentName,
        Category: category,
        Year: document.getElementById('newStudentYear').value,
        Semester: document.getElementById('newStudentSemester').value,
        Specialization: document.getElementById('newStudentSpecialization').value,
        Email: document.getElementById('newStudentEmail').value.trim(),
        Phone: document.getElementById('newStudentPhone').value.trim(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      const saveBtn = document.getElementById('saveStudentBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<div class="loading-spinner"></div> Saving...';
      saveBtn.disabled = true;
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (!existingSnapshot.empty) {
          showAlert('Student ID already exists! Please use a different ID.', 'danger');
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
          return;
        }
        
        await db.collection('students').add(studentData);
        
        showAlert('Student added successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        console.error('Add student error:', error);
        showAlert('Failed to add student: ' + error.message, 'danger');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    async function editStudent(studentId) {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        const student = { id: studentDoc.id, ...studentDoc.data() };
        
        const modal = document.getElementById('operationModal');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Student</h2>
            <form onsubmit="updateStudent(event, '${studentId}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID</label>
                  <input type="text" class="form-control" value="${student.ID}" readonly>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editStudentName" value="${student.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category</label>
                <input type="text" class="form-control" id="editStudentCategory" value="${student.Category || ''}" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <input type="text" class="form-control" id="editStudentYear" value="${student.Year || ''}">
                </div>
                <div class="form-group">
                  <label>Semester</label>
                  <input type="text" class="form-control" id="editStudentSemester" value="${student.Semester || ''}">
                </div>
              </div>
              <div class="form-group">
                <label>Specialization</label>
                <input type="text" class="form-control" id="editStudentSpecialization" value="${student.Specialization || ''}">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="editStudentEmail" value="${student.Email || ''}">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" class="form-control" id="editStudentPhone" value="${student.Phone || ''}">
                </div>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit student error:', error);
        showAlert('Failed to load student: ' + error.message, 'danger');
      }
    }

    async function updateStudent(event, studentId) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        
        const studentData = {
          Name: document.getElementById('editStudentName').value.trim(),
          Category: document.getElementById('editStudentCategory').value,
          Year: document.getElementById('editStudentYear').value,
          Semester: document.getElementById('editStudentSemester').value,
          Specialization: document.getElementById('editStudentSpecialization').value,
          Email: document.getElementById('editStudentEmail').value.trim(),
          Phone: document.getElementById('editStudentPhone').value.trim(),
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!studentData.Name || !studentData.Category) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('students').doc(studentDoc.id).update(studentData);
        
        showAlert('Student updated successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        console.error('Update student error:', error);
        showAlert('Failed to update student: ' + error.message, 'danger');
      }
    }

    async function deleteStudent(studentId) {
      showConfirmationDialog(
        "Delete Student",
        "Are you sure you want to delete this student? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
            if (studentsSnapshot.empty) {
              showAlert('Student not found', 'danger');
              return;
            }
            
            await db.collection('students').doc(studentsSnapshot.docs[0].id).delete();
            
            showAlert('Student deleted successfully!', 'success');
            showStudentsManagement();
            
          } catch (error) {
            console.error('Delete student error:', error);
            showAlert('Failed to delete student: ' + error.message, 'danger');
          }
        }
      );
    }

    function applyLeaveForStudent(studentId) {
      showLeaveEntryForm(studentId);
    }

    // ==================== LEAVE TYPES MANAGEMENT ====================
    async function showLeaveTypesManagement() {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let leaveTypesHTML = '';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th>Max/App</th>
                  <th>Max/Year</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${leaveTypes.map(lt => `
                  <tr>
                    <td><span class="badge badge-primary">${lt.Code || ''}</span></td>
                    <td>${lt.Name || ''}</td>
                    <td>${lt.Description || ''}</td>
                    <td><span class="badge ${lt.ApprovalType === 'credit' ? 'badge-info' : 'badge-warning'}">
                      ${lt.ApprovalType === 'credit' ? 'Credit' : 'Approval'}
                    </span></td>
                    <td>${lt.MaxDaysPerApplication || 0}</td>
                    <td>${lt.MaxDaysPerYear || 0}</td>
                    <td>
                      <span class="badge ${lt.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${lt.Enabled === true ? 'ENABLED' : 'DISABLED'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editLeaveType('${lt.Code}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          leaveTypesHTML = '<p>No leave types found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-list-alt"></i> Leave Types Management</h2>
              <button class="btn btn-success" onclick="showAddLeaveTypeModal()">
                <i class="fas fa-plus"></i> Add Leave Type
              </button>
            </div>
            <div class="table-container">
              ${leaveTypesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Leave types error:', error);
        showAlert('Failed to load leave types: ' + error.message, 'danger');
      }
    }

    function showAddLeaveTypeModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add Leave Type</h2>
          <form onsubmit="addLeaveType(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Code <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeCode" required maxlength="10">
                <small style="color: #666;">Short code (e.g., CL, RH, ML)</small>
              </div>
              <div class="form-group">
                <label>Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeName" required>
                <small style="color: #666;">Full name of the leave type</small>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="leaveTypeDescription" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Approval Type <span style="color: red;">*</span></label>
              <select class="form-control" id="leaveTypeApprovalType" required>
                <option value="credit">Credit-based</option>
                <option value="approval">Approval-based</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Max Days per Application</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerApp" value="5" min="1" required>
              </div>
              <div class="form-group">
                <label>Max Days per Year</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerYear" value="10" min="1" required>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="leaveTypeEnabled" checked> Enabled
              </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Leave Type
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addLeaveType(event) {
      event.preventDefault();
      
      const leaveTypeData = {
        Code: document.getElementById('leaveTypeCode').value.trim().toUpperCase(),
        Name: document.getElementById('leaveTypeName').value.trim(),
        Description: document.getElementById('leaveTypeDescription').value.trim(),
        ApprovalType: document.getElementById('leaveTypeApprovalType').value,
        MaxDaysPerApplication: parseInt(document.getElementById('leaveTypeMaxPerApp').value) || 0,
        MaxDaysPerYear: parseInt(document.getElementById('leaveTypeMaxPerYear').value) || 0,
        Enabled: document.getElementById('leaveTypeEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!leaveTypeData.Code || !leaveTypeData.Name) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('leaveTypes').where('Code', '==', leaveTypeData.Code).get();
        if (!existingSnapshot.empty) {
          showAlert('Leave type code already exists', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').add(leaveTypeData);
        
        showAlert('Leave type added successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        console.error('Add leave type error:', error);
        showAlert('Failed to add leave type: ' + error.message, 'danger');
      }
    }

    async function editLeaveType(code) {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        const leaveType = leaveTypeDoc.data();
        
        const modal = document.getElementById('operationModal');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Leave Type</h2>
            <form onsubmit="updateLeaveType(event, '${code}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Code</label>
                  <input type="text" class="form-control" value="${leaveType.Code}" readonly>
                </div>
                <div class="form-group">
                  <label>Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editLeaveTypeName" value="${leaveType.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="editLeaveTypeDescription" rows="2">${leaveType.Description || ''}</textarea>
              </div>
              <div class="form-group">
                <label>Approval Type <span style="color: red;">*</span></label>
                <select class="form-control" id="editLeaveTypeApprovalType" required>
                  <option value="credit" ${leaveType.ApprovalType === 'credit' ? 'selected' : ''}>Credit-based</option>
                  <option value="approval" ${leaveType.ApprovalType === 'approval' ? 'selected' : ''}>Approval-based</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Max Days per Application</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerApp" value="${leaveType.MaxDaysPerApplication || 0}" min="1" required>
                </div>
                <div class="form-group">
                  <label>Max Days per Year</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerYear" value="${leaveType.MaxDaysPerYear || 0}" min="1" required>
                </div>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editLeaveTypeEnabled" ${leaveType.Enabled === true ? 'checked' : ''}> Enabled
                </label>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Leave Type
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit leave type error:', error);
        showAlert('Failed to load leave type: ' + error.message, 'danger');
      }
    }

    async function updateLeaveType(event, code) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        
        const leaveTypeData = {
          Name: document.getElementById('editLeaveTypeName').value.trim(),
          Description: document.getElementById('editLeaveTypeDescription').value.trim(),
          ApprovalType: document.getElementById('editLeaveTypeApprovalType').value,
          MaxDaysPerApplication: parseInt(document.getElementById('editLeaveTypeMaxPerApp').value) || 0,
          MaxDaysPerYear: parseInt(document.getElementById('editLeaveTypeMaxPerYear').value) || 0,
          Enabled: document.getElementById('editLeaveTypeEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!leaveTypeData.Name) {
          showAlert('Please fill in the required fields', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').doc(leaveTypeDoc.id).update(leaveTypeData);
        
        showAlert('Leave type updated successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        console.error('Update leave type error:', error);
        showAlert('Failed to update leave type: ' + error.message, 'danger');
      }
    }

    // ==================== CATEGORIES MANAGEMENT ====================
    async function showCategoriesManagement() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let categoriesHTML = '';
        if (categories && categories.length > 0) {
          categoriesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Years</th>
                  <th>Semesters</th>
                  <th>Specializations</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${categories.map(cat => `
                  <tr>
                    <td><strong>${cat.Category || ''}</strong></td>
                    <td>${cat.Years || ''}</td>
                    <td>${cat.Semesters || ''}</td>
                    <td>${cat.Specializations || ''}</td>
                    <td>
                      <span class="badge ${cat.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${cat.Enabled === true ? 'ACTIVE' : 'INACTIVE'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editCategory('${cat.Category}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          categoriesHTML = '<p>No categories found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-users-cog"></i> Categories Management</h2>
              <button class="btn btn-success" onclick="showAddCategoryModal()">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>
            <div class="table-container">
              ${categoriesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Categories error:', error);
        showAlert('Failed to load categories: ' + error.message, 'danger');
      }
    }

    function showAddCategoryModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add New Category</h2>
          <form onsubmit="addCategory(event)">
            <div class="form-group">
              <label>Category Name <span style="color: red;">*</span></label>
              <input type="text" class="form-control" id="categoryName" required>
              <small style="color: #666;">e.g., M.Tech, B.Tech, PhD</small>
            </div>
            
            <div class="form-group">
              <label>Years (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categoryYears" rows="2" required>1st Year, 2nd Year, 3rd Year, 4th Year</textarea>
              <small style="color: #666;">Enter years separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Semesters (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySemesters" rows="2" required>Semester 1, Semester 2, Semester 3, Semester 4</textarea>
              <small style="color: #666;">Enter semesters separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Specializations (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySpecializations" rows="2" required>Computer Science, IT, ECE, Mechanical</textarea>
              <small style="color: #666;">Enter specializations separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="categoryEnabled" checked> Active
              </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Category
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addCategory(event) {
      event.preventDefault();
      
      const categoryData = {
        Category: document.getElementById('categoryName').value.trim(),
        Years: document.getElementById('categoryYears').value.trim(),
        Semesters: document.getElementById('categorySemesters').value.trim(),
        Specializations: document.getElementById('categorySpecializations').value.trim(),
        Enabled: document.getElementById('categoryEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('categories').where('Category', '==', categoryData.Category).get();
        if (!existingSnapshot.empty) {
          showAlert('Category already exists', 'warning');
          return;
        }
        
        await db.collection('categories').add(categoryData);
        
        showAlert('Category added successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        console.error('Add category error:', error);
        showAlert('Failed to add category: ' + error.message, 'danger');
      }
    }

    async function editCategory(categoryName) {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', categoryName).get();
        
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        const category = categoryDoc.data();
        
        const modal = document.getElementById('operationModal');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Category</h2>
            <form onsubmit="updateCategory(event, '${categoryName}')">
              <div class="form-group">
                <label>Category Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="editCategoryName" value="${category.Category || ''}" required>
              </div>
              
              <div class="form-group">
                <label>Years (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategoryYears" rows="2" required>${category.Years || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Semesters (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySemesters" rows="2" required>${category.Semesters || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Specializations (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySpecializations" rows="2" required>${category.Specializations || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editCategoryEnabled" ${category.Enabled === true ? 'checked' : ''}> Active
                </label>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Category
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Edit category error:', error);
        showAlert('Failed to load category: ' + error.message, 'danger');
      }
    }

    async function updateCategory(event, oldCategoryName) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', oldCategoryName).get();
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        
        const categoryData = {
          Category: document.getElementById('editCategoryName').value.trim(),
          Years: document.getElementById('editCategoryYears').value.trim(),
          Semesters: document.getElementById('editCategorySemesters').value.trim(),
          Specializations: document.getElementById('editCategorySpecializations').value.trim(),
          Enabled: document.getElementById('editCategoryEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('categories').doc(categoryDoc.id).update(categoryData);
        
        showAlert('Category updated successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        console.error('Update category error:', error);
        showAlert('Failed to update category: ' + error.message, 'danger');
      }
    }

    // ==================== YEAR CREDITS MANAGEMENT ====================
    async function showYearCreditsManagement() {
      try {
        const db = firebase.firestore();
        
        const yearCreditsSnapshot = await db.collection('yearCredits').get();
        const yearCredits = yearCreditsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let creditsHTML = '';
        if (yearCredits && yearCredits.length > 0) {
          let tableHeaders = '<tr><th>Category</th><th>Year</th>';
          creditLeaveTypes.forEach(lt => {
            tableHeaders += `<th>${lt.Code}</th>`;
          });
          tableHeaders += '<th>Status</th><th>Actions</th></tr>';
          
          let tableRows = '';
          yearCredits.forEach(yc => {
            tableRows += '<tr>';
            tableRows += `<td>${yc.Category || ''}</td>`;
            tableRows += `<td>${yc.Year || ''}</td>`;
            
            creditLeaveTypes.forEach(lt => {
              const value = yc[lt.Code] || 0;
              tableRows += `<td>${value}</td>`;
            });
            
            tableRows += `<td><span class="badge ${yc.Active === true ? 'badge-success' : 'badge-danger'}">
              ${yc.Active === true ? 'ACTIVE' : 'INACTIVE'}
            </span></td>`;
            
            tableRows += `<td>
              <div class="year-credit-actions">
                <button class="btn btn-sm btn-primary" onclick="editYearCredit('${yc.Category}', '${yc.Year}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </td></tr>`;
          });
          
          creditsHTML = `
            <table class="data-table">
              <thead>${tableHeaders}</thead>
              <tbody>${tableRows}</tbody>
            </table>
          `;
        } else {
          creditsHTML = '<p>No year credits found. Add year credits for different categories and years.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-calendar-alt"></i> Year Credits Management</h2>
              <button class="btn btn-success" onclick="showAddYearCreditModal()">
                <i class="fas fa-plus"></i> Add Year Credit
              </button>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Year credits determine how many leave days students have available.
            </div>
            <div class="table-container">
              ${creditsHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Year credits error:', error);
        showAlert('Failed to load year credits: ' + error.message, 'danger');
      }
    }

    function showAddYearCreditModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add Year Credit</h2>
          <form onsubmit="addYearCredit(event)">
            <div class="form-group">
              <label>Category <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="yearCreditCategory" required>
            </div>
            <div class="form-group">
              <label>Year <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="yearCreditYear" required>
            </div>
            <div id="creditFields"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Year Credit
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
      
      // Load credit leave types
      setTimeout(async () => {
        try {
          const db = firebase.firestore();
          const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
          const creditTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
          
          const creditFieldsDiv = document.getElementById('creditFields');
          let fieldsHTML = '<h4>Credit Days</h4>';
          creditTypes.forEach(lt => {
            fieldsHTML += `
              <div class="form-group">
                <label>${lt.Name} (${lt.Code})</label>
                <input type="number" class="form-control" id="credit_${lt.Code}" value="0" min="0">
              </div>
            `;
          });
          fieldsHTML += `
            <div class="form-group">
              <label>
                <input type="checkbox" id="yearCreditActive" checked> Active
              </label>
            </div>
          `;
          creditFieldsDiv.innerHTML = fieldsHTML;
        } catch (error) {
          console.error('Error loading credit types:', error);
        }
      }, 100);
    }

    async function addYearCredit(event) {
      event.preventDefault();
      
      const category = document.getElementById('yearCreditCategory').value.trim();
      const year = document.getElementById('yearCreditYear').value.trim();
      const active = document.getElementById('yearCreditActive').checked;
      
      if (!category || !year) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
        const creditTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const creditData = {
          Category: category,
          Year: year,
          Active: active,
          createdAt: new Date().toISOString(),
          createdBy: currentUser?.email || 'admin'
        };
        
        creditTypes.forEach(lt => {
          const input = document.getElementById(`credit_${lt.Code}`);
          if (input) {
            creditData[lt.Code] = parseInt(input.value) || 0;
          }
        });
        
        await db.collection('yearCredits').add(creditData);
        
        showAlert('Year credit added successfully!', 'success');
        closeModal();
        showYearCreditsManagement();
        
      } catch (error) {
        console.error('Add year credit error:', error);
        showAlert('Failed to add year credit: ' + error.message, 'danger');
      }
    }

    function editYearCredit(category, year) {
      showAlert('Edit year credit feature - Please use the interface to edit', 'info');
    }

    // ==================== BULK UPLOAD ====================
    function showBulkUpload() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-file-upload"></i> Bulk Student Upload</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Upload a CSV file with student data. Required columns: Student ID, Name, Category, Year, Semester, Specialization, Email, Phone
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-primary" onclick="downloadSampleTemplate()">
                <i class="fas fa-download"></i> Download Sample Template
              </button>
            </div>
            
            <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
              <h3>Click to Upload CSV File</h3>
              <p>Supports .csv files with comma separator</p>
              <p><small>Maximum file size: 5MB</small></p>
            </div>
            
            <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleBulkUpload(event)">
            
            <div id="uploadPreview" style="display: none; margin-top: 20px;">
              <h3>Preview (First 10 rows)</h3>
              <div id="previewTable" class="file-preview"></div>
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-success" onclick="processBulkUpload()">
                  <i class="fas fa-check"></i> Confirm Upload
                </button>
                <button class="btn btn-danger" onclick="clearUpload()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
            
            <div id="uploadResult" style="display: none; margin-top: 20px;"></div>
          </div>
        </div>
      `;
      
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleBulkUpload({ target: { files: files } });
        }
      });
    }

    function downloadSampleTemplate() {
      const csvContent = [
        ['Student ID', 'Name', 'Category', 'Year', 'Semester', 'Specialization', 'Email', 'Phone'],
        ['S001', 'John Doe', 'B.Tech', '2nd Year', 'Semester 3', 'Computer Science', 'john@example.com', '1234567890'],
        ['S002', 'Jane Smith', 'B.Tech', '1st Year', 'Semester 1', 'Information Technology', 'jane@example.com', '0987654321']
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "student_upload_template.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Template downloaded successfully!', 'success');
    }

    let uploadedData = [];

    function handleBulkUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        showAlert('File size exceeds 5MB limit', 'danger');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = [];
          const lines = text.split('\n');
          
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const row = [];
            let current = '';
            let insideQuotes = false;
            
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              
              if (char === '"') {
                insideQuotes = !insideQuotes;
              } else if (char === ',' && !insideQuotes) {
                row.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            row.push(current.trim());
            rows.push(row);
          }
          
          if (rows.length < 2) {
            showAlert('CSV file must have at least a header row and one data row', 'warning');
            return;
          }
          
          const previewDiv = document.getElementById('uploadPreview');
          const previewTable = document.getElementById('previewTable');
          
          let previewHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
          previewHTML += '<thead><tr style="background: #f8f9fa;">';
          rows[0].forEach((cell, index) => {
            previewHTML += `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${cell}</th>`;
          });
          previewHTML += '</tr></thead><tbody>';
          
          const previewRows = Math.min(10, rows.length - 1);
          for (let i = 1; i <= previewRows; i++) {
            previewHTML += '<tr>';
            rows[i].forEach((cell, index) => {
              previewHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
            });
            previewHTML += '</tr>';
          }
          previewHTML += '</tbody></table>';
          
          if (rows.length > 11) {
            previewHTML += `<p style="text-align: center; color: #666; margin-top: 10px;">... and ${rows.length - 11} more rows</p>`;
          }
          
          previewTable.innerHTML = previewHTML;
          previewDiv.style.display = 'block';
          document.getElementById('uploadArea').style.display = 'none';
          
          uploadedData = rows.slice(1).filter(row => row.length >= 3 && row[0] && row[1] && row[2]);
          
          showAlert(`Loaded ${uploadedData.length} student records for upload`, 'info');
          
        } catch (error) {
          console.error('CSV parsing error:', error);
          showAlert('Error parsing CSV file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function processBulkUpload() {
      if (uploadedData.length === 0) {
        showAlert('No data to upload!', 'warning');
        return;
      }
      
      showAlert(`Processing ${uploadedData.length} student records...`, 'info');
      
      try {
        const db = firebase.firestore();
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const row of uploadedData) {
          try {
            const studentData = {
              ID: row[0],
              Name: row[1],
              Category: row[2],
              Year: row[3] || '',
              Semester: row[4] || '',
              Specialization: row[5] || '',
              Email: row[6] || '',
              Phone: row[7] || '',
              createdAt: new Date().toISOString(),
              createdBy: currentUser?.email || 'admin'
            };
            
            const existingSnapshot = await db.collection('students').where('ID', '==', studentData.ID).get();
            if (!existingSnapshot.empty) {
              errors.push(`Student ID ${studentData.ID} already exists - skipped`);
              errorCount++;
              continue;
            }
            
            await db.collection('students').add(studentData);
            successCount++;
            
          } catch (err) {
            errors.push(`Error adding student ${row[0]}: ${err.message}`);
            errorCount++;
          }
        }
        
        const resultDiv = document.getElementById('uploadResult');
        let resultHTML = `
          <div class="alert ${successCount > 0 ? 'alert-success' : 'alert-warning'}">
            <i class="fas ${successCount > 0 ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
            <div>
              <strong>Upload Complete</strong>
              <p>Successfully uploaded: ${successCount} students</p>
              <p>Errors: ${errorCount}</p>
            </div>
          </div>
        `;
        
        if (errors.length > 0) {
          resultHTML += `
            <div class="alert alert-danger" style="margin-top: 15px;">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Errors encountered:</strong>
                <ul style="margin: 10px 0 0 20px; max-height: 200px; overflow-y: auto;">
                  ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        resultDiv.innerHTML = resultHTML;
        resultDiv.style.display = 'block';
        
        if (successCount > 0) {
          setTimeout(() => {
            showStudentsManagement();
          }, 3000);
        }
        
      } catch (error) {
        console.error('Bulk upload error:', error);
        showAlert('Failed to process upload: ' + error.message, 'danger');
      }
    }

    function clearUpload() {
      uploadedData = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadPreview').style.display = 'none';
      document.getElementById('uploadResult').style.display = 'none';
      document.getElementById('uploadArea').style.display = 'block';
    }

    // ==================== REPORTS ====================
    function showReports() {
      const contentDiv = document.getElementById('adminMainContent');
      
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      const lastMonthStr = lastMonth.toISOString().split('T')[0];
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Reports</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Generate reports with date range filters. Export to PDF available.
            </div>
            
            <div style="margin: 20px 0;">
              <div class="form-row">
                <div class="form-group">
                  <label>From Date</label>
                  <input type="date" class="form-control" id="reportFromDate" value="${lastMonthStr}">
                </div>
                <div class="form-group">
                  <label>To Date</label>
                  <input type="date" class="form-control" id="reportToDate" value="${today}">
                </div>
              </div>
              
              <div class="form-group">
                <label>Report Type</label>
                <select class="form-control" id="reportType">
                  <option value="all">All Leave Applications</option>
                  <option value="pending">Pending Applications</option>
                  <option value="approved">Approved Applications</option>
                  <option value="rejected">Rejected Applications</option>
                  <option value="students">Student List</option>
                </select>
              </div>
              
              <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="generateReport()">
                  <i class="fas fa-search"></i> Generate Report
                </button>
                <button class="btn btn-pdf" onclick="exportToPDF()" style="margin-left: 10px;">
                  <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
              </div>
            </div>
            
            <div id="reportResult"></div>
          </div>
        </div>
      `;
    }

    async function generateReport() {
      const fromDate = document.getElementById('reportFromDate').value;
      const toDate = document.getElementById('reportToDate').value;
      const reportType = document.getElementById('reportType').value;
      
      showAlert('Generating report...', 'info');
      
      try {
        const db = firebase.firestore();
        let data = [];
        let title = '';
        
        if (reportType === 'students') {
          const snapshot = await db.collection('students').get();
          data = snapshot.docs.map(doc => doc.data());
          title = 'Student List Report';
        } else {
          let query = db.collection('leaveApplications');
          
          if (reportType !== 'all') {
            query = query.where('Status', '==', reportType);
          }
          
          const snapshot = await query.get();
          let applications = snapshot.docs.map(doc => doc.data());
          
          if (fromDate) {
            applications = applications.filter(app => app.FromDate >= fromDate);
          }
          if (toDate) {
            applications = applications.filter(app => app.ToDate <= toDate);
          }
          
          const studentsSnapshot = await db.collection('students').get();
          const studentsMap = {};
          studentsSnapshot.docs.forEach(doc => {
            const student = doc.data();
            studentsMap[student.ID] = student.Name;
          });
          
          applications.forEach(app => {
            app.StudentName = studentsMap[app.StudentID] || 'Unknown';
          });
          
          data = applications;
          title = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Leave Applications Report`;
        }
        
        const reportResult = {
          title: title,
          fromDate: fromDate,
          toDate: toDate,
          generatedDate: new Date().toLocaleString(),
          total: data.length,
          data: data
        };
        
        currentReportData = reportResult;
        currentReportType = reportType;
        
        displayReport(reportResult, reportType);
        
      } catch (error) {
        console.error('Generate report error:', error);
        showAlert('Failed to generate report: ' + error.message, 'danger');
      }
    }

    function displayReport(reportData, reportType) {
      const reportDiv = document.getElementById('reportResult');
      
      let reportHTML = `
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> ${reportData.title}</h3>
            <div>
              <span class="badge badge-info">Total: ${reportData.total || 0}</span>
              <button class="btn btn-sm btn-pdf" onclick="exportCurrentReportToPDF()" style="margin-left: 10px;">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
          <div style="padding: 15px;">
            <p><strong>Date Range:</strong> ${reportData.fromDate ? formatDate(reportData.fromDate) : 'Any'} to ${reportData.toDate ? formatDate(reportData.toDate) : 'Any'}</p>
            <p><strong>Generated:</strong> ${reportData.generatedDate}</p>
      `;
      
      if (reportData.data && reportData.data.length > 0) {
        if (reportType === 'students') {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Specialization</th>
                    <th>Email</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(student => `
                    <tr>
                      <td>${student.ID || ''}</td>
                      <td>${student.Name || ''}</td>
                      <td>${student.Category || ''}</td>
                      <td>${student.Year || 'N/A'}</td>
                      <td>${student.Semester || 'N/A'}</td>
                      <td>${student.Specialization || 'N/A'}</td>
                      <td>${student.Email || 'N/A'}</td>
                      <td>${student.Phone || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Application ID</th>
                    <th>Student</th>
                    <th>Leave Type</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Days</th>
                    <th>Status</th>
                    <th>Applied Date</th>
                    <th>Semester</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(app => `
                    <tr>
                      <td>${app.ID || ''}</td>
                      <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                      <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                      <td>${formatDate(app.FromDate)}</td>
                      <td>${formatDate(app.ToDate)}</td>
                      <td>${app.NoOfDays || 0}</td>
                      <td>
                        <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                          ${(app.Status || '').toUpperCase()}
                        </span>
                      </td>
                      <td>${formatDate(app.AppliedDate)}</td>
                      <td>${app.Semester || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } else {
        reportHTML += '<p>No data found for the selected criteria.</p>';
      }
      
      reportHTML += `
          </div>
        </div>
      `;
      
      reportDiv.innerHTML = reportHTML;
      
      showAlert('Report generated successfully', 'success');
    }

    function exportToPDF() {
      if (!currentReportData) {
        showAlert('Please generate a report first', 'warning');
        return;
      }
      
      exportCurrentReportToPDF();
    }

    function exportCurrentReportToPDF() {
      if (!currentReportData) {
        showAlert('No report data available', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      doc.setFontSize(20);
      doc.setTextColor(40, 40, 40);
      doc.text("Student Leave Management System", 150, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(currentReportData.title, 150, 30, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Date Range: ${currentReportData.fromDate ? formatDate(currentReportData.fromDate) : 'Any'} to ${currentReportData.toDate ? formatDate(currentReportData.toDate) : 'Any'}`, 14, 40);
      doc.text(`Generated: ${currentReportData.generatedDate}`, 14, 46);
      doc.text(`Total Records: ${currentReportData.total}`, 14, 52);
      
      let startY = 60;
      
      if (currentReportData.data.length > 0) {
        if (currentReportType === 'students') {
          const headers = [['Student ID', 'Name', 'Category', 'Year', 'Semester', 'Specialization', 'Email', 'Phone']];
          const rows = currentReportData.data.map(student => [
            student.ID || '',
            student.Name || '',
            student.Category || '',
            student.Year || 'N/A',
            student.Semester || 'N/A',
            student.Specialization || 'N/A',
            student.Email || 'N/A',
            student.Phone || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] },
            margin: { top: 10 }
          });
        } else {
          const headers = [['App ID', 'Student ID', 'Student Name', 'Leave Type', 'From Date', 'To Date', 'Days', 'Status', 'Semester']];
          const rows = currentReportData.data.map(app => [
            app.ID || '',
            app.StudentID || '',
            app.StudentName || '',
            app.LeaveType || '',
            formatDate(app.FromDate),
            formatDate(app.ToDate),
            app.NoOfDays || 0,
            (app.Status || '').toUpperCase(),
            app.Semester || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] },
            margin: { top: 10 }
          });
        }
      } else {
        doc.text('No data found for the selected criteria.', 14, startY);
      }
      
      const fileName = `${currentReportData.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      showAlert('PDF exported successfully!', 'success');
    }

    // ==================== BACKUP MANAGEMENT (with Restore) ====================
    function showBackupManagement() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-database"></i> Backup & Restore</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Note:</strong> Backup and restore will export/import all data including students, leave types, categories, year credits, and leave applications.
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <h3 id="backupStudentCount">0</h3>
                <p>Students</p>
              </div>
              <div class="stat-card">
                <h3 id="backupApplicationCount">0</h3>
                <p>Applications</p>
              </div>
              <div class="stat-card">
                <h3 id="backupTime">-</h3>
                <p>Last Backup</p>
              </div>
            </div>
            
            <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-success" onclick="createFirestoreBackup()" style="flex: 1;">
                <i class="fas fa-download"></i> Export Data (JSON)
              </button>
              <button class="btn btn-primary" onclick="showImportBackupModal()" style="flex: 1;">
                <i class="fas fa-upload"></i> Import Data (JSON)
              </button>
            </div>
            
            <div id="backupHistory" style="margin-top: 30px;">
              <h3>Backup History</h3>
              <div id="backupList" class="backup-list">
                <p style="text-align: center; color: #666;">Loading backups...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadBackupStats();
      loadBackupHistory();
    }

    async function loadBackupStats() {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        document.getElementById('backupStudentCount').textContent = studentsSnapshot.size;
        document.getElementById('backupApplicationCount').textContent = applicationsSnapshot.size;
        
        const lastBackup = localStorage.getItem('lastBackupTimestamp');
        if (lastBackup) {
          document.getElementById('backupTime').textContent = formatDate(lastBackup);
        } else {
          document.getElementById('backupTime').textContent = 'Never';
        }
        
      } catch (error) {
        console.error('Load backup stats error:', error);
      }
    }

    async function loadBackupHistory() {
      try {
        const db = firebase.firestore();
        const backupsSnapshot = await db.collection('configBackups')
          .orderBy('timestamp', 'desc')
          .limit(10)
          .get();
        
        const backups = backupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const backupListDiv = document.getElementById('backupList');
        
        if (backups.length > 0) {
          let backupsHTML = '';
          backups.forEach(backup => {
            backupsHTML += `
              <div class="backup-item">
                <div class="backup-info">
                  <h4><i class="fas fa-history"></i> ${backup.type || 'Unknown'} Backup</h4>
                  <div class="backup-meta">
                    <p><strong>Date:</strong> ${formatDate(backup.timestamp)}</p>
                    <p><strong>By:</strong> ${backup.createdBy || backup.syncedBy || 'Unknown'}</p>
                  </div>
                </div>
                <button class="btn btn-sm btn-info" onclick="restoreFromBackup('${backup.id}')">
                  <i class="fas fa-undo"></i> Restore
                </button>
              </div>
            `;
          });
          backupListDiv.innerHTML = backupsHTML;
        } else {
          backupListDiv.innerHTML = '<p style="text-align: center; color: #666;">No backup history found.</p>';
        }
        
      } catch (error) {
        console.error('Load backup history error:', error);
        document.getElementById('backupList').innerHTML = '<p style="text-align: center; color: #666;">Error loading backups.</p>';
      }
    }

    async function createFirestoreBackup() {
      showAlert('Exporting data...', 'info');
      
      try {
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins'];
        const backupData = {};
        
        for (const collection of collections) {
          const snapshot = await db.collection(collection).get();
          backupData[collection] = snapshot.docs.map(doc => ({
            id: doc.id,
            data: doc.data()
          }));
        }
        
        backupData.timestamp = new Date().toISOString();
        backupData.version = '1.0';
        backupData.createdBy = currentUser?.email || 'admin';
        
        // Save to Firestore backups collection
        await db.collection('configBackups').add({
          type: 'full',
          data: backupData,
          timestamp: backupData.timestamp,
          createdBy: backupData.createdBy
        });
        
        // Save to localStorage
        localStorage.setItem('lastBackupTimestamp', backupData.timestamp);
        
        // Download as JSON file
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `firestore_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Data exported successfully!', 'success');
        loadBackupStats();
        loadBackupHistory();
        
      } catch (error) {
        console.error('Export error:', error);
        showAlert('Failed to export data: ' + error.message, 'danger');
      }
    }

    function showImportBackupModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-upload"></i> Import Backup</h2>
          
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> This will overwrite ALL existing data. This action cannot be undone.
          </div>
          
          <div class="file-upload-area" onclick="document.getElementById('importFileInput').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
            <h3>Click to Select Backup File</h3>
            <p>Select a JSON backup file</p>
          </div>
          
          <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
          
          <div id="importPreview" style="display: none; margin-top: 20px;">
            <h4>Preview</h4>
            <div id="importDetails" class="alert alert-info"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="btn btn-danger" onclick="confirmImport()" style="flex: 1;">
                <i class="fas fa-exclamation-triangle"></i> Confirm Import
              </button>
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Cancel
              </button>
            </div>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    let importBackupData = null;

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          importBackupData = JSON.parse(e.target.result);
          
          const importPreview = document.getElementById('importPreview');
          const importDetails = document.getElementById('importDetails');
          
          let collections = Object.keys(importBackupData).filter(key => 
            !['timestamp', 'version', 'createdBy'].includes(key)
          );
          
          let totalRecords = 0;
          collections.forEach(col => {
            if (Array.isArray(importBackupData[col])) {
              totalRecords += importBackupData[col].length;
            }
          });
          
          importDetails.innerHTML = `
            <strong>Backup File Details:</strong><br>
            Date: ${importBackupData.timestamp ? formatDate(importBackupData.timestamp) : 'Unknown'}<br>
            Version: ${importBackupData.version || '1.0'}<br>
            Collections: ${collections.join(', ')}<br>
            Total Records: ${totalRecords}<br>
            <strong style="color: red;">This will replace ALL existing data!</strong>
          `;
          
          importPreview.style.display = 'block';
          
        } catch (error) {
          console.error('Parse backup error:', error);
          showAlert('Invalid backup file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function confirmImport() {
      if (!importBackupData) {
        showAlert('No backup data to import', 'warning');
        return;
      }
      
      showConfirmationDialog(
        "Confirm Import",
        "Are you absolutely sure you want to import this backup? All current data will be lost!",
        async () => {
          await processImport(importBackupData);
        }
      );
    }

    async function processImport(backupData) {
      showAlert('Importing data... This may take a moment.', 'info');
      closeModal();
      
      try {
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins'];
        
        // Delete all existing data
        for (const collection of collections) {
          if (backupData[collection]) {
            const snapshot = await db.collection(collection).get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          }
        }
        
        // Import new data
        for (const collection of collections) {
          if (backupData[collection] && backupData[collection].length > 0) {
            const batch = db.batch();
            backupData[collection].forEach(item => {
              const docRef = db.collection(collection).doc(item.id);
              batch.set(docRef, item.data);
            });
            await batch.commit();
          }
        }
        
        // Save import record
        await db.collection('configBackups').add({
          type: 'import',
          timestamp: new Date().toISOString(),
          createdBy: currentUser?.email || 'admin',
          source: backupData.timestamp || 'unknown'
        });
        
        showAlert('Data imported successfully! Refreshing...', 'success');
        
        setTimeout(() => {
          window.location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('Import error:', error);
        showAlert('Failed to import data: ' + error.message, 'danger');
      }
    }

    async function restoreFromBackup(backupId) {
      try {
        const db = firebase.firestore();
        
        const backupDoc = await db.collection('configBackups').doc(backupId).get();
        if (!backupDoc.exists) {
          showAlert('Backup not found', 'danger');
          return;
        }
        
        const backup = backupDoc.data();
        
        showConfirmationDialog(
          "Restore from Backup",
          `Restore data from ${formatDate(backup.timestamp)}? This will overwrite current data.`,
          async () => {
            if (backup.data) {
              await processImport(backup.data);
            } else {
              showAlert('Invalid backup format', 'danger');
            }
          }
        );
        
      } catch (error) {
        console.error('Restore error:', error);
        showAlert('Failed to restore backup: ' + error.message, 'danger');
      }
    }

    // ==================== ADMIN PROFILE ====================
    function showAdminProfile() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-user-circle"></i> My Profile</h2>
            <div>
              <button class="btn btn-warning" onclick="showForgotPasswordModal()" style="margin-right: 10px;">
                <i class="fas fa-key"></i> Reset Password
              </button>
              <button class="btn btn-primary" onclick="editAdminProfile()">
                <i class="fas fa-edit"></i> Edit Profile
              </button>
            </div>
          </div>
          
          <div class="profile-header">
            <div class="profile-avatar">
              <i class="fas fa-user-shield"></i>
            </div>
            <div class="profile-info">
              <h2>${currentUser.name || 'Administrator'}</h2>
              <p><i class="fas fa-envelope"></i> ${currentUser.email || 'No email'}</p>
              <p><i class="fas fa-id-card"></i> User ID: ${currentUser.uid || 'N/A'}</p>
            </div>
          </div>
          
          <div class="profile-details">
            <div class="profile-field">
              <label>User ID (Firebase UID)</label>
              <div class="value">${currentUser.uid || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Email Address</label>
              <div class="value">${currentUser.email || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Display Name</label>
              <div class="value">${currentUser.name || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Role</label>
              <div class="value">Administrator</div>
            </div>
          </div>
        </div>
      `;
    }

    function editAdminProfile() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-edit"></i> Edit Profile</h2>
          <form onsubmit="updateAdminProfile(event)">
            <div class="form-group">
              <label>User ID (Firebase UID)</label>
              <input type="text" class="form-control" value="${currentUser.uid || ''}" readonly disabled>
            </div>
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" class="form-control" value="${currentUser.email || ''}" readonly disabled>
            </div>
            <div class="form-group">
              <label>Display Name</label>
              <input type="text" class="form-control" id="adminProfileName" value="${currentUser.name || ''}" required>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Update Profile
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function updateAdminProfile(event) {
      event.preventDefault();
      
      const name = document.getElementById('adminProfileName').value;
      
      try {
        if (firebase.apps.length > 0 && currentUser.uid !== 'default-admin') {
          await firebase.firestore().collection('admins').doc(currentUser.uid).update({
            name: name,
            updatedAt: new Date().toISOString()
          });
          
          currentUser.name = name;
        }
        
        document.getElementById('adminName').textContent = name;
        
        showAlert('Profile updated successfully!', 'success');
        closeModal();
        showAdminProfile();
        
      } catch (error) {
        console.error('Profile update error:', error);
        showAlert('Failed to update profile: ' + error.message, 'danger');
      }
    }

    // ==================== STUDENT PROFILE ====================
    function showStudentProfile() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-user-circle"></i> My Profile</h2>
            <button class="btn btn-primary" onclick="editStudentProfile()">
              <i class="fas fa-edit"></i> Edit Profile
            </button>
          </div>
          
          <div class="profile-header" style="background: linear-gradient(135deg, var(--student-color) 0%, #138a72 100%);">
            <div class="profile-avatar">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="profile-info">
              <h2>${student.Name || 'Student'}</h2>
              <p><i class="fas fa-id-card"></i> Student ID: ${student.ID || 'N/A'}</p>
              <p><i class="fas fa-envelope"></i> ${student.Email || 'No email'}</p>
            </div>
          </div>
          
          <div class="profile-details">
            <div class="profile-field">
              <label>Student ID</label>
              <div class="value">${student.ID || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Full Name</label>
              <div class="value">${student.Name || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Category</label>
              <div class="value">${student.Category || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Year</label>
              <div class="value">${student.Year || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Semester</label>
              <div class="value">${student.Semester || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Specialization</label>
              <div class="value">${student.Specialization || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Email</label>
              <div class="value">${student.Email || 'N/A'}</div>
            </div>
            <div class="profile-field">
              <label>Phone</label>
              <div class="value">${student.Phone || 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
    }

    function editStudentProfile() {
      const student = currentStudent || currentUser;
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-edit"></i> Edit Student Profile</h2>
          <form onsubmit="updateStudentProfile(event)">
            <div class="form-group">
              <label>Student ID</label>
              <input type="text" class="form-control" id="studentProfileId" value="${student.ID || ''}" required>
            </div>
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" class="form-control" id="studentProfileName" value="${student.Name || ''}" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="studentProfileEmail" value="${student.Email || ''}">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" class="form-control" id="studentProfilePhone" value="${student.Phone || ''}">
            </div>
            <div class="form-group">
              <label>Category</label>
              <input type="text" class="form-control" id="studentProfileCategory" value="${student.Category || ''}">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="text" class="form-control" id="studentProfileYear" value="${student.Year || ''}">
            </div>
            <div class="form-group">
              <label>Semester</label>
              <input type="text" class="form-control" id="studentProfileSemester" value="${student.Semester || ''}">
            </div>
            <div class="form-group">
              <label>Specialization</label>
              <input type="text" class="form-control" id="studentProfileSpecialization" value="${student.Specialization || ''}">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Update Profile
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function updateStudentProfile(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('studentProfileId').value;
      const name = document.getElementById('studentProfileName').value;
      const email = document.getElementById('studentProfileEmail').value;
      const phone = document.getElementById('studentProfilePhone').value;
      const category = document.getElementById('studentProfileCategory').value;
      const year = document.getElementById('studentProfileYear').value;
      const semester = document.getElementById('studentProfileSemester').value;
      const specialization = document.getElementById('studentProfileSpecialization').value;
      
      try {
        if (firebase.apps.length > 0) {
          const db = firebase.firestore();
          const student = currentStudent || currentUser;
          
          await db.collection('students').doc(student.uid).update({
            ID: studentId,
            Name: name,
            Email: email,
            Phone: phone,
            Category: category,
            Year: year,
            Semester: semester,
            Specialization: specialization,
            updatedAt: new Date().toISOString()
          });
          
          currentUser.ID = studentId;
          currentUser.Name = name;
          currentUser.Email = email;
          currentUser.Phone = phone;
          currentUser.Category = category;
          currentUser.Year = year;
          currentUser.Semester = semester;
          currentUser.Specialization = specialization;
          
          if (currentRole === 'student') {
            currentStudent = currentUser;
            document.getElementById('studentName').textContent = name;
          }
        }
        
        showAlert('Profile updated successfully!', 'success');
        closeModal();
        showStudentProfile();
        
      } catch (error) {
        console.error('Student profile update error:', error);
        showAlert('Failed to update profile: ' + error.message, 'danger');
      }
    }

    // ==================== EMAIL FUNCTIONS ====================
    async function sendApprovalEmail(applicationData, studentData, action, oldData = null) {
      if (!studentData.Email) {
        console.log('Student has no email - skipping notification');
        return;
      }
      
      if (!GOOGLE_APPS_SCRIPT_URL) {
        console.warn('Google Apps Script URL not configured - skipping email notification');
        return;
      }
      
      try {
        const emailParams = {
          to_email: studentData.Email,
          to_name: studentData.Name,
          student_id: studentData.ID,
          application_id: applicationData.ID,
          leave_type: applicationData.LeaveType,
          from_date: formatDateDDMMYYYY(applicationData.FromDate),
          to_date: formatDateDDMMYYYY(applicationData.ToDate),
          days: applicationData.NoOfDays,
          reason: applicationData.Reason,
          status: applicationData.Status,
          action: action,
          approved_by: currentUser?.email || 'Admin',
          approved_date: formatDateDDMMYYYY(new Date().toISOString()),
          category_year: `${studentData.Category || ''} - ${studentData.Year || ''}`.trim()
        };
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailParams)
        });
        
        console.log('Email sent successfully to:', studentData.Email);
        return true;
        
      } catch (error) {
        console.error('Error sending email:', error);
        return false;
      }
    }

    // ==================== INITIALIZATION ====================
    // Start the auto-load process
    autoLoadFirebaseConfig();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl+Shift+D to show debug panel
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        showDebugPanel();
      }
      
      // Ctrl+R to refresh (prevent default and do our refresh)
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        if (currentRole === 'admin') {
          refreshAdminData();
        } else if (currentRole === 'student') {
          refreshStudentData();
        }
      }
      
      // Escape to close modal
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Also try after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // If Firebase still not loaded after 2 seconds, try again
      setTimeout(() => {
        if (firebase.apps.length === 0) {
          console.log('Firebase not loaded, retrying...');
          autoLoadFirebaseConfig();
        }
      }, 2000);
    });
  </script>
</body>
</html>
