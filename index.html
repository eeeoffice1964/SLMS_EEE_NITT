<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Leave Management System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #17a2b8;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --admin-color: #8e44ad;
      --student-color: #16a085;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 2.2rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
    }

    .role-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
    }

    .role-btn {
      padding: 18px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .role-btn i {
      font-size: 1.3rem;
    }

    .admin-btn {
      background: var(--admin-color);
      color: white;
    }

    .admin-btn:hover {
      background: #7d3c98;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
    }

    .student-btn {
      background: var(--student-color);
      color: white;
    }

    .student-btn:hover {
      background: #138a72;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(22, 160, 133, 0.3);
    }

    .footer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .footer p {
      color: #666;
      font-size: 0.9rem;
    }

    .footer i {
      color: var(--secondary);
      margin-right: 5px;
    }

    /* Modal Styles - Fixed for email config */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s ease;
    }

    /* Special wider modal for email config */
    .modal-content.wide-modal {
      max-width: 900px;
    }

    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
      transition: color 0.3s ease;
      z-index: 10;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-link {
      background: none;
      border: none;
      color: var(--secondary);
      padding: 0;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-link:hover {
      text-decoration: underline;
      transform: none;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #27ae60;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #e74c3c;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #f39c12;
    }

    .close-btn {
      margin-left: auto;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Dashboard Styles */
    .dashboard-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      min-height: 90vh;
      display: none;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .header-right button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .header-right button:hover {
      background: rgba(255,255,255,0.3);
    }

    .dashboard-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 0;
      min-height: calc(90vh - 100px);
    }

    .sidebar {
      background: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #e9ecef;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .menu-btn {
      width: 100%;
      text-align: left;
      padding: 12px 15px;
      border: none;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--dark);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid transparent;
    }

    .menu-btn.active {
      background: var(--secondary);
      color: white;
      border-left-color: var(--primary);
    }

    .menu-btn:hover:not(.active) {
      background: #e9ecef;
      border-left-color: #adb5bd;
    }

    .main-content {
      padding: 25px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
      transition: opacity 0.3s ease;
    }

    .main-content.hidden {
      opacity: 0;
    }

    .main-content.visible {
      opacity: 1;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
      flex-wrap: wrap;
      gap: 10px;
    }

    .card-header h2 {
      color: var(--primary);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #d6eaf8; color: #1a5276; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 5px solid var(--secondary);
    }

    .stat-card h3 {
      color: var(--secondary);
      font-size: 2rem;
      margin: 5px 0;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 800px;
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    /* Form row for 2-column layout */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    /* Email config specific styles */
    .email-config-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .config-section {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #e9ecef;
    }

    .config-section h3 {
      margin-bottom: 15px;
      color: var(--primary);
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 8px;
    }

    .storage-status {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 0.9rem;
    }

    .storage-status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .storage-status-item i {
      width: 20px;
    }

    .storage-status-item.success { color: #28a745; }
    .storage-status-item.warning { color: #ffc107; }
    .storage-status-item.info { color: #17a2b8; }

    .apps-script-code {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .apps-script-code pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #ecf0f1;
      font-family: 'Courier New', monospace;
    }

    .email-template-preview {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background: #f8f9fa;
      max-height: 300px;
      overflow-y: auto;
    }

    .template-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
      flex-wrap: wrap;
    }

    .template-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .template-tab.active {
      color: var(--secondary);
      border-bottom: 3px solid var(--secondary);
      background: #e8f4fd;
    }

    /* Debug button */
    #debugButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
        max-height: 300px;
      }
      
      .header-right {
        flex-direction: column;
        align-items: flex-end;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .email-config-layout {
        grid-template-columns: 1fr;
      }
      
      .modal-content.wide-modal {
        max-width: 95%;
      }
      
      .login-card {
        padding: 25px;
      }
      
      .login-card h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <div class="login-card">
      <h1><i class="fas fa-graduation-cap"></i> Leave Management System</h1>
      <p class="subtitle">Version 5.0 | Enhanced Security</p>
      
      <div class="role-selector">
        <button onclick="showAdminLoginForm()" class="role-btn admin-btn">
          <i class="fas fa-user-shield"></i> Admin Login
        </button>
        <button onclick="showStudentLoginForm()" class="role-btn student-btn">
          <i class="fas fa-user-graduate"></i> Student Login
        </button>
      </div>
      
      <div class="footer">
        <p>
          <i class="fas fa-shield-alt"></i> Secure Authentication System
        </p>
        <p style="color: #27ae60; font-size: 0.85rem; margin-top: 5px;">
          <i class="fas fa-check-circle"></i> Firebase Ready
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        <p>Welcome, <span id="adminName">Administrator</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="firebaseStatusBadge">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshAdminData()" title="Refresh Data" id="adminRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showAdminProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="showEmailConfig()">
          <i class="fas fa-envelope"></i> Email Config
        </button>
        <button onclick="showConfigHistory()">
          <i class="fas fa-history"></i> Config History
        </button>
        <button onclick="syncConfigurations()">
          <i class="fas fa-sync"></i> Sync Config
        </button>
        <button onclick="logout('admin')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showAdminSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('students')">
            <i class="fas fa-user-graduate"></i> Students
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveTypes')">
            <i class="fas fa-list-alt"></i> Leave Types
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('categories')">
            <i class="fas fa-users-cog"></i> Categories
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('yearCredits')">
            <i class="fas fa-calendar-alt"></i> Year Credits
          </button></li>
          <li><button class="menu-btn" onclick="showLeaveEntryForm()">
            <i class="fas fa-file-signature"></i> Enter Leave Request
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveApprovals')">
            <i class="fas fa-check-circle"></i> Leave Approvals
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('leaveHistory')">
            <i class="fas fa-history"></i> Leave History
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('bulkUpload')">
            <i class="fas fa-file-upload"></i> Bulk Upload
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('reports')">
            <i class="fas fa-chart-bar"></i> Reports
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('backup')">
            <i class="fas fa-database"></i> Backup & Restore
          </button></li>
          <li><button class="menu-btn" onclick="showAdminSection('firebaseConfig')">
            <i class="fas fa-fire"></i> Firebase Config
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="adminMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Student Dashboard -->
  <div id="studentDashboard" class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1><i class="fas fa-user-graduate"></i> Student Dashboard</h1>
        <p>Welcome, <span id="studentName">Student</span>
        <span class="badge badge-success" style="margin-left: 10px;" id="studentFirebaseStatus">FIREBASE MODE</span>
        </p>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="refreshStudentData()" title="Refresh Data" id="studentRefreshBtn">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="showStudentProfile()">
          <i class="fas fa-user-circle"></i> Profile
        </button>
        <button onclick="logout('student')">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="dashboard-content">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><button class="menu-btn active" onclick="showStudentSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveBalance')">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </button></li>
          <li><button class="menu-btn" onclick="showStudentSection('leaveHistory')">
            <i class="fas fa-history"></i> My Leave History
          </button></li>
        </ul>
      </div>
      <div class="main-content visible" id="studentMainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal for Operations -->
  <div id="operationModal" class="modal"></div>

  <!-- Debug Button (hidden by default, shows when errors occur) -->
  <button id="debugButton" onclick="showDebugInfo()">ðŸ”§ Debug</button>

  <script>
    // ==================== AUTO-DEBUGGING SYSTEM ====================
    const DEBUG = {
      enabled: true,
      logs: [],
      errors: [],
      warnings: [],
      
      log: function(message, data = null) {
        if (this.enabled) {
          console.log(`âœ… [AUTO-DEBUG] ${message}`, data || '');
          this.logs.push({ time: new Date().toISOString(), message, data });
        }
      },
      
      warn: function(message, data = null) {
        console.warn(`âš ï¸ [AUTO-DEBUG] ${message}`, data || '');
        this.warnings.push({ time: new Date().toISOString(), message, data });
      },
      
      error: function(message, data = null) {
        console.error(`âŒ [AUTO-DEBUG] ${message}`, data || '');
        this.errors.push({ time: new Date().toISOString(), message, data });
        
        // Show debug button on error
        const debugBtn = document.getElementById('debugButton');
        if (debugBtn) debugBtn.style.display = 'block';
      },
      
      showReport: function() {
        console.log('========== AUTO-DEBUG REPORT ==========');
        console.log(`Logs: ${this.logs.length}, Warnings: ${this.warnings.length}, Errors: ${this.errors.length}`);
        if (this.errors.length > 0) {
          console.log('LAST ERROR:', this.errors[this.errors.length - 1]);
        }
        console.log('=======================================');
        
        alert(`Debug Info:
Errors: ${this.errors.length}
Warnings: ${this.warnings.length}
Firebase: ${firebase.apps.length > 0 ? 'Connected' : 'Not Connected'}
Modal: ${document.getElementById('operationModal') ? 'OK' : 'Missing'}`);
      }
    };

    // Global error handler
    window.addEventListener('error', function(e) {
      DEBUG.error('Global error:', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        error: e.error
      });
    });

    function showDebugInfo() {
      DEBUG.showReport();
    }

    // ==================== GLOBAL VARIABLES ====================
    let firebaseInitialized = false;
    let currentUser = null;
    let currentRole = null;
    let currentStudent = null;
    let refreshInterval = null;
    let selectedStudentInfo = null;
    
    // Global variables for filtering and reports
    let currentReportData = null;
    let currentReportType = null;
    let currentFromDate = null;
    let currentToDate = null;
    let allStudents = [];
    let selectedStudents = new Set();
    let currentFilters = {
      search: '',
      category: '',
      year: '',
      semester: '',
      specialization: ''
    };

    // Store filter states globally
    let filterStates = {
      students: {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      },
      leaveHistory: {
        search: '',
        status: '',
        leaveType: '',
        studentId: ''
      },
      leaveApprovals: {
        search: '',
        studentId: '',
        leaveType: ''
      },
      reports: {
        fromDate: '',
        toDate: '',
        reportType: 'all'
      }
    };

    // Default admin credentials
    const DEFAULT_ADMIN_EMAIL = 'admin@leavemanagement.com';
    const DEFAULT_ADMIN_PASSWORD = 'Admin@123';

    // Google Apps Script URL - HARDCODED for security
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzE28pS-Jc66E8Qs2z4eC8gX0Cqomr9VDbfj6AzAX-D8XMXi4Z6xT4oST5xq6i0ts0/exec';
    
    // Store in localStorage
    if (!localStorage.getItem('googleAppsScriptUrl')) {
      localStorage.setItem('googleAppsScriptUrl', GOOGLE_APPS_SCRIPT_URL);
    }

    // Track initialization state
    let firebaseInitPromise = null;

    // ==================== FIREBASE INITIALIZATION ====================
    async function initializeFirebaseFromAppsScript() {
      if (firebaseInitPromise) {
        return firebaseInitPromise;
      }
      
      firebaseInitPromise = new Promise(async (resolve) => {
        try {
          DEBUG.log('Fetching Firebase config from Apps Script bridge...');
          
          // Try multiple approaches to fetch config
          let config = null;
          
          // Approach 1: Standard fetch with timeout
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
              method: 'GET',
              mode: 'cors',
              headers: { 'Content-Type': 'application/json' },
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
              const data = await response.json();
              if (!data.error) {
                config = data;
                DEBUG.log('Config fetched via standard fetch');
              }
            }
          } catch (e) {
            DEBUG.warn('Standard fetch failed:', e.message);
          }
          
          // Approach 2: Try JSONP if standard fetch fails
          if (!config) {
            try {
              config = await fetchConfigWithJSONP();
              DEBUG.log('Config fetched via JSONP');
            } catch (e) {
              DEBUG.warn('JSONP failed:', e.message);
            }
          }
          
          // If we got config, save and initialize
          if (config) {
            saveConfigToLocalStorage(config);
            const result = initializeFirebase(config);
            resolve(result);
            return;
          }
          
          // Try localStorage cache
          DEBUG.warn('All fetch attempts failed, trying localStorage cache...');
          const cachedConfig = localStorage.getItem('firebaseConfig');
          if (cachedConfig) {
            try {
              config = JSON.parse(cachedConfig);
              DEBUG.log('Using cached config from localStorage');
              const result = initializeFirebase(config);
              resolve(result);
              return;
            } catch (e) {
              DEBUG.error('Failed to parse cached config:', e);
            }
          }
          
          // If nothing works, resolve with failure
          DEBUG.error('All initialization methods failed');
          updateFirebaseStatusBadges(false);
          resolve({ success: false, error: 'Failed to load Firebase configuration' });
          
        } catch (error) {
          DEBUG.error('Fatal initialization error:', error);
          updateFirebaseStatusBadges(false);
          resolve({ success: false, error: error.message });
        }
      });
      
      return firebaseInitPromise;
    }

    function fetchConfigWithJSONP() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        const timeoutId = setTimeout(() => {
          window[callbackName] = null;
          document.head.removeChild(script);
          reject(new Error('JSONP timeout'));
        }, 10000);
        
        window[callbackName] = function(data) {
          clearTimeout(timeoutId);
          window[callbackName] = null;
          document.head.removeChild(script);
          resolve(data);
        };
        
        const script = document.createElement('script');
        script.src = GOOGLE_APPS_SCRIPT_URL + '?callback=' + callbackName;
        script.onerror = function() {
          clearTimeout(timeoutId);
          window[callbackName] = null;
          document.head.removeChild(script);
          reject(new Error('JSONP script load error'));
        };
        document.head.appendChild(script);
      });
    }

    function saveConfigToLocalStorage(config) {
      try {
        localStorage.setItem('firebaseConfig', JSON.stringify(config));
        localStorage.setItem('fb_apiKey', config.apiKey || '');
        localStorage.setItem('fb_authDomain', config.authDomain || '');
        localStorage.setItem('fb_projectId', config.projectId || '');
        localStorage.setItem('fb_storageBucket', config.storageBucket || '');
        localStorage.setItem('fb_messagingSenderId', config.messagingSenderId || '');
        localStorage.setItem('fb_appId', config.appId || '');
        if (config.measurementId) localStorage.setItem('fb_measurementId', config.measurementId);
        localStorage.setItem('configTimestamp', Date.now().toString());
        DEBUG.log('Config saved to localStorage');
      } catch (e) {
        DEBUG.warn('Failed to save to localStorage:', e);
      }
    }

    function initializeFirebase(config) {
      try {
        if (firebase.apps.length > 0) {
          return { success: true, message: 'Firebase already initialized' };
        }
        
        if (!config || !config.apiKey || !config.projectId) {
          throw new Error('Invalid Firebase configuration');
        }
        
        DEBUG.log('Initializing Firebase with config');
        
        firebase.initializeApp(config);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        // Enable persistence
        firebase.firestore().enablePersistence()
          .then(() => DEBUG.log('Firestore persistence enabled'))
          .catch((err) => {
            if (err.code === 'failed-precondition') {
              DEBUG.warn('Multiple tabs open, persistence disabled');
            } else if (err.code === 'unimplemented') {
              DEBUG.warn('Browser does not support persistence');
            }
          });
        
        firebaseInitialized = true;
        updateFirebaseStatusBadges(true);
        
        // Test connection
        testFirebaseConnection().catch(DEBUG.warn);
        
        return { success: true };
        
      } catch (error) {
        DEBUG.error('Firebase initialization error:', error);
        updateFirebaseStatusBadges(false);
        return { success: false, error: error.message };
      }
    }

    async function testFirebaseConnection() {
      if (!firebase.apps.length) return false;
      
      try {
        await firebase.firestore().collection('_test_').doc('connection').get();
        DEBUG.log('Firebase connection test successful');
        updateFirebaseStatusBadges(true);
        return true;
      } catch (error) {
        DEBUG.warn('Firebase connection test failed:', error.message);
        updateFirebaseStatusBadges(false);
        return false;
      }
    }

    function updateFirebaseStatusBadges(isConnected) {
      const adminBadge = document.getElementById('firebaseStatusBadge');
      const studentBadge = document.getElementById('studentFirebaseStatus');
      
      const statusText = isConnected ? 'FIREBASE CONNECTED' : 'FIREBASE DISCONNECTED';
      const statusClass = isConnected ? 'badge-success' : 'badge-danger';
      
      if (adminBadge) {
        adminBadge.textContent = statusText;
        adminBadge.className = `badge ${statusClass}`;
      }
      
      if (studentBadge) {
        studentBadge.textContent = statusText;
        studentBadge.className = `badge ${statusClass}`;
      }
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    function showAdminLoginForm() {
      DEBUG.log('showAdminLoginForm called');
      
      // Ensure modal exists
      let modal = document.getElementById('operationModal');
      if (!modal) {
        DEBUG.warn('Modal not found - creating');
        modal = document.createElement('div');
        modal.id = 'operationModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
      }
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
          <form onsubmit="adminLogin(event)">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="adminEmail" required 
                     placeholder="Enter your registered email">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" class="form-control" id="adminPassword" required 
                     placeholder="Enter your password">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
              <button type="button" class="btn btn-link" onclick="showForgotPasswordModal()" 
                      style="color: var(--secondary); padding: 0; background: none; border: none; cursor: pointer;">
                <i class="fas fa-key"></i> Forgot Password?
              </button>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;" id="adminLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
      DEBUG.log('Admin login modal displayed');
    }

    async function adminLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      
      const loginBtn = document.getElementById('adminLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Verifying...';
      loginBtn.disabled = true;
      
      try {
        const isFirebaseConfigured = localStorage.getItem('firebaseConfig') !== null && firebase.apps.length > 0;
        
        if (!isFirebaseConfigured) {
          // First-time login with default credentials
          if (email === DEFAULT_ADMIN_EMAIL && password === DEFAULT_ADMIN_PASSWORD) {
            currentUser = {
              uid: 'default-admin',
              email: DEFAULT_ADMIN_EMAIL,
              name: 'Administrator',
              role: 'admin'
            };
            currentRole = 'admin';
            
            showAlert('Welcome, Administrator! Please configure Firebase to continue.', 'info');
            closeModal();
            showAdminDashboard();
            
            setTimeout(() => {
              showFirebaseConfigPanel();
            }, 500);
            
            return;
          } else {
            showAlert('Invalid credentials. First-time login requires default credentials.', 'danger');
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
            return;
          }
        }
        
        // Firebase is configured - use Firebase Auth
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        
        // Verify this is an admin account
        const adminDoc = await firebase.firestore().collection('admins').doc(userCredential.user.uid).get();
        
        if (adminDoc.exists) {
          currentUser = {
            uid: userCredential.user.uid,
            email: userCredential.user.email,
            name: adminDoc.data().name || 'Administrator',
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Welcome back, Administrator!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        } else {
          // Create admin record
          await firebase.firestore().collection('admins').doc(userCredential.user.uid).set({
            email: email,
            name: email.split('@')[0],
            role: 'admin',
            createdAt: new Date().toISOString()
          });
          
          currentUser = {
            uid: userCredential.user.uid,
            email: email,
            name: email.split('@')[0],
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Admin account created! Welcome!', 'success');
          closeModal();
          showAdminDashboard();
          startAutoRefresh();
        }
        
      } catch (error) {
        DEBUG.error('Admin login error:', error);
        
        // Try default admin as fallback
        if (email === DEFAULT_ADMIN_EMAIL && password === DEFAULT_ADMIN_PASSWORD) {
          currentUser = {
            uid: 'default-admin',
            email: DEFAULT_ADMIN_EMAIL,
            name: 'Administrator',
            role: 'admin'
          };
          currentRole = 'admin';
          
          showAlert('Using default admin mode. Firebase Auth failed: ' + error.message, 'warning');
          closeModal();
          showAdminDashboard();
          return;
        }
        
        let errorMessage = 'Login failed';
        switch(error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email format.';
            break;
          default:
            errorMessage = error.message;
        }
        
        showAlert(errorMessage, 'danger');
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    function showStudentLoginForm() {
      DEBUG.log('showStudentLoginForm called');
      
      // Ensure modal exists
      let modal = document.getElementById('operationModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'operationModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
      }
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-user-graduate"></i> Student Login</h2>
          <form onsubmit="studentLogin(event)">
            <div class="form-group">
              <label>Student ID / Roll Number</label>
              <input type="text" class="form-control" id="studentIdInput" placeholder="Enter your student ID" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="studentLoginBtn">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
      DEBUG.log('Student login modal displayed');
    }

    async function studentLogin(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('studentIdInput').value.trim();
      
      const loginBtn = document.getElementById('studentLoginBtn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
      loginBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          // Demo mode
          if (studentId) {
            currentUser = {
              uid: 'demo-student',
              ID: studentId,
              Name: 'Demo Student',
              role: 'student'
            };
            currentRole = 'student';
            currentStudent = currentUser;
            
            showAlert('Welcome, Demo Student!', 'success');
            closeModal();
            showStudentDashboard();
          } else {
            showAlert('Please enter Student ID', 'warning');
          }
          return;
        }
        
        const db = firebase.firestore();
        const snapshot = await db.collection('students').where('ID', '==', studentId).limit(1).get();
        
        if (snapshot.empty) {
          showAlert('Student not found with this ID', 'danger');
          return;
        }
        
        const studentDoc = snapshot.docs[0];
        const studentData = studentDoc.data();
        
        currentUser = {
          uid: studentDoc.id,
          ...studentData,
          id: studentData.ID
        };
        currentRole = 'student';
        currentStudent = currentUser;
        
        showAlert(`Welcome, ${studentData.Name}!`, 'success');
        closeModal();
        showStudentDashboard();
        startAutoRefresh();
        
      } catch (error) {
        DEBUG.error('Student login error:', error);
        showAlert('Login failed: ' + error.message, 'danger');
      } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    function showForgotPasswordModal() {
      const modal = document.getElementById('operationModal');
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-key"></i> Reset Password</h2>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Enter your registered email address. You will receive a password reset link.
          </div>
          
          <form onsubmit="sendPasswordResetEmail(event)">
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" class="form-control" id="resetEmail" required 
                     placeholder="Enter your admin email">
            </div>
            
            <div id="resetStatus"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary" style="flex: 1;" id="sendResetBtn">
                <i class="fas fa-paper-plane"></i> Send Reset Link
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function sendPasswordResetEmail(event) {
      event.preventDefault();
      
      const email = document.getElementById('resetEmail').value;
      const sendBtn = document.getElementById('sendResetBtn');
      const resetStatus = document.getElementById('resetStatus');
      
      sendBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';
      sendBtn.disabled = true;
      
      try {
        if (firebase.apps.length > 0) {
          await firebase.auth().sendPasswordResetEmail(email, {
            url: window.location.href,
            handleCodeInApp: false
          });
        } else {
          // Simulate in demo mode
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
        
        resetStatus.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>Reset email sent!</strong>
              <p>Check your inbox for instructions.</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-check"></i> Email Sent';
        
        setTimeout(() => {
          closeModal();
        }, 3000);
        
      } catch (error) {
        DEBUG.error('Password reset error:', error);
        resetStatus.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <strong>Failed to send reset email</strong>
              <p>${error.message}</p>
            </div>
          </div>
        `;
        
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Try Again';
        sendBtn.disabled = false;
      }
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function showAdminDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('studentDashboard').style.display = 'none';
      
      if (currentUser) {
        document.getElementById('adminName').textContent = currentUser.name || 'Administrator';
      }
      
      showAdminSection('dashboard');
    }

    function showStudentDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'block';
      
      if (currentUser) {
        document.getElementById('studentName').textContent = currentUser.name || 'Student';
      }
      
      showStudentSection('dashboard');
    }

    async function logout(role) {
      stopAutoRefresh();
      
      try {
        if (firebase.apps.length > 0 && firebase.auth().currentUser) {
          await firebase.auth().signOut();
        }
      } catch (error) {
        DEBUG.error('Signout error:', error);
      }
      
      currentUser = null;
      currentRole = null;
      currentStudent = null;
      selectedStudentInfo = null;
      selectedStudents.clear();
      
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('studentDashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      
      showAlert('Logged out successfully', 'info');
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshInterval = setInterval(() => {
        if (currentRole === 'admin') {
          refreshAdminData(true);
        } else if (currentRole === 'student') {
          refreshStudentData(true);
        }
      }, 30000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function refreshAdminData(silent = false) {
      const refreshBtn = document.getElementById('adminRefreshBtn');
      if (refreshBtn) refreshBtn.classList.add('loading');
      
      const activeBtn = document.querySelector('#adminDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getAdminSectionFromButton(activeBtn);
        if (section) showAdminSection(section, true);
      }
      
      setTimeout(() => {
        if (refreshBtn) refreshBtn.classList.remove('loading');
      }, 1000);
    }

    function refreshStudentData(silent = false) {
      const refreshBtn = document.getElementById('studentRefreshBtn');
      if (refreshBtn) refreshBtn.classList.add('loading');
      
      const activeBtn = document.querySelector('#studentDashboard .menu-btn.active');
      if (activeBtn) {
        const section = getStudentSectionFromButton(activeBtn);
        if (section) showStudentSection(section, true);
      }
      
      setTimeout(() => {
        if (refreshBtn) refreshBtn.classList.remove('loading');
      }, 1000);
    }

    function getAdminSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-user-graduate')) return 'students';
      if (icon.classList.contains('fa-list-alt')) return 'leaveTypes';
      if (icon.classList.contains('fa-users-cog')) return 'categories';
      if (icon.classList.contains('fa-calendar-alt')) return 'yearCredits';
      if (icon.classList.contains('fa-check-circle')) return 'leaveApprovals';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      if (icon.classList.contains('fa-file-upload')) return 'bulkUpload';
      if (icon.classList.contains('fa-chart-bar')) return 'reports';
      if (icon.classList.contains('fa-database')) return 'backup';
      if (icon.classList.contains('fa-fire')) return 'firebaseConfig';
      return 'dashboard';
    }

    function getStudentSectionFromButton(button) {
      const icon = button.querySelector('i');
      if (icon.classList.contains('fa-tachometer-alt')) return 'dashboard';
      if (icon.classList.contains('fa-chart-pie')) return 'leaveBalance';
      if (icon.classList.contains('fa-history')) return 'leaveHistory';
      return 'dashboard';
    }

    function showAdminSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#adminDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showAdminDashboardHome();
          break;
        case 'students':
          showStudentsManagement();
          break;
        case 'leaveTypes':
          showLeaveTypesManagement();
          break;
        case 'categories':
          showCategoriesManagement();
          break;
        case 'yearCredits':
          showYearCreditsManagement();
          break;
        case 'leaveApprovals':
          showLeaveApprovals();
          break;
        case 'leaveHistory':
          showLeaveHistory();
          break;
        case 'bulkUpload':
          showBulkUpload();
          break;
        case 'reports':
          showReports();
          break;
        case 'backup':
          showBackupManagement();
          break;
        case 'firebaseConfig':
          showFirebaseConfigPanel();
          break;
      }
    }

    function showStudentSection(section, silent = false) {
      if (!silent && event && event.target) {
        document.querySelectorAll('#studentDashboard .menu-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
      
      switch(section) {
        case 'dashboard':
          showStudentDashboardHome();
          break;
        case 'leaveBalance':
          showStudentLeaveBalance();
          break;
        case 'leaveHistory':
          showStudentLeaveHistory();
          break;
      }
    }

    // ==================== ADMIN DASHBOARD HOME ====================
    async function showAdminDashboardHome() {
      try {
        let stats = {
          totalStudents: 0,
          totalLeaveTypes: 0,
          pendingLeaves: 0
        };
        
        if (firebase.apps.length > 0) {
          const db = firebase.firestore();
          const studentsSnapshot = await db.collection('students').get();
          const leaveTypesSnapshot = await db.collection('leaveTypes').get();
          const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
          
          stats = {
            totalStudents: studentsSnapshot.size,
            totalLeaveTypes: leaveTypesSnapshot.size,
            pendingLeaves: applicationsSnapshot.size
          };
        }
        
        const isFirebaseConfigured = localStorage.getItem('firebaseConfig') !== null;
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-tachometer-alt"></i> System Overview</h2>
              <span class="badge ${isFirebaseConfigured ? 'badge-success' : 'badge-warning'}">
                ${isFirebaseConfigured ? 'FIREBASE CONFIGURED' : 'FIREBASE NOT CONFIGURED'}
              </span>
            </div>
            ${!isFirebaseConfigured ? `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <strong>Firebase Not Configured</strong>
                  <p>Please configure Firebase to start using the system with full functionality.</p>
                  <button class="btn btn-primary" onclick="showFirebaseConfigPanel()" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> Configure Firebase
                  </button>
                </div>
              </div>
            ` : ''}
            <div class="stats-grid">
              <div class="stat-card">
                <h3>${stats.totalStudents}</h3>
                <p>Total Students</p>
              </div>
              <div class="stat-card">
                <h3>${stats.totalLeaveTypes}</h3>
                <p>Leave Types</p>
              </div>
              <div class="stat-card">
                <h3>${stats.pendingLeaves}</h3>
                <p>Pending Leaves</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <button class="btn btn-primary" onclick="showAddStudentModal()">
                <i class="fas fa-user-plus"></i> Add Student
              </button>
              <button class="btn btn-success" onclick="showLeaveEntryForm()">
                <i class="fas fa-file-medical"></i> New Leave
              </button>
              <button class="btn btn-info" onclick="showAdminSection('leaveApprovals')">
                <i class="fas fa-check-double"></i> Approve Leaves
              </button>
              <button class="btn btn-warning" onclick="showAdminSection('reports')">
                <i class="fas fa-chart-line"></i> Generate Report
              </button>
            </div>
          </div>
        `;
      } catch (error) {
        DEBUG.error('Dashboard error:', error);
        showAlert('Failed to load dashboard: ' + error.message, 'danger');
      }
    }

    // ==================== STUDENT DASHBOARD HOME ====================
    function showStudentDashboardHome() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
          </div>
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
              <div style="width: 60px; height: 60px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                <i class="fas fa-user-graduate"></i>
              </div>
              <div>
                <h3 style="margin-bottom: 5px;">${student.Name || 'Student'}</h3>
                <p style="color: #666; margin: 0;">
                  ${student.ID || ''} | ${student.Category || ''} ${student.Year ? '- ' + student.Year : ''}
                  ${student.Email ? '| Email: ' + student.Email : ''}
                </p>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Quick Info</h3>
              <div class="stats-grid">
                <div class="stat-card">
                  <h3 id="studentTotalLeaves">0</h3>
                  <p>Total Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentApprovedLeaves">0</h3>
                  <p>Approved Leaves</p>
                </div>
                <div class="stat-card">
                  <h3 id="studentPendingLeaves">0</h3>
                  <p>Pending Leaves</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentStats();
    }

    async function loadStudentStats() {
      if (firebase.apps.length === 0) return;
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('StudentID', '==', student.ID).get();
        const applications = applicationsSnapshot.docs.map(doc => doc.data());
        
        const total = applications.length;
        const approved = applications.filter(app => app.Status === 'approved').length;
        const pending = applications.filter(app => app.Status === 'pending').length;
        
        document.getElementById('studentTotalLeaves').textContent = total;
        document.getElementById('studentApprovedLeaves').textContent = approved;
        document.getElementById('studentPendingLeaves').textContent = pending;
        
      } catch (error) {
        DEBUG.error('Load student stats error:', error);
      }
    }

    // ==================== FIREBASE CONFIG PANEL ====================
    function showFirebaseConfigPanel() {
      const contentDiv = document.getElementById('adminMainContent');
      const isConfigured = firebase.apps.length > 0;
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-fire"></i> Firebase Configuration</h2>
            <div>
              <span class="badge ${isConfigured ? 'badge-success' : 'badge-danger'}" id="firebaseStatus">
                ${isConfigured ? 'CONNECTED' : 'NOT CONNECTED'}
              </span>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>Google Apps Script Bridge:</strong> Your Firebase config is fetched automatically.
              <br>Apps Script URL: <code>${GOOGLE_APPS_SCRIPT_URL}</code>
            </div>
          </div>
          
          <div class="connection-status" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
            <div class="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: ${isConfigured ? '#27ae60' : '#e74c3c'}; box-shadow: 0 0 10px ${isConfigured ? '#27ae60' : '#e74c3c'};"></div>
            <div>
              <strong>Status:</strong> 
              ${isConfigured ? 'Firebase is connected and ready' : 'Firebase is not configured'}
            </div>
          </div>
          
          ${!isConfigured ? `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              Firebase is not configured. Please enter your Firebase configuration below.
            </div>
          ` : ''}
          
          <form onsubmit="saveFirebaseConfig(event)">
            <h3 style="margin: 20px 0 10px 0;">1. Firebase Configuration</h3>
            <div class="form-group">
              <label>apiKey</label>
              <input type="text" class="form-control" id="fb_apiKey" required 
                     value="${localStorage.getItem('fb_apiKey') || ''}">
            </div>
            <div class="form-group">
              <label>authDomain</label>
              <input type="text" class="form-control" id="fb_authDomain" required
                     value="${localStorage.getItem('fb_authDomain') || ''}">
            </div>
            <div class="form-group">
              <label>projectId</label>
              <input type="text" class="form-control" id="fb_projectId" required
                     value="${localStorage.getItem('fb_projectId') || ''}">
            </div>
            <div class="form-group">
              <label>storageBucket</label>
              <input type="text" class="form-control" id="fb_storageBucket" required
                     value="${localStorage.getItem('fb_storageBucket') || ''}">
            </div>
            <div class="form-group">
              <label>messagingSenderId</label>
              <input type="text" class="form-control" id="fb_messagingSenderId" required
                     value="${localStorage.getItem('fb_messagingSenderId') || ''}">
            </div>
            <div class="form-group">
              <label>appId</label>
              <input type="text" class="form-control" id="fb_appId" required
                     value="${localStorage.getItem('fb_appId') || ''}">
            </div>
            <div class="form-group">
              <label>measurementId (optional)</label>
              <input type="text" class="form-control" id="fb_measurementId"
                     value="${localStorage.getItem('fb_measurementId') || ''}">
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">2. Connection Test</h3>
            <button type="button" class="btn btn-info" onclick="testFirebaseConnection()" style="margin-bottom: 20px;">
              <i class="fas fa-plug"></i> Test Connection
            </button>
            <div id="connectionTestResult"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save & Connect
              </button>
              ${isConfigured ? `
                <button type="button" class="btn btn-info" onclick="syncConfigurations()" style="flex: 1;">
                  <i class="fas fa-sync"></i> Sync to DB
                </button>
                <button type="button" class="btn btn-warning" onclick="showConfigHistory()" style="flex: 1;">
                  <i class="fas fa-history"></i> History
                </button>
                <button type="button" class="btn btn-danger" onclick="clearFirebaseConfig()" style="flex: 1;">
                  <i class="fas fa-trash"></i> Clear
                </button>
              ` : ''}
            </div>
          </form>
        </div>
      `;
    }

    // ==================== EMAIL CONFIGURATION ====================
    function showEmailConfig() {
      const savedUrl = localStorage.getItem('googleAppsScriptUrl') || GOOGLE_APPS_SCRIPT_URL;
      
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content wide-modal">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-envelope"></i> Email Configuration</h2>
          
          <div class="email-config-layout">
            <!-- Left Column - Configuration -->
            <div class="config-section">
              <h3><i class="fas fa-cog"></i> Settings</h3>
              
              <div class="alert alert-info" style="padding: 15px;">
                <p style="margin: 0;"><i class="fas fa-info-circle"></i> Configure your Google Apps Script URL for email notifications.</p>
              </div>
              
              <form onsubmit="saveEmailConfig(event)">
                <div class="form-group">
                  <label>Google Apps Script URL <span style="color: red;">*</span></label>
                  <input type="url" class="form-control" id="appsScriptUrl" 
                         placeholder="https://script.google.com/macros/s/your-script-id/exec"
                         value="${savedUrl}" required>
                  <small style="color: #666;">Paste your deployed Google Apps Script web app URL here</small>
                </div>
                
                <div class="storage-status">
                  <h4 style="margin-bottom: 10px;">Storage Status:</h4>
                  <div class="storage-status-item success">
                    <i class="fas fa-check-circle"></i>
                    <span>Hardcoded in GitHub: ${savedUrl.substring(0, 50)}...</span>
                  </div>
                  <div class="storage-status-item ${localStorage.getItem('googleAppsScriptUrl') ? 'success' : 'warning'}">
                    <i class="fas ${localStorage.getItem('googleAppsScriptUrl') ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                    <span>localStorage: ${localStorage.getItem('googleAppsScriptUrl') ? 'âœ… Saved' : 'âŒ Not saved'}</span>
                  </div>
                  <div class="storage-status-item ${firebase.apps.length > 0 ? 'info' : 'warning'}">
                    <i class="fas ${firebase.apps.length > 0 ? 'fa-database' : 'fa-exclamation-triangle'}"></i>
                    <span>Firestore: ${firebase.apps.length > 0 ? 'Checking...' : 'âŒ Firebase not connected'}</span>
                  </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button type="submit" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-save"></i> Save Configuration
                  </button>
                  <button type="button" class="btn btn-primary" onclick="testEmailConfiguration()" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Test Email
                  </button>
                </div>
                
                ${firebase.apps.length > 0 ? `
                  <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button type="button" class="btn btn-info" onclick="syncConfigurations()" style="flex: 1;">
                      <i class="fas fa-sync"></i> Sync to DB
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearEmailConfig()" style="flex: 1;">
                      <i class="fas fa-trash"></i> Clear
                    </button>
                  </div>
                ` : ''}
              </form>
            </div>
            
            <!-- Right Column - Preview and Instructions -->
            <div class="config-section">
              <h3><i class="fas fa-file-alt"></i> Email Templates</h3>
              
              <div class="template-tabs">
                <button class="template-tab active" onclick="showTemplatePreview('approved', event)">Approved</button>
                <button class="template-tab" onclick="showTemplatePreview('updated', event)">Updated</button>
                <button class="template-tab" onclick="showTemplatePreview('multiple', event)">Multiple Changes</button>
              </div>
              
              <div id="templatePreview" class="email-template-preview">
                ${generateApprovedEmailHTML({
                  to_name: 'John Doe',
                  application_id: 'LA-2024-0123',
                  student_id: '2024001',
                  leave_type: 'Medical Leave',
                  from_date: '15/03/2024',
                  to_date: '18/03/2024',
                  days: '4',
                  reason: 'Family function',
                  approved_date: '14/03/2024',
                  category_year: 'M.Tech - 1st Year'
                })}
              </div>
              
              <div style="margin-top: 20px;">
                <h4><i class="fas fa-code"></i> Apps Script Code</h4>
                <div class="apps-script-code">
                  <pre>function doPost(e) {
  try {
    var params = JSON.parse(e.postData.contents);
    
    var subject = "Leave Application ";
    if (params.action === 'approved') {
      subject += "Approved";
    } else {
      subject += "Updated & Approved";
    }
    subject += " - " + params.application_id;
    
    MailApp.sendEmail({
      to: params.to_email,
      subject: subject,
      htmlBody: params.html_content
    });
    
    return ContentService.createTextOutput(
      JSON.stringify({result: "success"})
    ).setMimeType(ContentService.MimeType.JSON);
    
  } catch(error) {
    return ContentService.createTextOutput(
      JSON.stringify({result: "error", error: error.toString()})
    ).setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
            <i class="fas fa-shield-alt"></i> Using same Gmail account for both Firebase and Apps Script ensures automatic authentication
          </div>
        </div>
      `;
      modal.style.display = 'flex';
      
      // Add template preview function
      window.showTemplatePreview = function(templateType, ev) {
        if (ev) {
          const tabs = document.querySelectorAll('.template-tab');
          tabs.forEach(tab => tab.classList.remove('active'));
          ev.target.classList.add('active');
        }
        
        const previewDiv = document.getElementById('templatePreview');
        let previewHTML = '';
        
        switch(templateType) {
          case 'approved':
            previewHTML = generateApprovedEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Medical Leave',
              from_date: '15/03/2024',
              to_date: '18/03/2024',
              days: '4',
              reason: 'Family function',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year'
            });
            break;
          case 'updated':
            previewHTML = generateUpdatedApprovedEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Casual Leave',
              from_date: '20/03/2024',
              to_date: '22/03/2024',
              days: '3',
              reason: 'Family function',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year',
              old_from_date: '15/03/2024',
              old_to_date: '18/03/2024',
              old_days: '4'
            });
            break;
          case 'multiple':
            previewHTML = generateMultipleChangesEmailHTML({
              to_name: 'John Doe',
              application_id: 'LA-2024-0123',
              student_id: '2024001',
              leave_type: 'Medical Leave',
              from_date: '20/03/2024',
              to_date: '22/03/2024',
              days: '3',
              reason: 'Medical appointment with doctor',
              approved_date: '14/03/2024',
              category_year: 'M.Tech - 1st Year',
              changes: {
                'From Date': { old: '15/03/2024', new: '20/03/2024' },
                'To Date': { old: '18/03/2024', new: '22/03/2024' },
                'Number of Days': { old: '4', new: '3' },
                'Reason': { old: 'Family function', new: 'Medical appointment with doctor' }
              }
            });
            break;
        }
        
        previewDiv.innerHTML = previewHTML;
      };
      
      // Update Firestore status
      if (firebase.apps.length > 0) {
        firebase.firestore().collection('systemConfig').doc('email').get()
          .then(doc => {
            const statusDiv = document.querySelector('.storage-status');
            if (statusDiv) {
              const firestoreStatus = statusDiv.querySelector('.storage-status-item:last-child span');
              if (firestoreStatus) {
                firestoreStatus.textContent = doc.exists ? 'Firestore: âœ… Saved' : 'Firestore: âŒ Not saved';
              }
            }
          })
          .catch(() => {});
      }
    }

    // Email template functions
    function generateApprovedEmailHTML(params) {
      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px;">
          <div style="background: #4a6fa5; color: white; padding: 20px; text-align: center;">
            <h3 style="margin: 0;">Leave Application Approved</h3>
          </div>
          <div style="padding: 20px; background: #f9f9f9;">
            <p>Dear <strong>${params.to_name}</strong>,</p>
            <p>Your leave application has been <strong style="color: #28a745;">APPROVED</strong>.</p>
            <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
              <p><strong>Application ID:</strong> ${params.application_id}</p>
              <p><strong>Leave Type:</strong> ${params.leave_type}</p>
              <p><strong>From Date:</strong> ${params.from_date}</p>
              <p><strong>To Date:</strong> ${params.to_date}</p>
              <p><strong>Days:</strong> ${params.days}</p>
              <p><strong>Reason:</strong> ${params.reason}</p>
            </div>
            <p>Best regards,<br>Leave Management System</p>
          </div>
        </div>
      `;
    }

    function generateUpdatedApprovedEmailHTML(params) {
      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px;">
          <div style="background: #4a6fa5; color: white; padding: 20px; text-align: center;">
            <h3 style="margin: 0;">Leave Application Updated & Approved</h3>
          </div>
          <div style="padding: 20px; background: #f9f9f9;">
            <p>Dear <strong>${params.to_name}</strong>,</p>
            <p>Your leave application has been <strong style="color: #ff9800;">UPDATED & APPROVED</strong>.</p>
            <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
              <p><strong>Application ID:</strong> ${params.application_id}</p>
              <p><strong>Leave Type:</strong> ${params.leave_type}</p>
              <p><strong>From Date:</strong> <span style="text-decoration: line-through; color: #999;">${params.old_from_date}</span> â†’ <span style="color: #28a745;">${params.from_date}</span></p>
              <p><strong>To Date:</strong> <span style="text-decoration: line-through; color: #999;">${params.old_to_date}</span> â†’ <span style="color: #28a745;">${params.to_date}</span></p>
              <p><strong>Days:</strong> <span style="text-decoration: line-through; color: #999;">${params.old_days}</span> â†’ <span style="color: #28a745;">${params.days}</span></p>
              <p><strong>Reason:</strong> ${params.reason}</p>
            </div>
            <p>Best regards,<br>Leave Management System</p>
          </div>
        </div>
      `;
    }

    function generateMultipleChangesEmailHTML(params) {
      let changesHTML = '';
      if (params.changes) {
        changesHTML = Object.entries(params.changes).map(([field, values]) => `
          <p><strong>${field}:</strong> <span style="text-decoration: line-through; color: #999;">${values.old}</span> â†’ <span style="color: #28a745;">${values.new}</span></p>
        `).join('');
      }
      
      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px;">
          <div style="background: #4a6fa5; color: white; padding: 20px; text-align: center;">
            <h3 style="margin: 0;">Leave Application Updated & Approved</h3>
          </div>
          <div style="padding: 20px; background: #f9f9f9;">
            <p>Dear <strong>${params.to_name}</strong>,</p>
            <p>Your leave application has been <strong style="color: #ff9800;">UPDATED & APPROVED</strong> with multiple changes.</p>
            <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
              <p><strong>Application ID:</strong> ${params.application_id}</p>
              ${changesHTML}
            </div>
            <p>Best regards,<br>Leave Management System</p>
          </div>
        </div>
      `;
    }

    async function saveEmailConfig(event) {
      event.preventDefault();
      
      const url = document.getElementById('appsScriptUrl').value.trim();
      
      if (!url) {
        showAlert('Please enter a valid Google Apps Script URL', 'warning');
        return;
      }
      
      const emailConfig = {
        googleAppsScriptUrl: url,
        updatedAt: new Date().toISOString()
      };
      
      localStorage.setItem('googleAppsScriptUrl', url);
      
      try {
        if (firebase.apps.length > 0) {
          const db = firebase.firestore();
          
          await db.collection('systemConfig').doc('email').set({
            config: emailConfig,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system'
          });
          
          await db.collection('configBackups').add({
            type: 'email',
            config: emailConfig,
            timestamp: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system'
          });
          
          showAlert('Email configuration saved to both localStorage and database!', 'success');
        } else {
          showAlert('Email configuration saved to localStorage only (Firebase not connected)', 'success');
        }
        
        setTimeout(() => {
          closeModal();
        }, 1500);
        
      } catch (error) {
        DEBUG.error('Save email config error:', error);
        showAlert('Email config saved locally but failed to save to database', 'warning');
      }
    }

    async function testEmailConfiguration() {
      const url = document.getElementById('appsScriptUrl').value.trim();
      
      if (!url) {
        showAlert('Please enter Google Apps Script URL first', 'warning');
        return;
      }
      
      showAlert('Sending test email...', 'info');
      
      try {
        const testParams = {
          to_email: currentUser?.email || 'test@example.com',
          to_name: currentUser?.name || 'Test User',
          application_id: 'TEST-001',
          leave_type: 'Test Leave',
          from_date: formatDateDDMMYYYY(new Date().toISOString()),
          to_date: formatDateDDMMYYYY(new Date().toISOString()),
          days: '1',
          reason: 'This is a test email',
          status: 'approved',
          action: 'approved',
          approved_date: formatDateDDMMYYYY(new Date().toISOString()),
          html_content: '<h1>Test Email</h1><p>This is a test email from Leave Management System.</p>'
        };
        
        await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testParams)
        });
        
        showAlert('Test email sent! Check your inbox (may take a few minutes).', 'success');
        
      } catch (error) {
        DEBUG.error('Test email error:', error);
        showAlert('Failed to send test email: ' + error.message, 'danger');
      }
    }

    async function saveFirebaseConfig(event) {
      event.preventDefault();
      
      const config = {
        apiKey: document.getElementById('fb_apiKey').value,
        authDomain: document.getElementById('fb_authDomain').value,
        projectId: document.getElementById('fb_projectId').value,
        storageBucket: document.getElementById('fb_storageBucket').value,
        messagingSenderId: document.getElementById('fb_messagingSenderId').value,
        appId: document.getElementById('fb_appId').value
      };
      
      const measurementId = document.getElementById('fb_measurementId').value;
      if (measurementId) config.measurementId = measurementId;
      
      saveConfigToLocalStorage(config);
      
      showAlert('Initializing Firebase...', 'info');
      
      const result = initializeFirebase(config);
      
      if (result.success) {
        try {
          const db = firebase.firestore();
          
          await db.collection('systemConfig').doc('firebase').set({
            config: config,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system'
          });
          
          await db.collection('configBackups').add({
            type: 'firebase',
            config: config,
            timestamp: new Date().toISOString(),
            updatedBy: currentUser?.email || 'system'
          });
          
          showAlert('Firebase connected and configuration saved to database!', 'success');
        } catch (dbError) {
          DEBUG.error('Error saving config to Firestore:', dbError);
          showAlert('Firebase connected but config could not be saved to database.', 'warning');
        }
        
        await initializeDefaultData();
        showFirebaseConfigPanel();
      } else {
        showAlert('Firebase connection failed: ' + result.error, 'danger');
      }
    }

    async function syncConfigurations() {
      if (firebase.apps.length === 0) {
        showAlert('Firebase not configured', 'warning');
        return;
      }
      
      showAlert('Syncing configurations...', 'info');
      
      try {
        const db = firebase.firestore();
        const localFirebaseConfig = localStorage.getItem('firebaseConfig');
        const localEmailUrl = localStorage.getItem('googleAppsScriptUrl');
        
        const batch = db.batch();
        
        if (localFirebaseConfig) {
          const firebaseConfig = JSON.parse(localFirebaseConfig);
          const firebaseConfigRef = db.collection('systemConfig').doc('firebase');
          batch.set(firebaseConfigRef, {
            config: firebaseConfig,
            syncedAt: new Date().toISOString(),
            syncedBy: currentUser?.email || 'system',
            source: 'localStorage'
          }, { merge: true });
        }
        
        if (localEmailUrl) {
          const emailConfigRef = db.collection('systemConfig').doc('email');
          batch.set(emailConfigRef, {
            config: { googleAppsScriptUrl: localEmailUrl },
            syncedAt: new Date().toISOString(),
            syncedBy: currentUser?.email || 'system',
            source: 'localStorage'
          }, { merge: true });
        }
        
        await batch.commit();
        
        await db.collection('configBackups').add({
          type: 'sync',
          timestamp: new Date().toISOString(),
          syncedBy: currentUser?.email || 'system',
          firebaseConfig: localFirebaseConfig ? JSON.parse(localFirebaseConfig) : null,
          emailConfig: localEmailUrl ? { googleAppsScriptUrl: localEmailUrl } : null
        });
        
        showAlert('Configurations synced successfully!', 'success');
        
      } catch (error) {
        DEBUG.error('Sync error:', error);
        showAlert('Failed to sync configurations: ' + error.message, 'danger');
      }
    }

    async function showConfigHistory() {
      if (firebase.apps.length === 0) {
        showAlert('Firebase not configured', 'warning');
        return;
      }
      
      try {
        const db = firebase.firestore();
        
        const backupsSnapshot = await db.collection('configBackups')
          .orderBy('timestamp', 'desc')
          .limit(20)
          .get();
        
        const backups = backupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        let backupsHTML = '';
        if (backups.length > 0) {
          backupsHTML = backups.map(backup => `
            <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
              <h4 style="margin-bottom: 5px;"><i class="fas fa-history"></i> ${backup.type.toUpperCase()} Backup</h4>
              <p style="margin: 0; color: #666;">Date: ${formatDate(backup.timestamp)}</p>
              <p style="margin: 0; color: #666;">By: ${backup.syncedBy || backup.updatedBy || 'Unknown'}</p>
            </div>
          `).join('');
        } else {
          backupsHTML = '<p>No configuration history found.</p>';
        }
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px;">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-history"></i> Configuration History</h2>
            
            <div style="max-height: 400px; overflow-y: auto;">
              ${backupsHTML}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="syncConfigurations()" style="flex: 1;">
                <i class="fas fa-sync"></i> Sync Now
              </button>
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        DEBUG.error('Load config history error:', error);
        showAlert('Failed to load configuration history', 'danger');
      }
    }

    function clearFirebaseConfig() {
      showConfirmationDialog(
        "Clear Firebase Configuration",
        "This will remove Firebase configuration from both localStorage and Firestore. Continue?",
        async () => {
          localStorage.removeItem('firebaseConfig');
          localStorage.removeItem('fb_apiKey');
          localStorage.removeItem('fb_authDomain');
          localStorage.removeItem('fb_projectId');
          localStorage.removeItem('fb_storageBucket');
          localStorage.removeItem('fb_messagingSenderId');
          localStorage.removeItem('fb_appId');
          localStorage.removeItem('fb_measurementId');
          
          if (firebase.apps.length > 0) {
            try {
              await firebase.firestore().collection('systemConfig').doc('firebase').delete();
              
              await firebase.firestore().collection('configBackups').add({
                type: 'firebase',
                action: 'deleted',
                timestamp: new Date().toISOString(),
                deletedBy: currentUser?.email || 'system'
              });
              
            } catch (error) {
              DEBUG.error('Delete config error:', error);
            }
          }
          
          showAlert('Configuration cleared. Refreshing page...', 'success');
          setTimeout(() => location.reload(), 2000);
        }
      );
    }

    function clearEmailConfig() {
      showConfirmationDialog(
        "Clear Email Configuration",
        "This will remove email settings from both localStorage and Firestore. Continue?",
        async () => {
          localStorage.removeItem('googleAppsScriptUrl');
          
          if (firebase.apps.length > 0) {
            try {
              await firebase.firestore().collection('systemConfig').doc('email').delete();
              
              await firebase.firestore().collection('configBackups').add({
                type: 'email',
                action: 'deleted',
                timestamp: new Date().toISOString(),
                deletedBy: currentUser?.email || 'system'
              });
              
            } catch (error) {
              DEBUG.error('Delete email config error:', error);
            }
          }
          
          showAlert('Email configuration cleared from all storage', 'success');
          closeModal();
        }
      );
    }

    async function initializeDefaultData() {
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').limit(1).get();
        
        if (leaveTypesSnapshot.empty) {
          const defaultLeaveTypes = [
            { Code: 'CL', Name: 'Casual Leave', Description: 'For casual/emergency leaves', ApprovalType: 'credit', MaxDaysPerApplication: 5, MaxDaysPerYear: 12, Enabled: true },
            { Code: 'RH', Name: 'Restricted Holiday', Description: 'Optional holidays', ApprovalType: 'approval', MaxDaysPerApplication: 1, MaxDaysPerYear: 2, Enabled: true },
            { Code: 'ML', Name: 'Medical Leave', Description: 'For medical reasons', ApprovalType: 'approval', MaxDaysPerApplication: 10, MaxDaysPerYear: 20, Enabled: true },
            { Code: 'EL', Name: 'Earned Leave', Description: 'Accumulated leave', ApprovalType: 'credit', MaxDaysPerApplication: 15, MaxDaysPerYear: 30, Enabled: true }
          ];
          
          for (const lt of defaultLeaveTypes) {
            await db.collection('leaveTypes').add(lt);
          }
        }
        
        const categoriesSnapshot = await db.collection('categories').limit(1).get();
        
        if (categoriesSnapshot.empty) {
          const defaultCategories = [
            { 
              Category: 'B.Tech', 
              Years: '1st Year,2nd Year,3rd Year,4th Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4,Semester 5,Semester 6,Semester 7,Semester 8',
              Specializations: 'Computer Science,Information Technology,Electronics,Mechanical,Civil,Electrical',
              Enabled: true
            },
            { 
              Category: 'M.Tech', 
              Years: '1st Year,2nd Year', 
              Semesters: 'Semester 1,Semester 2,Semester 3,Semester 4',
              Specializations: 'Computer Science,Electronics,Mechanical,Structural Engineering',
              Enabled: true
            }
          ];
          
          for (const cat of defaultCategories) {
            await db.collection('categories').add(cat);
          }
        }
        
        DEBUG.log('Default data initialized');
        
      } catch (error) {
        DEBUG.error('Error initializing default data:', error);
      }
    }

    // ==================== STUDENT MANAGEMENT FUNCTIONS ====================
    async function showStudentsManagement() {
      try {
        const db = firebase.firestore();
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        window.allStudents = students;
        selectedStudents.clear();
        
        const uniqueCategories = [...new Set(students.map(s => s.Category).filter(Boolean))];
        const uniqueYears = [...new Set(students.map(s => s.Year).filter(Boolean))];
        
        const savedFilters = loadFilterState('students');
        currentFilters = { ...savedFilters };
        
        const filteredStudents = filterStudents(students, currentFilters);
        
        const contentDiv = document.getElementById('adminMainContent');
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-user-graduate"></i> Students Management</h2>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="showAddStudentModal()">
                  <i class="fas fa-plus"></i> Add Student
                </button>
              </div>
            </div>
            
            <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <div class="filter-group search-box" style="position: relative;">
                <label>Search</label>
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 35px; color: #6c757d;"></i>
                <input type="text" class="form-control" id="studentSearch" placeholder="Search by ID or Name..." 
                       style="padding-left: 35px;" oninput="filterStudentList()" value="${currentFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>Category</label>
                <select class="form-control" id="filterCategory" onchange="filterStudentList()">
                  <option value="">All Categories</option>
                  ${uniqueCategories.map(cat => `<option value="${cat}" ${currentFilters.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>Year</label>
                <select class="form-control" id="filterYear" onchange="filterStudentList()">
                  <option value="">All Years</option>
                  ${uniqueYears.map(year => `<option value="${year}" ${currentFilters.year === year ? 'selected' : ''}>${year}</option>`).join('')}
                </select>
              </div>
              
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-secondary" onclick="clearStudentFilters()" style="margin-top: 5px;">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredStudents.length}</strong> of <strong>${students.length}</strong> students
            </div>
            
            <div class="table-container">
              ${renderStudentsTable(filteredStudents)}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Students data error:', error);
        showAlert('Failed to load students: ' + error.message, 'danger');
      }
    }

    function filterStudentList() {
      currentFilters = {
        search: document.getElementById('studentSearch').value.toLowerCase(),
        category: document.getElementById('filterCategory').value,
        year: document.getElementById('filterYear').value,
        semester: '',
        specialization: ''
      };
      
      saveFilterState('students', currentFilters);
      
      const filteredStudents = filterStudents(window.allStudents, currentFilters);
      
      const tableContainer = document.querySelector('.table-container');
      if (tableContainer) {
        tableContainer.innerHTML = renderStudentsTable(filteredStudents);
      }
      
      const infoAlert = document.querySelector('.alert-info');
      if (infoAlert) {
        infoAlert.innerHTML = `
          <i class="fas fa-info-circle"></i> 
          Showing <strong>${filteredStudents.length}</strong> of <strong>${window.allStudents.length}</strong> students
        `;
      }
    }

    function filterStudents(students, filters) {
      return students.filter(student => {
        if (filters.search) {
          const searchMatch = 
            (student.ID && student.ID.toString().toLowerCase().includes(filters.search)) ||
            (student.Name && student.Name.toLowerCase().includes(filters.search));
          if (!searchMatch) return false;
        }
        
        if (filters.category && student.Category !== filters.category) return false;
        if (filters.year && student.Year !== filters.year) return false;
        
        return true;
      });
    }

    function clearStudentFilters() {
      currentFilters = {
        search: '',
        category: '',
        year: '',
        semester: '',
        specialization: ''
      };
      
      if (document.getElementById('studentSearch')) document.getElementById('studentSearch').value = '';
      if (document.getElementById('filterCategory')) document.getElementById('filterCategory').value = '';
      if (document.getElementById('filterYear')) document.getElementById('filterYear').value = '';
      
      saveFilterState('students', currentFilters);
      filterStudentList();
    }

    function renderStudentsTable(students) {
      if (students.length === 0) {
        return '<p>No students found. Add your first student using the "Add Student" button.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Year</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr>
                <td>${student.ID || ''}</td>
                <td>${student.Name || ''}</td>
                <td>${student.Category || ''}</td>
                <td>${student.Year || 'N/A'}</td>
                <td>${student.Email || 'N/A'}</td>
                <td>${student.Phone || 'N/A'}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-primary" onclick="editStudent('${student.ID}')" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.ID}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="applyLeaveForStudent('${student.ID}')" title="Apply Leave">
                      <i class="fas fa-file-signature"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ==================== ADD STUDENT MODAL ====================
    async function showAddStudentModal() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        // Get all existing student IDs for duplicate checking
        const studentsSnapshot = await db.collection('students').get();
        const existingStudentIds = new Set();
        studentsSnapshot.docs.forEach(doc => {
          existingStudentIds.add(doc.data().ID);
        });
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        let categoriesHTML = '<option value="">Select Category</option>';
        if (categories && categories.length > 0) {
          categoriesHTML += categories.filter(c => c.Enabled === true).map(cat => `
            <option value="${cat.Category}">${cat.Category}</option>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-plus"></i> Add New Student</h2>
            <form onsubmit="addStudent(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentId" required 
                         onkeyup="checkStudentIdDuplicate(this.value)" onblur="checkStudentIdDuplicate(this.value)">
                  <div id="studentIdStatus" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="newStudentName" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category <span style="color: red;">*</span></label>
                <select class="form-control" id="newStudentCategory" required onchange="updateYearOptions(this.value)">
                  ${categoriesHTML}
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <select class="form-control" id="newStudentYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="newStudentEmail">
                </div>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-control" id="newStudentPhone">
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="saveStudentBtn">
                  <i class="fas fa-save"></i> Save Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        window.existingStudentIds = existingStudentIds;
        
        window.checkStudentIdDuplicate = function(studentId) {
          const statusDiv = document.getElementById('studentIdStatus');
          const saveBtn = document.getElementById('saveStudentBtn');
          
          if (!studentId || studentId.trim() === '') {
            statusDiv.innerHTML = '';
            if (saveBtn) saveBtn.disabled = false;
            return;
          }
          
          if (window.existingStudentIds.has(studentId)) {
            statusDiv.innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> Student ID already exists!</span>';
            if (saveBtn) saveBtn.disabled = true;
          } else {
            statusDiv.innerHTML = '<span style="color: #27ae60;"><i class="fas fa-check-circle"></i> Student ID is available</span>';
            if (saveBtn) saveBtn.disabled = false;
          }
        };
        
        window.updateYearOptions = function(category) {
          const selectedCat = categories.find(c => c.Category === category);
          const yearSelect = document.getElementById('newStudentYear');
          
          if (selectedCat) {
            const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
            
            yearSelect.innerHTML = '<option value="">Select Year</option>' + 
              years.map(year => `<option value="${year}">${year}</option>`).join('');
          }
        };
        
      } catch (error) {
        DEBUG.error('Add student modal error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function addStudent(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('newStudentId').value.trim();
      const studentName = document.getElementById('newStudentName').value.trim();
      const category = document.getElementById('newStudentCategory').value;
      
      if (!studentId || !studentName || !category) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      if (window.existingStudentIds && window.existingStudentIds.has(studentId)) {
        showAlert('Student ID already exists! Please use a different ID.', 'danger');
        return;
      }
      
      const studentData = {
        ID: studentId,
        Name: studentName,
        Category: category,
        Year: document.getElementById('newStudentYear').value,
        Email: document.getElementById('newStudentEmail').value.trim(),
        Phone: document.getElementById('newStudentPhone').value.trim(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      const saveBtn = document.getElementById('saveStudentBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<div class="loading-spinner"></div> Saving...';
      saveBtn.disabled = true;
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured. Please configure Firebase first.', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (!existingSnapshot.empty) {
          showAlert('Student ID already exists! Please use a different ID.', 'danger');
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
          return;
        }
        
        await db.collection('students').add(studentData);
        
        showAlert('Student added successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        DEBUG.error('Add student error:', error);
        showAlert('Failed to add student: ' + error.message, 'danger');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    async function editStudent(studentId) {
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        const student = { id: studentDoc.id, ...studentDoc.data() };
        
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => doc.data());
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        let categoriesHTML = '<option value="">Select Category</option>';
        if (categories && categories.length > 0) {
          categoriesHTML += categories.filter(c => c.Enabled === true).map(cat => `
            <option value="${cat.Category}" ${student.Category === cat.Category ? 'selected' : ''}>${cat.Category}</option>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Student</h2>
            <form onsubmit="updateStudent(event, '${studentId}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Student ID</label>
                  <input type="text" class="form-control" value="${student.ID}" readonly>
                </div>
                <div class="form-group">
                  <label>Student Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editStudentName" value="${student.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Category <span style="color: red;">*</span></label>
                <select class="form-control" id="editStudentCategory" required onchange="updateEditYearOptions(this.value)">
                  ${categoriesHTML}
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Year</label>
                  <select class="form-control" id="editStudentYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" id="editStudentEmail" value="${student.Email || ''}">
                </div>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-control" id="editStudentPhone" value="${student.Phone || ''}">
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Student
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        const selectedCat = categories.find(c => c.Category === student.Category);
        if (selectedCat) {
          const yearSelect = document.getElementById('editStudentYear');
          const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
          
          yearSelect.innerHTML = '<option value="">Select Year</option>' + 
            years.map(year => `<option value="${year}" ${student.Year === year ? 'selected' : ''}>${year}</option>`).join('');
        }
        
        window.updateEditYearOptions = function(category) {
          const selectedCat = categories.find(c => c.Category === category);
          const yearSelect = document.getElementById('editStudentYear');
          
          if (selectedCat) {
            const years = selectedCat.Years ? selectedCat.Years.split(',').map(y => y.trim()) : [];
            
            yearSelect.innerHTML = '<option value="">Select Year</option>' + 
              years.map(year => `<option value="${year}">${year}</option>`).join('');
          }
        };
        
      } catch (error) {
        DEBUG.error('Edit student error:', error);
        showAlert('Failed to load student: ' + error.message, 'danger');
      }
    }

    async function updateStudent(event, studentId) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
        if (studentsSnapshot.empty) {
          showAlert('Student not found', 'danger');
          return;
        }
        
        const studentDoc = studentsSnapshot.docs[0];
        
        const studentData = {
          Name: document.getElementById('editStudentName').value.trim(),
          Category: document.getElementById('editStudentCategory').value,
          Year: document.getElementById('editStudentYear').value,
          Email: document.getElementById('editStudentEmail').value.trim(),
          Phone: document.getElementById('editStudentPhone').value.trim(),
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!studentData.Name || !studentData.Category) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('students').doc(studentDoc.id).update(studentData);
        
        showAlert('Student updated successfully!', 'success');
        closeModal();
        showStudentsManagement();
        
      } catch (error) {
        DEBUG.error('Update student error:', error);
        showAlert('Failed to update student: ' + error.message, 'danger');
      }
    }

    async function deleteStudent(studentId) {
      showConfirmationDialog(
        "Delete Student",
        "Are you sure you want to delete this student? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const studentsSnapshot = await db.collection('students').where('ID', '==', studentId).get();
            if (studentsSnapshot.empty) {
              showAlert('Student not found', 'danger');
              return;
            }
            
            await db.collection('students').doc(studentsSnapshot.docs[0].id).delete();
            
            showAlert('Student deleted successfully!', 'success');
            showStudentsManagement();
            
          } catch (error) {
            DEBUG.error('Delete student error:', error);
            showAlert('Failed to delete student: ' + error.message, 'danger');
          }
        }
      );
    }

    function applyLeaveForStudent(studentId) {
      showLeaveEntryForm(studentId);
    }

    // ==================== LEAVE TYPES MANAGEMENT ====================
    async function showLeaveTypesManagement() {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let leaveTypesHTML = '';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th>Max/App</th>
                  <th>Max/Year</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${leaveTypes.map(lt => `
                  <tr>
                    <td><span class="badge badge-primary">${lt.Code || ''}</span></td>
                    <td>${lt.Name || ''}</td>
                    <td>${lt.Description || ''}</td>
                    <td><span class="badge ${lt.ApprovalType === 'credit' ? 'badge-info' : 'badge-warning'}">
                      ${lt.ApprovalType === 'credit' ? 'Credit' : 'Approval'}
                    </span></td>
                    <td>${lt.MaxDaysPerApplication || 0}</td>
                    <td>${lt.MaxDaysPerYear || 0}</td>
                    <td>
                      <span class="badge ${lt.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${lt.Enabled === true ? 'ENABLED' : 'DISABLED'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editLeaveType('${lt.Code}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteLeaveType('${lt.Code}')" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          leaveTypesHTML = '<p>No leave types found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-list-alt"></i> Leave Types Management</h2>
              <button class="btn btn-success" onclick="showAddLeaveTypeModal()">
                <i class="fas fa-plus"></i> Add Leave Type
              </button>
            </div>
            <div class="table-container">
              ${leaveTypesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Leave types error:', error);
        showAlert('Failed to load leave types: ' + error.message, 'danger');
      }
    }

    function showAddLeaveTypeModal() {
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add Leave Type</h2>
          <form onsubmit="addLeaveType(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Code <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeCode" required maxlength="10">
                <small style="color: #666;">Short code (e.g., CL, RH, ML)</small>
              </div>
              <div class="form-group">
                <label>Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="leaveTypeName" required>
                <small style="color: #666;">Full name of the leave type</small>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="leaveTypeDescription" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Approval Type <span style="color: red;">*</span></label>
              <select class="form-control" id="leaveTypeApprovalType" required>
                <option value="credit">Credit-based</option>
                <option value="approval">Approval-based</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Max Days per Application</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerApp" value="5" min="1" required>
              </div>
              <div class="form-group">
                <label>Max Days per Year</label>
                <input type="number" class="form-control" id="leaveTypeMaxPerYear" value="10" min="1" required>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="leaveTypeEnabled" checked> Enabled
              </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Leave Type
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addLeaveType(event) {
      event.preventDefault();
      
      const leaveTypeData = {
        Code: document.getElementById('leaveTypeCode').value.trim().toUpperCase(),
        Name: document.getElementById('leaveTypeName').value.trim(),
        Description: document.getElementById('leaveTypeDescription').value.trim(),
        ApprovalType: document.getElementById('leaveTypeApprovalType').value,
        MaxDaysPerApplication: parseInt(document.getElementById('leaveTypeMaxPerApp').value) || 0,
        MaxDaysPerYear: parseInt(document.getElementById('leaveTypeMaxPerYear').value) || 0,
        Enabled: document.getElementById('leaveTypeEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!leaveTypeData.Code || !leaveTypeData.Name) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('leaveTypes').where('Code', '==', leaveTypeData.Code).get();
        if (!existingSnapshot.empty) {
          showAlert('Leave type code already exists', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').add(leaveTypeData);
        
        showAlert('Leave type added successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        DEBUG.error('Add leave type error:', error);
        showAlert('Failed to add leave type: ' + error.message, 'danger');
      }
    }

    async function editLeaveType(code) {
      try {
        const db = firebase.firestore();
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        const leaveType = leaveTypeDoc.data();
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Leave Type</h2>
            <form onsubmit="updateLeaveType(event, '${code}')">
              <div class="form-row">
                <div class="form-group">
                  <label>Code</label>
                  <input type="text" class="form-control" value="${leaveType.Code}" readonly>
                </div>
                <div class="form-group">
                  <label>Name <span style="color: red;">*</span></label>
                  <input type="text" class="form-control" id="editLeaveTypeName" value="${leaveType.Name || ''}" required>
                </div>
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="editLeaveTypeDescription" rows="2">${leaveType.Description || ''}</textarea>
              </div>
              <div class="form-group">
                <label>Approval Type <span style="color: red;">*</span></label>
                <select class="form-control" id="editLeaveTypeApprovalType" required>
                  <option value="credit" ${leaveType.ApprovalType === 'credit' ? 'selected' : ''}>Credit-based</option>
                  <option value="approval" ${leaveType.ApprovalType === 'approval' ? 'selected' : ''}>Approval-based</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Max Days per Application</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerApp" value="${leaveType.MaxDaysPerApplication || 0}" min="1" required>
                </div>
                <div class="form-group">
                  <label>Max Days per Year</label>
                  <input type="number" class="form-control" id="editLeaveTypeMaxPerYear" value="${leaveType.MaxDaysPerYear || 0}" min="1" required>
                </div>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editLeaveTypeEnabled" ${leaveType.Enabled === true ? 'checked' : ''}> Enabled
                </label>
              </div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Leave Type
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        DEBUG.error('Edit leave type error:', error);
        showAlert('Failed to load leave type: ' + error.message, 'danger');
      }
    }

    async function updateLeaveType(event, code) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
        if (leaveTypesSnapshot.empty) {
          showAlert('Leave type not found', 'danger');
          return;
        }
        
        const leaveTypeDoc = leaveTypesSnapshot.docs[0];
        
        const leaveTypeData = {
          Name: document.getElementById('editLeaveTypeName').value.trim(),
          Description: document.getElementById('editLeaveTypeDescription').value.trim(),
          ApprovalType: document.getElementById('editLeaveTypeApprovalType').value,
          MaxDaysPerApplication: parseInt(document.getElementById('editLeaveTypeMaxPerApp').value) || 0,
          MaxDaysPerYear: parseInt(document.getElementById('editLeaveTypeMaxPerYear').value) || 0,
          Enabled: document.getElementById('editLeaveTypeEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!leaveTypeData.Name) {
          showAlert('Please fill in the required fields', 'warning');
          return;
        }
        
        await db.collection('leaveTypes').doc(leaveTypeDoc.id).update(leaveTypeData);
        
        showAlert('Leave type updated successfully!', 'success');
        closeModal();
        showLeaveTypesManagement();
        
      } catch (error) {
        DEBUG.error('Update leave type error:', error);
        showAlert('Failed to update leave type: ' + error.message, 'danger');
      }
    }

    async function deleteLeaveType(code) {
      showConfirmationDialog(
        "Delete Leave Type",
        "Are you sure you want to delete this leave type? This action cannot be undone.",
        async () => {
          try {
            const db = firebase.firestore();
            
            const leaveTypesSnapshot = await db.collection('leaveTypes').where('Code', '==', code).get();
            if (leaveTypesSnapshot.empty) {
              showAlert('Leave type not found', 'danger');
              return;
            }
            
            await db.collection('leaveTypes').doc(leaveTypesSnapshot.docs[0].id).delete();
            
            showAlert('Leave type deleted successfully!', 'success');
            showLeaveTypesManagement();
            
          } catch (error) {
            DEBUG.error('Delete leave type error:', error);
            showAlert('Failed to delete leave type: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== CATEGORIES MANAGEMENT ====================
    async function showCategoriesManagement() {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').get();
        const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let categoriesHTML = '';
        if (categories && categories.length > 0) {
          categoriesHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Years</th>
                  <th>Semesters</th>
                  <th>Specializations</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${categories.map(cat => `
                  <tr>
                    <td><strong>${cat.Category || ''}</strong></td>
                    <td>${cat.Years || ''}</td>
                    <td>${cat.Semesters || ''}</td>
                    <td>${cat.Specializations || ''}</td>
                    <td>
                      <span class="badge ${cat.Enabled === true ? 'badge-success' : 'badge-danger'}">
                        ${cat.Enabled === true ? 'ACTIVE' : 'INACTIVE'}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editCategory('${cat.Category}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.Category}')" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          categoriesHTML = '<p>No categories found.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-users-cog"></i> Categories Management</h2>
              <button class="btn btn-success" onclick="showAddCategoryModal()">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>
            <div class="table-container">
              ${categoriesHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Categories error:', error);
        showAlert('Failed to load categories: ' + error.message, 'danger');
      }
    }

    function showAddCategoryModal() {
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-plus"></i> Add New Category</h2>
          <form onsubmit="addCategory(event)">
            <div class="form-group">
              <label>Category Name <span style="color: red;">*</span></label>
              <input type="text" class="form-control" id="categoryName" required>
              <small style="color: #666;">e.g., M.Tech, B.Tech, PhD</small>
            </div>
            
            <div class="form-group">
              <label>Years (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categoryYears" rows="2" required>1st Year, 2nd Year, 3rd Year, 4th Year</textarea>
              <small style="color: #666;">Enter years separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Semesters (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySemesters" rows="2" required>Semester 1, Semester 2, Semester 3, Semester 4</textarea>
              <small style="color: #666;">Enter semesters separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>Specializations (comma separated) <span style="color: red;">*</span></label>
              <textarea class="form-control" id="categorySpecializations" rows="2" required>Computer Science, IT, ECE, Mechanical</textarea>
              <small style="color: #666;">Enter specializations separated by commas</small>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="categoryEnabled" checked> Active
              </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Save Category
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function addCategory(event) {
      event.preventDefault();
      
      const categoryData = {
        Category: document.getElementById('categoryName').value.trim(),
        Years: document.getElementById('categoryYears').value.trim(),
        Semesters: document.getElementById('categorySemesters').value.trim(),
        Specializations: document.getElementById('categorySpecializations').value.trim(),
        Enabled: document.getElementById('categoryEnabled').checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'admin'
      };
      
      if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const existingSnapshot = await db.collection('categories').where('Category', '==', categoryData.Category).get();
        if (!existingSnapshot.empty) {
          showAlert('Category already exists', 'warning');
          return;
        }
        
        await db.collection('categories').add(categoryData);
        
        showAlert('Category added successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        DEBUG.error('Add category error:', error);
        showAlert('Failed to add category: ' + error.message, 'danger');
      }
    }

    async function editCategory(categoryName) {
      try {
        const db = firebase.firestore();
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', categoryName).get();
        
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        const category = categoryDoc.data();
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-edit"></i> Edit Category</h2>
            <form onsubmit="updateCategory(event, '${categoryName}')">
              <div class="form-group">
                <label>Category Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="editCategoryName" value="${category.Category || ''}" required>
              </div>
              
              <div class="form-group">
                <label>Years (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategoryYears" rows="2" required>${category.Years || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Semesters (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySemesters" rows="2" required>${category.Semesters || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>Specializations (comma separated) <span style="color: red;">*</span></label>
                <textarea class="form-control" id="editCategorySpecializations" rows="2" required>${category.Specializations || ''}</textarea>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="editCategoryEnabled" ${category.Enabled === true ? 'checked' : ''}> Active
                </label>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="fas fa-save"></i> Update Category
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        DEBUG.error('Edit category error:', error);
        showAlert('Failed to load category: ' + error.message, 'danger');
      }
    }

    async function updateCategory(event, oldCategoryName) {
      event.preventDefault();
      
      try {
        const db = firebase.firestore();
        
        const categoriesSnapshot = await db.collection('categories').where('Category', '==', oldCategoryName).get();
        if (categoriesSnapshot.empty) {
          showAlert('Category not found', 'danger');
          return;
        }
        
        const categoryDoc = categoriesSnapshot.docs[0];
        
        const categoryData = {
          Category: document.getElementById('editCategoryName').value.trim(),
          Years: document.getElementById('editCategoryYears').value.trim(),
          Semesters: document.getElementById('editCategorySemesters').value.trim(),
          Specializations: document.getElementById('editCategorySpecializations').value.trim(),
          Enabled: document.getElementById('editCategoryEnabled').checked,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'admin'
        };
        
        if (!categoryData.Category || !categoryData.Years || !categoryData.Semesters || !categoryData.Specializations) {
          showAlert('Please fill in all required fields', 'warning');
          return;
        }
        
        await db.collection('categories').doc(categoryDoc.id).update(categoryData);
        
        showAlert('Category updated successfully!', 'success');
        closeModal();
        showCategoriesManagement();
        
      } catch (error) {
        DEBUG.error('Update category error:', error);
        showAlert('Failed to update category: ' + error.message, 'danger');
      }
    }

    async function deleteCategory(categoryName) {
      showConfirmationDialog(
        "Delete Category",
        "Are you sure you want to delete this category?",
        async () => {
          try {
            const db = firebase.firestore();
            
            const categoriesSnapshot = await db.collection('categories').where('Category', '==', categoryName).get();
            if (categoriesSnapshot.empty) {
              showAlert('Category not found', 'danger');
              return;
            }
            
            await db.collection('categories').doc(categoriesSnapshot.docs[0].id).delete();
            
            showAlert('Category deleted successfully!', 'success');
            showCategoriesManagement();
            
          } catch (error) {
            DEBUG.error('Delete category error:', error);
            showAlert('Failed to delete category: ' + error.message, 'danger');
          }
        }
      );
    }

    // ==================== YEAR CREDITS MANAGEMENT ====================
    async function showYearCreditsManagement() {
      try {
        const db = firebase.firestore();
        
        const yearCreditsSnapshot = await db.collection('yearCredits').get();
        const yearCredits = yearCreditsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const creditLeaveTypes = (leaveTypes || []).filter(lt => lt.ApprovalType === 'credit' && lt.Enabled === true);
        
        const contentDiv = document.getElementById('adminMainContent');
        
        let creditsHTML = '';
        if (yearCredits && yearCredits.length > 0) {
          let tableHeaders = '<tr><th>Category</th><th>Year</th>';
          creditLeaveTypes.forEach(lt => {
            tableHeaders += `<th>${lt.Code}</th>`;
          });
          tableHeaders += '<th>Status</th><th>Actions</th></tr>';
          
          let tableRows = '';
          yearCredits.forEach(yc => {
            tableRows += '<tr>';
            tableRows += `<td>${yc.Category || ''}</td>`;
            tableRows += `<td>${yc.Year || ''}</td>`;
            
            creditLeaveTypes.forEach(lt => {
              const value = yc[lt.Code] || 0;
              tableRows += `<td>${value}</td>`;
            });
            
            tableRows += `<td><span class="badge ${yc.Active === true ? 'badge-success' : 'badge-danger'}">
              ${yc.Active === true ? 'ACTIVE' : 'INACTIVE'}
            </span></td>`;
            
            tableRows += `<td>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-sm btn-primary" onclick="editYearCredit('${yc.Category}', '${yc.Year}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteYearCredit('${yc.Category}', '${yc.Year}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td></tr>`;
          });
          
          creditsHTML = `
            <table class="data-table">
              <thead>${tableHeaders}</thead>
              <tbody>${tableRows}</tbody>
            </table>
          `;
        } else {
          creditsHTML = '<p>No year credits found. Add year credits for different categories and years.</p>';
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-calendar-alt"></i> Year Credits Management</h2>
              <button class="btn btn-success" onclick="showAddYearCreditModal()">
                <i class="fas fa-plus"></i> Add Year Credit
              </button>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Year credits determine how many leave days students have available.
            </div>
            <div class="table-container">
              ${creditsHTML}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Year credits error:', error);
        showAlert('Failed to load year credits: ' + error.message, 'danger');
      }
    }

    function showAddYearCreditModal() {
      showAlert('Add year credit feature - Please use Firebase Console for now', 'info');
    }

    function editYearCredit(category, year) {
      showAlert('Edit year credit feature - Please use Firebase Console for now', 'info');
    }

    function deleteYearCredit(category, year) {
      showAlert('Delete year credit feature - Please use Firebase Console for now', 'info');
    }

    // ==================== LEAVE APPLICATION FUNCTIONS ====================
    async function showLeaveEntryForm(prefilledStudentId = null) {
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').get();
        const leaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        let leaveTypesOptions = '<option value="">Select Leave Type</option>';
        if (leaveTypes && leaveTypes.length > 0) {
          leaveTypesOptions += leaveTypes.filter(lt => lt.Enabled === true).map(lt => `
            <option value="${lt.Code}">${lt.Name} (${lt.Code})</option>
          `).join('');
        }
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-file-signature"></i> Enter Leave Request</h2>
            <form onsubmit="submitLeaveRequest(event)">
              <div class="form-group">
                <label>Select Student ID <span style="color: red;">*</span></label>
                <div style="position: relative;">
                  <input type="text" class="form-control" id="studentSearchInput" 
                         placeholder="Search Student ID..." 
                         oninput="searchStudent(this.value)"
                         autocomplete="off"
                         ${prefilledStudentId ? `value="${prefilledStudentId}" readonly` : ''}>
                  <div id="studentSearchResults" class="search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ced4da; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 1000;"></div>
                </div>
                <input type="hidden" id="leaveStudentId" required>
              </div>
              
              <div id="studentInfoBox" class="student-info-box" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid var(--secondary);">
                <h4><i class="fas fa-user-graduate"></i> Selected Student Information</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                  <div>
                    <span style="font-size: 0.85rem; color: #666;">Student ID:</span>
                    <span style="font-weight: 600; display: block;" id="selectedStudentId">-</span>
                  </div>
                  <div>
                    <span style="font-size: 0.85rem; color: #666;">Name:</span>
                    <span style="font-weight: 600; display: block;" id="selectedStudentName">-</span>
                  </div>
                  <div>
                    <span style="font-size: 0.85rem; color: #666;">Category:</span>
                    <span style="font-weight: 600; display: block;" id="selectedStudentCategory">-</span>
                  </div>
                  <div>
                    <span style="font-size: 0.85rem; color: #666;">Year:</span>
                    <span style="font-weight: 600; display: block;" id="selectedStudentYear">-</span>
                  </div>
                  <div>
                    <span style="font-size: 0.85rem; color: #666;">Email:</span>
                    <span style="font-weight: 600; display: block;" id="selectedStudentEmail">-</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Leave Type <span style="color: red;">*</span></label>
                <select class="form-control" id="leaveType" required>
                  ${leaveTypesOptions}
                </select>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>From Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveFromDate" value="${tomorrowStr}" required>
                </div>
                <div class="form-group">
                  <label>To Date <span style="color: red;">*</span></label>
                  <input type="date" class="form-control" id="leaveToDate" value="${tomorrowStr}" required>
                </div>
              </div>
              
              <div id="dateValidationMessage" class="alert alert-danger" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span>To Date must be greater than or equal to From Date</span>
              </div>
              
              <div class="form-group">
                <label>Number of Days <span style="color: red;">*</span></label>
                <input type="number" class="form-control" id="leaveNoOfDays" min="1" value="1" required>
              </div>
              
              <div class="form-group">
                <label>Reason for Leave <span style="color: red;">*</span></label>
                <textarea class="form-control" id="leaveReason" rows="4" required></textarea>
              </div>
              
              <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="leaveStatus">
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;" id="submitLeaveBtn">
                  <i class="fas fa-paper-plane"></i> Submit Leave Request
                </button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        `;
        modal.style.display = 'flex';
        
        if (prefilledStudentId) {
          document.getElementById('leaveStudentId').value = prefilledStudentId;
          loadStudentDetails(prefilledStudentId);
        }
        
        // Date validation
        document.getElementById('leaveFromDate').addEventListener('change', validateLeaveDates);
        document.getElementById('leaveToDate').addEventListener('change', validateLeaveDates);
        
        // Student search
        window.searchStudent = async function(searchTerm) {
          const searchResults = document.getElementById('studentSearchResults');
          
          if (!searchTerm || searchTerm.trim() === '') {
            searchResults.style.display = 'none';
            return;
          }
          
          try {
            const searchTermLower = searchTerm.toLowerCase();
            const matchedStudents = students
              .filter(student => 
                student.ID && student.ID.toString().toLowerCase().includes(searchTermLower) ||
                student.Name && student.Name.toLowerCase().includes(searchTermLower)
              )
              .slice(0, 10);
            
            if (matchedStudents.length > 0) {
              let resultsHTML = '';
              matchedStudents.forEach(student => {
                resultsHTML += `
                  <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #e9ecef;" onclick="selectStudent('${student.ID}', '${student.Name.replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600; color: var(--primary);">${student.ID}</div>
                    <div style="color: #666; font-size: 0.9rem;">${student.Name}</div>
                  </div>
                `;
              });
              searchResults.innerHTML = resultsHTML;
              searchResults.style.display = 'block';
            } else {
              searchResults.style.display = 'none';
            }
          } catch (error) {
            DEBUG.error('Search error:', error);
            searchResults.style.display = 'none';
          }
        };
        
        window.selectStudent = function(studentId, studentName) {
          document.getElementById('studentSearchInput').value = studentId;
          document.getElementById('leaveStudentId').value = studentId;
          document.getElementById('studentSearchResults').style.display = 'none';
          loadStudentDetails(studentId);
        };
        
        async function loadStudentDetails(studentId) {
          const student = students.find(s => s.ID === studentId);
          if (student) {
            document.getElementById('selectedStudentId').textContent = student.ID || '-';
            document.getElementById('selectedStudentName').textContent = student.Name || '-';
            document.getElementById('selectedStudentCategory').textContent = student.Category || '-';
            document.getElementById('selectedStudentYear').textContent = student.Year || '-';
            document.getElementById('selectedStudentEmail').textContent = student.Email || 'No email';
            document.getElementById('studentInfoBox').style.display = 'block';
            window.selectedStudent = student;
          } else {
            document.getElementById('studentInfoBox').style.display = 'none';
            window.selectedStudent = null;
          }
        }
        
        function validateLeaveDates() {
          const fromDate = document.getElementById('leaveFromDate').value;
          const toDate = document.getElementById('leaveToDate').value;
          const messageDiv = document.getElementById('dateValidationMessage');
          const submitBtn = document.getElementById('submitLeaveBtn');
          
          if (fromDate && toDate) {
            const from = new Date(fromDate);
            const to = new Date(toDate);
            
            if (to < from) {
              messageDiv.style.display = 'flex';
              if (submitBtn) submitBtn.disabled = true;
              return false;
            } else {
              messageDiv.style.display = 'none';
              if (submitBtn) submitBtn.disabled = false;
              
              // Calculate days
              const timeDiff = to.getTime() - from.getTime();
              const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
              document.getElementById('leaveNoOfDays').value = dayDiff > 0 ? dayDiff : 1;
              
              return true;
            }
          }
          return true;
        }
        
      } catch (error) {
        DEBUG.error('Leave entry form error:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    async function submitLeaveRequest(event) {
      event.preventDefault();
      
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const studentId = document.getElementById('leaveStudentId').value;
      const leaveType = document.getElementById('leaveType').value;
      const days = parseInt(document.getElementById('leaveNoOfDays').value) || 1;
      
      // Validate date order
      const from = new Date(fromDate);
      const to = new Date(toDate);
      if (to < from) {
        showAlert('To Date cannot be earlier than From Date', 'danger');
        return;
      }
      
      const applicationData = {
        StudentID: studentId,
        LeaveType: leaveType,
        FromDate: fromDate,
        ToDate: toDate,
        NoOfDays: days,
        Reason: document.getElementById('leaveReason').value,
        Status: document.getElementById('leaveStatus').value,
        AppliedDate: new Date().toISOString(),
        AppliedBy: currentUser?.email || 'admin'
      };
      
      if (!applicationData.StudentID || !applicationData.LeaveType) {
        showAlert('Please select a student and leave type', 'warning');
        return;
      }
      
      const submitBtn = document.getElementById('submitLeaveBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner"></div> Submitting...';
      submitBtn.disabled = true;
      
      try {
        const db = firebase.firestore();
        
        await db.collection('leaveApplications').add(applicationData);
        
        showAlert('Leave request submitted successfully!', 'success');
        closeModal();
        showAdminSection('leaveApprovals');
        
      } catch (error) {
        DEBUG.error('Submit leave error:', error);
        showAlert('Failed to submit leave request: ' + error.message, 'danger');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    // ==================== LEAVE APPROVALS ====================
    async function showLeaveApprovals() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const savedFilters = loadFilterState('leaveApprovals');
        
        const filteredApps = applications.filter(app => {
          if (savedFilters.search) {
            const searchMatch = 
              (app.StudentID && app.StudentID.toString().toLowerCase().includes(savedFilters.search)) ||
              (app.StudentName && app.StudentName.toLowerCase().includes(savedFilters.search));
            if (!searchMatch) return false;
          }
          return true;
        });
        
        const contentDiv = document.getElementById('adminMainContent');
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-check-circle"></i> Pending Leave Approvals</h2>
              <div>
                <span class="badge badge-warning">Pending: ${filteredApps.length}</span>
                <button class="btn btn-sm btn-info" onclick="refreshAdminData()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <div class="filter-group search-box" style="position: relative;">
                <label>Search</label>
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 35px; color: #6c757d;"></i>
                <input type="text" class="form-control" id="approvalSearch" placeholder="Search by Student Name or ID..." 
                       style="padding-left: 35px;" oninput="filterApprovalList()" value="${savedFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-secondary" onclick="clearApprovalFilters()" style="margin-top: 5px;">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> pending applications
            </div>
            
            <div class="table-container">
              ${renderApprovalsTable(filteredApps)}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Leave approvals error:', error);
        showAlert('Failed to load leave applications: ' + error.message, 'danger');
      }
    }

    function renderApprovalsTable(applications) {
      if (applications.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>No Pending Approvals</h3>
            <p>All leave applications have been processed.</p>
          </div>
        `;
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>${app.Reason || ''}</td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-success" onclick="approveLeave('${app.id}')" title="Approve">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectLeave('${app.id}')" title="Reject">
                      <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function filterApprovalList() {
      const search = document.getElementById('approvalSearch').value.toLowerCase();
      
      saveFilterState('leaveApprovals', { search });
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').where('Status', '==', 'pending').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = applications.filter(app => {
          if (search) {
            const searchMatch = 
              (app.StudentID && app.StudentID.toString().toLowerCase().includes(search)) ||
              (app.StudentName && app.StudentName.toLowerCase().includes(search));
            return searchMatch;
          }
          return true;
        });
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderApprovalsTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> pending applications
          `;
        }
      } catch (error) {
        DEBUG.error('Filter approval error:', error);
      }
    }

    function clearApprovalFilters() {
      if (document.getElementById('approvalSearch')) document.getElementById('approvalSearch').value = '';
      saveFilterState('leaveApprovals', { search: '' });
      filterApprovalList();
    }

    async function approveLeave(applicationId) {
      showConfirmationDialog(
        "Approve Leave",
        "Are you sure you want to approve this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'approved',
              ApprovedDate: new Date().toISOString(),
              ApprovedBy: currentUser?.email || 'admin'
            });
            
            showAlert('Leave application approved successfully!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            DEBUG.error('Approve leave error:', error);
            showAlert('Failed to approve leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function rejectLeave(applicationId) {
      showConfirmationDialog(
        "Reject Leave",
        "Are you sure you want to reject this leave application?",
        async () => {
          try {
            const db = firebase.firestore();
            
            await db.collection('leaveApplications').doc(applicationId).update({
              Status: 'rejected',
              RejectedDate: new Date().toISOString(),
              RejectedBy: currentUser?.email || 'admin'
            });
            
            showAlert('Leave application rejected!', 'success');
            showLeaveApprovals();
            
          } catch (error) {
            DEBUG.error('Reject leave error:', error);
            showAlert('Failed to reject leave: ' + error.message, 'danger');
          }
        }
      );
    }

    async function viewApplicationDetails(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        
        let studentName = 'Unknown';
        if (app.StudentID) {
          const studentsSnapshot = await db.collection('students').where('ID', '==', app.StudentID).get();
          if (!studentsSnapshot.empty) {
            studentName = studentsSnapshot.docs[0].data().Name;
          }
        }
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-info-circle"></i> Application Details</h2>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
              <p><strong>Student:</strong> ${studentName} (${app.StudentID})</p>
              <p><strong>Leave Type:</strong> ${app.LeaveType}</p>
              <p><strong>From Date:</strong> ${formatDate(app.FromDate)}</p>
              <p><strong>To Date:</strong> ${formatDate(app.ToDate)}</p>
              <p><strong>Days:</strong> ${app.NoOfDays}</p>
              <p><strong>Reason:</strong> ${app.Reason || 'No reason provided'}</p>
              <p><strong>Status:</strong> <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${app.Status || 'pending'}</span></p>
              <p><strong>Applied Date:</strong> ${formatDate(app.AppliedDate)}</p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        DEBUG.error('View application error:', error);
        showAlert('Failed to load application details: ' + error.message, 'danger');
      }
    }

    // ==================== LEAVE HISTORY ====================
    async function showLeaveHistory() {
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        applications.sort((a, b) => new Date(b.AppliedDate) - new Date(a.AppliedDate));
        
        const savedFilters = loadFilterState('leaveHistory');
        
        const filteredApps = applications.filter(app => {
          if (savedFilters.search) {
            const searchMatch = 
              (app.StudentID && app.StudentID.toString().toLowerCase().includes(savedFilters.search)) ||
              (app.StudentName && app.StudentName.toLowerCase().includes(savedFilters.search));
            if (!searchMatch) return false;
          }
          if (savedFilters.status && app.Status !== savedFilters.status) return false;
          return true;
        });
        
        const contentDiv = document.getElementById('adminMainContent');
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> All Leave Applications</h2>
              <div>
                <span class="badge badge-info">Total: ${filteredApps.length}</span>
                <button class="btn btn-sm btn-info" onclick="refreshAdminData()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <div class="filter-group search-box" style="position: relative;">
                <label>Search</label>
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 35px; color: #6c757d;"></i>
                <input type="text" class="form-control" id="historySearch" placeholder="Search by Student Name or ID..." 
                       style="padding-left: 35px;" oninput="filterHistoryList()" value="${savedFilters.search || ''}">
              </div>
              
              <div class="filter-group">
                <label>Status</label>
                <select class="form-control" id="filterStatus" onchange="filterHistoryList()">
                  <option value="">All Status</option>
                  <option value="pending" ${savedFilters.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="approved" ${savedFilters.status === 'approved' ? 'selected' : ''}>Approved</option>
                  <option value="rejected" ${savedFilters.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                </select>
              </div>
              
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-secondary" onclick="clearHistoryFilters()" style="margin-top: 5px;">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> applications
            </div>
            
            <div class="table-container">
              ${renderLeaveHistoryTable(filteredApps)}
            </div>
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Leave history error:', error);
        showAlert('Failed to load leave applications: ' + error.message, 'danger');
      }
    }

    function renderLeaveHistoryTable(applications) {
      if (applications.length === 0) {
        return '<p>No leave applications found.</p>';
      }
      
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Status</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(app => `
              <tr>
                <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                <td>${formatDate(app.FromDate)}</td>
                <td>${formatDate(app.ToDate)}</td>
                <td>${app.NoOfDays || 0}</td>
                <td>
                  <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                    ${(app.Status || '').toUpperCase()}
                  </span>
                </td>
                <td>${formatDate(app.AppliedDate)}</td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-info" onclick="viewApplicationDetails('${app.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function filterHistoryList() {
      const search = document.getElementById('historySearch').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      
      saveFilterState('leaveHistory', { search, status });
      
      try {
        const db = firebase.firestore();
        
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const studentsSnapshot = await db.collection('students').get();
        const studentsMap = {};
        studentsSnapshot.docs.forEach(doc => {
          const student = doc.data();
          studentsMap[student.ID] = student.Name;
        });
        
        applications.forEach(app => {
          app.StudentName = studentsMap[app.StudentID] || 'Unknown';
        });
        
        const filteredApps = applications.filter(app => {
          if (search) {
            const searchMatch = 
              (app.StudentID && app.StudentID.toString().toLowerCase().includes(search)) ||
              (app.StudentName && app.StudentName.toLowerCase().includes(search));
            if (!searchMatch) return false;
          }
          if (status && app.Status !== status) return false;
          return true;
        });
        
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.innerHTML = renderLeaveHistoryTable(filteredApps);
        }
        
        const infoAlert = document.querySelector('.alert-info');
        if (infoAlert) {
          infoAlert.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Showing <strong>${filteredApps.length}</strong> of <strong>${applications.length}</strong> applications
          `;
        }
      } catch (error) {
        DEBUG.error('Filter history error:', error);
      }
    }

    function clearHistoryFilters() {
      if (document.getElementById('historySearch')) document.getElementById('historySearch').value = '';
      if (document.getElementById('filterStatus')) document.getElementById('filterStatus').value = '';
      
      saveFilterState('leaveHistory', { search: '', status: '' });
      filterHistoryList();
    }

    // ==================== STUDENT LEAVE HISTORY ====================
    async function showStudentLeaveHistory() {
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        if (!student || !student.ID) {
          showAlert('Student information not found', 'danger');
          return;
        }
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .orderBy('AppliedDate', 'desc')
          .get();
        
        const applications = applicationsSnapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data
          };
        });
        
        const contentDiv = document.getElementById('studentMainContent');
        
        let applicationsHTML = '';
        
        if (applications.length > 0) {
          // Summary stats
          const approved = applications.filter(app => app.Status === 'approved').length;
          const pending = applications.filter(app => app.Status === 'pending').length;
          const rejected = applications.filter(app => app.Status === 'rejected').length;
          const totalDays = applications.reduce((sum, app) => sum + (app.NoOfDays || 0), 0);
          
          applicationsHTML = `
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card" style="background: #d4edda;">
                <h3 style="color: #155724;">${approved}</h3>
                <p>Approved</p>
              </div>
              <div class="stat-card" style="background: #fff3cd;">
                <h3 style="color: #856404;">${pending}</h3>
                <p>Pending</p>
              </div>
              <div class="stat-card" style="background: #f8d7da;">
                <h3 style="color: #721c24;">${rejected}</h3>
                <p>Rejected</p>
              </div>
              <div class="stat-card" style="background: #d1ecf1;">
                <h3 style="color: #0c5460;">${totalDays}</h3>
                <p>Total Days</p>
              </div>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Leave Type</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Days</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Applied Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${applications.map(app => {
                    const fromDate = app.FromDate ? formatDate(app.FromDate) : 'N/A';
                    const toDate = app.ToDate ? formatDate(app.ToDate) : 'N/A';
                    const appliedDate = app.AppliedDate ? formatDate(app.AppliedDate) : 'N/A';
                    
                    let statusClass = 'badge-warning';
                    if (app.Status === 'approved') statusClass = 'badge-success';
                    if (app.Status === 'rejected') statusClass = 'badge-danger';
                    
                    return `
                      <tr>
                        <td><span class="badge badge-primary">${app.LeaveType || 'N/A'}</span></td>
                        <td>${fromDate}</td>
                        <td>${toDate}</td>
                        <td><strong>${app.NoOfDays || 0}</strong></td>
                        <td>${app.Reason || '-'}</td>
                        <td>
                          <span class="badge ${statusClass}">
                            ${(app.Status || 'pending').toUpperCase()}
                          </span>
                        </td>
                        <td>${appliedDate}</td>
                        <td>
                          <button class="btn btn-sm btn-info" onclick="viewStudentApplicationDetails('${app.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                          </button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          applicationsHTML = `
            <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px;">
              <i class="fas fa-calendar-times" style="font-size: 4rem; color: #6c757d; margin-bottom: 15px;"></i>
              <h3 style="color: #495057; margin-bottom: 10px;">No Leave Applications Found</h3>
              <p style="color: #6c757d;">You haven't applied for any leave yet.</p>
            </div>
          `;
        }
        
        contentDiv.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> My Leave History</h2>
              <div>
                <span class="badge badge-info">Total: ${applications.length}</span>
                <button class="btn btn-sm btn-primary" onclick="showStudentLeaveHistory()" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>
            
            <div class="student-info-box" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--student-color);">
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: var(--student-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div>
                  <h4 style="margin-bottom: 5px;">${student.Name || 'Student'}</h4>
                  <p style="color: #666; margin: 0;">
                    <strong>ID:</strong> ${student.ID || 'N/A'} | 
                    <strong>Category:</strong> ${student.Category || 'N/A'} | 
                    <strong>Year:</strong> ${student.Year || 'N/A'}
                  </p>
                </div>
              </div>
            </div>
            
            ${applicationsHTML}
          </div>
        `;
        
      } catch (error) {
        DEBUG.error('Student leave history error:', error);
        
        let errorMessage = error.message;
        if (error.code === 'failed-precondition') {
          errorMessage = 'Database index missing. Please contact administrator.';
        }
        
        document.getElementById('studentMainContent').innerHTML = `
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-history"></i> My Leave History</h2>
            </div>
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Failed to load leave history</strong>
                <p>${errorMessage}</p>
                <button class="btn btn-sm btn-primary" onclick="showStudentLeaveHistory()" style="margin-top: 10px;">
                  <i class="fas fa-redo"></i> Try Again
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }

    async function viewStudentApplicationDetails(applicationId) {
      try {
        const db = firebase.firestore();
        
        const appDoc = await db.collection('leaveApplications').doc(applicationId).get();
        if (!appDoc.exists) {
          showAlert('Application not found', 'danger');
          return;
        }
        
        const app = { id: appDoc.id, ...appDoc.data() };
        const student = currentStudent || currentUser;
        
        const modal = document.getElementById('operationModal');
        modal.className = 'modal';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h2><i class="fas fa-file-alt"></i> Application Details</h2>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <div style="text-align: center; margin-bottom: 20px;">
                <span class="badge" style="background: ${app.Status === 'approved' ? '#27ae60' : app.Status === 'rejected' ? '#e74c3c' : '#f39c12'}; color: white; font-size: 1rem; padding: 8px 20px;">
                  ${(app.Status || 'pending').toUpperCase()}
                </span>
              </div>
              
              <p><strong>Leave Type:</strong> ${app.LeaveType || 'N/A'}</p>
              <p><strong>From Date:</strong> ${formatDate(app.FromDate)}</p>
              <p><strong>To Date:</strong> ${formatDate(app.ToDate)}</p>
              <p><strong>Days:</strong> ${app.NoOfDays || 0}</p>
              <p><strong>Applied Date:</strong> ${formatDate(app.AppliedDate)}</p>
              
              <div style="margin-top: 15px;">
                <strong>Reason:</strong>
                <p style="background: white; padding: 12px; border-radius: 5px; margin-top: 5px;">${app.Reason || 'No reason provided'}</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          </div>
        `;
        modal.style.display = 'flex';
        
      } catch (error) {
        DEBUG.error('View student application error:', error);
        showAlert('Failed to load application details: ' + error.message, 'danger');
      }
    }

    // ==================== STUDENT LEAVE BALANCE ====================
    async function showStudentLeaveBalance() {
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> My Leave Balance</h2>
          </div>
          <div style="padding: 20px;">
            <div class="leave-balance-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;" id="leaveBalanceContainer">
              <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Loading leave balance...</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadStudentLeaveBalance();
    }

    async function loadStudentLeaveBalance() {
      if (firebase.apps.length === 0) {
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Firebase not configured. Cannot load leave balance.
          </div>
        `;
        return;
      }
      
      try {
        const db = firebase.firestore();
        const student = currentStudent || currentUser;
        
        const yearCreditsSnapshot = await db.collection('yearCredits')
          .where('Category', '==', student.Category)
          .where('Year', '==', student.Year)
          .get();
        
        if (yearCreditsSnapshot.empty) {
          document.getElementById('leaveBalanceContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Leave Credits Found</h3>
              <p>Please contact administrator.</p>
            </div>
          `;
          return;
        }
        
        const yearCredit = yearCreditsSnapshot.docs[0].data();
        
        const applicationsSnapshot = await db.collection('leaveApplications')
          .where('StudentID', '==', student.ID)
          .where('Status', '==', 'approved')
          .get();
        
        const approvedLeaves = applicationsSnapshot.docs.map(doc => doc.data());
        
        const usedCredits = {};
        approvedLeaves.forEach(app => {
          if (!usedCredits[app.LeaveType]) {
            usedCredits[app.LeaveType] = 0;
          }
          usedCredits[app.LeaveType] += app.NoOfDays || 0;
        });
        
        const leaveTypesSnapshot = await db.collection('leaveTypes').where('ApprovalType', '==', 'credit').get();
        const creditLeaveTypes = leaveTypesSnapshot.docs.map(doc => doc.data());
        
        let balanceHTML = '';
        creditLeaveTypes.forEach(lt => {
          const totalCredits = yearCredit[lt.Code] || 0;
          const used = usedCredits[lt.Code] || 0;
          const remaining = Math.max(0, totalCredits - used);
          
          balanceHTML += `
            <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-top: 5px solid #3498db;">
              <div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px;">${lt.Name} (${lt.Code})</div>
              <div style="font-size: 2rem; font-weight: 700; margin: 10px 0;">${remaining}</div>
              <div>Days Available</div>
              <small style="color: #666;">Total: ${totalCredits} | Used: ${used}</small>
            </div>
          `;
        });
        
        if (balanceHTML === '') {
          balanceHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
              <h3>No Credit Leave Types</h3>
            </div>
          `;
        }
        
        document.getElementById('leaveBalanceContainer').innerHTML = balanceHTML;
        
      } catch (error) {
        DEBUG.error('Load leave balance error:', error);
        document.getElementById('leaveBalanceContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Failed to load leave balance: ${error.message}
          </div>
        `;
      }
    }

    // ==================== BULK UPLOAD ====================
    function showBulkUpload() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-file-upload"></i> Bulk Student Upload</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Upload a CSV file with student data. Required columns: Student ID, Name, Category, Year, Email, Phone
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-primary" onclick="downloadSampleTemplate()">
                <i class="fas fa-download"></i> Download Sample Template
              </button>
            </div>
            
            <div style="border: 2px dashed #3498db; border-radius: 10px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer;" id="uploadArea" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
              <h3>Click to Upload CSV File</h3>
              <p>Supports .csv files with comma separator</p>
              <p><small>Maximum file size: 5MB</small></p>
            </div>
            
            <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleBulkUpload(event)">
            
            <div id="uploadPreview" style="display: none; margin-top: 20px;">
              <h3>Preview (First 10 rows)</h3>
              <div id="previewTable" class="file-preview" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin-top: 15px; padding: 10px; background: white;"></div>
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-success" onclick="processBulkUpload()">
                  <i class="fas fa-check"></i> Confirm Upload
                </button>
                <button class="btn btn-danger" onclick="clearUpload()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
            
            <div id="uploadResult" style="display: none; margin-top: 20px;"></div>
          </div>
        </div>
      `;
      
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.background = '#e9ecef';
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.background = '#f8f9fa';
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.background = '#f8f9fa';
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleBulkUpload({ target: { files: files } });
        }
      });
    }

    function downloadSampleTemplate() {
      const csvContent = [
        ['Student ID', 'Name', 'Category', 'Year', 'Email', 'Phone'],
        ['S001', 'John Doe', 'B.Tech', '2nd Year', 'john@example.com', '1234567890'],
        ['S002', 'Jane Smith', 'B.Tech', '1st Year', 'jane@example.com', '0987654321']
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "student_upload_template.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Template downloaded successfully!', 'success');
    }

    let uploadedData = [];

    function handleBulkUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        showAlert('File size exceeds 5MB limit', 'danger');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = [];
          const lines = text.split('\n');
          
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const row = lines[i].split(',').map(cell => cell.replace(/"/g, '').trim());
            rows.push(row);
          }
          
          if (rows.length < 2) {
            showAlert('CSV file must have at least a header row and one data row', 'warning');
            return;
          }
          
          const previewDiv = document.getElementById('uploadPreview');
          const previewTable = document.getElementById('previewTable');
          
          let previewHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
          previewHTML += '<thead><tr style="background: #f8f9fa;">';
          rows[0].forEach(cell => {
            previewHTML += `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${cell}</th>`;
          });
          previewHTML += '</tr></thead><tbody>';
          
          const previewRows = Math.min(10, rows.length - 1);
          for (let i = 1; i <= previewRows; i++) {
            previewHTML += '<tr>';
            rows[i].forEach(cell => {
              previewHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
            });
            previewHTML += '</tr>';
          }
          previewHTML += '</tbody></table>';
          
          if (rows.length > 11) {
            previewHTML += `<p style="text-align: center; color: #666; margin-top: 10px;">... and ${rows.length - 11} more rows</p>`;
          }
          
          previewTable.innerHTML = previewHTML;
          previewDiv.style.display = 'block';
          document.getElementById('uploadArea').style.display = 'none';
          
          uploadedData = rows.slice(1).filter(row => row.length >= 3 && row[0] && row[1] && row[2]);
          
          showAlert(`Loaded ${uploadedData.length} student records for upload`, 'info');
          
        } catch (error) {
          DEBUG.error('CSV parsing error:', error);
          showAlert('Error parsing CSV file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function processBulkUpload() {
      if (uploadedData.length === 0) {
        showAlert('No data to upload!', 'warning');
        return;
      }
      
      showAlert(`Processing ${uploadedData.length} student records...`, 'info');
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const row of uploadedData) {
          try {
            const studentData = {
              ID: row[0],
              Name: row[1],
              Category: row[2],
              Year: row[3] || '',
              Email: row[4] || '',
              Phone: row[5] || '',
              createdAt: new Date().toISOString(),
              createdBy: currentUser?.email || 'admin'
            };
            
            const existingSnapshot = await db.collection('students').where('ID', '==', studentData.ID).get();
            if (!existingSnapshot.empty) {
              errors.push(`Student ID ${studentData.ID} already exists - skipped`);
              errorCount++;
              continue;
            }
            
            await db.collection('students').add(studentData);
            successCount++;
            
          } catch (err) {
            errors.push(`Error adding student ${row[0]}: ${err.message}`);
            errorCount++;
          }
        }
        
        const resultDiv = document.getElementById('uploadResult');
        let resultHTML = `
          <div class="alert ${successCount > 0 ? 'alert-success' : 'alert-warning'}">
            <i class="fas ${successCount > 0 ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
            <div>
              <strong>Upload Complete</strong>
              <p>Successfully uploaded: ${successCount} students</p>
              <p>Errors: ${errorCount}</p>
            </div>
          </div>
        `;
        
        if (errors.length > 0) {
          resultHTML += `
            <div class="alert alert-danger" style="margin-top: 15px;">
              <i class="fas fa-exclamation-circle"></i>
              <div>
                <strong>Errors encountered:</strong>
                <ul style="margin: 10px 0 0 20px; max-height: 200px; overflow-y: auto;">
                  ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        resultDiv.innerHTML = resultHTML;
        resultDiv.style.display = 'block';
        
        if (successCount > 0) {
          setTimeout(() => {
            showStudentsManagement();
          }, 3000);
        }
        
      } catch (error) {
        DEBUG.error('Bulk upload error:', error);
        showAlert('Failed to process upload: ' + error.message, 'danger');
      }
    }

    function clearUpload() {
      uploadedData = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadPreview').style.display = 'none';
      document.getElementById('uploadResult').style.display = 'none';
      document.getElementById('uploadArea').style.display = 'block';
    }

    // ==================== REPORTS ====================
    function showReports() {
      const contentDiv = document.getElementById('adminMainContent');
      
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      const lastMonthStr = lastMonth.toISOString().split('T')[0];
      
      const savedFilters = loadFilterState('reports');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Reports</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Generate reports with date range filters. Applications that overlap with the selected date range will be included.
            </div>
            
            <div style="margin: 20px 0;">
              <div class="form-row">
                <div class="form-group">
                  <label>From Date</label>
                  <input type="date" class="form-control" id="reportFromDate" value="${savedFilters.fromDate || lastMonthStr}">
                </div>
                <div class="form-group">
                  <label>To Date</label>
                  <input type="date" class="form-control" id="reportToDate" value="${savedFilters.toDate || today}">
                </div>
              </div>
              
              <div class="form-group">
                <label>Report Type</label>
                <select class="form-control" id="reportType">
                  <option value="all" ${savedFilters.reportType === 'all' ? 'selected' : ''}>All Leave Applications</option>
                  <option value="pending" ${savedFilters.reportType === 'pending' ? 'selected' : ''}>Pending Applications</option>
                  <option value="approved" ${savedFilters.reportType === 'approved' ? 'selected' : ''}>Approved Applications</option>
                  <option value="rejected" ${savedFilters.reportType === 'rejected' ? 'selected' : ''}>Rejected Applications</option>
                  <option value="students" ${savedFilters.reportType === 'students' ? 'selected' : ''}>Student List</option>
                </select>
              </div>
              
              <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="generateReport()">
                  <i class="fas fa-search"></i> Generate Report
                </button>
                <button class="btn btn-pdf" onclick="exportToPDF()" style="margin-left: 10px; background: #e74c3c; color: white;">
                  <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
                <button class="btn btn-secondary" onclick="clearReportFilters()" style="margin-left: 10px;">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
            
            <div id="reportResult"></div>
          </div>
        </div>
      `;
    }

    async function generateReport() {
      const fromDate = document.getElementById('reportFromDate').value;
      const toDate = document.getElementById('reportToDate').value;
      const reportType = document.getElementById('reportType').value;
      
      const fromDateTime = fromDate ? new Date(fromDate) : null;
      const toDateTime = toDate ? new Date(toDate) : null;
      if (toDateTime) toDateTime.setHours(23, 59, 59, 999);
      
      saveFilterState('reports', { fromDate, toDate, reportType });
      
      showAlert('Generating report...', 'info');
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        let data = [];
        let title = '';
        
        if (reportType === 'students') {
          const snapshot = await db.collection('students').get();
          data = snapshot.docs.map(doc => doc.data());
          title = 'Student List Report';
        } else {
          let query = db.collection('leaveApplications');
          
          if (reportType !== 'all') {
            query = query.where('Status', '==', reportType);
          }
          
          const snapshot = await query.get();
          let applications = snapshot.docs.map(doc => doc.data());
          
          // Filter by date overlap
          if (fromDate || toDate) {
            applications = applications.filter(app => {
              const appFromDate = app.FromDate ? new Date(app.FromDate) : null;
              const appToDate = app.ToDate ? new Date(app.ToDate) : null;
              
              if (!appFromDate || !appToDate) return false;
              
              let overlaps = true;
              
              if (fromDateTime) {
                overlaps = overlaps && (appToDate >= fromDateTime);
              }
              if (toDateTime) {
                overlaps = overlaps && (appFromDate <= toDateTime);
              }
              
              return overlaps;
            });
          }
          
          const studentsSnapshot = await db.collection('students').get();
          const studentsMap = {};
          studentsSnapshot.docs.forEach(doc => {
            const student = doc.data();
            studentsMap[student.ID] = student.Name;
          });
          
          applications.forEach(app => {
            app.StudentName = studentsMap[app.StudentID] || 'Unknown';
          });
          
          data = applications;
          title = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Leave Applications Report`;
        }
        
        const reportResult = {
          title: title,
          fromDate: fromDate,
          toDate: toDate,
          generatedDate: new Date().toLocaleString(),
          total: data.length,
          data: data
        };
        
        currentReportData = reportResult;
        currentReportType = reportType;
        currentFromDate = fromDate;
        currentToDate = toDate;
        
        displayReport(reportResult, reportType);
        
      } catch (error) {
        DEBUG.error('Generate report error:', error);
        showAlert('Failed to generate report: ' + error.message, 'danger');
      }
    }

    function displayReport(reportData, reportType) {
      const reportDiv = document.getElementById('reportResult');
      
      let reportHTML = `
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> ${reportData.title}</h3>
            <div>
              <span class="badge badge-info">Total: ${reportData.total || 0}</span>
            </div>
          </div>
          <div style="padding: 15px;">
            <p><strong>Date Range:</strong> ${reportData.fromDate ? formatDate(reportData.fromDate) : 'Any'} to ${reportData.toDate ? formatDate(reportData.toDate) : 'Any'}</p>
            <p><strong>Generated:</strong> ${reportData.generatedDate}</p>
      `;
      
      if (reportData.data && reportData.data.length > 0) {
        if (reportType === 'students') {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Year</th>
                    <th>Email</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(student => `
                    <tr>
                      <td>${student.ID || ''}</td>
                      <td>${student.Name || ''}</td>
                      <td>${student.Category || ''}</td>
                      <td>${student.Year || 'N/A'}</td>
                      <td>${student.Email || 'N/A'}</td>
                      <td>${student.Phone || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          reportHTML += `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Leave Type</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Days</th>
                    <th>Status</th>
                    <th>Applied Date</th>
                  </tr>
                </thead>
                <tbody>
                  ${reportData.data.map(app => `
                    <tr>
                      <td>${app.StudentName || ''}<br><small>${app.StudentID || ''}</small></td>
                      <td><span class="badge badge-primary">${app.LeaveType || ''}</span></td>
                      <td>${formatDate(app.FromDate)}</td>
                      <td>${formatDate(app.ToDate)}</td>
                      <td>${app.NoOfDays || 0}</td>
                      <td>
                        <span class="badge ${app.Status === 'approved' ? 'badge-success' : app.Status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                          ${(app.Status || '').toUpperCase()}
                        </span>
                      </td>
                      <td>${formatDate(app.AppliedDate)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } else {
        reportHTML += '<p>No data found for the selected criteria.</p>';
      }
      
      reportHTML += `
          </div>
        </div>
      `;
      
      reportDiv.innerHTML = reportHTML;
      
      showAlert('Report generated successfully', 'success');
    }

    function clearReportFilters() {
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      const lastMonthStr = lastMonth.toISOString().split('T')[0];
      
      if (document.getElementById('reportFromDate')) document.getElementById('reportFromDate').value = lastMonthStr;
      if (document.getElementById('reportToDate')) document.getElementById('reportToDate').value = today;
      if (document.getElementById('reportType')) document.getElementById('reportType').value = 'all';
      
      saveFilterState('reports', { fromDate: '', toDate: '', reportType: 'all' });
      
      document.getElementById('reportResult').innerHTML = '';
      currentReportData = null;
    }

    function exportToPDF() {
      if (!currentReportData) {
        showAlert('Please generate a report first', 'warning');
        return;
      }
      
      exportCurrentReportToPDF();
    }

    function exportCurrentReportToPDF() {
      if (!currentReportData || typeof window.jspdf === 'undefined') {
        showAlert('PDF library not available', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      doc.setFontSize(20);
      doc.text("Student Leave Management System", 150, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(currentReportData.title, 150, 30, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Date Range: ${currentReportData.fromDate ? formatDate(currentReportData.fromDate) : 'Any'} to ${currentReportData.toDate ? formatDate(currentReportData.toDate) : 'Any'}`, 14, 40);
      doc.text(`Generated: ${currentReportData.generatedDate}`, 14, 46);
      doc.text(`Total Records: ${currentReportData.total}`, 14, 52);
      
      let startY = 60;
      
      if (currentReportData.data.length > 0) {
        if (currentReportType === 'students') {
          const headers = [['Student ID', 'Name', 'Category', 'Year', 'Email', 'Phone']];
          const rows = currentReportData.data.map(student => [
            student.ID || '',
            student.Name || '',
            student.Category || '',
            student.Year || 'N/A',
            student.Email || 'N/A',
            student.Phone || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] }
          });
        } else {
          const headers = [['Student ID', 'Student Name', 'Leave Type', 'From Date', 'To Date', 'Days', 'Status', 'Semester']];
          const rows = currentReportData.data.map(app => [
            app.StudentID || '',
            app.StudentName || '',
            app.LeaveType || '',
            formatDate(app.FromDate),
            formatDate(app.ToDate),
            app.NoOfDays || 0,
            (app.Status || '').toUpperCase(),
            app.Semester || 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: rows,
            startY: startY,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185] }
          });
        }
      }
      
      const fileName = `${currentReportData.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      showAlert('PDF exported successfully!', 'success');
    }

    // ==================== BACKUP MANAGEMENT ====================
    function showBackupManagement() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-database"></i> Backup & Restore</h2>
          </div>
          <div style="padding: 20px;">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Note:</strong> For production use, use Firebase Console's export feature.
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <h3 id="studentCount">0</h3>
                <p>Students</p>
              </div>
              <div class="stat-card">
                <h3 id="applicationCount">0</h3>
                <p>Applications</p>
              </div>
              <div class="stat-card">
                <h3 id="backupTime">-</h3>
                <p>Last Backup</p>
              </div>
            </div>
            
            <div style="margin: 20px 0;">
              <button class="btn btn-success" onclick="createFirestoreBackup()" style="margin-right: 10px;">
                <i class="fas fa-save"></i> Export Data (JSON)
              </button>
              <button class="btn btn-primary" onclick="importFirestoreBackup()">
                <i class="fas fa-upload"></i> Import Data (JSON)
              </button>
            </div>
          </div>
        </div>
      `;
      
      loadBackupStats();
    }

    async function loadBackupStats() {
      try {
        if (firebase.apps.length === 0) return;
        
        const db = firebase.firestore();
        
        const studentsSnapshot = await db.collection('students').get();
        const applicationsSnapshot = await db.collection('leaveApplications').get();
        
        document.getElementById('studentCount').textContent = studentsSnapshot.size;
        document.getElementById('applicationCount').textContent = applicationsSnapshot.size;
        
        const lastBackup = localStorage.getItem('lastBackupTimestamp');
        if (lastBackup) {
          document.getElementById('backupTime').textContent = formatDate(lastBackup);
        }
        
      } catch (error) {
        DEBUG.error('Load backup stats error:', error);
      }
    }

    async function createFirestoreBackup() {
      showAlert('Exporting data...', 'info');
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins'];
        const backupData = {};
        
        for (const collection of collections) {
          const snapshot = await db.collection(collection).get();
          backupData[collection] = snapshot.docs.map(doc => ({
            id: doc.id,
            data: doc.data()
          }));
        }
        
        backupData.timestamp = new Date().toISOString();
        backupData.version = '1.0';
        
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `firestore_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.click();
        URL.revokeObjectURL(url);
        
        localStorage.setItem('lastBackupTimestamp', new Date().toISOString());
        document.getElementById('backupTime').textContent = formatDate(new Date().toISOString());
        
        showAlert('Data exported successfully!', 'success');
        
      } catch (error) {
        DEBUG.error('Export error:', error);
        showAlert('Failed to export data: ' + error.message, 'danger');
      }
    }

    function importFirestoreBackup() {
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-upload"></i> Import Backup</h2>
          
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> This will overwrite ALL existing data. This action cannot be undone.
          </div>
          
          <div style="border: 2px dashed #3498db; border-radius: 10px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer;" onclick="document.getElementById('importFileInput').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
            <h3>Click to Select Backup File</h3>
            <p>Select a JSON backup file</p>
          </div>
          
          <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
              Cancel
            </button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          showConfirmationDialog(
            "Confirm Import",
            `This will import ${Object.keys(backupData).length} collections and overwrite all existing data. Are you sure?`,
            async () => {
              await processImport(backupData);
            }
          );
          
        } catch (error) {
          DEBUG.error('Parse backup error:', error);
          showAlert('Invalid backup file: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file);
    }

    async function processImport(backupData) {
      showAlert('Importing data... This may take a moment.', 'info');
      
      try {
        if (firebase.apps.length === 0) {
          showAlert('Firebase not configured', 'warning');
          return;
        }
        
        const db = firebase.firestore();
        
        const collections = ['students', 'leaveTypes', 'categories', 'yearCredits', 'leaveApplications', 'admins'];
        
        // Delete existing data
        for (const collection of collections) {
          if (backupData[collection]) {
            const snapshot = await db.collection(collection).get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          }
        }
        
        // Import new data
        for (const collection of collections) {
          if (backupData[collection] && backupData[collection].length > 0) {
            const batch = db.batch();
            backupData[collection].forEach(item => {
              const docRef = db.collection(collection).doc(item.id);
              batch.set(docRef, item.data);
            });
            await batch.commit();
          }
        }
        
        showAlert('Data imported successfully!', 'success');
        closeModal();
        
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        DEBUG.error('Import error:', error);
        showAlert('Failed to import data: ' + error.message, 'danger');
      }
    }

    // ==================== PROFILE FUNCTIONS ====================
    function showAdminProfile() {
      const contentDiv = document.getElementById('adminMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-user-circle"></i> My Profile</h2>
            <div>
              <button class="btn btn-warning" onclick="showForgotPasswordModal()" style="margin-right: 10px;">
                <i class="fas fa-key"></i> Reset Password
              </button>
              <button class="btn btn-primary" onclick="editAdminProfile()">
                <i class="fas fa-edit"></i> Edit Profile
              </button>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%); border-radius: 12px; color: white;">
            <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 3px solid white;">
              <i class="fas fa-user-shield"></i>
            </div>
            <div>
              <h2 style="font-size: 2rem; margin-bottom: 10px;">${currentUser.name || 'Administrator'}</h2>
              <p style="opacity: 0.9; font-size: 1.1rem;"><i class="fas fa-envelope"></i> ${currentUser.email || 'No email'}</p>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">User ID</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${currentUser.uid || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Email Address</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${currentUser.email || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Display Name</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${currentUser.name || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Role</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">Administrator</div>
            </div>
          </div>
        </div>
      `;
    }

    function editAdminProfile() {
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-edit"></i> Edit Profile</h2>
          <form onsubmit="updateAdminProfile(event)">
            <div class="form-group">
              <label>Display Name</label>
              <input type="text" class="form-control" id="adminProfileName" value="${currentUser.name || ''}" required>
            </div>
            
            <div class="alert alert-info" style="margin: 15px 0;">
              <i class="fas fa-info-circle"></i>
              To change your password, use the "Forgot Password" option on the login page.
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Update Profile
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function updateAdminProfile(event) {
      event.preventDefault();
      
      const name = document.getElementById('adminProfileName').value;
      
      try {
        if (firebase.apps.length > 0 && currentUser.uid !== 'default-admin') {
          await firebase.firestore().collection('admins').doc(currentUser.uid).update({
            name: name,
            updatedAt: new Date().toISOString()
          });
          
          currentUser.name = name;
        }
        
        document.getElementById('adminName').textContent = name;
        
        showAlert('Profile updated successfully!', 'success');
        closeModal();
        showAdminProfile();
        
      } catch (error) {
        DEBUG.error('Profile update error:', error);
        showAlert('Failed to update profile: ' + error.message, 'danger');
      }
    }

    function showStudentProfile() {
      const student = currentStudent || currentUser;
      const contentDiv = document.getElementById('studentMainContent');
      
      contentDiv.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-user-circle"></i> My Profile</h2>
            <button class="btn btn-primary" onclick="editStudentProfile()">
              <i class="fas fa-edit"></i> Edit Profile
            </button>
          </div>
          
          <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, var(--student-color) 0%, #138a72 100%); border-radius: 12px; color: white;">
            <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 3px solid white;">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div>
              <h2 style="font-size: 2rem; margin-bottom: 10px;">${student.Name || 'Student'}</h2>
              <p style="opacity: 0.9; font-size: 1.1rem;"><i class="fas fa-id-card"></i> Student ID: ${student.ID || 'N/A'}</p>
              <p style="opacity: 0.9; font-size: 1.1rem;"><i class="fas fa-envelope"></i> ${student.Email || 'No email'}</p>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Record ID</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.uid || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Student ID</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.ID || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Full Name</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.Name || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Category</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.Category || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Year</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.Year || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Email</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.Email || 'N/A'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px;">Phone</label>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">${student.Phone || 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
    }

    function editStudentProfile() {
      const student = currentStudent || currentUser;
      const modal = document.getElementById('operationModal');
      modal.className = 'modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="close-modal" onclick="closeModal()">&times;</div>
          <h2><i class="fas fa-edit"></i> Edit Student Profile</h2>
          <form onsubmit="updateStudentProfile(event)">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" class="form-control" id="studentProfileName" value="${student.Name || ''}" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="studentProfileEmail" value="${student.Email || ''}">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" class="form-control" id="studentProfilePhone" value="${student.Phone || ''}">
            </div>
            <div class="form-group">
              <label>Category</label>
              <input type="text" class="form-control" id="studentProfileCategory" value="${student.Category || ''}">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="text" class="form-control" id="studentProfileYear" value="${student.Year || ''}">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-success" style="flex: 1;">
                <i class="fas fa-save"></i> Update Profile
              </button>
              <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      modal.style.display = 'flex';
    }

    async function updateStudentProfile(event) {
      event.preventDefault();
      
      const name = document.getElementById('studentProfileName').value;
      const email = document.getElementById('studentProfileEmail').value;
      const phone = document.getElementById('studentProfilePhone').value;
      const category = document.getElementById('studentProfileCategory').value;
      const year = document.getElementById('studentProfileYear').value;
      
      try {
        if (firebase.apps.length > 0) {
          const db = firebase.firestore();
          const student = currentStudent || currentUser;
          
          await db.collection('students').doc(student.uid).update({
            Name: name,
            Email: email,
            Phone: phone,
            Category: category,
            Year: year,
            updatedAt: new Date().toISOString()
          });
          
          currentUser.Name = name;
          currentUser.Email = email;
          currentUser.Phone = phone;
          currentUser.Category = category;
          currentUser.Year = year;
          
          if (currentRole === 'student') {
            currentStudent = currentUser;
            document.getElementById('studentName').textContent = name;
          }
        }
        
        showAlert('Profile updated successfully!', 'success');
        closeModal();
        showStudentProfile();
        
      } catch (error) {
        DEBUG.error('Student profile update error:', error);
        showAlert('Failed to update profile: ' + error.message, 'danger');
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type) {
      // Remove any existing alerts
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => alert.remove());
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      // Find appropriate container to show alert
      if (currentRole === 'admin') {
        const mainContent = document.getElementById('adminMainContent');
        if (mainContent && mainContent.firstChild) {
          mainContent.insertBefore(alertDiv, mainContent.firstChild);
        } else if (mainContent) {
          mainContent.appendChild(alertDiv);
        }
      } else if (currentRole === 'student') {
        const mainContent = document.getElementById('studentMainContent');
        if (mainContent && mainContent.firstChild) {
          mainContent.insertBefore(alertDiv, mainContent.firstChild);
        } else if (mainContent) {
          mainContent.appendChild(alertDiv);
        }
      } else {
        const loginCard = document.querySelector('.login-card');
        if (loginCard) {
          loginCard.insertBefore(alertDiv, loginCard.firstChild);
        }
      }
      
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function closeModal() {
      const modal = document.getElementById('operationModal');
      if (modal) {
        modal.style.display = 'none';
        // Clear content to prevent memory leaks
        setTimeout(() => {
          if (modal.style.display === 'none') {
            modal.innerHTML = '';
          }
        }, 100);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('operationModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return 'N/A';
      }
    }

    function formatDateDDMMYYYY(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return 'N/A';
      }
    }

    function saveFilterState(section, filters) {
      filterStates[section] = { ...filters };
      localStorage.setItem(`filterState_${section}`, JSON.stringify(filters));
    }

    function loadFilterState(section) {
      const saved = localStorage.getItem(`filterState_${section}`);
      if (saved) {
        try {
          filterStates[section] = JSON.parse(saved);
        } catch (e) {
          // Ignore parse errors
        }
      }
      return filterStates[section];
    }

    function showConfirmationDialog(title, message, confirmCallback, cancelCallback) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;';
      
      const dialog = document.createElement('div');
      dialog.style.cssText = 'background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;';
      dialog.innerHTML = `
        <h3 style="margin-bottom: 10px;">${title}</h3>
        <p style="color: #666; margin-bottom: 20px;">${message}</p>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-danger" onclick="window.confirmAction()" style="flex: 1;">Confirm</button>
          <button class="btn btn-secondary" onclick="window.cancelAction()" style="flex: 1;">Cancel</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      window.confirmAction = function() {
        if (confirmCallback) confirmCallback();
        overlay.remove();
        delete window.confirmAction;
        delete window.cancelAction;
      };
      
      window.cancelAction = function() {
        if (cancelCallback) cancelCallback();
        overlay.remove();
        delete window.confirmAction;
        delete window.cancelAction;
      };
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      DEBUG.log('DOM Content Loaded');
      
      // Ensure modal exists
      let modal = document.getElementById('operationModal');
      if (!modal) {
        DEBUG.log('Creating modal element');
        modal = document.createElement('div');
        modal.id = 'operationModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
      }
      
      // Initialize Firebase
      initializeFirebaseFromAppsScript().then(result => {
        if (result.success) {
          DEBUG.log('Firebase initialized successfully from Apps Script');
          loadConfigurationsFromFirestore().catch(DEBUG.error);
        } else {
          DEBUG.warn('Could not initialize from Apps Script', result.error);
        }
      }).catch(DEBUG.error);
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          if (currentRole === 'admin') {
            refreshAdminData();
          } else if (currentRole === 'student') {
            refreshStudentData();
          }
        }
        
        if (e.key === 'Escape') {
          closeModal();
        }
      });
      
      // Test if login functions are accessible
      DEBUG.log('Login functions:', {
        showAdminLoginForm: typeof window.showAdminLoginForm,
        showStudentLoginForm: typeof window.showStudentLoginForm
      });
    });
  </script>
</body>
</html>